var ur;(function(n){n[n.Disjoint=0]="Disjoint",n[n.Contains=1]="Contains",n[n.Intersects=2]="Intersects"})(ur||(ur={}));var _t;(function(n){n[n.Back=0]="Back",n[n.Front=1]="Front",n[n.Intersecting=2]="Intersecting"})(_t||(_t={}));var le;(function(n){n[n.Near=0]="Near",n[n.Far=1]="Far",n[n.Left=2]="Left",n[n.Right=3]="Right",n[n.Bottom=4]="Bottom",n[n.Top=5]="Top"})(le||(le={}));function Ua(n,l){for(var a=0;a<l.length;a++){var t=l[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function jn(n,l,a){return l&&Ua(n.prototype,l),a&&Ua(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n}var G=function(){function n(){}return n.clamp=function(a,t,e){return Math.max(t,Math.min(e,a))},n.equals=function(a,t){return Math.abs(a-t)<=n.zeroTolerance},n.isPowerOf2=function(a){return(a&a-1)===0},n.radianToDegree=function(a){return a*n.radToDegreeFactor},n.degreeToRadian=function(a){return a*n.degreeToRadFactor},n}();G.zeroTolerance=1e-6;G.radToDegreeFactor=180/Math.PI;G.degreeToRadFactor=Math.PI/180;var w=function(){n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._z=t._z-e._z,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._z=t._z*e._z,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._z=t._z/e._z,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z},n.cross=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e._x,u=e._y,_=e._z;r.set(o*_-s*u,s*c-i*_,i*u-o*c)},n.distance=function(t,e){var r=e._x-t._x,i=e._y-t._y,o=e._z-t._z;return Math.sqrt(r*r+i*i+o*o)},n.distanceSquared=function(t,e){var r=e._x-t._x,i=e._y-t._y,o=e._z-t._z;return r*r+i*i+o*o},n.equals=function(t,e){return G.equals(t._x,e._x)&&G.equals(t._y,e._y)&&G.equals(t._z,e._z)},n.lerp=function(t,e,r,i){var o=t._x,s=t._y,c=t._z;i._x=o+(e._x-o)*r,i._y=s+(e._y-s)*r,i._z=c+(e._z-c)*r,i._onValueChanged&&i._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._z=Math.max(t._z,e._z),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._z=Math.min(t._z,e._z),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,i=t._y,o=t._z,s=Math.sqrt(r*r+i*i+o*o);s>G.zeroTolerance&&(s=1/s,e.set(r*s,i*s,o*s))},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._onValueChanged&&r._onValueChanged()},n.transformNormal=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e.elements;r._x=i*c[0]+o*c[4]+s*c[8],r._y=i*c[1]+o*c[5]+s*c[9],r._z=i*c[2]+o*c[6]+s*c[10],r._onValueChanged&&r._onValueChanged()},n.transformToVec3=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e.elements;r._x=i*c[0]+o*c[4]+s*c[8]+c[12],r._y=i*c[1]+o*c[5]+s*c[9]+c[13],r._z=i*c[2]+o*c[6]+s*c[10]+c[14],r._onValueChanged&&r._onValueChanged()},n.transformToVec4=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e.elements;r._x=i*c[0]+o*c[4]+s*c[8]+c[12],r._y=i*c[1]+o*c[5]+s*c[9]+c[13],r._z=i*c[2]+o*c[6]+s*c[10]+c[14],r._w=i*c[3]+o*c[7]+s*c[11]+c[15],r._onValueChanged&&r._onValueChanged()},n.transformCoordinate=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e.elements,u=i*c[3]+o*c[7]+s*c[11]+c[15];u=1/u,r._x=(i*c[0]+o*c[4]+s*c[8]+c[12])*u,r._y=(i*c[1]+o*c[5]+s*c[9]+c[13])*u,r._z=(i*c[2]+o*c[6]+s*c[10]+c[14])*u,r._onValueChanged&&r._onValueChanged()},n.transformByQuat=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e._x,u=e._y,_=e._z,h=e._w,d=h*i+u*s-_*o,f=h*o+_*i-c*s,p=h*s+c*o-u*i,v=-c*i-u*o-_*s;r._x=d*h-v*c-f*_+p*u,r._y=f*h-v*u-p*c+d*_,r._z=p*h-v*_-d*u+f*c,r._onValueChanged&&r._onValueChanged()};function n(a,t,e){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),this._x=void 0,this._y=void 0,this._z=void 0,this._onValueChanged=null,this._x=a,this._y=t,this._z=e}var l=n.prototype;return l.set=function(t,e,r){return this._x=t,this._y=e,this._z=r,this._onValueChanged&&this._onValueChanged(),this},l.add=function(t){return this._x+=t._x,this._y+=t._y,this._z+=t._z,this._onValueChanged&&this._onValueChanged(),this},l.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._z-=t._z,this._onValueChanged&&this._onValueChanged(),this},l.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._z*=t._z,this._onValueChanged&&this._onValueChanged(),this},l.divide=function(t){return this._x/=t._x,this._y/=t._y,this._z/=t._z,this._onValueChanged&&this._onValueChanged(),this},l.length=function(){var t=this._x,e=this._y,r=this._z;return Math.sqrt(t*t+e*e+r*r)},l.lengthSquared=function(){var t=this._x,e=this._y,r=this._z;return t*t+e*e+r*r},l.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._onValueChanged&&this._onValueChanged(),this},l.normalize=function(){return n.normalize(this,this),this},l.scale=function(t){return this._x*=t,this._y*=t,this._z*=t,this._onValueChanged&&this._onValueChanged(),this},l.transformNormal=function(t){return n.transformNormal(this,t,this),this},l.transformToVec3=function(t){return n.transformToVec3(this,t,this),this},l.transformCoordinate=function(t){return n.transformCoordinate(this,t,this),this},l.transformByQuat=function(t){return n.transformByQuat(this,t,this),this},l.clone=function(){return new n(this._x,this._y,this._z)},l.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._onValueChanged&&this._onValueChanged(),this},l.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._onValueChanged&&this._onValueChanged(),this},l.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z},jn(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}}]),n}();w._zero=new w(0,0,0);w._one=new w(1,1,1);var iu=function(){n.fromPoints=function(t,e){if(!t||t.length===0)throw new Error("points must be array and length must > 0");var r=t.length,i=n._tempVec30;i.x=i.y=i.z=0;for(var o=0;o<r;++o)w.add(t[o],i,i);w.scale(i,1/r,e.center);for(var s=0,c=0;c<r;++c){var u=w.distanceSquared(i,t[c]);u>s&&(s=u)}e.radius=Math.sqrt(s)},n.fromBox=function(t,e){var r=e.center,i=t.min,o=t.max;r.x=(i.x+o.x)*.5,r.y=(i.y+o.y)*.5,r.z=(i.z+o.z)*.5,e.radius=w.distance(r,o)};function n(a,t){a===void 0&&(a=null),t===void 0&&(t=0),this.center=new w,this.radius=0,a&&this.center.copyFrom(a),this.radius=t}var l=n.prototype;return l.clone=function(){return new n(this.center,this.radius)},l.copyFrom=function(t){return this.center.copyFrom(t.center),this.radius=t.radius,this},n}();iu._tempVec30=new w;var Tt=function(){n.fromCenterAndExtent=function(t,e,r){w.subtract(t,e,r.min),w.add(t,e,r.max)},n.fromPoints=function(t,e){if(!t||t.length===0)throw new Error("points must be array and length must > 0");var r=e.min,i=e.max;r.x=r.y=r.z=Number.MAX_VALUE,i.x=i.y=i.z=-Number.MAX_VALUE;for(var o=0,s=t.length;o<s;++o){var c=t[o];w.min(r,c,r),w.max(i,c,i)}},n.fromSphere=function(t,e){var r=t.center,i=t.radius,o=e.min,s=e.max;o.x=r.x-i,o.y=r.y-i,o.z=r.z-i,s.x=r.x+i,s.y=r.y+i,s.z=r.z+i},n.transform=function(t,e,r){var i=n._tempVec30,o=n._tempVec31;t.getCenter(i),t.getExtent(o),w.transformCoordinate(i,e,i);var s=o.x,c=o.y,u=o.z,_=e.elements;o.x=Math.abs(s*_[0])+Math.abs(c*_[4])+Math.abs(u*_[8]),o.y=Math.abs(s*_[1])+Math.abs(c*_[5])+Math.abs(u*_[9]),o.z=Math.abs(s*_[2])+Math.abs(c*_[6])+Math.abs(u*_[10]),w.subtract(i,o,r.min),w.add(i,o,r.max)},n.merge=function(t,e,r){return w.min(t.min,e.min,r.min),w.max(t.max,e.max,r.max),r};function n(a,t){a===void 0&&(a=null),t===void 0&&(t=null),this.min=new w,this.max=new w,a&&this.min.copyFrom(a),t&&this.max.copyFrom(t)}var l=n.prototype;return l.getCenter=function(t){return w.add(this.min,this.max,t),w.scale(t,.5,t),t},l.getExtent=function(t){return w.subtract(this.max,this.min,t),w.scale(t,.5,t),t},l.getCorners=function(t){t===void 0&&(t=[]);var e=this.min,r=this.max,i=e.x,o=e.y,s=e.z,c=r.x,u=r.y,_=r.z,h=t.length;if(h<8)for(var d=0,f=8-h;d<f;++d)t[h+d]=new w;return t[0].set(i,u,_),t[1].set(c,u,_),t[2].set(c,o,_),t[3].set(i,o,_),t[4].set(i,u,s),t[5].set(c,u,s),t[6].set(c,o,s),t[7].set(i,o,s),t},l.transform=function(t){return n.transform(this,t,this),this},l.clone=function(){return new n(this.min,this.max)},l.copyFrom=function(t){return this.min.copyFrom(t.min),this.max.copyFrom(t.max),this},n}();Tt._tempVec30=new w;Tt._tempVec31=new w;var tt=function(){function n(){}return n.intersectionPointThreePlanes=function(a,t,e,r){var i=a.normal,o=t.normal,s=e.normal;w.cross(o,s,n._tempVec30),w.cross(s,i,n._tempVec31),w.cross(i,o,n._tempVec32);var c=-w.dot(i,n._tempVec30),u=-w.dot(o,n._tempVec31),_=-w.dot(s,n._tempVec32);w.scale(n._tempVec30,a.distance/c,n._tempVec30),w.scale(n._tempVec31,t.distance/u,n._tempVec31),w.scale(n._tempVec32,e.distance/_,n._tempVec32),w.add(n._tempVec30,n._tempVec31,r),w.add(r,n._tempVec32,r)},n.distancePlaneAndPoint=function(a,t){return w.dot(a.normal,t)+a.distance},n.intersectsPlaneAndPoint=function(a,t){var e=n.distancePlaneAndPoint(a,t);return e>0?_t.Front:e<0?_t.Back:_t.Intersecting},n.intersectsPlaneAndBox=function(a,t){var e=t.min,r=t.max,i=a.normal,o=n._tempVec30,s=n._tempVec31;return i.x>=0?(o.x=r.x,s.x=e.x):(o.x=e.x,s.x=r.x),i.y>=0?(o.y=r.y,s.y=e.y):(o.y=e.y,s.y=r.y),i.z>=0?(o.z=r.z,s.z=e.z):(o.z=e.z,s.z=r.z),n.distancePlaneAndPoint(a,o)<0?_t.Back:n.distancePlaneAndPoint(a,s)>0?_t.Front:_t.Intersecting},n.intersectsPlaneAndSphere=function(a,t){var e=t.center,r=t.radius,i=n.distancePlaneAndPoint(a,e);return i>r?_t.Front:i<-r?_t.Back:_t.Intersecting},n.intersectsRayAndPlane=function(a,t){var e=t.normal,r=G.zeroTolerance,i=w.dot(e,a.direction);if(Math.abs(i)<r)return-1;var o=w.dot(e,a.origin),s=(-t.distance-o)/i;if(s<0){if(s<-r)return-1;s=0}return s},n.intersectsRayAndBox=function(a,t){var e=G.zeroTolerance,r=a.origin,i=a.direction,o=t.min,s=t.max,c=i.x,u=i.y,_=i.z,h=r.x,d=r.y,f=r.z,p=0,v=Number.MAX_VALUE;if(Math.abs(c)<e){if(h<o.x||h>s.x)return-1}else{var m=1/c,g=(o.x-h)*m,y=(s.x-h)*m;if(g>y){var x=g;g=y,y=x}if(p=Math.max(g,p),v=Math.min(y,v),p>v)return-1}if(Math.abs(u)<e){if(d<o.y||d>s.y)return-1}else{var b=1/u,S=(o.y-d)*b,P=(s.y-d)*b;if(S>P){var T=S;S=P,P=T}if(p=Math.max(S,p),v=Math.min(P,v),p>v)return-1}if(Math.abs(_)<e){if(f<o.z||f>s.z)return-1}else{var E=1/_,M=(o.z-f)*E,V=(s.z-f)*E;if(M>V){var A=M;M=V,V=A}if(p=Math.max(M,p),v=Math.min(V,v),p>v)return-1}return p},n.intersectsRayAndSphere=function(a,t){var e=a.origin,r=a.direction,i=t.center,o=t.radius,s=n._tempVec30;w.subtract(e,i,s);var c=w.dot(s,r),u=w.dot(s,s)-o*o;if(c>0&&u>0)return-1;var _=c*c-u;if(_<0)return-1;var h=-c-Math.sqrt(_);return h<0&&(h=0),h},n.intersectsBoxAndBox=function(a,t){return a.min.x>t.max.x||t.min.x>a.max.x||a.min.y>t.max.y||t.min.y>a.max.y?!1:!(a.min.z>t.max.z||t.min.z>a.max.z)},n.intersectsSphereAndSphere=function(a,t){var e=a.radius+t.radius;return w.distanceSquared(a.center,t.center)<e*e},n.intersectsSphereAndBox=function(a,t){var e=a.center,r=t.max,i=t.min,o=n._tempVec30;o.set(Math.max(i.x,Math.min(e.x,r.x)),Math.max(i.y,Math.min(e.y,r.y)),Math.max(i.z,Math.min(e.z,r.z)));var s=w.distanceSquared(e,o);return s<=a.radius*a.radius},n.intersectsFrustumAndBox=function(a,t){for(var e=t.min,r=t.max,i=n._tempVec30,o=0;o<6;++o){var s=a.getPlane(o),c=s.normal;if(i.set(c.x>=0?r.x:e.x,c.y>=0?r.y:e.y,c.z>=0?r.z:e.z),w.dot(c,i)<-s.distance)return!1}return!0},n.frustumContainsBox=function(a,t){for(var e=t.min,r=t.max,i=n._tempVec30,o=n._tempVec31,s=ur.Contains,c=0;c<6;++c){var u=a.getPlane(c),_=u.normal;if(_.x>=0?(i.x=r.x,o.x=e.x):(i.x=e.x,o.x=r.x),_.y>=0?(i.y=r.y,o.y=e.y):(i.y=e.y,o.y=r.y),_.z>=0?(i.z=r.z,o.z=e.z):(i.z=e.z,o.z=r.z),n.intersectsPlaneAndPoint(u,i)===_t.Back)return ur.Disjoint;n.intersectsPlaneAndPoint(u,o)===_t.Back&&(s=ur.Intersects)}return s},n.frustumContainsSphere=function(a,t){for(var e=ur.Contains,r=0;r<6;++r){var i=a.getPlane(r),o=n.intersectsPlaneAndSphere(i,t);if(o===_t.Back)return ur.Disjoint;if(o===_t.Intersecting){e=ur.Intersects;break}}return e},n}();tt._tempVec30=new w;tt._tempVec31=new w;tt._tempVec32=new w;var We=function(){n.normalize=function(t,e){var r=t.normal,i=1/r.length();w.scale(r,i,e.normal),e.distance=t.distance*i},n.fromPoints=function(t,e,r,i){var o=t.x,s=t.y,c=t.z,u=e.x-o,_=e.y-s,h=e.z-c,d=r.x-o,f=r.y-s,p=r.z-c,v=_*p-h*f,m=h*d-u*p,g=u*f-_*d,y=1/Math.sqrt(v*v+m*m+g*g),x=v*y,b=m*y,S=g*y,P=i.normal;P.x=x,P.y=b,P.z=S,i.distance=-(x*o+b*s+S*c)};function n(a,t){a===void 0&&(a=null),t===void 0&&(t=0),this.normal=new w,this.distance=0,a&&this.normal.copyFrom(a),this.distance=t}var l=n.prototype;return l.normalize=function(){return n.normalize(this,this),this},l.clone=function(){var t=new n;return t.copyFrom(this),t},l.copyFrom=function(t){return this.normal.copyFrom(t.normal),this.distance=t.distance,this},n}(),Hu=function(){function n(a){a===void 0&&(a=null),this.near=void 0,this.far=void 0,this.left=void 0,this.right=void 0,this.bottom=void 0,this.top=void 0,this.near=new We,this.far=new We,this.left=new We,this.right=new We,this.top=new We,this.bottom=new We,a&&this.calculateFromMatrix(a)}var l=n.prototype;return l.getPlane=function(t){switch(t){case le.Near:return this.near;case le.Far:return this.far;case le.Left:return this.left;case le.Right:return this.right;case le.Bottom:return this.bottom;case le.Top:return this.top;default:return null}},l.calculateFromMatrix=function(t){var e=t.elements,r=e[0],i=e[1],o=e[2],s=e[3],c=e[4],u=e[5],_=e[6],h=e[7],d=e[8],f=e[9],p=e[10],v=e[11],m=e[12],g=e[13],y=e[14],x=e[15],b=this.near.normal;b.set(s+o,h+_,v+p),this.near.distance=x+y,this.near.normalize();var S=this.far.normal;S.set(s-o,h-_,v-p),this.far.distance=x-y,this.far.normalize();var P=this.left.normal;P.set(s+r,h+c,v+d),this.left.distance=x+m,this.left.normalize();var T=this.right.normal;T.set(s-r,h-c,v-d),this.right.distance=x-m,this.right.normalize();var E=this.bottom.normal;E.set(s+i,h+u,v+f),this.bottom.distance=x+g,this.bottom.normalize();var M=this.top.normal;M.set(s-i,h-u,v-f),this.top.distance=x-g,this.top.normalize()},l.intersectsBox=function(t){return tt.intersectsFrustumAndBox(this,t)},l.intersectsSphere=function(t){return tt.frustumContainsSphere(this,t)!==ur.Disjoint},l.clone=function(){var t=new n;return t.copyFrom(this),t},l.copyFrom=function(t){return this.near.copyFrom(t.near),this.far.copyFrom(t.far),this.left.copyFrom(t.left),this.right.copyFrom(t.right),this.bottom.copyFrom(t.bottom),this.top.copyFrom(t.top),this},n}(),fn=function(){n.add=function(t,e,r){var i=t.elements,o=e.elements,s=r.elements;s[0]=i[0]+o[0],s[1]=i[1]+o[1],s[2]=i[2]+o[2],s[3]=i[3]+o[3],s[4]=i[4]+o[4],s[5]=i[5]+o[5],s[6]=i[6]+o[6],s[7]=i[7]+o[7],s[8]=i[8]+o[8]},n.subtract=function(t,e,r){var i=t.elements,o=e.elements,s=r.elements;s[0]=i[0]-o[0],s[1]=i[1]-o[1],s[2]=i[2]-o[2],s[3]=i[3]-o[3],s[4]=i[4]-o[4],s[5]=i[5]-o[5],s[6]=i[6]-o[6],s[7]=i[7]-o[7],s[8]=i[8]-o[8]},n.multiply=function(t,e,r){var i=t.elements,o=e.elements,s=r.elements,c=i[0],u=i[1],_=i[2],h=i[3],d=i[4],f=i[5],p=i[6],v=i[7],m=i[8],g=o[0],y=o[1],x=o[2],b=o[3],S=o[4],P=o[5],T=o[6],E=o[7],M=o[8];s[0]=c*g+h*y+p*x,s[1]=u*g+d*y+v*x,s[2]=_*g+f*y+m*x,s[3]=c*b+h*S+p*P,s[4]=u*b+d*S+v*P,s[5]=_*b+f*S+m*P,s[6]=c*T+h*E+p*M,s[7]=u*T+d*E+v*M,s[8]=_*T+f*E+m*M},n.equals=function(t,e){var r=t.elements,i=e.elements;return G.equals(r[0],i[0])&&G.equals(r[1],i[1])&&G.equals(r[2],i[2])&&G.equals(r[3],i[3])&&G.equals(r[4],i[4])&&G.equals(r[5],i[5])&&G.equals(r[6],i[6])&&G.equals(r[7],i[7])&&G.equals(r[8],i[8])},n.lerp=function(t,e,r,i){var o=t.elements,s=e.elements,c=i.elements,u=1-r;c[0]=o[0]*u+s[0]*r,c[1]=o[1]*u+s[1]*r,c[2]=o[2]*u+s[2]*r,c[3]=o[3]*u+s[3]*r,c[4]=o[4]*u+s[4]*r,c[5]=o[5]*u+s[5]*r,c[6]=o[6]*u+s[6]*r,c[7]=o[7]*u+s[7]*r,c[8]=o[8]*u+s[8]*r},n.rotationQuaternion=function(t,e){var r=e.elements,i=t._x,o=t._y,s=t._z,c=t._w,u=i+i,_=o+o,h=s+s,d=i*u,f=o*u,p=o*_,v=s*u,m=s*_,g=s*h,y=c*u,x=c*_,b=c*h;r[0]=1-p-g,r[3]=f-b,r[6]=v+x,r[1]=f+b,r[4]=1-d-g,r[7]=m-y,r[2]=v-x,r[5]=m+y,r[8]=1-d-p},n.scaling=function(t,e){var r=e.elements;r[0]=t._x,r[1]=0,r[2]=0,r[3]=0,r[4]=t._y,r[5]=0,r[6]=0,r[7]=0,r[8]=1},n.translation=function(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=t._x,r[7]=t._y,r[8]=1},n.invert=function(t,e){var r=t.elements,i=e.elements,o=r[0],s=r[1],c=r[2],u=r[3],_=r[4],h=r[5],d=r[6],f=r[7],p=r[8],v=p*_-h*f,m=-p*u+h*d,g=f*u-_*d,y=o*v+s*m+c*g;!y||(y=1/y,i[0]=v*y,i[1]=(-p*s+c*f)*y,i[2]=(h*s-c*_)*y,i[3]=m*y,i[4]=(p*o-c*d)*y,i[5]=(-h*o+c*u)*y,i[6]=g*y,i[7]=(-f*o+s*d)*y,i[8]=(_*o-s*u)*y)},n.normalMatrix=function(t,e){var r=t.elements,i=e.elements,o=r[0],s=r[1],c=r[2],u=r[3],_=r[4],h=r[5],d=r[6],f=r[7],p=r[8],v=r[9],m=r[10],g=r[11],y=r[12],x=r[13],b=r[14],S=r[15],P=o*h-s*_,T=o*d-c*_,E=o*f-u*_,M=s*d-c*h,V=s*f-u*h,A=c*f-u*d,C=p*x-v*y,R=p*b-m*y,z=p*S-g*y,F=v*b-m*x,D=v*S-g*x,I=m*S-g*b,B=P*I-T*D+E*F+M*z-V*R+A*C;if(!B)return null;B=1/B,i[0]=(h*I-d*D+f*F)*B,i[1]=(d*z-_*I-f*R)*B,i[2]=(_*D-h*z+f*C)*B,i[3]=(c*D-s*I-u*F)*B,i[4]=(o*I-c*z+u*R)*B,i[5]=(s*z-o*D-u*C)*B,i[6]=(x*A-b*V+S*M)*B,i[7]=(b*E-y*A-S*T)*B,i[8]=(y*V-x*E+S*P)*B},n.rotate=function(t,e,r){var i=t.elements,o=r.elements,s=Math.sin(e),c=Math.cos(e),u=i[0],_=i[1],h=i[2],d=i[3],f=i[4],p=i[5],v=i[6],m=i[7],g=i[8];o[0]=c*u+s*d,o[1]=c*_+s*f,o[2]=c*h+s*p,o[3]=c*d-s*u,o[4]=c*f-s*_,o[5]=c*p-s*h,o[6]=v,o[7]=m,o[8]=g},n.scale=function(t,e,r){var i=e._x,o=e._y,s=t.elements,c=r.elements;c[0]=i*s[0],c[1]=i*s[1],c[2]=i*s[2],c[3]=o*s[3],c[4]=o*s[4],c[5]=o*s[5],c[6]=s[6],c[7]=s[7],c[8]=s[8]},n.translate=function(t,e,r){var i=e._x,o=e._y,s=t.elements,c=r.elements,u=s[0],_=s[1],h=s[2],d=s[3],f=s[4],p=s[5],v=s[6],m=s[7],g=s[8];c[0]=u,c[1]=_,c[2]=h,c[3]=d,c[4]=f,c[5]=p,c[6]=i*u+o*d+v,c[7]=i*_+o*f+m,c[8]=i*h+o*p+g},n.transpose=function(t,e){var r=t.elements,i=e.elements;if(e===t){var o=r[1],s=r[2],c=r[5];i[1]=r[3],i[2]=r[6],i[3]=o,i[5]=r[7],i[6]=s,i[7]=c}else i[0]=r[0],i[1]=r[3],i[2]=r[6],i[3]=r[1],i[4]=r[4],i[5]=r[7],i[6]=r[2],i[7]=r[5],i[8]=r[8]};function n(a,t,e,r,i,o,s,c,u){a===void 0&&(a=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),i===void 0&&(i=1),o===void 0&&(o=0),s===void 0&&(s=0),c===void 0&&(c=0),u===void 0&&(u=1),this.elements=new Float32Array(9);var _=this.elements;_[0]=a,_[1]=t,_[2]=e,_[3]=r,_[4]=i,_[5]=o,_[6]=s,_[7]=c,_[8]=u}var l=n.prototype;return l.set=function(t,e,r,i,o,s,c,u,_){var h=this.elements;return h[0]=t,h[1]=e,h[2]=r,h[3]=i,h[4]=o,h[5]=s,h[6]=c,h[7]=u,h[8]=_,this},l.add=function(t){return n.add(this,t,this),this},l.subtract=function(t){return n.subtract(this,t,this),this},l.multiply=function(t){return n.multiply(this,t,this),this},l.determinant=function(){var t=this.elements,e=t[0],r=t[1],i=t[2],o=t[3],s=t[4],c=t[5],u=t[6],_=t[7],h=t[8],d=h*s-c*_,f=-h*o+c*u,p=_*o-s*u;return e*d+r*f+i*p},l.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},l.invert=function(){return n.invert(this,this),this},l.rotate=function(t){return n.rotate(this,t,this),this},l.scale=function(t){return n.scale(this,t,this),this},l.translate=function(t){return n.translate(this,t,this),this},l.transpose=function(){return n.transpose(this,this),this},l.clone=function(){var t=this.elements,e=new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]);return e},l.copyFrom=function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this},l.copyFromArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,i=0;i<12;i++)r[i]=t[i+e];return this},l.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8]},l.copyFromMatrix=function(t){var e=t.elements,r=this.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],this},n}(),xe=function(){n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._w=t._w+e._w,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=t._w,u=e._x,_=e._y,h=e._z,d=e._w;r._x=i*d+c*u+o*h-s*_,r._y=o*d+c*_+s*u-i*h,r._z=s*d+c*h+i*_-o*u,r._w=c*d-i*u-o*_-s*h,r._onValueChanged&&r._onValueChanged()},n.conjugate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._w=t._w,e._onValueChanged&&e._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w},n.equals=function(t,e){return G.equals(t._x,e._x)&&G.equals(t._y,e._y)&&G.equals(t._z,e._z)&&G.equals(t._w,e._w)},n.rotationAxisAngle=function(t,e,r){var i=n._tempVector3;w.normalize(t,i),e*=.5;var o=Math.sin(e);r._x=i._x*o,r._y=i._y*o,r._z=i._z*o,r._w=Math.cos(e),r._onValueChanged&&r._onValueChanged()},n.rotationEuler=function(t,e,r,i){n.rotationYawPitchRoll(e,t,r,i)},n.rotationYawPitchRoll=function(t,e,r,i){var o=r*.5,s=e*.5,c=t*.5,u=Math.sin(o),_=Math.cos(o),h=Math.sin(s),d=Math.cos(s),f=Math.sin(c),p=Math.cos(c),v=p*d,m=f*h;i._x=p*h*_+f*d*u,i._y=f*d*_-p*h*u,i._z=v*u-m*_,i._w=v*_+m*u,i._onValueChanged&&i._onValueChanged()},n.rotationMatrix3x3=function(t,e){var r=t.elements,i=r[0],o=r[1],s=r[2],c=r[3],u=r[4],_=r[5],h=r[6],d=r[7],f=r[8],p=i+u+f,v,m;p>0?(v=Math.sqrt(p+1),e._w=v*.5,v=.5/v,e._x=(_-d)*v,e._y=(h-s)*v,e._z=(o-c)*v):i>=u&&i>=f?(v=Math.sqrt(1+i-u-f),m=.5/v,e._x=.5*v,e._y=(o+c)*m,e._z=(s+h)*m,e._w=(_-d)*m):u>f?(v=Math.sqrt(1+u-i-f),m=.5/v,e._x=(c+o)*m,e._y=.5*v,e._z=(d+_)*m,e._w=(h-s)*m):(v=Math.sqrt(1+f-i-u),m=.5/v,e._x=(s+h)*m,e._y=(_+d)*m,e._z=.5*v,e._w=(o-c)*m),e._onValueChanged&&e._onValueChanged()},n.invert=function(t,e){var r=t._x,i=t._y,o=t._z,s=t._w,c=r*r+i*i+o*o+s*s;if(c>G.zeroTolerance){var u=1/c;e._x=-r*u,e._y=-i*u,e._z=-o*u,e._w=s*u,e._onValueChanged&&e._onValueChanged()}},n.lerp=function(t,e,r,i){var o=1-r;n.dot(t,e)>=0?(i._x=t._x*o+e._x*r,i._y=t._y*o+e._y*r,i._z=t._z*o+e._z*r,i._w=t._w*o+e._w*r):(i._x=t._x*o-e._x*r,i._y=t._y*o-e._y*r,i._z=t._z*o-e._z*r,i._w=t._w*o-e._w*r),i.normalize()},n.slerp=function(t,e,r,i){var o,s,c=n.dot(t,e);if(Math.abs(c)>1-G.zeroTolerance)s=1-r,o=r*Math.sign(c);else{var u=Math.acos(Math.abs(c)),_=1/Math.sin(u);s=Math.sin((1-r)*u)*_,o=Math.sin(r*u)*_*Math.sign(c)}i.x=s*t.x+o*e.x,i.y=s*t.y+o*e.y,i.z=s*t.z+o*e.z,i.w=s*t.w+o*e.w,i._onValueChanged&&i._onValueChanged()},n.normalize=function(t,e){var r=t._x,i=t._y,o=t._z,s=t._w,c=Math.sqrt(r*r+i*i+o*o+s*s);c>G.zeroTolerance&&(c=1/c,e._x=r*c,e._y=i*c,e._z=o*c,e._w=s*c,e._onValueChanged&&e._onValueChanged())},n.rotationX=function(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e._x=r,e._y=0,e._z=0,e._w=i,e._onValueChanged&&e._onValueChanged()},n.rotationY=function(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e._x=0,e._y=r,e._z=0,e._w=i,e._onValueChanged&&e._onValueChanged()},n.rotationZ=function(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e._x=0,e._y=0,e._z=r,e._w=i,e._onValueChanged&&e._onValueChanged()},n.rotateX=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=t._w;e*=.5;var u=Math.sin(e),_=Math.cos(e);r._x=i*_+c*u,r._y=o*_+s*u,r._z=s*_-o*u,r._w=c*_-i*u,r._onValueChanged&&r._onValueChanged()},n.rotateY=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=t._w;e*=.5;var u=Math.sin(e),_=Math.cos(e);r._x=i*_-s*u,r._y=o*_+c*u,r._z=s*_+i*u,r._w=c*_-o*u,r._onValueChanged&&r._onValueChanged()},n.rotateZ=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=t._w;e*=.5;var u=Math.sin(e),_=Math.cos(e);r._x=i*_+o*u,r._y=o*_-i*u,r._z=s*_+c*u,r._w=c*_-s*u,r._onValueChanged&&r._onValueChanged()},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._w=t._w*e,r._onValueChanged&&r._onValueChanged()};function n(a,t,e,r){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=1),this._x=void 0,this._y=void 0,this._z=void 0,this._w=void 0,this._onValueChanged=null,this._x=a,this._y=t,this._z=e,this._w=r}var l=n.prototype;return l.set=function(t,e,r,i){return this._x=t,this._y=e,this._z=r,this._w=i,this._onValueChanged&&this._onValueChanged(),this},l.conjugate=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onValueChanged&&this._onValueChanged(),this},l.getAxisAngle=function(t){var e=this._x,r=this._y,i=this._z,o=e*e+r*r+i*i;if(o<G.zeroTolerance)return t._x=1,t._y=0,t._z=0,0;var s=1/o;return t._x=this._x*s,t._y=this._y*s,t._z=this._z*s,Math.acos(this._w)*2},l.identity=function(){return this._x=0,this._y=0,this._z=0,this._w=1,this._onValueChanged&&this._onValueChanged(),this},l.length=function(){var t=this._x,e=this._y,r=this._z,i=this._w;return Math.sqrt(t*t+e*e+r*r+i*i)},l.lengthSquared=function(){var t=this._x,e=this._y,r=this._z,i=this._w;return t*t+e*e+r*r+i*i},l.normalize=function(){return n.normalize(this,this),this},l.toEuler=function(t){this._toYawPitchRoll(t);var e=t._x;return t._x=t._y,t._y=e,t._onValueChanged&&t._onValueChanged(),t},l.toYawPitchRoll=function(t){return this._toYawPitchRoll(t),t._onValueChanged&&t._onValueChanged(),t},l.rotateX=function(t){return n.rotateX(this,t,this),this},l.rotateY=function(t){return n.rotateY(this,t,this),this},l.rotateZ=function(t){return n.rotateZ(this,t,this),this},l.rotationAxisAngle=function(t,e){return n.rotationAxisAngle(t,e,this),this},l.multiply=function(t){return n.multiply(this,t,this),this},l.invert=function(){return n.invert(this,this),this},l.dot=function(t){return n.dot(this,t)},l.lerp=function(t,e){return n.lerp(this,t,e,this),this},l.rotateAxisAngle=function(t,e){return n._tempQuat1.rotationAxisAngle(t,e),this.multiply(n._tempQuat1),this},l.clone=function(){return new n(this._x,this._y,this._z,this._w)},l.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onValueChanged&&this._onValueChanged(),this},l.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onValueChanged&&this._onValueChanged(),this},l.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w},l._toYawPitchRoll=function(t){var e=this._x,r=this._y,i=this._z,o=this._w,s=e*e,c=r*r,u=i*i,_=e*r,h=i*o,d=i*e,f=r*o,p=r*i,v=e*o;return t._y=Math.asin(2*(v-p)),Math.cos(t.y)>G.zeroTolerance?(t._z=Math.atan2(2*(_+h),1-2*(u+s)),t._x=Math.atan2(2*(d+f),1-2*(c+s))):(t._z=Math.atan2(-2*(_-h),1-2*(c+u)),t._x=0),t},jn(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}},{key:"normalized",get:function(){return Math.abs(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w-1)<G.zeroTolerance}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onValueChanged&&this._onValueChanged()}}]),n}();xe._tempVector3=new w;xe._tempQuat1=new xe;var te=function(){n.multiply=function(t,e,r){var i=t.elements,o=e.elements,s=r.elements,c=i[0],u=i[1],_=i[2],h=i[3],d=i[4],f=i[5],p=i[6],v=i[7],m=i[8],g=i[9],y=i[10],x=i[11],b=i[12],S=i[13],P=i[14],T=i[15],E=o[0],M=o[1],V=o[2],A=o[3],C=o[4],R=o[5],z=o[6],F=o[7],D=o[8],I=o[9],B=o[10],k=o[11],Y=o[12],K=o[13],Q=o[14],ee=o[15];s[0]=c*E+d*M+m*V+b*A,s[1]=u*E+f*M+g*V+S*A,s[2]=_*E+p*M+y*V+P*A,s[3]=h*E+v*M+x*V+T*A,s[4]=c*C+d*R+m*z+b*F,s[5]=u*C+f*R+g*z+S*F,s[6]=_*C+p*R+y*z+P*F,s[7]=h*C+v*R+x*z+T*F,s[8]=c*D+d*I+m*B+b*k,s[9]=u*D+f*I+g*B+S*k,s[10]=_*D+p*I+y*B+P*k,s[11]=h*D+v*I+x*B+T*k,s[12]=c*Y+d*K+m*Q+b*ee,s[13]=u*Y+f*K+g*Q+S*ee,s[14]=_*Y+p*K+y*Q+P*ee,s[15]=h*Y+v*K+x*Q+T*ee},n.equals=function(t,e){var r=t.elements,i=e.elements;return G.equals(r[0],i[0])&&G.equals(r[1],i[1])&&G.equals(r[2],i[2])&&G.equals(r[3],i[3])&&G.equals(r[4],i[4])&&G.equals(r[5],i[5])&&G.equals(r[6],i[6])&&G.equals(r[7],i[7])&&G.equals(r[8],i[8])&&G.equals(r[9],i[9])&&G.equals(r[10],i[10])&&G.equals(r[11],i[11])&&G.equals(r[12],i[12])&&G.equals(r[13],i[13])&&G.equals(r[14],i[14])&&G.equals(r[15],i[15])},n.lerp=function(t,e,r,i){var o=t.elements,s=e.elements,c=i.elements,u=1-r;c[0]=o[0]*u+s[0]*r,c[1]=o[1]*u+s[1]*r,c[2]=o[2]*u+s[2]*r,c[3]=o[3]*u+s[3]*r,c[4]=o[4]*u+s[4]*r,c[5]=o[5]*u+s[5]*r,c[6]=o[6]*u+s[6]*r,c[7]=o[7]*u+s[7]*r,c[8]=o[8]*u+s[8]*r,c[9]=o[9]*u+s[9]*r,c[10]=o[10]*u+s[10]*r,c[11]=o[11]*u+s[11]*r,c[12]=o[12]*u+s[12]*r,c[13]=o[13]*u+s[13]*r,c[14]=o[14]*u+s[14]*r,c[15]=o[15]*u+s[15]*r},n.rotationQuaternion=function(t,e){var r=e.elements,i=t._x,o=t._y,s=t._z,c=t._w,u=i+i,_=o+o,h=s+s,d=i*u,f=o*u,p=o*_,v=s*u,m=s*_,g=s*h,y=c*u,x=c*_,b=c*h;r[0]=1-p-g,r[1]=f+b,r[2]=v-x,r[3]=0,r[4]=f-b,r[5]=1-d-g,r[6]=m+y,r[7]=0,r[8]=v+x,r[9]=m-y,r[10]=1-d-p,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},n.rotationAxisAngle=function(t,e,r){var i=r.elements,o=t._x,s=t._y,c=t._z,u=Math.sqrt(o*o+s*s+c*c),_,h,d;Math.abs(u)<G.zeroTolerance||(u=1/u,o*=u,s*=u,c*=u,_=Math.sin(e),h=Math.cos(e),d=1-h,i[0]=o*o*d+h,i[1]=s*o*d+c*_,i[2]=c*o*d-s*_,i[3]=0,i[4]=o*s*d-c*_,i[5]=s*s*d+h,i[6]=c*s*d+o*_,i[7]=0,i[8]=o*c*d+s*_,i[9]=s*c*d-o*_,i[10]=c*c*d+h,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1)},n.rotationTranslation=function(t,e,r){n.rotationQuaternion(t,r);var i=r.elements;i[12]=e._x,i[13]=e._y,i[14]=e._z},n.affineTransformation=function(t,e,r,i){var o=i.elements,s=e._x,c=e._y,u=e._z,_=e._w,h=s+s,d=c+c,f=u+u,p=s*h,v=s*d,m=s*f,g=c*d,y=c*f,x=u*f,b=_*h,S=_*d,P=_*f,T=t._x,E=t._y,M=t._z;o[0]=(1-(g+x))*T,o[1]=(v+P)*T,o[2]=(m-S)*T,o[3]=0,o[4]=(v-P)*E,o[5]=(1-(p+x))*E,o[6]=(y+b)*E,o[7]=0,o[8]=(m+S)*M,o[9]=(y-b)*M,o[10]=(1-(p+g))*M,o[11]=0,o[12]=r._x,o[13]=r._y,o[14]=r._z,o[15]=1},n.scaling=function(t,e){var r=e.elements;r[0]=t._x,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t._y,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t._z,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},n.translation=function(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t._x,r[13]=t._y,r[14]=t._z,r[15]=1},n.invert=function(t,e){var r=t.elements,i=e.elements,o=r[0],s=r[1],c=r[2],u=r[3],_=r[4],h=r[5],d=r[6],f=r[7],p=r[8],v=r[9],m=r[10],g=r[11],y=r[12],x=r[13],b=r[14],S=r[15],P=o*h-s*_,T=o*d-c*_,E=o*f-u*_,M=s*d-c*h,V=s*f-u*h,A=c*f-u*d,C=p*x-v*y,R=p*b-m*y,z=p*S-g*y,F=v*b-m*x,D=v*S-g*x,I=m*S-g*b,B=P*I-T*D+E*F+M*z-V*R+A*C;if(!B)return null;B=1/B,i[0]=(h*I-d*D+f*F)*B,i[1]=(c*D-s*I-u*F)*B,i[2]=(x*A-b*V+S*M)*B,i[3]=(m*V-v*A-g*M)*B,i[4]=(d*z-_*I-f*R)*B,i[5]=(o*I-c*z+u*R)*B,i[6]=(b*E-y*A-S*T)*B,i[7]=(p*A-m*E+g*T)*B,i[8]=(_*D-h*z+f*C)*B,i[9]=(s*z-o*D-u*C)*B,i[10]=(y*V-x*E+S*P)*B,i[11]=(v*E-p*V-g*P)*B,i[12]=(h*R-_*F-d*C)*B,i[13]=(o*F-s*R+c*C)*B,i[14]=(x*T-y*M-b*P)*B,i[15]=(p*M-v*T+m*P)*B},n.lookAt=function(t,e,r,i){var o=i.elements,s=n._tempVec30,c=n._tempVec31,u=n._tempVec32;w.subtract(t,e,u),u.normalize(),w.cross(r,u,s),s.normalize(),w.cross(u,s,c),o[0]=s._x,o[1]=c._x,o[2]=u._x,o[3]=0,o[4]=s._y,o[5]=c._y,o[6]=u._y,o[7]=0,o[8]=s._z,o[9]=c._z,o[10]=u._z,o[11]=0,o[12]=-w.dot(s,t),o[13]=-w.dot(c,t),o[14]=-w.dot(u,t),o[15]=1},n.ortho=function(t,e,r,i,o,s,c){var u=c.elements,_=1/(t-e),h=1/(r-i),d=1/(o-s);u[0]=-2*_,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=-2*h,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=2*d,u[11]=0,u[12]=(t+e)*_,u[13]=(i+r)*h,u[14]=(s+o)*d,u[15]=1},n.perspective=function(t,e,r,i,o){var s=o.elements,c=1/Math.tan(t/2),u=1/(r-i);s[0]=c/e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=c,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=(i+r)*u,s[11]=-1,s[12]=0,s[13]=0,s[14]=2*i*r*u,s[15]=0},n.rotateAxisAngle=function(t,e,r,i){var o=e._x,s=e._y,c=e._z,u=Math.sqrt(o*o+s*s+c*c);if(!(Math.abs(u)<G.zeroTolerance)){var _=t.elements,h=i.elements,d,f,p;u=1/u,o*=u,s*=u,c*=u,d=Math.sin(r),f=Math.cos(r),p=1-f;var v=_[0],m=_[1],g=_[2],y=_[3],x=_[4],b=_[5],S=_[6],P=_[7],T=_[8],E=_[9],M=_[10],V=_[11],A=o*o*p+f,C=s*o*p+c*d,R=c*o*p-s*d,z=o*s*p-c*d,F=s*s*p+f,D=c*s*p+o*d,I=o*c*p+s*d,B=s*c*p-o*d,k=c*c*p+f;h[0]=v*A+x*C+T*R,h[1]=m*A+b*C+E*R,h[2]=g*A+S*C+M*R,h[3]=y*A+P*C+V*R,h[4]=v*z+x*F+T*D,h[5]=m*z+b*F+E*D,h[6]=g*z+S*F+M*D,h[7]=y*z+P*F+V*D,h[8]=v*I+x*B+T*k,h[9]=m*I+b*B+E*k,h[10]=g*I+S*B+M*k,h[11]=y*I+P*B+V*k,t!==i&&(h[12]=_[12],h[13]=_[13],h[14]=_[14],h[15]=_[15])}},n.scale=function(t,e,r){var i=t.elements,o=r.elements,s=e._x,c=e._y,u=e._z;o[0]=i[0]*s,o[1]=i[1]*s,o[2]=i[2]*s,o[3]=i[3]*s,o[4]=i[4]*c,o[5]=i[5]*c,o[6]=i[6]*c,o[7]=i[7]*c,o[8]=i[8]*u,o[9]=i[9]*u,o[10]=i[10]*u,o[11]=i[11]*u,o[12]=i[12],o[13]=i[13],o[14]=i[14],o[15]=i[15]},n.translate=function(t,e,r){var i=t.elements,o=r.elements,s=e._x,c=e._y,u=e._z;if(t===r)o[12]=i[0]*s+i[4]*c+i[8]*u+i[12],o[13]=i[1]*s+i[5]*c+i[9]*u+i[13],o[14]=i[2]*s+i[6]*c+i[10]*u+i[14],o[15]=i[3]*s+i[7]*c+i[11]*u+i[15];else{var _=i[0],h=i[1],d=i[2],f=i[3],p=i[4],v=i[5],m=i[6],g=i[7],y=i[8],x=i[9],b=i[10],S=i[11];o[0]=_,o[1]=h,o[2]=d,o[3]=f,o[4]=p,o[5]=v,o[6]=m,o[7]=g,o[8]=y,o[9]=x,o[10]=b,o[11]=S,o[12]=_*s+p*c+y*u+i[12],o[13]=h*s+v*c+x*u+i[13],o[14]=d*s+m*c+b*u+i[14],o[15]=f*s+g*c+S*u+i[15]}},n.transpose=function(t,e){var r=t.elements,i=e.elements;if(e===t){var o=r[1],s=r[2],c=r[3],u=r[6],_=r[7],h=r[11];i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=o,i[6]=r[9],i[7]=r[13],i[8]=s,i[9]=u,i[11]=r[14],i[12]=c,i[13]=_,i[14]=h}else i[0]=r[0],i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=r[1],i[5]=r[5],i[6]=r[9],i[7]=r[13],i[8]=r[2],i[9]=r[6],i[10]=r[10],i[11]=r[14],i[12]=r[3],i[13]=r[7],i[14]=r[11],i[15]=r[15]};function n(a,t,e,r,i,o,s,c,u,_,h,d,f,p,v,m){a===void 0&&(a=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),i===void 0&&(i=0),o===void 0&&(o=1),s===void 0&&(s=0),c===void 0&&(c=0),u===void 0&&(u=0),_===void 0&&(_=0),h===void 0&&(h=1),d===void 0&&(d=0),f===void 0&&(f=0),p===void 0&&(p=0),v===void 0&&(v=0),m===void 0&&(m=1),this.elements=new Float32Array(16);var g=this.elements;g[0]=a,g[1]=t,g[2]=e,g[3]=r,g[4]=i,g[5]=o,g[6]=s,g[7]=c,g[8]=u,g[9]=_,g[10]=h,g[11]=d,g[12]=f,g[13]=p,g[14]=v,g[15]=m}var l=n.prototype;return l.set=function(t,e,r,i,o,s,c,u,_,h,d,f,p,v,m,g){var y=this.elements;return y[0]=t,y[1]=e,y[2]=r,y[3]=i,y[4]=o,y[5]=s,y[6]=c,y[7]=u,y[8]=_,y[9]=h,y[10]=d,y[11]=f,y[12]=p,y[13]=v,y[14]=m,y[15]=g,this},l.multiply=function(t){return n.multiply(this,t,this),this},l.determinant=function(){var t=this.elements,e=t[0],r=t[1],i=t[2],o=t[3],s=t[4],c=t[5],u=t[6],_=t[7],h=t[8],d=t[9],f=t[10],p=t[11],v=t[12],m=t[13],g=t[14],y=t[15],x=e*c-r*s,b=e*u-i*s,S=e*_-o*s,P=r*u-i*c,T=r*_-o*c,E=i*_-o*u,M=h*m-d*v,V=h*g-f*v,A=h*y-p*v,C=d*g-f*m,R=d*y-p*m,z=f*y-p*g;return x*z-b*R+S*C+P*A-T*V+E*M},l.decompose=function(t,e,r){var i=n._tempMat30,o=this.elements,s=i.elements,c=o[0],u=o[1],_=o[2],h=o[3],d=o[4],f=o[5],p=o[6],v=o[7],m=o[8],g=o[9],y=o[10],x=o[11];t.set(o[12],o[13],o[14]);var b=Math.sign(c*u*_*h)<0?-1:1,S=Math.sign(d*f*p*v)<0?-1:1,P=Math.sign(m*g*y*x)<0?-1:1,T=b*Math.sqrt(c*c+u*u+_*_),E=S*Math.sqrt(d*d+f*f+p*p),M=P*Math.sqrt(m*m+g*g+y*y);if(r.set(T,E,M),Math.abs(T)<G.zeroTolerance||Math.abs(E)<G.zeroTolerance||Math.abs(M)<G.zeroTolerance)return e.identity(),!1;var V=1/T,A=1/E,C=1/M;return s[0]=c*V,s[1]=u*V,s[2]=_*V,s[3]=d*A,s[4]=f*A,s[5]=p*A,s[6]=m*C,s[7]=g*C,s[8]=y*C,xe.rotationMatrix3x3(i,e),!0},l.getRotation=function(t){var e=this.elements,r=e[0]+e[5]+e[10];if(r>G.zeroTolerance){var i=Math.sqrt(r+1)*2;t._w=.25*i,t._x=(e[6]-e[9])/i,t._y=(e[8]-e[2])/i,t._z=(e[1]-e[4])/i}else if(e[0]>e[5]&&e[0]>e[10]){var o=Math.sqrt(1+e[0]-e[5]-e[10])*2;t._w=(e[6]-e[9])/o,t._x=.25*o,t._y=(e[1]+e[4])/o,t._z=(e[8]+e[2])/o}else if(e[5]>e[10]){var s=Math.sqrt(1+e[5]-e[0]-e[10])*2;t._w=(e[8]-e[2])/s,t._x=(e[1]+e[4])/s,t._y=.25*s,t._z=(e[6]+e[9])/s}else{var c=Math.sqrt(1+e[10]-e[0]-e[5])*2;t._w=(e[1]-e[4])/c,t._x=(e[8]+e[2])/c,t._y=(e[6]+e[9])/c,t._z=.25*c}return t._onValueChanged&&t._onValueChanged(),t},l.getScaling=function(t){var e=this.elements,r=e[0],i=e[1],o=e[2],s=e[4],c=e[5],u=e[6],_=e[8],h=e[9],d=e[10];return t.set(Math.sqrt(r*r+i*i+o*o),Math.sqrt(s*s+c*c+u*u),Math.sqrt(_*_+h*h+d*d)),t},l.getTranslation=function(t){var e=this.elements;return t.set(e[12],e[13],e[14]),t},l.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},l.invert=function(){return n.invert(this,this),this},l.rotateAxisAngle=function(t,e){return n.rotateAxisAngle(this,t,e,this),this},l.scale=function(t){return n.scale(this,t,this),this},l.translate=function(t){return n.translate(this,t,this),this},l.transpose=function(){return n.transpose(this,this),this},l.clone=function(){var t=this.elements,e=new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]);return e},l.copyFrom=function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this},l.copyFromArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,i=0;i<16;i++)r[i]=t[i+e];return this},l.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15]},n}();te._tempVec30=new w;te._tempVec31=new w;te._tempVec32=new w;te._tempMat30=new fn;te._identity=new te(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var Wu=function(){function n(a,t){a===void 0&&(a=null),t===void 0&&(t=null),this.origin=new w,this.direction=new w,a&&this.origin.copyFrom(a),t&&this.direction.copyFrom(t)}var l=n.prototype;return l.intersectPlane=function(t){return tt.intersectsRayAndPlane(this,t)},l.intersectSphere=function(t){return tt.intersectsRayAndSphere(this,t)},l.intersectBox=function(t){return tt.intersectsRayAndBox(this,t)},l.getPoint=function(t,e){return w.scale(this.direction,t,e),e.add(this.origin)},n}(),X=function(){n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y},n.distance=function(t,e){var r=e._x-t._x,i=e._y-t._y;return Math.sqrt(r*r+i*i)},n.distanceSquared=function(t,e){var r=e._x-t._x,i=e._y-t._y;return r*r+i*i},n.equals=function(t,e){return G.equals(t._x,e._x)&&G.equals(t._y,e._y)},n.lerp=function(t,e,r,i){var o=t._x,s=t._y;i._x=o+(e._x-o)*r,i._y=s+(e._y-s)*r,i._onValueChanged&&i._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,i=t._y,o=Math.sqrt(r*r+i*i);o>G.zeroTolerance&&(o=1/o,e._x=r*o,e._y=i*o,e._onValueChanged&&e._onValueChanged())},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._onValueChanged&&r._onValueChanged()};function n(a,t){a===void 0&&(a=0),t===void 0&&(t=0),this._x=void 0,this._y=void 0,this._onValueChanged=null,this._x=a,this._y=t}var l=n.prototype;return l.set=function(t,e){return this._x=t,this._y=e,this._onValueChanged&&this._onValueChanged(),this},l.add=function(t){return this._x+=t._x,this._y+=t._y,this._onValueChanged&&this._onValueChanged(),this},l.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._onValueChanged&&this._onValueChanged(),this},l.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._onValueChanged&&this._onValueChanged(),this},l.divide=function(t){return this._x/=t._x,this._y/=t._y,this._onValueChanged&&this._onValueChanged(),this},l.length=function(){var t=this._x,e=this._y;return Math.sqrt(t*t+e*e)},l.lengthSquared=function(){var t=this._x,e=this._y;return t*t+e*e},l.negate=function(){return this._x=-this._x,this._y=-this._y,this._onValueChanged&&this._onValueChanged(),this},l.normalize=function(){return n.normalize(this,this),this},l.scale=function(t){return this._x*=t,this._y*=t,this._onValueChanged&&this._onValueChanged(),this},l.clone=function(){return new n(this._x,this._y)},l.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._onValueChanged&&this._onValueChanged(),this},l.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._onValueChanged&&this._onValueChanged(),this},l.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y},jn(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}}]),n}();X._zero=new X(0,0);X._one=new X(1,1);var ve=function(){n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._w=t._w+e._w,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._z=t._z-e._z,r._w=t._w-e._w,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._z=t._z*e._z,r._w=t._w*e._w,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._z=t._z/e._z,r._w=t._w/e._w,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w},n.distance=function(t,e){var r=e._x-t._x,i=e._y-t._y,o=e._z-t._z,s=e._w-t._w;return Math.sqrt(r*r+i*i+o*o+s*s)},n.distanceSquared=function(t,e){var r=e._x-t._x,i=e._y-t._y,o=e._z-t._z,s=e._w-t._w;return r*r+i*i+o*o+s*s},n.equals=function(t,e){return G.equals(t._x,e._x)&&G.equals(t._y,e._y)&&G.equals(t._z,e._z)&&G.equals(t._w,e._w)},n.lerp=function(t,e,r,i){var o=t._x,s=t._y,c=t._z,u=t._w;i._x=o+(e._x-o)*r,i._y=s+(e._y-s)*r,i._z=c+(e._z-c)*r,i._w=u+(e._w-u)*r,i._onValueChanged&&i._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._z=Math.max(t._z,e._z),r._w=Math.max(t._w,e._w),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._z=Math.min(t._z,e._z),r._w=Math.min(t._w,e._w),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._w=-t._w,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,i=t._y,o=t._z,s=t._w,c=Math.sqrt(r*r+i*i+o*o+s*s);c>G.zeroTolerance&&(c=1/c,e._x=r*c,e._y=i*c,e._z=o*c,e._w=s*c,e._onValueChanged&&e._onValueChanged())},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._w=t._w*e,r._onValueChanged&&r._onValueChanged()},n.transform=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=t._w,u=e.elements;r._x=i*u[0]+o*u[4]+s*u[8]+c*u[12],r._y=i*u[1]+o*u[5]+s*u[9]+c*u[13],r._z=i*u[2]+o*u[6]+s*u[10]+c*u[14],r._w=i*u[3]+o*u[7]+s*u[11]+c*u[15],r._onValueChanged&&r._onValueChanged()},n.transformByQuat=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=t._w,u=e._x,_=e._y,h=e._z,d=e._w,f=d*i+_*s-h*o,p=d*o+h*i-u*s,v=d*s+u*o-_*i,m=-u*i-_*o-h*s;r._x=f*d-m*u-p*h+v*_,r._y=p*d-m*_-v*u+f*h,r._z=v*d-m*h-f*_+p*u,r._w=c,r._onValueChanged&&r._onValueChanged()};function n(a,t,e,r){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this._x=void 0,this._y=void 0,this._z=void 0,this._w=void 0,this._onValueChanged=null,this._x=a,this._y=t,this._z=e,this._w=r}var l=n.prototype;return l.set=function(t,e,r,i){return this._x=t,this._y=e,this._z=r,this._w=i,this._onValueChanged&&this._onValueChanged(),this},l.add=function(t){return this._x+=t._x,this._y+=t._y,this._z+=t._z,this._w+=t._w,this._onValueChanged&&this._onValueChanged(),this},l.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._z-=t._z,this._w-=t._w,this._onValueChanged&&this._onValueChanged(),this},l.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._z*=t._z,this._w*=t._w,this._onValueChanged&&this._onValueChanged(),this},l.divide=function(t){return this._x/=t._x,this._y/=t._y,this._z/=t._z,this._w/=t._w,this._onValueChanged&&this._onValueChanged(),this},l.length=function(){var t=this._x,e=this._y,r=this._z,i=this._w;return Math.sqrt(t*t+e*e+r*r+i*i)},l.lengthSquared=function(){var t=this._x,e=this._y,r=this._z,i=this._w;return t*t+e*e+r*r+i*i},l.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._w=-this._w,this._onValueChanged&&this._onValueChanged(),this},l.normalize=function(){return n.normalize(this,this),this},l.scale=function(t){return this._x*=t,this._y*=t,this._z*=t,this._w*=t,this._onValueChanged&&this._onValueChanged(),this},l.clone=function(){var t=new n(this._x,this._y,this._z,this._w);return t},l.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onValueChanged&&this._onValueChanged(),this},l.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onValueChanged&&this._onValueChanged(),this},l.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w},jn(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onValueChanged&&this._onValueChanged()}}]),n}();ve._zero=new ve(0,0,0,0);ve._one=new ve(1,1,1,1);var re=function(){n.gammaToLinearSpace=function(t){return t<=0?0:t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)},n.linearToGammaSpace=function(t){return t<=0?0:t<.0031308?12.92*t:t<1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)},n.equals=function(t,e){return G.equals(t._r,e._r)&&G.equals(t._g,e._g)&&G.equals(t._b,e._b)&&G.equals(t._a,e._a)},n.add=function(t,e,r){return r._r=t._r+e._r,r._g=t._g+e._g,r._b=t._b+e._b,r._a=t._a+e._a,r._onValueChanged&&r._onValueChanged(),r},n.subtract=function(t,e,r){r._r=t._r-e._r,r._g=t._g-e._g,r._b=t._b-e._b,r._a=t._a-e._a,r._onValueChanged&&r._onValueChanged()},n.scale=function(t,e,r){return r._r=t._r*e,r._g=t._g*e,r._b=t._b*e,r._a=t._a*e,r._onValueChanged&&r._onValueChanged(),r},n.lerp=function(t,e,r,i){var o=t._r,s=t._g,c=t._b,u=t._a;return i._r=o+(e._r-o)*r,i._g=s+(e._g-s)*r,i._b=c+(e._b-c)*r,i._a=u+(e._a-u)*r,i._onValueChanged&&i._onValueChanged(),i};function n(a,t,e,r){a===void 0&&(a=1),t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),this._r=void 0,this._g=void 0,this._b=void 0,this._a=void 0,this._onValueChanged=null,this._r=a,this._g=t,this._b=e,this._a=r}var l=n.prototype;return l.set=function(t,e,r,i){return this._r=t,this._g=e,this._b=r,this._a=i,this._onValueChanged&&this._onValueChanged(),this},l.add=function(t){return this._r+=t._r,this._g+=t._g,this._b+=t._b,this._a+=t._a,this._onValueChanged&&this._onValueChanged(),this},l.scale=function(t){return this._r*=t,this._g*=t,this._b*=t,this._a*=t,this._onValueChanged&&this._onValueChanged(),this},l.clone=function(){var t=new n(this._r,this._g,this._b,this._a);return t},l.copyFrom=function(t){return this._r=t.r,this._g=t.g,this._b=t.b,this._a=t.a,this._onValueChanged&&this._onValueChanged(),this},l.toLinear=function(t){return t._r=n.gammaToLinearSpace(this._r),t._g=n.gammaToLinearSpace(this._g),t._b=n.gammaToLinearSpace(this._b),this._onValueChanged&&this._onValueChanged(),t},l.toGamma=function(t){return t._r=n.linearToGammaSpace(this._r),t._g=n.linearToGammaSpace(this._g),t._b=n.linearToGammaSpace(this._b),this._onValueChanged&&this._onValueChanged(),t},l.getBrightness=function(){var t=this.r,e=this.g,r=this.b,i=t,o=t;return e>i&&(i=e),r>i&&(i=r),e<o&&(o=e),r<o&&(o=r),(i+o)/2},jn(n,[{key:"r",get:function(){return this._r},set:function(t){this._r=t,this._onValueChanged&&this._onValueChanged()}},{key:"g",get:function(){return this._g},set:function(t){this._g=t,this._onValueChanged&&this._onValueChanged()}},{key:"b",get:function(){return this._b},set:function(t){this._b=t,this._onValueChanged&&this._onValueChanged()}},{key:"a",get:function(){return this._a},set:function(t){this._a=t,this._onValueChanged&&this._onValueChanged()}}]),n}(),ea=function(){function n(a,t,e,r){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),this.x=void 0,this.y=void 0,this.width=void 0,this.height=void 0,this.x=a,this.y=t,this.width=e,this.height=r}var l=n.prototype;return l.set=function(t,e,r,i){return this.x=t,this.y=e,this.width=r,this.height=i,this},l.clone=function(){return new n(this.x,this.y,this.width,this.height)},l.copyFrom=function(t){return this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this},n}(),Xu=function(){function n(){this.coefficients=new Float32Array(27)}var l=n.prototype;return l.addLight=function(t,e,r){e.scale(r);var i=this.coefficients,o=t._x,s=t._y,c=t._z,u=e.r,_=e.g,h=e.b,d=.282095,f=-.488603*s,p=.488603*c,v=-.488603*o,m=1.092548*(o*s),g=-1.092548*(s*c),y=.315392*(3*c*c-1),x=-1.092548*(o*c),b=.546274*(o*o-s*s);i[0]+=u*d,i[1]+=_*d,i[2]+=h*d,i[3]+=u*f,i[4]+=_*f,i[5]+=h*f,i[6]+=u*p,i[7]+=_*p,i[8]+=h*p,i[9]+=u*v,i[10]+=_*v,i[11]+=h*v,i[12]+=u*m,i[13]+=_*m,i[14]+=h*m,i[15]+=u*g,i[16]+=_*g,i[17]+=h*g,i[18]+=u*y,i[19]+=_*y,i[20]+=h*y,i[21]+=u*x,i[22]+=_*x,i[23]+=h*x,i[24]+=u*b,i[25]+=_*b,i[26]+=h*b},l.evaluate=function(t,e){var r=this.coefficients,i=t._x,o=t._y,s=t._z,c=.886227,u=-1.023327*o,_=1.023327*s,h=-1.023327*i,d=.858086*o*i,f=-.858086*o*s,p=.247708*(3*s*s-1),v=-.858086*s*i,m=.429042*(i*i-o*o),g=r[0]*c,y=r[1]*c,x=r[2]*c;return g+=r[3]*u+r[6]*_+r[9]*h,y+=r[4]*u+r[7]*_+r[10]*h,x+=r[5]*u+r[8]*_+r[11]*h,g+=r[12]*d+r[15]*f+r[18]*p+r[21]*v+r[24]*m,y+=r[13]*d+r[16]*f+r[19]*p+r[22]*v+r[25]*m,x+=r[14]*d+r[17]*f+r[20]*p+r[23]*v+r[26]*m,e.set(g,y,x,1),e},l.scale=function(t){var e=this.coefficients;e[0]*=t,e[1]*=t,e[2]*=t,e[3]*=t,e[4]*=t,e[5]*=t,e[6]*=t,e[7]*=t,e[8]*=t,e[9]*=t,e[10]*=t,e[11]*=t,e[12]*=t,e[13]*=t,e[14]*=t,e[15]*=t,e[16]*=t,e[17]*=t,e[18]*=t,e[19]*=t,e[20]*=t,e[21]*=t,e[22]*=t,e[23]*=t,e[24]*=t,e[25]*=t,e[26]*=t},l.clone=function(){var t=new n;return t.copyFrom(this),t},l.copyFrom=function(t){return t.copyToArray(this.coefficients),this},l.copyFromArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;r[0]=t[e],r[1]=t[1+e],r[2]=t[2+e],r[3]=t[3+e],r[4]=t[4+e],r[5]=t[5+e],r[6]=t[6+e],r[7]=t[7+e],r[8]=t[8+e],r[9]=t[9+e],r[10]=t[10+e],r[11]=t[11+e],r[12]=t[12+e],r[13]=t[13+e],r[14]=t[14+e],r[15]=t[15+e],r[16]=t[16+e],r[17]=t[17+e],r[18]=t[18+e],r[19]=t[19+e],r[20]=t[20+e],r[21]=t[21+e],r[22]=t[22+e],r[23]=t[23+e],r[24]=t[24+e],r[25]=t[25+e],r[26]=t[26+e]},l.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.coefficients;t[0+e]=r[0],t[1+e]=r[1],t[2+e]=r[2],t[3+e]=r[3],t[4+e]=r[4],t[5+e]=r[5],t[6+e]=r[6],t[7+e]=r[7],t[8+e]=r[8],t[9+e]=r[9],t[10+e]=r[10],t[11+e]=r[11],t[12+e]=r[12],t[13+e]=r[13],t[14+e]=r[14],t[15+e]=r[15],t[16+e]=r[16],t[17+e]=r[17],t[18+e]=r[18],t[19+e]=r[19],t[20+e]=r[20],t[21+e]=r[21],t[22+e]=r[22],t[23+e]=r[23],t[24+e]=r[24],t[25+e]=r[25],t[26+e]=r[26]},n}();function ka(n,l){var a=Object.keys(n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(n);l&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),a.push.apply(a,t)}return a}function ki(n){for(var l=1;l<arguments.length;l++){var a=arguments[l]!=null?arguments[l]:{};l%2?ka(Object(a),!0).forEach(function(t){qu(n,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):ka(Object(a)).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(a,t))})}return n}function Ga(n,l){for(var a=0;a<l.length;a++){var t=l[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function j(n,l,a){return l&&Ga(n.prototype,l),a&&Ga(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n}function qu(n,l,a){return l in n?Object.defineProperty(n,l,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[l]=a,n}function On(){return On=Object.assign?Object.assign.bind():function(n){for(var l=1;l<arguments.length;l++){var a=arguments[l];for(var t in a)Object.prototype.hasOwnProperty.call(a,t)&&(n[t]=a[t])}return n},On.apply(this,arguments)}function $(n,l){n.prototype=Object.create(l.prototype),n.prototype.constructor=n,ta(n,l)}function ta(n,l){return ta=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},ta(n,l)}function L(n){if(n===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return n}function U(n,l,a,t){!a||Object.defineProperty(n,l,{enumerable:a.enumerable,configurable:a.configurable,writable:a.writable,value:a.initializer?a.initializer.call(t):void 0})}function N(n,l,a,t,e){var r={};return Object.keys(t).forEach(function(i){r[i]=t[i]}),r.enumerable=!!r.enumerable,r.configurable=!!r.configurable,("value"in r||r.initializer)&&(r.writable=!0),r=a.slice().reverse().reduce(function(i,o){return o(n,l,i)||i},r),e&&r.initializer!==void 0&&(r.value=r.initializer?r.initializer.call(e):void 0,r.initializer=void 0),r.initializer===void 0&&(Object.defineProperty(n,l,r),r=null),r}var ne=function(){function n(){}return n.clamp=function(a,t,e){return Math.max(t,Math.min(e,a))},n.equals=function(a,t){return Math.abs(a-t)<=n.zeroTolerance},n.isPowerOf2=function(a){return(a&a-1)===0},n.radianToDegree=function(a){return a*n.radToDegreeFactor},n.degreeToRadian=function(a){return a*n.degreeToRadFactor},n}();ne.zeroTolerance=1e-6;ne.radToDegreeFactor=180/Math.PI;ne.degreeToRadFactor=Math.PI/180;var ju=function(){n.gammaToLinearSpace=function(t){return t<=0?0:t<=.04045?t/12.92:t<1?Math.pow((t+.055)/1.055,2.4):Math.pow(t,2.4)},n.linearToGammaSpace=function(t){return t<=0?0:t<.0031308?12.92*t:t<1?1.055*Math.pow(t,.41666)-.055:Math.pow(t,.41666)},n.equals=function(t,e){return ne.equals(t._r,e._r)&&ne.equals(t._g,e._g)&&ne.equals(t._b,e._b)&&ne.equals(t._a,e._a)},n.add=function(t,e,r){return r._r=t._r+e._r,r._g=t._g+e._g,r._b=t._b+e._b,r._a=t._a+e._a,r._onValueChanged&&r._onValueChanged(),r},n.subtract=function(t,e,r){r._r=t._r-e._r,r._g=t._g-e._g,r._b=t._b-e._b,r._a=t._a-e._a,r._onValueChanged&&r._onValueChanged()},n.scale=function(t,e,r){return r._r=t._r*e,r._g=t._g*e,r._b=t._b*e,r._a=t._a*e,r._onValueChanged&&r._onValueChanged(),r},n.lerp=function(t,e,r,i){var o=t._r,s=t._g,c=t._b,u=t._a;return i._r=o+(e._r-o)*r,i._g=s+(e._g-s)*r,i._b=c+(e._b-c)*r,i._a=u+(e._a-u)*r,i._onValueChanged&&i._onValueChanged(),i};function n(a,t,e,r){a===void 0&&(a=1),t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),this._r=void 0,this._g=void 0,this._b=void 0,this._a=void 0,this._onValueChanged=null,this._r=a,this._g=t,this._b=e,this._a=r}var l=n.prototype;return l.set=function(t,e,r,i){return this._r=t,this._g=e,this._b=r,this._a=i,this._onValueChanged&&this._onValueChanged(),this},l.add=function(t){return this._r+=t._r,this._g+=t._g,this._b+=t._b,this._a+=t._a,this._onValueChanged&&this._onValueChanged(),this},l.scale=function(t){return this._r*=t,this._g*=t,this._b*=t,this._a*=t,this._onValueChanged&&this._onValueChanged(),this},l.clone=function(){var t=new n(this._r,this._g,this._b,this._a);return t},l.copyFrom=function(t){return this._r=t.r,this._g=t.g,this._b=t.b,this._a=t.a,this._onValueChanged&&this._onValueChanged(),this},l.toLinear=function(t){return t._r=n.gammaToLinearSpace(this._r),t._g=n.gammaToLinearSpace(this._g),t._b=n.gammaToLinearSpace(this._b),this._onValueChanged&&this._onValueChanged(),t},l.toGamma=function(t){return t._r=n.linearToGammaSpace(this._r),t._g=n.linearToGammaSpace(this._g),t._b=n.linearToGammaSpace(this._b),this._onValueChanged&&this._onValueChanged(),t},l.getBrightness=function(){var t=this.r,e=this.g,r=this.b,i=t,o=t;return e>i&&(i=e),r>i&&(i=r),e<o&&(o=e),r<o&&(o=r),(i+o)/2},j(n,[{key:"r",get:function(){return this._r},set:function(t){this._r=t,this._onValueChanged&&this._onValueChanged()}},{key:"g",get:function(){return this._g},set:function(t){this._g=t,this._onValueChanged&&this._onValueChanged()}},{key:"b",get:function(){return this._b},set:function(t){this._b=t,this._onValueChanged&&this._onValueChanged()}},{key:"a",get:function(){return this._a},set:function(t){this._a=t,this._onValueChanged&&this._onValueChanged()}}]),n}(),vr;(function(n){n[n.Ignore=0]="Ignore",n[n.Assignment=1]="Assignment",n[n.Shallow=2]="Shallow",n[n.Deep=3]="Deep"})(vr||(vr={}));function q(n,l){Nt.registerCloneMode(n,l,vr.Ignore)}function Ce(n,l){Nt.registerCloneMode(n,l,vr.Assignment)}function au(n,l){Nt.registerCloneMode(n,l,vr.Shallow)}function ze(n,l){Nt.registerCloneMode(n,l,vr.Deep)}var Nt=function(){function n(){}return n.registerCloneMode=function(a,t,e){var r=n._subCloneModeMap.get(a.constructor);r||(r=Object.create(null),n._subCloneModeMap.set(a.constructor,r)),r[t]=e},n.getCloneMode=function(a){var t=n._cloneModeMap.get(a);if(!t){t=Object.create(null),n._cloneModeMap.set(a,t);for(var e=n._objectType,r=n._subCloneModeMap;a!==e;){var i=r.get(a);i&&On(t,i),a=Object.getPrototypeOf(a)}}return t},n.deepCloneObject=function(a,t){var e=a.constructor;switch(e){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:t.set(a);break;case Array:for(var r=0,i=a.length;r<i;r++)n._deepCloneObjectItem(a,t,r);break;default:var o=a;if(o.clone&&o.cloneTo)o.cloneTo(t);else for(var s=Object.keys(a),c=0,u=s.length;c<u;c++)n._deepCloneObjectItem(a,t,s[c])}},n._deepCloneObjectItem=function(a,t,e){var r=a[e];if(r instanceof Object){var i=r.constructor;switch(i){case Uint8Array:case Uint16Array:case Uint32Array:case Int8Array:case Int16Array:case Int32Array:case Float32Array:case Float64Array:var o=r,s=t[e];s==null?t[e]=o.slice():s.set(o);break;case Array:var c=r,u=t[e];u==null?t[e]=new Array(c.length):u.length=c.length,n.deepCloneObject(c,u);break;default:if(r.clone&&r.cloneTo){var _=r,h=t[e];h?_.cloneTo(h):t[e]=_.clone()}else{var d=t[e];d==null&&(t[e]=d=new r.constructor),n.deepCloneObject(r,d);break}}}else t[e]=r},n}();Nt._subCloneModeMap=new Map;Nt._cloneModeMap=new Map;Nt._objectType=Object.getPrototypeOf(Object);var ti,Ha,Wa,Gi,xr=(ti=(Gi=function(){function n(a){U(this,"instanceId",Ha,this),U(this,"_engine",Wa,this),this._destroyed=!1,this._engine=a}var l=n.prototype;return l.destroy=function(){var t;this._destroyed||((t=this._engine.resourceManager)===null||t===void 0||t._deleteAsset(this),this._destroyed=!0)},j(n,[{key:"engine",get:function(){return this._engine}},{key:"destroyed",get:function(){return this._destroyed}}]),n}(),Gi._instanceIdCounter=0,Gi),Ha=N(ti.prototype,"instanceId",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return++xr._instanceIdCounter}}),Wa=N(ti.prototype,"_engine",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ti),wr=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,e.isGCIgnored=!1,e._refCount=0,t.resourceManager._addRefObject(e.instanceId,L(e)),e}var a=l.prototype;return a.destroy=function(e){if(e===void 0&&(e=!1),this._destroyed)return!0;if(!e&&this._refCount!==0)return!1;var r=this._engine.resourceManager;r&&(n.prototype.destroy.call(this),r._deleteRefObject(this.instanceId));var i=this._getRefCount();return i>0&&this._addRefCount(-i),this._engine=null,this._onDestroy(),!0},a._getRefCount=function(){return this._refCount},a._addRefCount=function(e){this._refCount+=e},a._addToResourceManager=function(e){this._engine.resourceManager._addAsset(e,this)},j(l,[{key:"refCount",get:function(){return this._refCount}}]),l}(xr),$e;(function(n){n[n.Depth=0]="Depth",n[n.DepthStencil=1]="DepthStencil",n[n.Stencil=2]="Stencil",n[n.Depth16=3]="Depth16",n[n.Depth24=4]="Depth24",n[n.Depth32=5]="Depth32",n[n.Depth24Stencil8=6]="Depth24Stencil8",n[n.Depth32Stencil8=7]="Depth32Stencil8"})($e||($e={}));var wt;(function(n){n[n.PositiveX=0]="PositiveX",n[n.NegativeX=1]="NegativeX",n[n.PositiveY=2]="PositiveY",n[n.NegativeY=3]="NegativeY",n[n.PositiveZ=4]="PositiveZ",n[n.NegativeZ=5]="NegativeZ"})(wt||(wt={}));var Vt;(function(n){n[n.Never=0]="Never",n[n.Less=1]="Less",n[n.Equal=2]="Equal",n[n.LessEqual=3]="LessEqual",n[n.Greater=4]="Greater",n[n.NotEqual=5]="NotEqual",n[n.GreaterEqual=6]="GreaterEqual",n[n.Always=7]="Always"})(Vt||(Vt={}));var gt;(function(n){n[n.Point=0]="Point",n[n.Bilinear=1]="Bilinear",n[n.Trilinear=2]="Trilinear"})(gt||(gt={}));var H;(function(n){n[n.R8G8B8=0]="R8G8B8",n[n.R8G8B8A8=1]="R8G8B8A8",n[n.R4G4B4A4=2]="R4G4B4A4",n[n.R5G5B5A1=3]="R5G5B5A1",n[n.R5G6B5=4]="R5G6B5",n[n.Alpha8=5]="Alpha8",n[n.LuminanceAlpha=6]="LuminanceAlpha",n[n.R16G16B16A16=7]="R16G16B16A16",n[n.R32G32B32A32=8]="R32G32B32A32",n[n.DXT1=9]="DXT1",n[n.DXT5=10]="DXT5",n[n.ETC1_RGB=11]="ETC1_RGB",n[n.ETC2_RGB=12]="ETC2_RGB",n[n.ETC2_RGBA5=13]="ETC2_RGBA5",n[n.ETC2_RGBA8=14]="ETC2_RGBA8",n[n.PVRTC_RGB2=15]="PVRTC_RGB2",n[n.PVRTC_RGBA2=16]="PVRTC_RGBA2",n[n.PVRTC_RGB4=17]="PVRTC_RGB4",n[n.PVRTC_RGBA4=18]="PVRTC_RGBA4",n[n.ASTC_4x4=19]="ASTC_4x4",n[n.ASTC_5x5=20]="ASTC_5x5",n[n.ASTC_6x6=21]="ASTC_6x6",n[n.ASTC_8x8=22]="ASTC_8x8",n[n.ASTC_10x10=23]="ASTC_10x10",n[n.ASTC_12x12=24]="ASTC_12x12",n[n.Depth=25]="Depth",n[n.DepthStencil=26]="DepthStencil",n[n.Depth16=27]="Depth16",n[n.Depth24=28]="Depth24",n[n.Depth32=29]="Depth32",n[n.Depth24Stencil8=30]="Depth24Stencil8",n[n.Depth32Stencil8=31]="Depth32Stencil8"})(H||(H={}));var pt;(function(n){n[n.Clamp=0]="Clamp",n[n.Repeat=1]="Repeat",n[n.Mirror=2]="Mirror"})(pt||(pt={}));var ra=function(){function n(a,t,e,r){t===void 0&&(t=null),e===void 0&&(e={}),r===void 0&&(r=!0),this.data=void 0,this._timeStamp=void 0,this._target=void 0,this._currentTarget=void 0,this._bubbles=void 0,this._propagationStopped=void 0,this._type=void 0,this._timeStamp=new Date().getTime(),this._target=t,this.data=e,this._currentTarget=null,this._bubbles=r,this._propagationStopped=!1,this._type=a}var l=n.prototype;return l.stopPropagation=function(){this._propagationStopped=!0},j(n,[{key:"propagationStopped",get:function(){return this._propagationStopped}},{key:"target",get:function(){return this._target},set:function(t){this._target=t}},{key:"timeStamp",get:function(){return this._timeStamp}},{key:"currentTarget",get:function(){return this._currentTarget},set:function(t){this._currentTarget=t}},{key:"bubbles",get:function(){return this._bubbles}},{key:"type",get:function(){return this._type}}]),n}(),Hi,Xa,ou=(Hi=function(){function n(){U(this,"_evts",Xa,this),this._evtCount=0}var l=n.prototype;return l.hasEvent=function(t){return this._evts[t]!=null},l.eventNames=function(){return this._evtCount===0?[]:Object.keys(this._evts)},l.listenerCount=function(t){var e=this._evts[t];return e?e.fn?1:e.length:0},l.dispatch=function(t,e){if(!this._evts[t])return!1;var r=this._evts[t];if(r.fn)r.once&&this.removeEventListener(t,r.fn),r.fn(e);else for(var i=r.length,o=0;o<i;o++)r[o].once&&this.removeEventListener(t,r[o].fn),r[o].fn(e);return!0},l.on=function(t,e){return this.addEventListener(t,e)},l.once=function(t,e){return this.addEventListener(t,e,!0)},l.addEventListener=function(t,e,r){var i={fn:e,once:r},o=this._evts;return o[t]?o[t].fn?o[t]=[o[t],i]:o[t].push(i):(o[t]=i,this._evtCount++),this},l.off=function(t,e){if(!this._evts[t])return this;if(!e)return this._clearEvent(t),this;var r=this._evts[t];if(r.fn&&r.fn===e)this._clearEvent(t);else{var i=r.indexOf(e);if(i>-1){var o=r[r.length-1];r[i]=o,r.length--,r.length===1&&(this._evts[t]=r[0])}}return this},l.removeEventListener=function(t,e){return this.off(t,e)},l.removeAllEventListeners=function(t){t?this._evts[t]&&this._clearEvent(t):(this._evts=Object.create(null),this._evtCount=0)},l.trigger=function(t){this.dispatch(t.type,t.data)},l._clearEvent=function(t){--this._evtCount===0?this._evts=Object.create(null):delete this._evts[t]},n}(),Xa=N(Hi.prototype,"_evts",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Object.create(null)}}),Hi),Tr=function(l){},$u=console.log.bind(console),Yu=console.info.bind(console),Qu=console.warn.bind(console),Ju=console.error.bind(console),ce={debug:Tr,info:Tr,warn:Tr,error:Tr,isEnabled:!1,enable:function(){this.debug=$u,this.info=Yu,this.warn=Qu,this.error=Ju,this.isEnabled=!0},disable:function(){this.debug=Tr,this.info=Tr,this.warn=Tr,this.error=Tr,this.isEnabled=!1}},su=function(){function n(){this._clock=void 0,this._timeScale=void 0,this._deltaTime=void 0,this._startTime=void 0,this._lastTickTime=void 0,this._clock=performance||Date,this._timeScale=1,this._deltaTime=1e-4;var a=this._clock.now();this._startTime=a,this._lastTickTime=a}var l=n.prototype;return l.reset=function(){this._lastTickTime=this._clock.now()},l.tick=function(){var t=this.nowTime;this._deltaTime=(t-this._lastTickTime)*this._timeScale,this._lastTickTime=t},j(n,[{key:"nowTime",get:function(){return this._clock.now()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"timeScale",get:function(){return this._timeScale},set:function(t){this._timeScale=t}},{key:"unscaledDeltaTime",get:function(){return this._deltaTime/this._timeScale}},{key:"timeSinceStartup",get:function(){return this.nowTime-this._startTime}}]),n}(),fi={isArray:"isArray"in Array?Array.isArray:function(n){return toString.call(n)==="[object Array]"},isArrayLike:function(l){return!!l&&typeof l.length=="number"&&typeof l!="function"},clone:function(l){if(typeof l!="object"||l===null)return l;var a;if(fi.isArrayLike(l)){a=l.slice();for(var t=0,e=l.length;t<e;t++)a[t]=fi.clone(l[t])}else{a={};for(var r in l)l.hasOwnProperty(r)&&(a[r]=fi.clone(l[r]))}return a},downloadBlob:function(l,a){a===void 0&&(a="");var t=window.URL.createObjectURL(l),e=document.createElement("a");document.body.appendChild(e),e.style.display="none",e.href=t,e.download=a,e.addEventListener("click",function(){e.parentElement&&e.parentElement.removeChild(e)}),e.click(),window.URL.revokeObjectURL(t)}};function vi(n,l){var a=n.indexOf(l);if(a<0)return!1;var t=n.length-1;if(a!==t){var e=n[t];n[a]=e}return n.length--,!0}function na(n){return Object.keys(n).map(function(l){return n[l]})}var Be;(function(n){n[n.FLOAT=5126]="FLOAT",n[n.FLOAT_VEC2=35664]="FLOAT_VEC2",n[n.FLOAT_VEC3=35665]="FLOAT_VEC3",n[n.FLOAT_VEC4=35666]="FLOAT_VEC4",n[n.INT=5124]="INT",n[n.INT_VEC2=35667]="INT_VEC2",n[n.INT_VEC3=35668]="INT_VEC3",n[n.INT_VEC4=35669]="INT_VEC4",n[n.BOOL=35670]="BOOL",n[n.BOOL_VEC2=35671]="BOOL_VEC2",n[n.BOOL_VEC3=35672]="BOOL_VEC3",n[n.BOOL_VEC4=35673]="BOOL_VEC4",n[n.FLOAT_MAT2=35674]="FLOAT_MAT2",n[n.FLOAT_MAT3=35675]="FLOAT_MAT3",n[n.FLOAT_MAT4=35676]="FLOAT_MAT4",n[n.FLOAT_ARRAY=35677]="FLOAT_ARRAY",n[n.FLOAT_VEC2_ARRAY=1e5]="FLOAT_VEC2_ARRAY",n[n.FLOAT_VEC3_ARRAY=100001]="FLOAT_VEC3_ARRAY",n[n.FLOAT_VEC4_ARRAY=100002]="FLOAT_VEC4_ARRAY",n[n.INT_ARRAY=100003]="INT_ARRAY",n[n.INT_VEC2_ARRAY=100004]="INT_VEC2_ARRAY",n[n.INT_VEC3_ARRAY=100005]="INT_VEC3_ARRAY",n[n.INT_VEC4_ARRAY=100006]="INT_VEC4_ARRAY",n[n.FLOAT_MAT2_ARRAY=100007]="FLOAT_MAT2_ARRAY",n[n.FLOAT_MAT3_ARRAY=100008]="FLOAT_MAT3_ARRAY",n[n.FLOAT_MAT4_ARRAY=100009]="FLOAT_MAT4_ARRAY",n[n.SAMPLER_2D_ARRAY=100010]="SAMPLER_2D_ARRAY",n[n.SAMPLER_CUBE_ARRAY=100011]="SAMPLER_CUBE_ARRAY",n[n.SAMPLER_2D=35678]="SAMPLER_2D",n[n.SAMPLER_CUBE=35680]="SAMPLER_CUBE",n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT"})(Be||(Be={}));var J;(function(n){n.shaderVertexID="shaderVertexID",n.standardDerivatives="OES_standard_derivatives",n.shaderTextureLod="EXT_shader_texture_lod",n.elementIndexUint="OES_element_index_uint",n.depthTexture="WEBGL_depth_texture",n.drawBuffers="WEBGL_draw_buffers",n.vertexArrayObject="OES_vertex_array_object",n.instancedArrays="ANGLE_instanced_arrays",n.multipleSample="multipleSampleOnlySupportedInWebGL2",n.textureFloat="OES_texture_float",n.textureFloatLinear="OES_texture_float_linear",n.textureHalfFloat="OES_texture_half_float",n.textureHalfFloatLinear="OES_texture_half_float_linear",n.WEBGL_colorBufferFloat="WEBGL_color_buffer_float",n.colorBufferFloat="EXT_color_buffer_float",n.colorBufferHalfFloat="EXT_color_buffer_half_float",n.textureFilterAnisotropic="EXT_texture_filter_anisotropic",n.blendMinMax="EXT_blend_minmax",n.astc="WEBGL_compressed_texture_astc",n.astc_webkit="WEBKIT_WEBGL_compressed_texture_astc",n.etc="WEBGL_compressed_texture_etc",n.etc_webkit="WEBKIT_WEBGL_compressed_texture_etc",n.etc1="WEBGL_compressed_texture_etc1",n.etc1_webkit="WEBKIT_WEBGL_compressed_texture_etc1",n.pvrtc="WEBGL_compressed_texture_pvrtc",n.pvrtc_webkit="WEBKIT_WEBGL_compressed_texture_pvrtc",n.s3tc="WEBGL_compressed_texture_s3tc",n.s3tc_webkit="WEBKIT_WEBGL_compressed_texture_s3tc"})(J||(J={}));var rr=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.name=void 0,t._platformTexture=void 0,t._mipmap=void 0,t._isDepthTexture=!1,t._format=void 0,t._width=void 0,t._height=void 0,t._mipmapCount=void 0,t._wrapModeU=void 0,t._wrapModeV=void 0,t._filterMode=void 0,t._anisoLevel=1,t._depthCompareFunction=void 0,t._useDepthCompareMode=!1,t}var a=l.prototype;return a.generateMipmaps=function(){!this._mipmap||this._platformTexture.generateMipmaps()},a._setUseDepthCompareMode=function(e){this._useDepthCompareMode!==e&&(this._platformTexture.setUseDepthCompareMode(e),this._useDepthCompareMode=e)},a._onDestroy=function(){this._platformTexture.destroy(),this._platformTexture=null},a._getMaxMiplevel=function(e){return Math.floor(Math.log2(e))},a._getMipmapCount=function(){return this._mipmap?Math.floor(Math.log2(Math.max(this._width,this._height)))+1:1},j(l,[{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"wrapModeU",get:function(){return this._wrapModeU},set:function(e){e!==this._wrapModeU&&(this._wrapModeU=e,this._platformTexture.wrapModeU=e)}},{key:"wrapModeV",get:function(){return this._wrapModeV},set:function(e){e!==this._wrapModeV&&(this._wrapModeV=e,this._platformTexture.wrapModeV=e)}},{key:"mipmapCount",get:function(){return this._mipmapCount}},{key:"filterMode",get:function(){return this._filterMode},set:function(e){e!==this._filterMode&&(this._filterMode=e,this._platformTexture.filterMode=e)}},{key:"anisoLevel",get:function(){return this._anisoLevel},set:function(e){var r=this._engine._hardwareRenderer.capability.maxAnisoLevel;e>r&&(ce.warn("anisoLevel:"+e+", exceeds the limit and is automatically downgraded to:"+r),e=r),e<1&&(ce.warn("anisoLevel:"+e+", must be greater than 0, and is automatically downgraded to 1"),e=1),e!==this._anisoLevel&&(this._anisoLevel=e,this._platformTexture.anisoLevel=e)}},{key:"depthCompareFunction",get:function(){return this._depthCompareFunction},set:function(e){if(!this._engine._hardwareRenderer._isWebGL2){console.warn("depthCompareFunction only support WebGL2");return}e!==this._depthCompareFunction&&(this._depthCompareFunction=e,this._platformTexture.depthCompareFunction=e)}}]),l}(wr),Nn=function(n){$(l,n);function l(t,e,r,i,o,s){var c;if(o===void 0&&(o=$e.Depth),s===void 0&&(s=1),c=n.call(this,t)||this,c._platformRenderTarget=void 0,c._depth=void 0,c._antiAliasing=void 0,c._autoGenerateMipmaps=!0,c._width=void 0,c._height=void 0,c._colorTextures=void 0,c._depthTexture=void 0,c._width=e,c._height=r,c._antiAliasing=s,c._depth=o,i){for(var u=i instanceof Array?i.slice():[i],_=0,h=u.length;_<h;_++)if(u[_]._isDepthTexture)throw"Render texture can't use depth format.";c._colorTextures=u}else c._colorTextures=[];if(o instanceof rr){if(!o._isDepthTexture)throw"Depth texture must use depth format.";c._depthTexture=o}return c._platformRenderTarget=t._hardwareRenderer.createPlatformRenderTarget(L(c)),c}var a=l.prototype;return a.getColorTexture=function(e){return e===void 0&&(e=0),this._colorTextures[e]},a.generateMipmaps=function(){if(this._autoGenerateMipmaps){for(var e=this._colorTextures,r=0,i=e.length;r<i;r++){var o=e[r];o.generateMipmaps()}this._depthTexture&&this._depthTexture.generateMipmaps()}},a.destroy=function(){this._platformRenderTarget.destroy(),this._colorTextures.length=0,this._depthTexture=null,this._depth=null},a._setRenderTargetInfo=function(e,r){this._platformRenderTarget.setRenderTargetInfo(e,r)},a._blitRenderTarget=function(){this._platformRenderTarget.blitRenderTarget()},j(l,[{key:"autoGenerateMipmaps",get:function(){return this._autoGenerateMipmaps},set:function(e){this._autoGenerateMipmaps=e}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"colorTextureCount",get:function(){return this._colorTextures.length}},{key:"depthTexture",get:function(){return this._depthTexture}},{key:"antiAliasing",get:function(){return this._antiAliasing}}]),l}(xr),Mt=function(n){$(l,n);function l(t,e,r,i,o){var s;return i===void 0&&(i=H.R8G8B8A8),o===void 0&&(o=!0),s=n.call(this,t)||this,s._mipmap=o,s._width=e,s._height=r,s._format=i,s._mipmapCount=s._getMipmapCount(),s._isDepthTexture=i==H.Depth||i==H.DepthStencil||i==H.Depth16||i==H.Depth24||i==H.Depth32||i==H.Depth24Stencil8||i==H.Depth32Stencil8,s._platformTexture=t._hardwareRenderer.createPlatformTexture2D(L(s)),s.filterMode=gt.Bilinear,s.wrapModeU=s.wrapModeV=pt.Repeat,s}var a=l.prototype;return a.setPixelBuffer=function(e,r,i,o,s,c){r===void 0&&(r=0),i===void 0&&(i=0),o===void 0&&(o=0),this._platformTexture.setPixelBuffer(e,r,i,o,s,c)},a.setImageSource=function(e,r,i,o,s,c){r===void 0&&(r=0),i===void 0&&(i=!1),o===void 0&&(o=!1),s===void 0&&(s=0),c===void 0&&(c=0),this._platformTexture.setImageSource(e,r,i,o,s,c)},a.getPixelBuffer=function(e,r,i,o,s,c){var u=arguments.length;u===1?this._platformTexture.getPixelBuffer(0,0,this._width,this._height,0,e):u===2?this._platformTexture.getPixelBuffer(0,0,this._width>>e,this._height>>e,e,r):u===5?this._platformTexture.getPixelBuffer(e,r,i,o,0,s):u===6&&this._platformTexture.getPixelBuffer(e,r,i,o,s,c)},l}(rr),_a=function(n){$(l,n);function l(t,e,r,i,o,s){var c;return o===void 0&&(o=H.R8G8B8A8),s===void 0&&(s=!0),c=n.call(this,t)||this,c._length=void 0,c._mipmap=s,c._width=e,c._height=r,c._length=i,c._format=o,c._mipmapCount=c._getMipmapCount(),c._platformTexture=t._hardwareRenderer.createPlatformTexture2DArray(L(c)),c.filterMode=gt.Bilinear,c.wrapModeU=c.wrapModeV=pt.Repeat,c}var a=l.prototype;return a.setPixelBuffer=function(e,r,i,o,s,c,u,_){i===void 0&&(i=0),o===void 0&&(o=0),s===void 0&&(s=0),this._platformTexture.setPixelBuffer(e,r,i,o,s,c,u,_)},a.setImageSource=function(e,r,i,o,s,c,u){i===void 0&&(i=0),o===void 0&&(o=!1),s===void 0&&(s=!1),c===void 0&&(c=0),u===void 0&&(u=0),this._platformTexture.setImageSource(e,r,i,o,s,c,u)},a.getPixelBuffer=function(e,r,i,o,s,c,u){var _=arguments.length;_===1?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,r):_===2?this._platformTexture.getPixelBuffer(e,0,0,this._width>>r,this._height>>r,r,i):_===5?this._platformTexture.getPixelBuffer(e,r,i,o,s,0,c):_===6&&this._platformTexture.getPixelBuffer(e,r,i,o,s,c,u)},j(l,[{key:"length",get:function(){return this._length}}]),l}(rr),Ct=function(n){$(l,n);function l(t,e,r,i){var o;return r===void 0&&(r=H.R8G8B8A8),i===void 0&&(i=!0),o=n.call(this,t)||this,o._mipmap=i,o._width=e,o._height=e,o._format=r,o._mipmapCount=o._getMipmapCount(),o._platformTexture=t._hardwareRenderer.createPlatformTextureCube(L(o)),o.filterMode=gt.Bilinear,o.wrapModeU=o.wrapModeV=pt.Clamp,o}var a=l.prototype;return a.setPixelBuffer=function(e,r,i,o,s,c,u){i===void 0&&(i=0),o===void 0&&(o=0),s===void 0&&(s=0),this._platformTexture.setPixelBuffer(e,r,i,o,s,c,u)},a.setImageSource=function(e,r,i,o,s,c,u){i===void 0&&(i=0),o===void 0&&(o=!1),s===void 0&&(s=!1),c===void 0&&(c=0),u===void 0&&(u=0),this._platformTexture.setImageSource(e,r,i,o,s,c,u)},a.getPixelBuffer=function(e,r,i,o,s,c,u){var _=arguments.length;_===2?this._platformTexture.getPixelBuffer(e,0,0,this._width,this._height,0,r):_===3?this._platformTexture.getPixelBuffer(e,0,0,this._width>>r,this._height>>r,r,i):_===6?this._platformTexture.getPixelBuffer(e,r,i,o,s,0,c):_===7&&this._platformTexture.getPixelBuffer(e,r,i,o,s,c,u)},l}(rr),Zu=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,e._charInfoMap={},e._texture=void 0,e._space=1,e._curX=1,e._curY=1,e._nextY=1,e}var a=l.prototype;return a._onDestroy=function(){this._texture.destroy(),this._texture=null,this._charInfoMap={}},a.uploadCharTexture=function(e){var r=e.w,i=e.h,o=e.data,s=this._space,c=this.texture,u=c.width,_=r+s,h=i+s;if(1+_>=u||1+h>=u)throw Error("The char fontSize is too large.");var d=this._curX+_;d>=u&&(this._curX=s,this._curY=this._nextY+s);var f=this._curY+h;if(f>this._nextY&&(this._nextY=f),f>=u)return!1;r>0&&i>0&&o&&(c.setPixelBuffer(o,0,this._curX,this._curY,r,i),c.generateMipmaps());var p=1/u,v=this._curX,m=this._curY,g=r,y=i,x=v*p,b=(v+g)*p,S=m*p,P=(m+y)*p;e.x=v,e.y=m;var T=e.uvs;return T[0].set(x,S),T[1].set(b,S),T[2].set(b,P),T[3].set(x,P),this._curX+=_+s,!0},a.addCharInfo=function(e,r){this._charInfoMap[e.charCodeAt(0)]=r},a.getCharInfo=function(e){return this._charInfoMap[e.charCodeAt(0)]},j(l,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e}}]),l}(wr),Ku=function(){function n(a){this._engine=void 0,this._fontAtlases=[],this._lastIndex=-1,this._engine=a}var l=n.prototype;return l.destroy=function(){for(var t=this._fontAtlases,e=0,r=t.length;e<r;++e)t[e].destroy(!0);t.length=0},l._uploadCharTexture=function(t){var e=this._fontAtlases,r=this._lastIndex;r===-1&&(this._createFontAtlas(),r++);var i=e[r];i.uploadCharTexture(t)||(i=this._createFontAtlas(),i.uploadCharTexture(t),r++),this._lastIndex=r,t.data=null},l._addCharInfo=function(t,e){var r=this._lastIndex;e.index=r,this._fontAtlases[r].addCharInfo(t,e)},l._getCharInfo=function(t){for(var e=this._fontAtlases,r=0,i=e.length;r<i;++r){var o=e[r],s=o.getCharInfo(t);if(s)return s}return null},l._getTextureByIndex=function(t){var e=this._fontAtlases[t];return e?e.texture:null},l._getLastIndex=function(){return this._lastIndex},l._createFontAtlas=function(){var t=this._engine,e=new Zu(t),r=new Mt(t,256,256);return e.texture=r,this._fontAtlases.push(e),e},n}(),tn=function(n){$(l,n),l.createFromOS=function(e,r){if(r){var i=l._fontMap,o=i[r];return o||(o=new l(e,r),i[r]=o,o)}return null};function l(t,e){var r;return e===void 0&&(e=""),r=n.call(this,t)||this,r._name="",r._subFontMap={},r._name=e,r}var a=l.prototype;return a._getSubFont=function(e,r){var i=e+"-"+r,o=this._subFontMap,s=o[i];return s||(s=new Ku(this.engine),o[i]=s,s)},a._onDestroy=function(){var e=this._subFontMap;for(var r in e)e[r].destroy();this._subFontMap=null,delete l._fontMap[this._name]},j(l,[{key:"name",get:function(){return this._name}}]),l}(wr);tn._fontMap={};var Ee=function(){n.all=function(t){return new n(function(e,r,i){var o=t.length,s=new Array(o),c=0;function u(h,d){h.then(function(f){c++,s[d]=f,i(c/o),c===o&&e(s)},r)}for(var _=0;_<o;_++)u(t[_],_)})};function n(a){var t=this;this._promise=void 0,this._state=Bt.Pending,this._onProgressCallback=[],this._onCancelHandler=void 0,this._reject=void 0,this._promise=new Promise(function(e,r){t._reject=r;var i=function(_){t._state===Bt.Pending&&(e(_),t._state=Bt.Fulfilled,t._onProgressCallback=void 0)},o=function(_){t._state===Bt.Pending&&(r(_),t._state=Bt.Rejected,t._onProgressCallback=void 0)},s=function(_){t._state===Bt.Pending&&(t._state=Bt.Canceled,t._onProgressCallback=void 0,t._onCancelHandler=_)},c=function(_){t._state===Bt.Pending&&t._onProgressCallback.forEach(function(h){return h(_)})};a(i,o,c,s)})}var l=n.prototype;return l.onProgress=function(t){return this._onProgressCallback.push(t),this},l.then=function(t,e){return this._promise.then(t,e)},l.catch=function(t){return this._promise.catch(t)},l.finally=function(t){return this._promise.finally(t)},l.cancel=function(){if(this._state===Bt.Pending)return this._state=Bt.Canceled,this._reject("canceled"),this._onCancelHandler&&this._onCancelHandler(),this},n}(),Bt;(function(n){n.Pending="pending",n.Fulfilled="fulfilled",n.Rejected="rejected",n.Canceled="canceled"})(Bt||(Bt={}));var $n=function(){n._addLoader=function(t,e,r){this._loaders[t]=e;for(var i=0,o=r.length;i<o;i++)this._extTypeMapping[r[i]]=t},n._getTypeByUrl=function(t){var e=t.split("?")[0];return this._extTypeMapping[e.substring(e.lastIndexOf(".")+1)]};function n(a){this.engine=a,this.retryCount=1,this.retryInterval=0,this.timeout=1/0,this._objectPool=Object.create(null),this._editorResourceConfig=Object.create(null),this._virtualPathMap=Object.create(null),this._assetPool=Object.create(null),this._assetUrlPool=Object.create(null),this._refObjectPool=Object.create(null),this._loadingPromises={}}var l=n.prototype;return l.load=function(t){var e=this;if(!Array.isArray(t))return this._loadSingleItem(t);var r=t.map(function(i){return e._loadSingleItem(i)});return Ee.all(r)},l.cancelNotLoaded=function(t){var e=this;if(!t)na(this._loadingPromises).forEach(function(i){i.cancel()});else if(typeof t=="string"){var r;(r=this._loadingPromises[t])===null||r===void 0||r.cancel()}else t.forEach(function(i){var o;(o=e._loadingPromises[i])===null||o===void 0||o.cancel()})},l.gc=function(){this._gc(!1)},l.getAssetPath=function(t){return this._assetPool[t]},l.getResourceByRef=function(t){var e=t.refId,r=t.key,i=t.isClone,o=this._objectPool[e],s;if(o)s=Promise.resolve(o);else{var c,u=(c=this._editorResourceConfig[e])===null||c===void 0?void 0:c.path;if(!u){ce.error("refId:"+e+" is not find in this._editorResourceConfig:"+JSON.stringify(this._editorResourceConfig));return}s=this.load({type:this._editorResourceConfig[e].type,url:""+u+(u.indexOf("?")>-1?"&":"?")+"q="+r})}return s.then(function(_){return i?_.clone():_})},l.initVirtualResources=function(t){var e=this;t.forEach(function(r){e._virtualPathMap[r.virtualPath]=r.path,e._editorResourceConfig[r.id]=r})},l._addAsset=function(t,e){this._assetPool[e.instanceId]=t,this._assetUrlPool[t]=e},l._deleteAsset=function(t){var e=t.instanceId,r=this._assetPool[e];r&&(delete this._assetPool[e],delete this._assetUrlPool[r])},l._addRefObject=function(t,e){this._refObjectPool[t]=e},l._deleteRefObject=function(t){delete this._refObjectPool[t]},l._destroy=function(){this.cancelNotLoaded(),this._gc(!0),this._assetPool=null,this._assetUrlPool=null,this._refObjectPool=null,this._loadingPromises=null},l._assignDefaultOptions=function(t){var e,r,i,o,s;if(t.type=(e=t.type)!=null?e:n._getTypeByUrl(t.url),t.type===void 0)throw"asset type should be specified: "+t.url;return t.retryCount=(r=t.retryCount)!=null?r:this.retryCount,t.timeout=(i=t.timeout)!=null?i:this.timeout,t.retryInterval=(o=t.retryInterval)!=null?o:this.retryInterval,t.url=(s=t.url)!=null?s:t.urls.join(","),t},l._loadSingleItem=function(t){var e=this,r=this._assignDefaultOptions(typeof t=="string"?{url:t}:t),i=r.url,o=this._virtualPathMap[i]?this._virtualPathMap[i]:i;if(this._assetUrlPool[o])return new Ee(function(u){u(e._assetUrlPool[o])});if(this._loadingPromises[o])return this._loadingPromises[r.url];var s=n._loaders[r.type];if(!s)throw"loader not found: "+r.type;r.url=o;var c=s.load(r,this);return this._loadingPromises[o]=c,c.then(function(u){s.useCache&&e._addAsset(o,u),e._loadingPromises&&delete e._loadingPromises[o]}).catch(function(u){Promise.reject(u),e._loadingPromises&&delete e._loadingPromises[o]}),c},l._gc=function(t){for(var e=na(this._refObjectPool),r=0,i=e.length;r<i;r++)(!e[r].isGCIgnored||t)&&e[r].destroy()},n}();$n._loaders={};$n._extTypeMapping={};function Ue(n,l,a){return a===void 0&&(a=!0),function(t){var e=new t(a);$n._addLoader(n,e,l)}}var Ne=function(){function n(a){a===void 0&&(a=0),this._elements=void 0,this.length=0,this._elements=new Array(a)}var l=n.prototype;return l.add=function(t){this.length===this._elements.length?this._elements.push(t):this._elements[this.length]=t,this.length++},l.delete=function(t){var e=this._elements.indexOf(t);this.deleteByIndex(e)},l.get=function(t){if(t>=this.length)throw"Index is out of range.";return this._elements[t]},l.deleteByIndex=function(t){var e=this._elements,r=null,i=this.length-1;return t!==i&&(r=e[i],e[t]=r),this.length--,r},l.garbageCollection=function(){this._elements.length=this.length},n}(),e_=function(){function n(){this._renderers=new Ne,this._onStartScripts=new Ne,this._onUpdateScripts=new Ne,this._onLateUpdateScripts=new Ne,this._onPhysicsUpdateScripts=new Ne,this._disableScripts=[],this._destroyScripts=[],this._onUpdateAnimations=new Ne,this._onUpdateRenderers=new Ne,this._componentsContainerPool=[]}var l=n.prototype;return l.addRenderer=function(t){t._rendererIndex=this._renderers.length,this._renderers.add(t)},l.removeRenderer=function(t){var e=this._renderers.deleteByIndex(t._rendererIndex);e&&(e._rendererIndex=t._rendererIndex),t._rendererIndex=-1},l.addOnStartScript=function(t){t._onStartIndex=this._onStartScripts.length,this._onStartScripts.add(t)},l.removeOnStartScript=function(t){var e=this._onStartScripts.deleteByIndex(t._onStartIndex);e&&(e._onStartIndex=t._onStartIndex),t._onStartIndex=-1},l.addOnUpdateScript=function(t){t._onUpdateIndex=this._onUpdateScripts.length,this._onUpdateScripts.add(t)},l.removeOnUpdateScript=function(t){var e=this._onUpdateScripts.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},l.addOnLateUpdateScript=function(t){t._onLateUpdateIndex=this._onLateUpdateScripts.length,this._onLateUpdateScripts.add(t)},l.removeOnLateUpdateScript=function(t){var e=this._onLateUpdateScripts.deleteByIndex(t._onLateUpdateIndex);e&&(e._onLateUpdateIndex=t._onLateUpdateIndex),t._onLateUpdateIndex=-1},l.addOnPhysicsUpdateScript=function(t){t._onPhysicsUpdateIndex=this._onPhysicsUpdateScripts.length,this._onPhysicsUpdateScripts.add(t)},l.removeOnPhysicsUpdateScript=function(t){var e=this._onPhysicsUpdateScripts.deleteByIndex(t._onPhysicsUpdateIndex);e&&(e._onPhysicsUpdateIndex=t._onPhysicsUpdateIndex),t._onPhysicsUpdateIndex=-1},l.addOnUpdateAnimations=function(t){t._onUpdateIndex=this._onUpdateAnimations.length,this._onUpdateAnimations.add(t)},l.removeOnUpdateAnimations=function(t){var e=this._onUpdateAnimations.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},l.addOnUpdateRenderers=function(t){t._onUpdateIndex=this._onUpdateRenderers.length,this._onUpdateRenderers.add(t)},l.removeOnUpdateRenderers=function(t){var e=this._onUpdateRenderers.deleteByIndex(t._onUpdateIndex);e&&(e._onUpdateIndex=t._onUpdateIndex),t._onUpdateIndex=-1},l.addDisableScript=function(t){this._disableScripts.push(t)},l.addDestroyScript=function(t){this._destroyScripts.push(t)},l.callScriptOnStart=function(){var t=this._onStartScripts;if(t.length>0){for(var e=t._elements,r=0;r<t.length;r++){var i=e[r];i._waitHandlingInValid||(i._started=!0,i._onStartIndex=-1,i.onStart())}t.length=0}},l.callScriptOnUpdate=function(t){for(var e=this._onUpdateScripts._elements,r=this._onUpdateScripts.length-1;r>=0;--r){var i=e[r];!i._waitHandlingInValid&&i._started&&i.onUpdate(t)}},l.callScriptOnLateUpdate=function(t){for(var e=this._onLateUpdateScripts._elements,r=this._onLateUpdateScripts.length-1;r>=0;--r){var i=e[r];!i._waitHandlingInValid&&i._started&&i.onLateUpdate(t)}},l.callScriptOnPhysicsUpdate=function(){for(var t=this._onPhysicsUpdateScripts._elements,e=this._onPhysicsUpdateScripts.length-1;e>=0;--e){var r=t[e];!r._waitHandlingInValid&&r._started&&r.onPhysicsUpdate()}},l.callAnimationUpdate=function(t){for(var e=this._onUpdateAnimations._elements,r=this._onUpdateAnimations.length-1;r>=0;--r)e[r].update(t)},l.callRendererOnUpdate=function(t){for(var e=this._onUpdateRenderers._elements,r=this._onUpdateRenderers.length-1;r>=0;--r)e[r].update(t)},l.handlingInvalidScripts=function(){var t=this._disableScripts,e=this._destroyScripts,r=t.length;if(r>0){for(var i=r-1;i>=0;i--){var o=t[i];o._waitHandlingInValid&&o._handlingInValid()}t.length=0}if(r=e.length,r>0){for(var s=r-1;s>=0;s--)e[s].onDestroy();e.length=0}},l.callCameraOnBeginRender=function(t){for(var e=t.entity._scripts,r=e.length-1;r>=0;--r){var i=e.get(r);i._waitHandlingInValid||i.onBeginRender(t)}},l.callCameraOnEndRender=function(t){for(var e=t.entity._scripts,r=e.length-1;r>=0;--r){var i=e.get(r);i._waitHandlingInValid||i.onEndRender(t)}},l.getActiveChangedTempList=function(){return this._componentsContainerPool.length?this._componentsContainerPool.pop():[]},l.putActiveChangedTempList=function(t){t.length=0,this._componentsContainerPool.push(t)},n}(),t_=function(){function n(){}return n.cloneComponent=function(a,t){for(var e=Nt.getCloneMode(a.constructor),r=Object.keys(a),i=0,o=r.length;i<o;i++){var s=r[i],c=e[s];switch(c){case void 0:case vr.Assignment:t[s]=a[s];break;case vr.Shallow:var u=a[s];if(u instanceof Object){var _=t[s];_==null&&(_=t[s]=u.constructor()),On(_,u)}else t[s]=u;break;case vr.Deep:var h=a[s];if(h instanceof Object){var d=t[s];d==null&&(d=t[s]=h.constructor()),Nt.deepCloneObject(h,d)}else t[s]=h;break}}a._cloneTo&&a._cloneTo(t)},n}(),Un=function(){n._register=function(a,t){this._addDependency(a,t,this._dependenciesMap),this._addDependency(t,a,this._invDependenciesMap)},n._addCheck=function(a,t){var e=n._dependenciesMap.get(t);if(e)for(var r=0,i=e.length;r<i;r++){var o=e[r];a.getComponent(o)||a.addComponent(o)}},n._removeCheck=function(a,t){var e=n._invDependenciesMap.get(t);if(e){for(var r=0,i=e.length;r<i;r++)if(a.getComponent(e[r]))throw"you should remove "+e[r]+" before adding "+t}},n._addDependency=function(a,t,e){var r=e.get(a);r||(r=[],e.set(a,r)),r.indexOf(t)===-1&&r.push(t)};function n(){}return n}();Un._dependenciesMap=new Map;Un._invDependenciesMap=new Map;function Yn(){for(var n=arguments.length,l=new Array(n),a=0;a<n;a++)l[a]=arguments[a];return function(t){l.forEach(function(e){return Un._register(t,e)})}}var nr;(function(n){n[n.Layer0=1]="Layer0",n[n.Layer1=2]="Layer1",n[n.Layer2=4]="Layer2",n[n.Layer3=8]="Layer3",n[n.Layer4=16]="Layer4",n[n.Layer5=32]="Layer5",n[n.Layer6=64]="Layer6",n[n.Layer7=128]="Layer7",n[n.Layer8=256]="Layer8",n[n.Layer9=512]="Layer9",n[n.Layer10=1024]="Layer10",n[n.Layer11=2048]="Layer11",n[n.Layer12=4096]="Layer12",n[n.Layer13=8192]="Layer13",n[n.Layer14=16384]="Layer14",n[n.Layer15=32768]="Layer15",n[n.Layer16=65536]="Layer16",n[n.Layer17=131072]="Layer17",n[n.Layer18=262144]="Layer18",n[n.Layer19=524288]="Layer19",n[n.Layer20=1048576]="Layer20",n[n.Layer21=2097152]="Layer21",n[n.Layer22=4194304]="Layer22",n[n.Layer23=8388608]="Layer23",n[n.Layer24=16777216]="Layer24",n[n.Layer25=33554432]="Layer25",n[n.Layer26=67108864]="Layer26",n[n.Layer27=134217728]="Layer27",n[n.Layer28=268435456]="Layer28",n[n.Layer29=536870912]="Layer29",n[n.Layer30=1073741824]="Layer30",n[n.Layer31=2147483648]="Layer31",n[n.Everything=4294967295]="Everything",n[n.Nothing=0]="Nothing"})(nr||(nr={}));var r_=function(){function n(){this._flagManagers=[]}var l=n.prototype;return l.clearFromManagers=function(){this._removeFromManagers(),this._flagManagers.length=0},l.destroy=function(){this._removeFromManagers(),this._flagManagers=null},l._removeFromManagers=function(){for(var t=this._flagManagers,e=0,r=t.length;e<r;e++)vi(t[e]._updateFlags,this)},n}(),Ai=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.flag=!0,t}var a=l.prototype;return a.dispatch=function(){this.flag=!0},l}(r_),Ur,qa,ja,$a,Ya,Qa,ir=(Ur=function(n){$(l,n);function l(t){var e;return e=n.call(this,t.engine)||this,U(e,"_entity",qa,L(e)),U(e,"_awoken",ja,L(e)),U(e,"_destroyed",$a,L(e)),U(e,"_phasedActive",Ya,L(e)),U(e,"_enabled",Qa,L(e)),e._entity=t,e}var a=l.prototype;return a.destroy=function(){this._destroyed||(this._entity._removeComponent(this),this._entity.isActiveInHierarchy&&this._enabled&&this._onDisable(),this._destroyed=!0,this._onDestroy())},a._onAwake=function(){},a._onEnable=function(){},a._onDisable=function(){},a._onDestroy=function(){},a._setActive=function(e){var r=this._entity;e?(!this._awoken&&r._isActiveInHierarchy&&(this._awoken=!0,this._onAwake()),!this._phasedActive&&r._isActiveInHierarchy&&this._enabled&&(this._phasedActive=!0,this._onEnable())):this._phasedActive&&!(r._isActiveInHierarchy&&this._enabled)&&(this._phasedActive=!1,this._onDisable())},j(l,[{key:"enabled",get:function(){return this._enabled},set:function(e){e!==this._enabled&&(this._enabled=e,this._entity.isActiveInHierarchy&&(e?(this._phasedActive=!0,this._onEnable()):(this._phasedActive=!1,this._onDisable())))}},{key:"destroyed",get:function(){return this._destroyed}},{key:"entity",get:function(){return this._entity}},{key:"scene",get:function(){return this._entity.scene}}]),l}(xr),qa=N(Ur.prototype,"_entity",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ja=N(Ur.prototype,"_awoken",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),$a=N(Ur.prototype,"_destroyed",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ya=N(Ur.prototype,"_phasedActive",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qa=N(Ur.prototype,"_enabled",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ur),mn=function(){function n(){this._updateFlags=[],this._listensers=[]}var l=n.prototype;return l.createFlag=function(t){var e=new t;return this.addFlag(e),e},l.addFlag=function(t){this._updateFlags.push(t),t._flagManagers.push(this)},l.removeFlag=function(t){var e=vi(this._updateFlags,t);e&&vi(t._flagManagers,this)},l.addListener=function(t){this._listensers.push(t)},l.removeListener=function(t){vi(this._listensers,t)},l.dispatch=function(t,e){for(var r=this._updateFlags,i=r.length-1;i>=0;i--)r[i].dispatch(t,e);for(var o=this._listensers,s=o.length-1;s>=0;s--)o[s](t,e)},n}(),fe,Ja,Za,Ka,eo,to,ro,no,io,ao,oo,so,lo,co,Gt,At=(fe=(Gt=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,U(e,"_position",Ja,L(e)),U(e,"_rotation",Za,L(e)),U(e,"_rotationQuaternion",Ka,L(e)),U(e,"_scale",eo,L(e)),U(e,"_worldPosition",to,L(e)),U(e,"_worldRotation",ro,L(e)),U(e,"_worldRotationQuaternion",no,L(e)),U(e,"_lossyWorldScale",io,L(e)),U(e,"_localMatrix",ao,L(e)),U(e,"_worldMatrix",oo,L(e)),U(e,"_isParentDirty",so,L(e)),U(e,"_parentTransformCache",lo,L(e)),e._dirtyFlag=ie.WmWpWeWqWs,U(e,"_updateFlagManager",co,L(e)),e._onPositionChanged=e._onPositionChanged.bind(L(e)),e._onWorldPositionChanged=e._onWorldPositionChanged.bind(L(e)),e._onRotationChanged=e._onRotationChanged.bind(L(e)),e._onWorldRotationChanged=e._onWorldRotationChanged.bind(L(e)),e._onRotationQuaternionChanged=e._onRotationQuaternionChanged.bind(L(e)),e._onWorldRotationQuaternionChanged=e._onWorldRotationQuaternionChanged.bind(L(e)),e._onScaleChanged=e._onScaleChanged.bind(L(e)),e._position._onValueChanged=e._onPositionChanged,e._worldPosition._onValueChanged=e._onWorldPositionChanged,e._rotation._onValueChanged=e._onRotationChanged,e._worldRotation._onValueChanged=e._onWorldRotationChanged,e._rotationQuaternion._onValueChanged=e._onRotationQuaternionChanged,e._worldRotationQuaternion._onValueChanged=e._onWorldRotationQuaternionChanged,e._scale._onValueChanged=e._onScaleChanged,e}var a=l.prototype;return a.setPosition=function(e,r,i){this._position.set(e,r,i)},a.setRotation=function(e,r,i){this._rotation.set(e,r,i)},a.setRotationQuaternion=function(e,r,i,o){this._rotationQuaternion.set(e,r,i,o)},a.setScale=function(e,r,i){this._scale.set(e,r,i)},a.setWorldPosition=function(e,r,i){this._worldPosition.set(e,r,i)},a.setWorldRotation=function(e,r,i){this._worldRotation.set(e,r,i)},a.setWorldRotationQuaternion=function(e,r,i,o){this._worldRotationQuaternion.set(e,r,i,o)},a.getWorldForward=function(e){var r=this.worldMatrix.elements;return e.set(-r[8],-r[9],-r[10]),e.normalize()},a.getWorldRight=function(e){var r=this.worldMatrix.elements;return e.set(r[0],r[1],r[2]),e.normalize()},a.getWorldUp=function(e){var r=this.worldMatrix.elements;return e.set(r[4],r[5],r[6]),e.normalize()},a.translate=function(e,r,i,o){if(typeof e=="number"){var s=l._tempVec30;s.set(e,r,i),this._translate(s,o)}else this._translate(e,r)},a.rotate=function(e,r,i,o){typeof e=="number"?this._rotateXYZ(e,r,i,o):this._rotateXYZ(e.x,e.y,e.z,r)},a.rotateByAxis=function(e,r,i){i===void 0&&(i=!0);var o=r*G.degreeToRadFactor;xe.rotationAxisAngle(e,o,l._tempQuat0),this._rotateByQuat(l._tempQuat0,i)},a.lookAt=function(e,r){var i=l._tempVec30;w.subtract(this.worldPosition,e,i);var o=i.length();if(!(o<=G.zeroTolerance)){i.scale(1/o);var s=l._tempVec31;if(r?w.cross(r,i,s):s.set(i.z,0,-i.x),o=s.length(),!(o<=G.zeroTolerance)){s.scale(1/o);var c=l._tempVec32;w.cross(i,s,c);var u=l._tempMat41,_=u.elements;_[0]=s.x,_[1]=s.y,_[2]=s.z,_[4]=c.x,_[5]=c.y,_[6]=c.z,_[8]=i.x,_[9]=i.y,_[10]=i.z,u.getRotation(this._worldRotationQuaternion)}}},a.registerWorldChangeFlag=function(){return this._updateFlagManager.createFlag(Ai)},a._parentChange=function(){this._isParentDirty=!0,this._updateAllWorldFlag()},a._isFrontFaceInvert=function(){var e=this.lossyWorldScale,r=e.x<0;return e.y<0&&(r=!r),e.z<0&&(r=!r),r},a._updateWorldPositionFlag=function(){if(!this._isContainDirtyFlags(ie.WmWp)){this._worldAssociatedChange(ie.WmWp);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionFlag()}}},a._updateWorldRotationFlag=function(){if(!this._isContainDirtyFlags(ie.WmWeWq)){this._worldAssociatedChange(ie.WmWeWq);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndRotationFlag()}}},a._updateWorldPositionAndRotationFlag=function(){if(!this._isContainDirtyFlags(ie.WmWpWeWq)){this._worldAssociatedChange(ie.WmWpWeWq);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndRotationFlag()}}},a._updateWorldScaleFlag=function(){if(!this._isContainDirtyFlags(ie.WmWs)){this._worldAssociatedChange(ie.WmWs);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndScaleFlag()}}},a._updateWorldPositionAndScaleFlag=function(){if(!this._isContainDirtyFlags(ie.WmWpWs)){this._worldAssociatedChange(ie.WmWpWs);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateWorldPositionAndScaleFlag()}}},a._updateAllWorldFlag=function(){if(!this._isContainDirtyFlags(ie.WmWpWeWqWs)){this._worldAssociatedChange(ie.WmWpWeWqWs);for(var e=this._entity._children,r=0,i=e.length;r<i;r++){var o;(o=e[r].transform)===null||o===void 0||o._updateAllWorldFlag()}}},a._getParentTransform=function(){if(!this._isParentDirty)return this._parentTransformCache;for(var e=null,r=this._entity.parent;r;){var i=r.transform;if(i){e=i;break}else r=r.parent}return this._parentTransformCache=e,this._isParentDirty=!1,e},a._getScaleMatrix=function(){var e=l._tempQuat0,r=l._tempMat30,i=l._tempMat31,o=l._tempMat32;return i.copyFromMatrix(this.worldMatrix),xe.invert(this.worldRotationQuaternion,e),fn.rotationQuaternion(e,r),fn.multiply(r,i,o),o},a._isContainDirtyFlags=function(e){return(this._dirtyFlag&e)===e},a._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},a._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},a._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},a._worldAssociatedChange=function(e){this._dirtyFlag|=e,this._updateFlagManager.dispatch(ie.WorldMatrix)},a._rotateByQuat=function(e,r){r?xe.multiply(this.rotationQuaternion,e,this._rotationQuaternion):xe.multiply(e,this.worldRotationQuaternion,this._worldRotationQuaternion)},a._translate=function(e,r){if(r===void 0&&(r=!0),r){var i=l._tempVec30;w.transformByQuat(e,this.worldRotationQuaternion,i),this._worldPosition.add(i)}else this._worldPosition.add(e)},a._rotateXYZ=function(e,r,i,o){o===void 0&&(o=!0);var s=G.degreeToRadFactor,c=l._tempQuat0;xe.rotationEuler(e*s,r*s,i*s,c),this._rotateByQuat(c,o)},a._onPositionChanged=function(){this._setDirtyFlagTrue(ie.LocalMatrix),this._updateWorldPositionFlag()},a._onWorldPositionChanged=function(){var e=this._worldPosition,r=this._getParentTransform();r?(te.invert(r.worldMatrix,l._tempMat41),w.transformCoordinate(e,l._tempMat41,this._position)):this._position.copyFrom(e),this._setDirtyFlagFalse(ie.WorldPosition)},a._onRotationChanged=function(){this._setDirtyFlagTrue(ie.LocalMatrix|ie.LocalQuat),this._setDirtyFlagFalse(ie.LocalEuler),this._updateWorldRotationFlag()},a._onWorldRotationChanged=function(){var e=this._worldRotation;xe.rotationEuler(G.degreeToRadian(e.x),G.degreeToRadian(e.y),G.degreeToRadian(e.z),this._worldRotationQuaternion),this._setDirtyFlagFalse(ie.WorldEuler)},a._onRotationQuaternionChanged=function(){this._setDirtyFlagTrue(ie.LocalMatrix|ie.LocalEuler),this._setDirtyFlagFalse(ie.LocalQuat),this._updateWorldRotationFlag()},a._onWorldRotationQuaternionChanged=function(){var e=this._worldRotationQuaternion,r=this._getParentTransform();if(r){var i=l._tempQuat0;xe.invert(r.worldRotationQuaternion,i),xe.multiply(i,e,this._rotationQuaternion)}else this._rotationQuaternion.copyFrom(e);this._setDirtyFlagFalse(ie.WorldQuat)},a._onScaleChanged=function(){this._setDirtyFlagTrue(ie.LocalMatrix),this._updateWorldScaleFlag()},j(l,[{key:"position",get:function(){return this._position},set:function(e){this._position!==e&&this._position.copyFrom(e)}},{key:"worldPosition",get:function(){var e=this._worldPosition;return this._isContainDirtyFlag(ie.WorldPosition)&&(e._onValueChanged=null,this._getParentTransform()?this.worldMatrix.getTranslation(e):e.copyFrom(this._position),e._onValueChanged=this._onWorldPositionChanged,this._setDirtyFlagFalse(ie.WorldPosition)),e},set:function(e){this._worldPosition!==e&&this._worldPosition.copyFrom(e)}},{key:"rotation",get:function(){var e=this._rotation;return this._isContainDirtyFlag(ie.LocalEuler)&&(e._onValueChanged=null,this._rotationQuaternion.toEuler(e),e._onValueChanged=this._onRotationChanged,e.scale(G.radToDegreeFactor),this._setDirtyFlagFalse(ie.LocalEuler)),e},set:function(e){this._rotation!==e&&this._rotation.copyFrom(e)}},{key:"worldRotation",get:function(){var e=this._worldRotation;return this._isContainDirtyFlag(ie.WorldEuler)&&(e._onValueChanged=null,this.worldRotationQuaternion.toEuler(e),e.scale(G.radToDegreeFactor),e._onValueChanged=this._onWorldRotationChanged,this._setDirtyFlagFalse(ie.WorldEuler)),e},set:function(e){this._worldRotation!==e&&this._worldRotation.copyFrom(e)}},{key:"rotationQuaternion",get:function(){var e=this._rotationQuaternion;return this._isContainDirtyFlag(ie.LocalQuat)&&(e._onValueChanged=null,xe.rotationEuler(G.degreeToRadian(this._rotation.x),G.degreeToRadian(this._rotation.y),G.degreeToRadian(this._rotation.z),e),e._onValueChanged=this._onRotationQuaternionChanged,this._setDirtyFlagFalse(ie.LocalQuat)),e},set:function(e){this._rotationQuaternion!==e?e.normalized?this._rotationQuaternion.copyFrom(e):xe.normalize(e,this._rotationQuaternion):e.normalized||e.normalize()}},{key:"worldRotationQuaternion",get:function(){var e=this._worldRotationQuaternion;if(this._isContainDirtyFlag(ie.WorldQuat)){e._onValueChanged=null;var r=this._getParentTransform();r!=null?xe.multiply(r.worldRotationQuaternion,this.rotationQuaternion,e):e.copyFrom(this.rotationQuaternion),e._onValueChanged=this._onWorldRotationQuaternionChanged,this._setDirtyFlagFalse(ie.WorldQuat)}return e},set:function(e){this._worldRotationQuaternion!==e&&(e.normalized?this._worldRotationQuaternion.copyFrom(e):xe.normalize(e,this._worldRotationQuaternion)),e.normalized||e.normalize()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale!==e&&this._scale.copyFrom(e)}},{key:"lossyWorldScale",get:function(){if(this._isContainDirtyFlag(ie.WorldScale)){if(this._getParentTransform()){var e=this._getScaleMatrix(),r=e.elements;this._lossyWorldScale.set(r[0],r[4],r[8])}else this._lossyWorldScale.copyFrom(this._scale);this._setDirtyFlagFalse(ie.WorldScale)}return this._lossyWorldScale}},{key:"localMatrix",get:function(){return this._isContainDirtyFlag(ie.LocalMatrix)&&(te.affineTransformation(this._scale,this.rotationQuaternion,this._position,this._localMatrix),this._setDirtyFlagFalse(ie.LocalMatrix)),this._localMatrix},set:function(e){this._localMatrix!==e&&this._localMatrix.copyFrom(e),this._localMatrix.decompose(this._position,this._rotationQuaternion,this._scale),this._setDirtyFlagTrue(ie.LocalEuler),this._setDirtyFlagFalse(ie.LocalMatrix),this._updateAllWorldFlag()}},{key:"worldMatrix",get:function(){if(this._isContainDirtyFlag(ie.WorldMatrix)){var e=this._getParentTransform();e?te.multiply(e.worldMatrix,this.localMatrix,this._worldMatrix):this._worldMatrix.copyFrom(this.localMatrix),this._setDirtyFlagFalse(ie.WorldMatrix)}return this._worldMatrix},set:function(e){this._worldMatrix!==e&&this._worldMatrix.copyFrom(e);var r=this._getParentTransform();r?(te.invert(r.worldMatrix,l._tempMat42),te.multiply(l._tempMat42,e,this._localMatrix)):this._localMatrix.copyFrom(e),this.localMatrix=this._localMatrix,this._setDirtyFlagFalse(ie.WorldMatrix)}}]),l}(ir),Gt._tempQuat0=new xe,Gt._tempVec30=new w,Gt._tempVec31=new w,Gt._tempVec32=new w,Gt._tempMat30=new fn,Gt._tempMat31=new fn,Gt._tempMat32=new fn,Gt._tempMat41=new te,Gt._tempMat42=new te,Gt),Ja=N(fe.prototype,"_position",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w}}),Za=N(fe.prototype,"_rotation",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w}}),Ka=N(fe.prototype,"_rotationQuaternion",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xe}}),eo=N(fe.prototype,"_scale",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w(1,1,1)}}),to=N(fe.prototype,"_worldPosition",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w}}),ro=N(fe.prototype,"_worldRotation",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w}}),no=N(fe.prototype,"_worldRotationQuaternion",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new xe}}),io=N(fe.prototype,"_lossyWorldScale",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new w(1,1,1)}}),ao=N(fe.prototype,"_localMatrix",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),oo=N(fe.prototype,"_worldMatrix",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),so=N(fe.prototype,"_isParentDirty",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),lo=N(fe.prototype,"_parentTransformCache",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),co=N(fe.prototype,"_updateFlagManager",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new mn}}),N(fe.prototype,"_onPositionChanged",[q],Object.getOwnPropertyDescriptor(fe.prototype,"_onPositionChanged"),fe.prototype),N(fe.prototype,"_onWorldPositionChanged",[q],Object.getOwnPropertyDescriptor(fe.prototype,"_onWorldPositionChanged"),fe.prototype),N(fe.prototype,"_onRotationChanged",[q],Object.getOwnPropertyDescriptor(fe.prototype,"_onRotationChanged"),fe.prototype),N(fe.prototype,"_onWorldRotationChanged",[q],Object.getOwnPropertyDescriptor(fe.prototype,"_onWorldRotationChanged"),fe.prototype),N(fe.prototype,"_onRotationQuaternionChanged",[q],Object.getOwnPropertyDescriptor(fe.prototype,"_onRotationQuaternionChanged"),fe.prototype),N(fe.prototype,"_onWorldRotationQuaternionChanged",[q],Object.getOwnPropertyDescriptor(fe.prototype,"_onWorldRotationQuaternionChanged"),fe.prototype),N(fe.prototype,"_onScaleChanged",[q],Object.getOwnPropertyDescriptor(fe.prototype,"_onScaleChanged"),fe.prototype),fe),ie;(function(n){n[n.LocalEuler=1]="LocalEuler",n[n.LocalQuat=2]="LocalQuat",n[n.WorldPosition=4]="WorldPosition",n[n.WorldEuler=8]="WorldEuler",n[n.WorldQuat=16]="WorldQuat",n[n.WorldScale=32]="WorldScale",n[n.LocalMatrix=64]="LocalMatrix",n[n.WorldMatrix=128]="WorldMatrix",n[n.WmWp=132]="WmWp",n[n.WmWeWq=152]="WmWeWq",n[n.WmWpWeWq=156]="WmWpWeWq",n[n.WmWs=160]="WmWs",n[n.WmWpWs=164]="WmWpWs",n[n.WmWpWeWqWs=188]="WmWpWeWqWs"})(ie||(ie={}));var hr=function(n){$(l,n),l._findChildByName=function(e,r){for(var i=e._children,o=i.length-1;o>=0;o--){var s=i[o];if(s.name===r)return s}return null},l._traverseSetOwnerScene=function(e,r){e._scene=r;for(var i=e._children,o=e.childCount-1;o>=0;o--)this._traverseSetOwnerScene(i[o],r)};function l(t,e){var r;return r=n.call(this,t)||this,r.name=void 0,r.layer=nr.Layer0,r.transform=void 0,r._isActiveInHierarchy=!1,r._components=[],r._scripts=new Ne,r._children=[],r._scene=void 0,r._isRoot=!1,r._isActive=!0,r._siblingIndex=-1,r._parent=null,r._activeChangedComponents=void 0,r._invModelMatrix=new te,r._inverseWorldMatFlag=void 0,r.name=e,r.transform=r.addComponent(At),r._inverseWorldMatFlag=r.transform.registerWorldChangeFlag(),r}var a=l.prototype;return a.addComponent=function(e){Un._addCheck(this,e);var r=new e(this);return this._components.push(r),r._setActive(!0),r},a.getComponent=function(e){for(var r=this._components.length-1;r>=0;r--){var i=this._components[r];if(i instanceof e)return i}},a.getComponents=function(e,r){r.length=0;for(var i=this._components.length-1;i>=0;i--){var o=this._components[i];o instanceof e&&r.push(o)}return r},a.getComponentsIncludeChildren=function(e,r){return r.length=0,this._getComponentsInChildren(e,r),r},a.addChild=function(e,r){var i;if(typeof e=="number"?i=e:(i=void 0,r=e),r._isRoot){r._scene._removeFromEntityList(r),r._isRoot=!1,this._addToChildrenList(i,r),r._parent=this;var o=this._scene;r._scene!==o&&l._traverseSetOwnerScene(r,o),this._isActiveInHierarchy?!r._isActiveInHierarchy&&r._isActive&&r._processActive():r._isActiveInHierarchy&&r._processInActive(),r._setTransformDirty()}else r._setParent(this,i)},a.removeChild=function(e){e._setParent(null)},a.getChild=function(e){return this._children[e]},a.findByName=function(e){var r=this._children,i=l._findChildByName(this,e);if(i)return i;for(var o=r.length-1;o>=0;o--){var s=r[o],c=s.findByName(e);if(c)return c}return null},a.findByPath=function(e){for(var r=e.split("/"),i=this,o=0,s=r.length;o<s;++o){var c=r[o];if(c&&(i=l._findChildByName(i,c),!i))return null}return i},a.createChild=function(e){var r=new l(this.engine,e);return r.layer=this.layer,r.parent=this,r},a.clearChildren=function(){for(var e=this._children,r=e.length-1;r>=0;r--){var i=e[r];i._parent=null,i._isActiveInHierarchy&&i._processInActive(),l._traverseSetOwnerScene(i,null)}e.length=0},a.clone=function(){var e=new l(this._engine,this.name);e._isActive=this._isActive,e.transform.localMatrix=this.transform.localMatrix;for(var r=this._children,i=0,o=this._children.length;i<o;i++){var s=r[i];e.addChild(s.clone())}for(var c=this._components,u=0,_=c.length;u<_;u++){var h=c[u];if(!(h instanceof At)){var d=e.addComponent(h.constructor);t_.cloneComponent(h,d)}}return e},a.destroy=function(){if(!this._destroyed){n.prototype.destroy.call(this);for(var e=this._components,r=e.length-1;r>=0;r--)e[r].destroy();this._components.length=0;for(var i=this._children;i.length>0;)i[0].destroy();this._isRoot?(this._scene._removeFromEntityList(this),this._isRoot=!1):this._removeFromParent()}},a._removeComponent=function(e){Un._removeCheck(this,e.constructor);var r=this._components;r.splice(r.indexOf(e),1)},a._addScript=function(e){e._entityScriptsIndex=this._scripts.length,this._scripts.add(e)},a._removeScript=function(e){var r=this._scripts.deleteByIndex(e._entityScriptsIndex);r&&(r._entityScriptsIndex=e._entityScriptsIndex),e._entityScriptsIndex=-1},a._removeFromParent=function(){var e=this._parent;if(e!=null){var r=e._children,i=this._siblingIndex;r.splice(i,1);for(var o=r.length;i<o;i++)r[i]._siblingIndex--;this._parent=null,this._siblingIndex=-1}},a._processActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main inActive entity' active in hierarchy, if the operation is in main inActive entity or it's children script's onDisable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!0)},a._processInActive=function(){if(this._activeChangedComponents)throw"Note: can't set the 'main active entity' inActive in hierarchy, if the operation is in main active entity or it's children script's onEnable Event.";this._activeChangedComponents=this._engine._componentsManager.getActiveChangedTempList(),this._setInActiveInHierarchy(this._activeChangedComponents),this._setActiveComponents(!1)},a._addToChildrenList=function(e,r){var i=this._children,o=i.length;if(e===void 0)r._siblingIndex=o,i.push(r);else{if(e<0||e>o)throw"The index "+e+" is out of child list bounds "+o;r._siblingIndex=e,i.splice(e,0,r);for(var s=e+1,c=o+1;s<c;s++)i[s]._siblingIndex++}},a._setParent=function(e,r){var i=this._parent;if(e!==i){if(this._removeFromParent(),this._parent=e,e){e._addToChildrenList(r,this);var o=e._scene;this._scene!==o&&l._traverseSetOwnerScene(this,o),e._isActiveInHierarchy?!this._isActiveInHierarchy&&this._isActive&&this._processActive():this._isActiveInHierarchy&&this._processInActive()}else this._isActiveInHierarchy&&this._processInActive(),i&&l._traverseSetOwnerScene(this,null);this._setTransformDirty()}},a._getComponentsInChildren=function(e,r){for(var i=this._components.length-1;i>=0;i--){var o=this._components[i];o instanceof e&&r.push(o)}for(var s=this._children.length-1;s>=0;s--)this._children[s]._getComponentsInChildren(e,r)},a._setActiveComponents=function(e){for(var r=this._activeChangedComponents,i=0,o=r.length;i<o;++i)r[i]._setActive(e);this._engine._componentsManager.putActiveChangedTempList(r),this._activeChangedComponents=null},a._setActiveInHierarchy=function(e){this._isActiveInHierarchy=!0;for(var r=this._components,i=r.length-1;i>=0;i--){var o=r[i];(o.enabled||!o._awoken)&&e.push(o)}for(var s=this._children,c=s.length-1;c>=0;c--){var u=s[c];u.isActive&&u._setActiveInHierarchy(e)}},a._setInActiveInHierarchy=function(e){this._isActiveInHierarchy=!1;for(var r=this._components,i=r.length-1;i>=0;i--){var o=r[i];o.enabled&&e.push(o)}for(var s=this._children,c=s.length-1;c>=0;c--){var u=s[c];u.isActive&&u._setInActiveInHierarchy(e)}},a._setTransformDirty=function(){if(this.transform)this.transform._parentChange();else for(var e=0,r=this._children.length;e<r;e++)this._children[e]._setTransformDirty()},a._setSiblingIndex=function(e,r){if(r=Math.min(r,e.length-1),r<0)throw"Sibling index "+r+" should large than 0";if(this._siblingIndex!==r){var i=this._siblingIndex;if(r<i)for(var o=i;o>=r;o--){var s=o==r?this:e[o-1];e[o]=s,s._siblingIndex=o}else for(var c=i;c<=r;c++){var u=c==r?this:e[c+1];e[c]=u,u._siblingIndex=c}}},a.getInvModelMatrix=function(){return this._inverseWorldMatFlag.flag&&(te.invert(this.transform.worldMatrix,this._invModelMatrix),this._inverseWorldMatFlag.flag=!1),this._invModelMatrix},j(l,[{key:"isActive",get:function(){return this._isActive},set:function(e){if(e!==this._isActive)if(this._isActive=e,e){var r=this._parent;(r!=null&&r._isActiveInHierarchy||this._isRoot&&this._scene._isActiveInEngine)&&this._processActive()}else this._isActiveInHierarchy&&this._processInActive()}},{key:"isActiveInHierarchy",get:function(){return this._isActiveInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this._setParent(e)}},{key:"children",get:function(){return this._children}},{key:"childCount",get:function(){return this._children.length}},{key:"scene",get:function(){return this._scene}},{key:"siblingIndex",get:function(){return this._siblingIndex},set:function(e){if(this._siblingIndex===-1)throw"The entity "+this.name+" is not in the hierarchy";this._setSiblingIndex(this._isRoot?this._scene._rootEntities:this._parent._children,e)}}]),l}(xr),zr;(function(n){n[n.Linear=0]="Linear",n[n.Gamma=1]="Gamma"})(zr||(zr={}));var je;(function(n){n[n.Down=0]="Down",n[n.Move=1]="Move",n[n.Stationary=2]="Stationary",n[n.Up=3]="Up",n[n.Leave=4]="Leave"})(je||(je={}));var lu=function(){var n=l.prototype;n._firePointerExitAndEnter=function(t){if(this._currentEnteredEntity!==t){if(this._currentEnteredEntity)for(var e=this._currentEnteredEntity._scripts,r=e.length-1;r>=0;r--){var i=e.get(r);i._waitHandlingInValid||i.onPointerExit(this)}if(t)for(var o=t._scripts,s=o.length-1;s>=0;s--){var c=o.get(s);c._waitHandlingInValid||c.onPointerEnter(this)}this._currentEnteredEntity=t}},n._firePointerDown=function(t){if(t)for(var e=t._scripts,r=e.length-1;r>=0;r--){var i=e.get(r);i._waitHandlingInValid||i.onPointerDown(this)}this._currentPressedEntity=t},n._firePointerDrag=function(){if(this._currentPressedEntity)for(var t=this._currentPressedEntity._scripts,e=t.length-1;e>=0;e--){var r=t.get(e);r._waitHandlingInValid||r.onPointerDrag(this)}},n._firePointerUpAndClick=function(t){var e=this._currentPressedEntity;if(e){for(var r=e===t,i=e._scripts,o=i.length-1;o>=0;o--){var s=i.get(o);s._waitHandlingInValid||(r&&s.onPointerClick(this),s.onPointerUp(this))}this._currentPressedEntity=null}};function l(a){this.id=void 0,this.phase=je.Leave,this.button=void 0,this.pressedButtons=void 0,this.position=new X,this.deltaPosition=new X,this._events=[],this._uniqueID=void 0,this._upMap=[],this._downMap=[],this._upList=new Ne,this._downList=new Ne,this._currentPressedEntity=void 0,this._currentEnteredEntity=void 0,this.id=a}return l}(),gi;(function(n){n[n.Backquote=0]="Backquote",n[n.Backslash=1]="Backslash",n[n.Backspace=2]="Backspace",n[n.BracketLeft=3]="BracketLeft",n[n.BracketRight=4]="BracketRight",n[n.Comma=5]="Comma",n[n.Digit0=6]="Digit0",n[n.Digit1=7]="Digit1",n[n.Digit2=8]="Digit2",n[n.Digit3=9]="Digit3",n[n.Digit4=10]="Digit4",n[n.Digit5=11]="Digit5",n[n.Digit6=12]="Digit6",n[n.Digit7=13]="Digit7",n[n.Digit8=14]="Digit8",n[n.Digit9=15]="Digit9",n[n.Equal=16]="Equal",n[n.IntlBackslash=17]="IntlBackslash",n[n.IntlRo=18]="IntlRo",n[n.IntlYen=19]="IntlYen",n[n.KeyA=20]="KeyA",n[n.KeyB=21]="KeyB",n[n.KeyC=22]="KeyC",n[n.KeyD=23]="KeyD",n[n.KeyE=24]="KeyE",n[n.KeyF=25]="KeyF",n[n.KeyG=26]="KeyG",n[n.KeyH=27]="KeyH",n[n.KeyI=28]="KeyI",n[n.KeyJ=29]="KeyJ",n[n.KeyK=30]="KeyK",n[n.KeyL=31]="KeyL",n[n.KeyM=32]="KeyM",n[n.KeyN=33]="KeyN",n[n.KeyO=34]="KeyO",n[n.KeyP=35]="KeyP",n[n.KeyQ=36]="KeyQ",n[n.KeyR=37]="KeyR",n[n.KeyS=38]="KeyS",n[n.KeyT=39]="KeyT",n[n.KeyU=40]="KeyU",n[n.KeyV=41]="KeyV",n[n.KeyW=42]="KeyW",n[n.KeyX=43]="KeyX",n[n.KeyY=44]="KeyY",n[n.KeyZ=45]="KeyZ",n[n.Minus=46]="Minus",n[n.Period=47]="Period",n[n.Quote=48]="Quote",n[n.Semicolon=49]="Semicolon",n[n.Slash=50]="Slash",n[n.AltLeft=51]="AltLeft",n[n.AltRight=52]="AltRight",n[n.CapsLock=53]="CapsLock",n[n.ContextMenu=54]="ContextMenu",n[n.ControlLeft=55]="ControlLeft",n[n.ControlRight=56]="ControlRight",n[n.Enter=57]="Enter",n[n.MetaLeft=58]="MetaLeft",n[n.MetaRight=59]="MetaRight",n[n.ShiftLeft=60]="ShiftLeft",n[n.ShiftRight=61]="ShiftRight",n[n.Space=62]="Space",n[n.Tab=63]="Tab",n[n.Convert=64]="Convert",n[n.KanaMode=65]="KanaMode",n[n.Lang1=66]="Lang1",n[n.Lang2=67]="Lang2",n[n.Lang3=68]="Lang3",n[n.Lang4=69]="Lang4",n[n.Lang5=70]="Lang5",n[n.NonConvert=71]="NonConvert",n[n.Delete=72]="Delete",n[n.End=73]="End",n[n.Help=74]="Help",n[n.Home=75]="Home",n[n.Insert=76]="Insert",n[n.PageDown=77]="PageDown",n[n.PageUp=78]="PageUp",n[n.ArrowDown=79]="ArrowDown",n[n.ArrowLeft=80]="ArrowLeft",n[n.ArrowRight=81]="ArrowRight",n[n.ArrowUp=82]="ArrowUp",n[n.NumLock=83]="NumLock",n[n.Numpad0=84]="Numpad0",n[n.Numpad1=85]="Numpad1",n[n.Numpad2=86]="Numpad2",n[n.Numpad3=87]="Numpad3",n[n.Numpad4=88]="Numpad4",n[n.Numpad5=89]="Numpad5",n[n.Numpad6=90]="Numpad6",n[n.Numpad7=91]="Numpad7",n[n.Numpad8=92]="Numpad8",n[n.Numpad9=93]="Numpad9",n[n.NumpadAdd=94]="NumpadAdd",n[n.NumpadBackspace=95]="NumpadBackspace",n[n.NumpadClear=96]="NumpadClear",n[n.NumpadClearEntry=97]="NumpadClearEntry",n[n.NumpadComma=98]="NumpadComma",n[n.NumpadDecimal=99]="NumpadDecimal",n[n.NumpadDivide=100]="NumpadDivide",n[n.NumpadEnter=101]="NumpadEnter",n[n.NumpadEqual=102]="NumpadEqual",n[n.NumpadHash=103]="NumpadHash",n[n.NumpadMemoryAdd=104]="NumpadMemoryAdd",n[n.NumpadMemoryClear=105]="NumpadMemoryClear",n[n.NumpadMemoryRecall=106]="NumpadMemoryRecall",n[n.NumpadMemoryStore=107]="NumpadMemoryStore",n[n.NumpadMemorySubtract=108]="NumpadMemorySubtract",n[n.NumpadMultiply=109]="NumpadMultiply",n[n.NumpadParenLeft=110]="NumpadParenLeft",n[n.NumpadParenRight=111]="NumpadParenRight",n[n.NumpadStar=112]="NumpadStar",n[n.NumpadSubtract=113]="NumpadSubtract",n[n.Escape=114]="Escape",n[n.F1=115]="F1",n[n.F2=116]="F2",n[n.F3=117]="F3",n[n.F4=118]="F4",n[n.F5=119]="F5",n[n.F6=120]="F6",n[n.F7=121]="F7",n[n.F8=122]="F8",n[n.F9=123]="F9",n[n.F10=124]="F10",n[n.F11=125]="F11",n[n.F12=126]="F12",n[n.F13=127]="F13",n[n.F14=128]="F14",n[n.F15=129]="F15",n[n.Fn=130]="Fn",n[n.FnLock=131]="FnLock",n[n.PrintScreen=132]="PrintScreen",n[n.ScrollLock=133]="ScrollLock",n[n.Pause=134]="Pause",n[n.BrowserBack=135]="BrowserBack",n[n.BrowserFavorites=136]="BrowserFavorites",n[n.BrowserForward=137]="BrowserForward",n[n.BrowserHome=138]="BrowserHome",n[n.BrowserRefresh=139]="BrowserRefresh",n[n.BrowserSearch=140]="BrowserSearch",n[n.BrowserStop=141]="BrowserStop",n[n.Eject=142]="Eject",n[n.LaunchApp1=143]="LaunchApp1",n[n.LaunchApp2=144]="LaunchApp2",n[n.LaunchMail=145]="LaunchMail",n[n.MediaPlayPause=146]="MediaPlayPause",n[n.MediaSelect=147]="MediaSelect",n[n.MediaStop=148]="MediaStop",n[n.MediaTrackNext=149]="MediaTrackNext",n[n.MediaTrackPrevious=150]="MediaTrackPrevious",n[n.Power=151]="Power",n[n.Sleep=152]="Sleep",n[n.AudioVolumeDown=153]="AudioVolumeDown",n[n.AudioVolumeMute=154]="AudioVolumeMute",n[n.AudioVolumeUp=155]="AudioVolumeUp",n[n.WakeUp=156]="WakeUp",n[n.Hyper=157]="Hyper",n[n.Super=158]="Super",n[n.Turbo=159]="Turbo",n[n.Abort=160]="Abort",n[n.Resume=161]="Resume",n[n.Suspend=162]="Suspend",n[n.Again=163]="Again",n[n.Copy=164]="Copy",n[n.Cut=165]="Cut",n[n.Find=166]="Find",n[n.Open=167]="Open",n[n.Paste=168]="Paste",n[n.Props=169]="Props",n[n.Select=170]="Select",n[n.Undo=171]="Undo",n[n.Hiragana=172]="Hiragana",n[n.Katakana=173]="Katakana",n[n.Unidentified=174]="Unidentified"})(gi||(gi={}));var n_=function(){function n(a){this._curHeldDownKeyToIndexMap=[],this._upKeyToFrameCountMap=[],this._downKeyToFrameCountMap=[],this._curFrameHeldDownList=new Ne,this._curFrameDownList=new Ne,this._curFrameUpList=new Ne,this._htmlCanvas=void 0,this._nativeEvents=[],this._hadListener=!1,this._htmlCanvas=a,a.tabIndex=a.tabIndex,this._onKeyEvent=this._onKeyEvent.bind(this),a.addEventListener("keydown",this._onKeyEvent),a.addEventListener("keyup",this._onKeyEvent),this._hadListener=!0}var l=n.prototype;return l._update=function(t){var e=this._nativeEvents,r=this._curFrameDownList,i=this._curFrameUpList;if(r.length=0,i.length=0,e.length>0){for(var o=this._curHeldDownKeyToIndexMap,s=this._curFrameHeldDownList,c=this._downKeyToFrameCountMap,u=this._upKeyToFrameCountMap,_=0,h=e.length;_<h;_++){var d=e[_],f=gi[d.code];switch(d.type){case"keydown":o[f]==null&&(r.add(f),s.add(f),o[f]=s.length-1,c[f]=t);break;case"keyup":var p=o[f];if(p!=null){o[f]=null;var v=s.deleteByIndex(p);v&&(o[v]=p)}i.add(f),u[f]=t;break}}e.length=0}},l._onFocus=function(){this._hadListener||(this._htmlCanvas.addEventListener("keydown",this._onKeyEvent),this._htmlCanvas.addEventListener("keyup",this._onKeyEvent),this._hadListener=!0)},l._onBlur=function(){this._hadListener&&(this._htmlCanvas.removeEventListener("keydown",this._onKeyEvent),this._htmlCanvas.removeEventListener("keyup",this._onKeyEvent),this._curHeldDownKeyToIndexMap.length=0,this._curFrameHeldDownList.length=0,this._curFrameDownList.length=0,this._curFrameUpList.length=0,this._nativeEvents.length=0,this._hadListener=!1)},l._destroy=function(){this._hadListener&&(this._htmlCanvas.removeEventListener("keydown",this._onKeyEvent),this._htmlCanvas.removeEventListener("keyup",this._onKeyEvent),this._hadListener=!1),this._curHeldDownKeyToIndexMap=null,this._upKeyToFrameCountMap=null,this._downKeyToFrameCountMap=null,this._nativeEvents=null,this._curFrameHeldDownList=null,this._curFrameDownList=null,this._curFrameUpList=null},l._onKeyEvent=function(t){this._nativeEvents.push(t)},n}(),It;(function(n){n[n.None=0]="None",n[n.Color=1]="Color",n[n.Depth=2]="Depth",n[n.Stencil=4]="Stencil",n[n.ColorDepth=3]="ColorDepth",n[n.ColorStencil=5]="ColorStencil",n[n.DepthStencil=6]="DepthStencil",n[n.All=7]="All"})(It||(It={}));var cu=function(){this.entity=null,this.distance=0,this.point=new w,this.normal=new w},bt=function(){function n(a){var t=this;this._initialized=!1,this._engine=void 0,this._restTime=0,this._colliders=new Ne,this._gravity=new w(0,-9.81,0),this._nativePhysicsManager=void 0,this._physicalObjectsMap={},this._onContactEnter=function(e,r){for(var i=t._physicalObjectsMap[e],o=t._physicalObjectsMap[r],s=i.collider.entity._scripts,c=0,u=s.length;c<u;c++){var _=s.get(c);_._waitHandlingInValid||_.onCollisionEnter(o)}s=o.collider.entity._scripts;for(var h=0,d=s.length;h<d;h++){var f=s.get(h);f._waitHandlingInValid||f.onCollisionEnter(i)}},this._onContactExit=function(e,r){for(var i=t._physicalObjectsMap[e],o=t._physicalObjectsMap[r],s=i.collider.entity._scripts,c=0,u=s.length;c<u;c++){var _=s.get(c);_._waitHandlingInValid||_.onCollisionExit(o)}s=o.collider.entity._scripts;for(var h=0,d=s.length;h<d;h++){var f=s.get(h);f._waitHandlingInValid||f.onCollisionExit(i)}},this._onContactStay=function(e,r){for(var i=t._physicalObjectsMap[e],o=t._physicalObjectsMap[r],s=i.collider.entity._scripts,c=0,u=s.length;c<u;c++){var _=s.get(c);_._waitHandlingInValid||_.onCollisionStay(o)}s=o.collider.entity._scripts;for(var h=0,d=s.length;h<d;h++){var f=s.get(h);f._waitHandlingInValid||f.onCollisionStay(i)}},this._onTriggerEnter=function(e,r){for(var i=t._physicalObjectsMap[e],o=t._physicalObjectsMap[r],s=i.collider.entity._scripts,c=0,u=s.length;c<u;c++){var _=s.get(c);_._waitHandlingInValid||_.onTriggerEnter(o)}s=o.collider.entity._scripts;for(var h=0,d=s.length;h<d;h++){var f=s.get(h);f._waitHandlingInValid||f.onTriggerEnter(i)}},this._onTriggerExit=function(e,r){for(var i=t._physicalObjectsMap[e],o=t._physicalObjectsMap[r],s=i.collider.entity._scripts,c=0,u=s.length;c<u;c++){var _=s.get(c);_._waitHandlingInValid||_.onTriggerExit(o)}s=o.collider.entity._scripts;for(var h=0,d=s.length;h<d;h++){var f=s.get(h);f._waitHandlingInValid||f.onTriggerExit(i)}},this._onTriggerStay=function(e,r){for(var i=t._physicalObjectsMap[e],o=t._physicalObjectsMap[r],s=i.collider.entity._scripts,c=0,u=s.length;c<u;c++){var _=s.get(c);_._waitHandlingInValid||_.onTriggerStay(o)}s=o.collider.entity._scripts;for(var h=0,d=s.length;h<d;h++){var f=s.get(h);f._waitHandlingInValid||f.onTriggerStay(i)}},this.fixedTimeStep=1/60,this.maxSumTimeStep=1/3,this._engine=a}var l=n.prototype;return l.initialize=function(t){this._initialized||(n._nativePhysics=t,this._nativePhysicsManager=n._nativePhysics.createPhysicsManager(this._onContactEnter,this._onContactExit,this._onContactStay,this._onTriggerEnter,this._onTriggerExit,this._onTriggerStay),this._initialized=!0)},l.raycast=function(t,e,r,i){var o=this,s,c=Number.MAX_VALUE;typeof e=="number"?c=e:e!=null&&(s=e);var u=nr.Everything;if(typeof r=="number"?u=r:r!=null&&(s=r),i&&(s=i),s!=null){var _=this._nativePhysicsManager.raycast(t,c,function(h,d,f,p){s.entity=o._physicalObjectsMap[h]._collider.entity,s.distance=d,s.normal.copyFrom(p),s.point.copyFrom(f)});return _?s.entity.layer&u?!0:(s.entity=null,s.distance=0,s.point.set(0,0,0),s.normal.set(0,0,0),!1):!1}else return this._nativePhysicsManager.raycast(t,c)},l._update=function(t){var e=this.fixedTimeStep,r=this._nativePhysicsManager,i=this._engine._componentsManager,o=t+this._restTime,s=Math.floor(Math.min(this.maxSumTimeStep,o)/e);this._restTime=o-s*e;for(var c=0;c<s;c++)i.callScriptOnPhysicsUpdate(),this._callColliderOnUpdate(),r.update(e),this._callColliderOnLateUpdate()},l._addColliderShape=function(t){this._physicalObjectsMap[t.id]=t,this._nativePhysicsManager.addColliderShape(t._nativeShape)},l._removeColliderShape=function(t){delete this._physicalObjectsMap[t.id],this._nativePhysicsManager.removeColliderShape(t._nativeShape)},l._addCollider=function(t){t._index===-1&&(t._index=this._colliders.length,this._colliders.add(t)),this._nativePhysicsManager.addCollider(t._nativeCollider)},l._addCharacterController=function(t){t._index===-1&&(t._index=this._colliders.length,this._colliders.add(t)),this._nativePhysicsManager.addCharacterController(t._nativeCollider)},l._removeCollider=function(t){var e=this._colliders.deleteByIndex(t._index);e&&(e._index=t._index),t._index=-1,this._nativePhysicsManager.removeCollider(t._nativeCollider)},l._removeCharacterController=function(t){var e=this._colliders.deleteByIndex(t._index);e&&(e._index=t._index),t._index=-1,this._nativePhysicsManager.removeCharacterController(t._nativeCollider)},l._callColliderOnUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onUpdate()},l._callColliderOnLateUpdate=function(){for(var t=this._colliders._elements,e=this._colliders.length-1;e>=0;--e)t[e]._onLateUpdate()},j(n,[{key:"gravity",get:function(){return this._gravity},set:function(t){var e=this._gravity;e!==t&&e.copyFrom(t),this._nativePhysicsManager.setGravity(e)}}]),n}();bt._nativePhysics=void 0;var kn;(function(n){n[n.Average=0]="Average",n[n.Minimum=1]="Minimum",n[n.Multiply=2]="Multiply",n[n.Maximum=3]="Maximum"})(kn||(kn={}));var uu=function(){function n(){this._bounciness=.1,this._dynamicFriction=.1,this._staticFriction=.1,this._bounceCombine=kn.Average,this._frictionCombine=kn.Average,this._nativeMaterial=void 0,this._nativeMaterial=bt._nativePhysics.createPhysicsMaterial(this._staticFriction,this._dynamicFriction,this._bounciness,this._bounceCombine,this._frictionCombine)}var l=n.prototype;return l._destroy=function(){this._nativeMaterial.destroy()},j(n,[{key:"bounciness",get:function(){return this._bounciness},set:function(t){this._bounciness=t,this._nativeMaterial.setBounciness(t)}},{key:"dynamicFriction",get:function(){return this._dynamicFriction},set:function(t){this._dynamicFriction=t,this._nativeMaterial.setDynamicFriction(t)}},{key:"staticFriction",get:function(){return this._staticFriction},set:function(t){this._staticFriction=t,this._nativeMaterial.setStaticFriction(t)}},{key:"bounceCombine",get:function(){return this._bounceCombine},set:function(t){this._bounceCombine=t,this._nativeMaterial.setBounceCombine(t)}},{key:"frictionCombine",get:function(){return this._frictionCombine},set:function(t){this._frictionCombine=t,this._nativeMaterial.setFrictionCombine(t)}}]),n}(),uo,_o,Wi,ho,Dr=(uo=Yn(At),uo(_o=(Wi=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,U(e,"_index",ho,L(e)),e._nativeCollider=void 0,e._updateFlag=void 0,e._shapes=[],e._updateFlag=e.entity.transform.registerWorldChangeFlag(),e}var a=l.prototype;return a.addShape=function(e){var r=e._collider;r!==this&&(r&&r.removeShape(e),this._shapes.push(e),this.engine.physicsManager._addColliderShape(e),e._collider=this,this._nativeCollider.addShape(e._nativeShape))},a.removeShape=function(e){var r=this._shapes.indexOf(e);r!==-1&&(this._shapes.splice(r,1),this.engine.physicsManager._removeColliderShape(e),e._collider=null,this._nativeCollider.removeShape(e._nativeShape))},a.clearShapes=function(){for(var e=this._shapes,r=0,i=e.length;r<i;r++){var o=e[r];this.engine.physicsManager._removeColliderShape(o),o._destroy(),this._nativeCollider.removeShape(o._nativeShape)}e.length=0},a._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform;this._nativeCollider.setWorldTransform(e.worldPosition,e.worldRotationQuaternion);for(var r=e.lossyWorldScale,i=0,o=this.shapes.length;i<o;i++)this.shapes[i]._nativeShape.setWorldScale(r);this._updateFlag.flag=!1}},a._onLateUpdate=function(){},a._onEnable=function(){this.engine.physicsManager._addCollider(this)},a._onDisable=function(){this.engine.physicsManager._removeCollider(this)},a._onDestroy=function(){this.clearShapes(),this._nativeCollider.destroy()},j(l,[{key:"shapes",get:function(){return this._shapes}}]),l}(ir),ho=N(Wi.prototype,"_index",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Wi))||_o),mi;(function(n){n[n.PreventClimbing=0]="PreventClimbing",n[n.PreventClimbingAndForceSliding=1]="PreventClimbingAndForceSliding"})(mi||(mi={}));var i_=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,e._index=-1,e._stepOffset=0,e._nonWalkableMode=mi.PreventClimbing,e._upDirection=new w(0,1,0),e._slopeLimit=0,e._nativeCollider=bt._nativePhysics.createCharacterController(),e}var a=l.prototype;return a.move=function(e,r,i){return this._nativeCollider.move(e,r,i)},a.addShape=function(e){if(this._shapes.length>0)throw"only allow single shape on controller!";n.prototype.addShape.call(this,e),this._updateFlag.flag=!0},a.clearShapes=function(){this._shapes.length>0&&n.prototype.removeShape.call(this,this._shapes[0])},a._onUpdate=function(){if(this._updateFlag.flag){var e=this.entity.transform,r=this.shapes;this._nativeCollider.setWorldPosition(e.worldPosition);for(var i=e.lossyWorldScale,o=0,s=r.length;o<s;o++)r[o]._nativeShape.setWorldScale(i);this._updateFlag.flag=!1}},a._onLateUpdate=function(){var e=this.entity.transform.worldPosition;this._nativeCollider.getWorldPosition(e),this.entity.transform.worldPosition=e,this._updateFlag.flag=!1},a._onEnable=function(){this.engine.physicsManager._addCharacterController(this)},a._onDisable=function(){this.engine.physicsManager._removeCharacterController(this)},j(l,[{key:"stepOffset",get:function(){return this._stepOffset},set:function(e){this._stepOffset=e,this._nativeCollider.setStepOffset(e)}},{key:"nonWalkableMode",get:function(){return this._nonWalkableMode},set:function(e){this._nonWalkableMode=e,this._nativeCollider.setNonWalkableMode(e)}},{key:"upDirection",get:function(){return this._upDirection},set:function(e){this._upDirection!==e&&this._upDirection.copyFrom(e),this._nativeCollider.setUpDirection(this._upDirection)}},{key:"slopeLimit",get:function(){return this._slopeLimit},set:function(e){this._slopeLimit=e,this._nativeCollider.setSlopeLimit(e)}}]),l}(Dr),Sn=function(){function n(){this._collider=void 0,this._nativeShape=void 0,this._id=void 0,this._material=void 0,this._isTrigger=!1,this._contactOffset=0,this._rotation=new w,this._position=new w,this._material=new uu,this._id=n._idGenerator++,this._setRotation=this._setRotation.bind(this),this._setPosition=this._setPosition.bind(this),this._rotation._onValueChanged=this._setRotation,this._position._onValueChanged=this._setPosition}var l=n.prototype;return l._destroy=function(){this._material._destroy(),this._nativeShape.destroy()},l._setPosition=function(){this._nativeShape.setPosition(this._position)},l._setRotation=function(){this._nativeShape.setRotation(this._rotation)},j(n,[{key:"collider",get:function(){return this._collider}},{key:"id",get:function(){return this._id}},{key:"contactOffset",get:function(){return this._contactOffset},set:function(t){this._contactOffset=t,this._nativeShape.setContactOffset(t)}},{key:"material",get:function(){return this._material},set:function(t){this._material=t,this._nativeShape.setMaterial(t._nativeMaterial)}},{key:"rotation",get:function(){return this._rotation},set:function(t){this._rotation!=t&&this._rotation.copyFrom(t)}},{key:"position",get:function(){return this._position},set:function(t){this._position!==t&&this._position.copyFrom(t)}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(t){this._isTrigger=t,this._nativeShape.setIsTrigger(t)}}]),n}();Sn._idGenerator=0;var a_=function(n){$(l,n);function l(){var t;return t=n.call(this)||this,t._size=new w(1,1,1),t._nativeShape=bt._nativePhysics.createBoxColliderShape(t._id,t._size,t._material._nativeMaterial),t}var a=l.prototype;return a.setSize=function(e,r,i){this._size.x=e,this._size.y=r,this._size.z=i,this._nativeShape.setSize(this._size)},j(l,[{key:"size",get:function(){return this._size},set:function(e){this._size!=e&&this._size.copyFrom(e),this._nativeShape.setSize(e)}}]),l}(Sn),o_=function(n){$(l,n);function l(){var a;return a=n.call(this)||this,a._radius=1,a._nativeShape=bt._nativePhysics.createSphereColliderShape(a._id,a._radius,a._material._nativeMaterial),a}return j(l,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t,this._nativeShape.setRadius(t)}}]),l}(Sn),s_=function(n){$(l,n);function l(){var a;return a=n.call(this)||this,a._nativeShape=bt._nativePhysics.createPlaneColliderShape(a._id,a._material._nativeMaterial),a}return l}(Sn),yi;(function(n){n[n.X=0]="X",n[n.Y=1]="Y",n[n.Z=2]="Z"})(yi||(yi={}));var l_=function(n){$(l,n);function l(){var a;return a=n.call(this)||this,a._radius=1,a._height=2,a._upAxis=yi.Y,a._nativeShape=bt._nativePhysics.createCapsuleColliderShape(a._id,a._radius,a._height,a._material._nativeMaterial),a}return j(l,[{key:"radius",get:function(){return this._radius},set:function(t){this._radius=t,this._nativeShape.setRadius(t)}},{key:"height",get:function(){return this._height},set:function(t){this._height=t,this._nativeShape.setHeight(t)}},{key:"upAxis",get:function(){return this._upAxis},set:function(t){this._upAxis=t,this._nativeShape.setUpAxis(t)}}]),l}(Sn),fo,vo,Pi=(fo=Yn(Dr),fo(vo=function(n){$(l,n);function l(a){var t;return t=n.call(this,a)||this,t._connectedCollider=new po,t._collider=new po,t._nativeJoint=void 0,t._force=0,t._torque=0,t._connectedCollider.localPosition=new w,t}return j(l,[{key:"connectedCollider",get:function(){return this._connectedCollider.collider},set:function(t){this._connectedCollider.collider!==t&&(this._connectedCollider.collider=t,this._nativeJoint.setConnectedCollider(t._nativeCollider))}},{key:"connectedAnchor",get:function(){return this._connectedCollider.localPosition},set:function(t){var e=this._connectedCollider.localPosition;t!==e&&e.copyFrom(t),this._nativeJoint.setConnectedAnchor(t)}},{key:"connectedMassScale",get:function(){return this._connectedCollider.massScale},set:function(t){t!==this._connectedCollider.massScale&&(this._connectedCollider.massScale=t,this._nativeJoint.setConnectedMassScale(t))}},{key:"connectedInertiaScale",get:function(){return this._connectedCollider.inertiaScale},set:function(t){t!==this._connectedCollider.inertiaScale&&(this._connectedCollider.inertiaScale=t,this._nativeJoint.setConnectedInertiaScale(t))}},{key:"massScale",get:function(){return this._collider.massScale},set:function(t){t!==this._collider.massScale&&(this._collider.massScale=t,this._nativeJoint.setMassScale(t))}},{key:"inertiaScale",get:function(){return this._collider.inertiaScale},set:function(t){t!==this._collider.inertiaScale&&(this._collider.inertiaScale=t,this._nativeJoint.setInertiaScale(t))}},{key:"breakForce",get:function(){return this._force},set:function(t){t!==this._force&&(this._force=t,this._nativeJoint.setBreakForce(t))}},{key:"breakTorque",get:function(){return this._torque},set:function(t){t!==this._torque&&(this._torque=t,this._nativeJoint.setBreakTorque(t))}}]),l}(ir))||vo),po=function(){this.collider=null,this.localPosition=void 0,this.localRotation=void 0,this.massScale=0,this.inertiaScale=0},c_=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a._onAwake=function(){var e=this._collider;e.collider=this.entity.getComponent(Dr),this._nativeJoint=bt._nativePhysics.createFixedJoint(e.collider._nativeCollider)},l}(Pi),Wt;(function(n){n[n.LimitEnabled=1]="LimitEnabled",n[n.DriveEnabled=2]="DriveEnabled",n[n.DriveFreeSpin=4]="DriveFreeSpin"})(Wt||(Wt={}));var u_=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t._axis=new w(1,0,0),t._hingeFlags=0,t._useSpring=!1,t._jointMonitor=void 0,t._limits=void 0,t}var a=l.prototype;return a._onAwake=function(){var e=this._collider;e.localPosition=new w,e.collider=this.entity.getComponent(Dr),this._nativeJoint=bt._nativePhysics.createHingeJoint(e.collider._nativeCollider)},j(l,[{key:"axis",get:function(){return this._axis},set:function(e){var r=this._axis;e!==r&&r.copyFrom(e),this._nativeJoint.setAxis(r)}},{key:"swingOffset",get:function(){return this._collider.localPosition},set:function(e){var r=this._collider.localPosition;e!==r&&r.copyFrom(e),this._nativeJoint.setSwingOffset(r)}},{key:"angle",get:function(){return this._nativeJoint.getAngle()}},{key:"velocity",get:function(){return this._nativeJoint.getVelocity()}},{key:"useLimits",get:function(){return(this._hingeFlags&Wt.LimitEnabled)==Wt.LimitEnabled},set:function(e){e!==this.useLimits&&(this._hingeFlags|=Wt.LimitEnabled),this._nativeJoint.setHingeJointFlag(Wt.LimitEnabled,e)}},{key:"useMotor",get:function(){return(this._hingeFlags&Wt.DriveEnabled)==Wt.DriveEnabled},set:function(e){e!==this.useMotor&&(this._hingeFlags|=Wt.DriveEnabled),this._nativeJoint.setHingeJointFlag(Wt.DriveEnabled,e)}},{key:"useSpring",get:function(){return this._useSpring},set:function(e){this._useSpring=e,this.limits=this._limits}},{key:"motor",get:function(){return this._jointMonitor},set:function(e){this._jointMonitor=e,this._nativeJoint.setDriveVelocity(e.targetVelocity),this._nativeJoint.setDriveForceLimit(e.forceLimit),this._nativeJoint.setDriveGearRatio(e.gearRation),this._nativeJoint.setHingeJointFlag(Wt.DriveFreeSpin,e.freeSpin)}},{key:"limits",get:function(){return this._limits},set:function(e){this._limits=e,this.useSpring?this._nativeJoint.setSoftLimit(e.min,e.max,e.stiffness,e.damping):this._nativeJoint.setHardLimit(e.min,e.max,e.contactDistance)}}]),l}(Pi),__=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t._minDistance=0,t._maxDistance=0,t._tolerance=.25,t._stiffness=0,t._damping=0,t}var a=l.prototype;return a._onAwake=function(){var e=this._collider;e.localPosition=new w,e.collider=this.entity.getComponent(Dr),this._nativeJoint=bt._nativePhysics.createSpringJoint(e.collider._nativeCollider)},j(l,[{key:"swingOffset",get:function(){return this._collider.localPosition},set:function(e){var r=this._collider.localPosition;e!==r&&r.copyFrom(e),this._nativeJoint.setSwingOffset(e)}},{key:"minDistance",get:function(){return this._minDistance},set:function(e){this._minDistance=e,this._nativeJoint.setMinDistance(e)}},{key:"maxDistance",get:function(){return this._maxDistance},set:function(e){this._maxDistance=e,this._nativeJoint.setMaxDistance(e)}},{key:"tolerance",get:function(){return this._tolerance},set:function(e){this._tolerance=e,this._nativeJoint.setTolerance(e)}},{key:"stiffness",get:function(){return this._stiffness},set:function(e){this._stiffness=e,this._nativeJoint.setStiffness(e)}},{key:"damping",get:function(){return this._damping},set:function(e){this._damping=e,this._nativeJoint.setDamping(e)}}]),l}(Pi),h_=function(){this.max=0,this.min=0,this.contactDistance=-1,this.stiffness=0,this.damping=0},d_=function(){this.targetVelocity=0,this.forceLimit=Number.MAX_VALUE,this.gearRation=1,this.freeSpin=!1},ia;(function(n){n[n.Sides=1]="Sides",n[n.Up=2]="Up",n[n.Down=4]="Down"})(ia||(ia={}));var f_=function(n){$(l,n);function l(a){var t;t=n.call(this,a)||this;var e=t.entity.transform;return t._nativeCollider=bt._nativePhysics.createStaticCollider(e.worldPosition,e.worldRotationQuaternion),t}return l}(Dr),v_=function(n){$(l,n);function l(t){var e;e=n.call(this,t)||this,e._linearDamping=0,e._angularDamping=0,e._linearVelocity=new w,e._angularVelocity=new w,e._mass=0,e._centerOfMass=new w,e._inertiaTensor=new w,e._maxAngularVelocity=0,e._maxDepenetrationVelocity=0,e._sleepThreshold=0,e._solverIterations=0,e._isKinematic=!1,e._constraints=0,e._collisionDetectionMode=xi.Discrete;var r=e.entity.transform;return e._nativeCollider=bt._nativePhysics.createDynamicCollider(r.worldPosition,r.worldRotationQuaternion),e}var a=l.prototype;return a.applyForce=function(e){this._nativeCollider.addForce(e)},a.applyTorque=function(e){this._nativeCollider.addTorque(e)},a.move=function(e,r){this._nativeCollider.move(e,r)},a.sleep=function(){this._nativeCollider.sleep()},a.wakeUp=function(){this._nativeCollider.wakeUp()},a._onLateUpdate=function(){var e=this.entity.transform,r=e.worldPosition,i=e.worldRotationQuaternion;this._nativeCollider.getWorldTransform(r,i),this._updateFlag.flag=!1},j(l,[{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._nativeCollider.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._nativeCollider.setAngularDamping(e)}},{key:"linearVelocity",get:function(){return this._linearVelocity},set:function(e){this._linearVelocity!==e&&this._linearVelocity.copyFrom(e),this._nativeCollider.setLinearVelocity(this._linearVelocity)}},{key:"angularVelocity",get:function(){return this._angularVelocity},set:function(e){this._angularVelocity!==e&&this._angularVelocity.copyFrom(e),this._nativeCollider.setAngularVelocity(this._angularVelocity)}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass=e,this._nativeCollider.setMass(e)}},{key:"centerOfMass",get:function(){return this._centerOfMass},set:function(e){this._centerOfMass!==e&&this._centerOfMass.copyFrom(e),this._nativeCollider.setCenterOfMass(this._centerOfMass)}},{key:"inertiaTensor",get:function(){return this._inertiaTensor},set:function(e){this._inertiaTensor!==e&&this._inertiaTensor.copyFrom(e),this._nativeCollider.setInertiaTensor(this._inertiaTensor)}},{key:"maxAngularVelocity",get:function(){return this._maxAngularVelocity},set:function(e){this._maxAngularVelocity=e,this._nativeCollider.setMaxAngularVelocity(e)}},{key:"maxDepenetrationVelocity",get:function(){return this._maxDepenetrationVelocity},set:function(e){this._maxDepenetrationVelocity=e,this._nativeCollider.setMaxDepenetrationVelocity(e)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){this._sleepThreshold=e,this._nativeCollider.setSleepThreshold(e)}},{key:"solverIterations",get:function(){return this._solverIterations},set:function(e){this._solverIterations=e,this._nativeCollider.setSolverIterations(e)}},{key:"isKinematic",get:function(){return this._isKinematic},set:function(e){this._isKinematic=e,this._nativeCollider.setIsKinematic(e)}},{key:"constraints",get:function(){return this._constraints},set:function(e){this._constraints=e,this._nativeCollider.setConstraints(e)}},{key:"collisionDetectionMode",get:function(){return this._collisionDetectionMode},set:function(e){this._collisionDetectionMode=e,this._nativeCollider.setCollisionDetectionMode(e)}}]),l}(Dr),xi;(function(n){n[n.Discrete=0]="Discrete",n[n.Continuous=1]="Continuous",n[n.ContinuousDynamic=2]="ContinuousDynamic",n[n.ContinuousSpeculative=3]="ContinuousSpeculative"})(xi||(xi={}));var aa;(function(n){n[n.None=0]="None",n[n.FreezePositionX=1]="FreezePositionX",n[n.FreezePositionY=2]="FreezePositionY",n[n.FreezePositionZ=4]="FreezePositionZ",n[n.FreezeRotationX=8]="FreezeRotationX",n[n.FreezeRotationY=16]="FreezeRotationY",n[n.FreezeRotationZ=32]="FreezeRotationZ"})(aa||(aa={}));var Xe;(function(n){n[n.None=0]="None",n[n.Primary=1]="Primary",n[n.Secondary=2]="Secondary",n[n.Auxiliary=4]="Auxiliary",n[n.XButton1=8]="XButton1",n[n.XButton2=16]="XButton2",n[n.XButton3=32]="XButton3",n[n.XButton4=64]="XButton4",n[n.XButton5=128]="XButton5",n[n.XButton6=256]="XButton6",n[n.XButton7=512]="XButton7",n[n.XButton8=1024]="XButton8"})(Xe||(Xe={}));var go=[Xe.Primary,Xe.Auxiliary,Xe.Secondary,Xe.XButton1,Xe.XButton2,Xe.XButton3,Xe.XButton4,Xe.XButton5,Xe.XButton6,Xe.XButton7,Xe.XButton8],mo={1:0,2:2,4:1,8:3,16:4,32:5,64:6,128:7,256:8,512:9,1024:10},Mi=function(){function n(a,t){this._pointers=[],this._multiPointerEnabled=!0,this._buttons=Xe.None,this._upMap=[],this._downMap=[],this._upList=new Ne,this._downList=new Ne,this._engine=void 0,this._canvas=void 0,this._htmlCanvas=void 0,this._nativeEvents=[],this._pointerPool=void 0,this._hadListener=!1,this._engine=a,this._canvas=a.canvas,this._htmlCanvas=t,t.oncontextmenu=function(e){return!1},this._onPointerEvent=this._onPointerEvent.bind(this),this._updatePointerWithPhysics=this._updatePointerWithPhysics.bind(this),this._updatePointerWithoutPhysics=this._updatePointerWithoutPhysics.bind(this),this._onFocus(),this._pointerPool=new Array(11)}var l=n.prototype;return l._update=function(t){var e=this._pointers,r=this._nativeEvents,i=e.length-1;if(i>=0){for(var o=i;o>=0;o--)e[o].phase===je.Leave&&(o!==i&&(e[o]=e[i]),--i);e.length=i+1}if(i=r.length-1,i>=0){for(var s=0;s<=i;s++){var c,u=r[s];(c=this._getPointer(u.pointerId))===null||c===void 0||c._events.push(u)}r.length=0}if(this._upList.length=this._downList.length=0,this._buttons=Xe.None,i=e.length-1,i>=0)for(var _=this._engine.physicsManager._initialized?this._updatePointerWithPhysics:this._updatePointerWithoutPhysics,h=this._htmlCanvas,d=h.clientWidth,f=h.clientHeight,p=this._canvas,v=p.width,m=p.height,g=i;g>=0;g--){var y=e[g];y._upList.length=y._downList.length=0,_(t,y,d,f,v,m),this._buttons|=y.pressedButtons}},l._onFocus=function(){if(!this._hadListener){var t=this._htmlCanvas,e=this._onPointerEvent;t.addEventListener("pointerdown",e),t.addEventListener("pointerup",e),t.addEventListener("pointerout",e),t.addEventListener("pointermove",e),this._hadListener=!0}},l._onBlur=function(){if(this._hadListener){var t=this._htmlCanvas,e=this._onPointerEvent;t.removeEventListener("pointerdown",e),t.removeEventListener("pointerup",e),t.removeEventListener("pointerout",e),t.removeEventListener("pointermove",e),this._hadListener=!1,this._downList.length=0,this._upList.length=0;for(var r=this._pointers,i=r.length-1;i>=0;i--)r[i].phase=je.Leave;r.length=0}},l._destroy=function(){if(this._hadListener){var t=this._htmlCanvas,e=this._onPointerEvent;t.removeEventListener("pointerdown",e),t.removeEventListener("pointerup",e),t.removeEventListener("pointerout",e),t.removeEventListener("pointermove",e),this._hadListener=!1}this._pointerPool.length=0,this._pointers.length=0,this._downList.length=0,this._upList.length=0,this._htmlCanvas=null,this._engine=null},l._onPointerEvent=function(t){t.cancelable&&t.preventDefault(),t.type==="pointerdown"&&this._htmlCanvas.focus(),this._nativeEvents.push(t)},l._getIndexByPointerID=function(t){for(var e=this._pointers,r=e.length-1;r>=0;r--)if(e[r]._uniqueID===t)return r;return-1},l._getPointer=function(t){var e=this._pointers,r=this._getIndexByPointerID(t);if(r>=0)return e[r];var i=e.length;if(i===0||this._multiPointerEnabled){for(var o=this._pointerPool,s=0;s<i&&!(e[s].id>s);s++);var c=o[s];return c||(c=o[s]=new lu(s)),c._uniqueID=t,e.splice(s,0,c),c}else return null},l._pointerRayCast=function(t,e){for(var r=n._tempPoint,i=n._tempRay,o=n._tempHitResult,s=this._engine.sceneManager.activeScene._activeCameras,c=s.length-1;c>=0;c--){var u=s[c];if(!(!u.enabled||u.renderTarget)){var _=u.viewport,h=_.x,d=_.y,f=_.z,p=_.w;if(t>=h&&e>=d&&t-h<=f&&e-d<=p){if(r.set((t-h)/f,(e-d)/p),this._engine.physicsManager.raycast(u.viewportPointToRay(r,i),Number.MAX_VALUE,u.cullingMask,o))return o.entity;if(u.clearFlags&It.Color)return null}}}},l._updatePointerWithPhysics=function(t,e,r,i,o,s){var c=e._events,u=e.position,_=c.length;if(_>0){var h=this._upList,d=this._upMap,f=this._downList,p=this._downMap,v=c[_-1],m=v.offsetX/r,g=v.offsetY/i,y=m*o,x=g*s;y===u.x&&x===u.y?(e.deltaPosition.set(0,0),e.phase=je.Stationary):(e.deltaPosition.set(y-u.x,x-u.y),e.phase=je.Move),u.set(y,x),e._firePointerDrag();var b=this._pointerRayCast(m,g);e._firePointerExitAndEnter(b);for(var S=0;S<_;S++){var P=c[S],T=P.button;switch(e.button=go[T]||Xe.None,e.pressedButtons=P.buttons,P.type){case"pointerdown":f.add(T),p[T]=t,e._downList.add(T),e._downMap[T]=t,e.phase=je.Down,e._firePointerDown(b);break;case"pointerup":h.add(T),d[T]=t,e._upList.add(T),e._upMap[T]=t,e.phase=je.Up,e._firePointerUpAndClick(b);break;case"pointerout":e.phase=je.Leave,e._firePointerExitAndEnter(null)}}e._events.length=0}else e.deltaPosition.set(0,0),e.phase=je.Stationary,e._firePointerDrag(),e._firePointerExitAndEnter(this._pointerRayCast(u.x/o,u.y/s))},l._updatePointerWithoutPhysics=function(t,e,r,i,o,s){var c=e._events,u=c.length;if(u>0){var _=e.position,h=c[u-1],d=h.offsetX/r*o,f=h.offsetY/i*s;e.deltaPosition.set(d-_.x,f-_.y),_.set(d,f),e.button=go[h.button]||Xe.None,e.pressedButtons=h.buttons;for(var p=this._upList,v=this._upMap,m=this._downList,g=this._downMap,y=0;y<u;y++){var x=c[y].button;switch(c[y].type){case"pointerdown":m.add(x),g[x]=t,e._downList.add(x),e._downMap[x]=t,e.phase=je.Down;break;case"pointerup":p.add(x),v[x]=t,e._upList.add(x),e._upMap[x]=t,e.phase=je.Up;break;case"pointermove":e.phase=je.Move;break;case"pointerout":e.phase=je.Leave}}e._events.length=0}else e.deltaPosition.set(0,0),e.phase=je.Stationary},n}();Mi._tempRay=new Wu;Mi._tempPoint=new X;Mi._tempHitResult=new cu;var p_=function(){function n(a){this._delta=new w,this._nativeEvents=[],this._canvas=void 0,this._hadListener=void 0,this._onWheelEvent=this._onWheelEvent.bind(this),a.addEventListener("wheel",this._onWheelEvent),this._canvas=a,this._hadListener=!0}var l=n.prototype;return l._update=function(){var t=this._delta;t.set(0,0,0);var e=this._nativeEvents;if(e.length>0){for(var r=e.length-1;r>=0;r--){var i=e[r];t.x+=i.deltaX,t.y+=i.deltaY,t.z+=i.deltaZ}e.length=0}},l._onFocus=function(){this._hadListener||(this._canvas.addEventListener("wheel",this._onWheelEvent),this._hadListener=!0)},l._onBlur=function(){this._hadListener&&(this._canvas.removeEventListener("wheel",this._onWheelEvent),this._nativeEvents.length=0,this._delta.set(0,0,0),this._hadListener=!1)},l._destroy=function(){this._hadListener&&(this._canvas.removeEventListener("wheel",this._onWheelEvent),this._hadListener=!1),this._nativeEvents=null},l._onWheelEvent=function(t){t.cancelable&&t.preventDefault(),this._nativeEvents.push(t)},n}(),_u=function(){var n=l.prototype;n.isKeyHeldDown=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameHeldDownList.length>0:this._keyboardManager._curHeldDownKeyToIndexMap[t]!=null:!1},n.isKeyDown=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameDownList.length>0:this._keyboardManager._downKeyToFrameCountMap[t]===this._curFrameCount:!1},n.isKeyUp=function(t){return this._initialized?t===void 0?this._keyboardManager._curFrameUpList.length>0:this._keyboardManager._upKeyToFrameCountMap[t]===this._curFrameCount:!1},n.isPointerHeldDown=function(t){return this._initialized?t===void 0?this._pointerManager._buttons!==0:(this._pointerManager._buttons&t)!==0:!1},n.isPointerDown=function(t){return this._initialized?t===void 0?this._pointerManager._downList.length>0:this._pointerManager._downMap[mo[t]]===this._curFrameCount:!1},n.isPointerUp=function(t){return this._initialized?t===void 0?this._pointerManager._upList.length>0:this._pointerManager._upMap[mo[t]]===this._curFrameCount:!1};function l(a){this._initialized=!1,this._curFrameCount=0,this._wheelManager=void 0,this._pointerManager=void 0,this._keyboardManager=void 0;var t=a._canvas._webCanvas;(typeof OffscreenCanvas>"u"||!(t instanceof OffscreenCanvas))&&(this._wheelManager=new p_(t),this._pointerManager=new Mi(a,t),this._keyboardManager=new n_(t),this._onBlur=this._onBlur.bind(this),window.addEventListener("blur",this._onBlur),this._onFocus=this._onFocus.bind(this),window.addEventListener("focus",this._onFocus),this._initialized=!0)}return n._update=function(){this._initialized&&(++this._curFrameCount,this._wheelManager._update(),this._pointerManager._update(this._curFrameCount),this._keyboardManager._update(this._curFrameCount))},n._destroy=function(){this._initialized&&(window.removeEventListener("blur",this._onBlur),window.removeEventListener("focus",this._onFocus),this._wheelManager._destroy(),this._pointerManager._destroy(),this._keyboardManager._destroy())},n._onBlur=function(){this._wheelManager._onBlur(),this._pointerManager._onBlur(),this._keyboardManager._onBlur()},n._onFocus=function(){this._wheelManager._onFocus(),this._pointerManager._onFocus(),this._keyboardManager._onFocus()},j(l,[{key:"pointers",get:function(){return this._initialized?this._pointerManager._pointers:[]}},{key:"multiPointerEnabled",get:function(){return this._initialized?this._pointerManager._multiPointerEnabled:!1},set:function(t){this._initialized&&(this._pointerManager._multiPointerEnabled=t)}},{key:"wheelDelta",get:function(){return this._initialized?this._wheelManager._delta:null}}]),l}(),Dt;(function(n){n[n.NoCascades=1]="NoCascades",n[n.TwoCascades=2]="TwoCascades",n[n.FourCascades=4]="FourCascades"})(Dt||(Dt={}));var Mr;(function(n){n[n.Low=0]="Low",n[n.Medium=1]="Medium",n[n.High=2]="High",n[n.VeryHigh=3]="VeryHigh"})(Mr||(Mr={}));var Br;(function(n){n[n.None=0]="None",n[n.Hard=1]="Hard",n[n.SoftLow=2]="SoftLow",n[n.SoftHigh=3]="SoftHigh"})(Br||(Br={}));var rt;(function(n){n[n.Opaque=0]="Opaque",n[n.AlphaTest=1]="AlphaTest",n[n.Transparent=2]="Transparent"})(rt||(rt={}));var oe;(function(n){n[n.Zero=0]="Zero",n[n.One=1]="One",n[n.SourceColor=2]="SourceColor",n[n.OneMinusSourceColor=3]="OneMinusSourceColor",n[n.DestinationColor=4]="DestinationColor",n[n.OneMinusDestinationColor=5]="OneMinusDestinationColor",n[n.SourceAlpha=6]="SourceAlpha",n[n.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",n[n.DestinationAlpha=8]="DestinationAlpha",n[n.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",n[n.SourceAlphaSaturate=10]="SourceAlphaSaturate",n[n.BlendColor=11]="BlendColor",n[n.OneMinusBlendColor=12]="OneMinusBlendColor"})(oe||(oe={}));var St;(function(n){n[n.Add=0]="Add",n[n.Subtract=1]="Subtract",n[n.ReverseSubtract=2]="ReverseSubtract",n[n.Min=3]="Min",n[n.Max=4]="Max"})(St||(St={}));var Xt;(function(n){n[n.None=0]="None",n[n.Red=1]="Red",n[n.Green=2]="Green",n[n.Blue=4]="Blue",n[n.Alpha=8]="Alpha",n[n.All=15]="All"})(Xt||(Xt={}));var be;(function(n){n[n.Never=0]="Never",n[n.Less=1]="Less",n[n.Equal=2]="Equal",n[n.LessEqual=3]="LessEqual",n[n.Greater=4]="Greater",n[n.NotEqual=5]="NotEqual",n[n.GreaterEqual=6]="GreaterEqual",n[n.Always=7]="Always"})(be||(be={}));var Pt;(function(n){n[n.Off=0]="Off",n[n.Front=1]="Front",n[n.Back=2]="Back"})(Pt||(Pt={}));var ht;(function(n){n[n.Float=0]="Float",n[n.Int=1]="Int",n[n.Vector2=2]="Vector2",n[n.Vector3=3]="Vector3",n[n.Vector4=4]="Vector4",n[n.Matrix=5]="Matrix",n[n.Color=6]="Color",n[n.Texture=7]="Texture",n[n.FloatArray=8]="FloatArray",n[n.IntArray=9]="IntArray",n[n.TextureArray=10]="TextureArray"})(ht||(ht={}));var He;(function(n){n[n.Keep=0]="Keep",n[n.Zero=1]="Zero",n[n.Replace=2]="Replace",n[n.IncrementSaturate=3]="IncrementSaturate",n[n.DecrementSaturate=4]="DecrementSaturate",n[n.Invert=5]="Invert",n[n.IncrementWrap=6]="IncrementWrap",n[n.DecrementWrap=7]="DecrementWrap"})(He||(He={}));var Ei=function n(l,a,t,e){this.name=void 0,this.value=void 0,this._nameId=void 0,this._maskIndex=void 0,this._maskValue=void 0,this.name=l,this._maskIndex=t,this._maskValue=e,this.value=a;var r=n._macroNameIdMap,i=r[l];r[l]===void 0&&(r[l]=i=n._macroNameCounter++),this._nameId=i};Ei._macroNameIdMap=Object.create(null);Ei._macroNameCounter=0;var Et=function(){function n(){this._mask=[],this._length=0}n.unionCollection=function(t,e,r){var i=r._mask,o,s,c,u;t._length<e._length?(o=t._length,s=e._length,c=t._mask,u=e._mask):(o=e._length,s=t._length,c=e._mask,u=t._mask);var _=0;for(i.length<s&&(i.length=s);_<o;_++)i[_]=c[_]|u[_];for(;_<s;_++)i[_]=u[_];r._length=s};var l=n.prototype;return l.enable=function(t){var e=t._maskIndex,r=e+1,i=this._mask,o=this._length;if(o<r){for(i.length<r&&(i.length=r);o<e;o++)i[o]=0;i[e]=t._maskValue,this._length=r}else i[e]|=t._maskValue},l.disable=function(t){var e=t._maskIndex,r=this._mask,i=this._length-1;if(!(e>i)){var o=r[e]&~t._maskValue;e==i&&o===0?this._length--:r[e]=o}},l.unionCollection=function(t){var e=t._mask,r=t._length,i=this._mask,o=this._length;if(o<r){i.length<r&&(i.length=r);for(var s=0;s<o;s++)i[s]|=e[s];for(;s<r;s++)i[s]=e[s];this._length=r}else for(var c=0;c<r;c++)i[c]|=e[c]},l.complementaryCollection=function(t){for(var e=t._mask,r=this._mask,i=this._length-1,o=Math.min(t._length-1,i);o>=0;o--){var s=r[o]&~e[o];o==i&&s===0?(i--,this._length--):r[o]=s}},l.intersectionCollection=function(t){for(var e=t._mask,r=this._mask,i=this._length-1;i>=0;i--){var o=r[i]&e[i];o==0&&i==this._length-1?this._length--:r[i]=o}},l.isEnable=function(t){var e=t._maskIndex;return e>=this._length?!1:(this._mask[e]&t._maskValue)!==0},l.clear=function(){this._length=0},n}(),g_=`#define GLSLIFY 1
#define PI 3.14159265359
#define RECIPROCAL_PI 0.31830988618
#define EPSILON 1e-6
#define LOG2 1.442695
#define saturate( a ) clamp( a, 0.0, 1.0 )
#define whiteCompliment(a) ( 1.0 - saturate( a ) )
float pow2(float x){return x*x;}vec4 RGBMToLinear(vec4 value,float maxRange){return vec4(value.rgb*value.a*maxRange,1.0);}vec4 gammaToLinear(vec4 srgbIn){return vec4(pow(srgbIn.rgb,vec3(2.2)),srgbIn.a);}vec4 linearToGamma(vec4 linearIn){return vec4(pow(linearIn.rgb,vec3(1.0/2.2)),linearIn.a);}
#ifdef GRAPHICS_API_WEBGL2
#define INVERSE_MAT(mat) inverse(mat)
#else
mat2 inverseMat(mat2 m){return mat2(m[1][1],-m[0][1],-m[1][0],m[0][0])/(m[0][0]*m[1][1]-m[0][1]*m[1][0]);}mat3 inverseMat(mat3 m){float a00=m[0][0],a01=m[0][1],a02=m[0][2];float a10=m[1][0],a11=m[1][1],a12=m[1][2];float a20=m[2][0],a21=m[2][1],a22=m[2][2];float b01=a22*a11-a12*a21;float b11=-a22*a10+a12*a20;float b21=a21*a10-a11*a20;float det=a00*b01+a01*b11+a02*b21;return mat3(b01,(-a22*a01+a02*a21),(a12*a01-a02*a11),b11,(a22*a00-a02*a20),(-a12*a00+a02*a10),b21,(-a21*a00+a01*a20),(a11*a00-a01*a10))/det;}mat4 inverseMat(mat4 m){float a00=m[0][0],a01=m[0][1],a02=m[0][2],a03=m[0][3],a10=m[1][0],a11=m[1][1],a12=m[1][2],a13=m[1][3],a20=m[2][0],a21=m[2][1],a22=m[2][2],a23=m[2][3],a30=m[3][0],a31=m[3][1],a32=m[3][2],a33=m[3][3],b00=a00*a11-a01*a10,b01=a00*a12-a02*a10,b02=a00*a13-a03*a10,b03=a01*a12-a02*a11,b04=a01*a13-a03*a11,b05=a02*a13-a03*a12,b06=a20*a31-a21*a30,b07=a20*a32-a22*a30,b08=a20*a33-a23*a30,b09=a21*a32-a22*a31,b10=a21*a33-a23*a31,b11=a22*a33-a23*a32,det=b00*b11-b01*b10+b02*b09+b03*b08-b04*b07+b05*b06;return mat4(a11*b11-a12*b10+a13*b09,a02*b10-a01*b11-a03*b09,a31*b05-a32*b04+a33*b03,a22*b04-a21*b05-a23*b03,a12*b08-a10*b11-a13*b07,a00*b11-a02*b08+a03*b07,a32*b02-a30*b05-a33*b01,a20*b05-a22*b02+a23*b01,a10*b10-a11*b08+a13*b06,a01*b08-a00*b10-a03*b06,a30*b04-a31*b02+a33*b00,a21*b02-a20*b04-a23*b00,a11*b07-a10*b09-a12*b06,a00*b09-a01*b07+a02*b06,a31*b01-a30*b03-a32*b00,a20*b03-a21*b01+a22*b00)/det;}
#define INVERSE_MAT(mat) inverseMat(mat)
#endif
`,m_=`#define GLSLIFY 1
attribute vec3 POSITION;
#ifdef O3_HAS_UV
attribute vec2 TEXCOORD_0;
#endif
#ifdef O3_HAS_UV1
attribute vec2 TEXCOORD_1;
#endif
#ifdef O3_HAS_SKIN
attribute vec4 JOINTS_0;attribute vec4 WEIGHTS_0;
#ifdef O3_USE_JOINT_TEXTURE
uniform sampler2D u_jointSampler;uniform float u_jointCount;mat4 getJointMatrix(sampler2D smp,float index){float base=index/u_jointCount;float hf=0.5/u_jointCount;float v=base+hf;vec4 m0=texture2D(smp,vec2(0.125,v));vec4 m1=texture2D(smp,vec2(0.375,v));vec4 m2=texture2D(smp,vec2(0.625,v));vec4 m3=texture2D(smp,vec2(0.875,v));return mat4(m0,m1,m2,m3);}
#else
uniform mat4 u_jointMatrix[O3_JOINTS_NUM];
#endif
#endif
#ifdef O3_HAS_VERTEXCOLOR
attribute vec4 COLOR_0;
#endif
uniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;uniform vec4 u_tilingOffset;
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
attribute vec3 NORMAL;
#endif
#ifdef O3_HAS_TANGENT
attribute vec4 TANGENT;
#endif
#endif
`,y_=`#define GLSLIFY 1
uniform mat4 u_localMat;uniform mat4 u_modelMat;uniform mat4 u_viewMat;uniform mat4 u_projMat;uniform mat4 u_MVMat;uniform mat4 u_MVPMat;uniform mat4 u_normalMat;uniform vec3 u_cameraPos;`,x_=`#define GLSLIFY 1
#ifdef O3_HAS_VERTEXCOLOR
varying vec4 v_color;
#endif
`,w_=`#define GLSLIFY 1
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
varying vec3 v_normal;
#if defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
varying mat3 v_TBN;
#endif
#endif
#endif
`,b_=`#define GLSLIFY 1
varying vec2 v_uv;
#ifdef O3_HAS_UV1
varying vec2 v_uv1;
#endif
`,C_=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
varying vec3 v_pos;
#endif
`,S_=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
varying vec3 v_fogDepth;uniform vec3 u_fogColor;
#ifdef O3_FOG_EXP2
uniform float u_fogDensity;
#else
uniform float u_fogNear;uniform float u_fogFar;
#endif
#endif
`,T_=`#define GLSLIFY 1
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
vec3 normal=vec3(NORMAL);
#endif
#ifdef O3_HAS_TANGENT
vec4 tangent=vec4(TANGENT);
#endif
#endif
`,A_=`#define GLSLIFY 1
vec4 position=vec4(POSITION,1.0);`,P_=`#define GLSLIFY 1
gl_Position=u_MVPMat*position;`,M_=`#define GLSLIFY 1
#ifdef O3_HAS_VERTEXCOLOR
v_color=COLOR_0;
#endif
`,E_=`#define GLSLIFY 1
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
v_normal=normalize(mat3(u_normalMat)*normal);
#if defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
vec3 normalW=normalize(mat3(u_normalMat)*normal.xyz);vec3 tangentW=normalize(mat3(u_normalMat)*tangent.xyz);vec3 bitangentW=cross(normalW,tangentW)*tangent.w;v_TBN=mat3(tangentW,bitangentW,normalW);
#endif
#endif
#endif
`,R_=`#define GLSLIFY 1
#ifdef O3_HAS_SKIN
#ifdef O3_USE_JOINT_TEXTURE
mat4 skinMatrix=WEIGHTS_0.x*getJointMatrix(u_jointSampler,JOINTS_0.x)+WEIGHTS_0.y*getJointMatrix(u_jointSampler,JOINTS_0.y)+WEIGHTS_0.z*getJointMatrix(u_jointSampler,JOINTS_0.z)+WEIGHTS_0.w*getJointMatrix(u_jointSampler,JOINTS_0.w);
#else
mat4 skinMatrix=WEIGHTS_0.x*u_jointMatrix[int(JOINTS_0.x)]+WEIGHTS_0.y*u_jointMatrix[int(JOINTS_0.y)]+WEIGHTS_0.z*u_jointMatrix[int(JOINTS_0.z)]+WEIGHTS_0.w*u_jointMatrix[int(JOINTS_0.w)];
#endif
position=skinMatrix*position;
#if defined(O3_HAS_NORMAL) && !defined(OMIT_NORMAL)
mat3 skinNormalMatrix=INVERSE_MAT(mat3(skinMatrix));normal=normal*skinNormalMatrix;
#if defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
tangent.xyz=tangent.xyz*skinNormalMatrix;
#endif
#endif
#endif
`,z_=`#define GLSLIFY 1
#ifdef OASIS_BLENDSHAPE
#ifdef OASIS_BLENDSHAPE_TEXTURE
uniform mediump sampler2DArray u_blendShapeTexture;uniform ivec3 u_blendShapeTextureInfo;uniform float u_blendShapeWeights[OASIS_BLENDSHAPE_COUNT];
#else
attribute vec3 POSITION_BS0;attribute vec3 POSITION_BS1;
#if defined( OASIS_BLENDSHAPE_NORMAL ) && defined( OASIS_BLENDSHAPE_TANGENT )
attribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;uniform float u_blendShapeWeights[2];
#else
#if defined( OASIS_BLENDSHAPE_NORMAL ) || defined( OASIS_BLENDSHAPE_TANGENT )
attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;
#ifdef OASIS_BLENDSHAPE_NORMAL
attribute vec3 NORMAL_BS0;attribute vec3 NORMAL_BS1;attribute vec3 NORMAL_BS2;attribute vec3 NORMAL_BS3;
#endif
#ifdef OASIS_BLENDSHAPE_TANGENT
attribute vec3 TANGENT_BS0;attribute vec3 TANGENT_BS1;attribute vec3 TANGENT_BS2;attribute vec3 TANGENT_BS3;
#endif
uniform float u_blendShapeWeights[4];
#else
attribute vec3 POSITION_BS2;attribute vec3 POSITION_BS3;attribute vec3 POSITION_BS4;attribute vec3 POSITION_BS5;attribute vec3 POSITION_BS6;attribute vec3 POSITION_BS7;uniform float u_blendShapeWeights[8];
#endif
#endif
#endif
#ifdef OASIS_BLENDSHAPE_TEXTURE
vec3 getBlendShapeVertexElement(int blendShapeIndex,int vertexElementIndex){int y=vertexElementIndex/u_blendShapeTextureInfo.y;int x=vertexElementIndex-y*u_blendShapeTextureInfo.y;ivec3 uv=ivec3(x,y,blendShapeIndex);return texelFetch(u_blendShapeTexture,uv,0).xyz;}
#endif
#endif
`,F_=`#define GLSLIFY 1
#ifdef OASIS_BLENDSHAPE
#ifdef OASIS_BLENDSHAPE_TEXTURE
int vertexOffset=gl_VertexID*u_blendShapeTextureInfo.x;for(int i=0;i<OASIS_BLENDSHAPE_COUNT;i++){int vertexElementOffset=vertexOffset;float weight=u_blendShapeWeights[i];position.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#ifndef OMIT_NORMAL
#if defined( O3_HAS_NORMAL ) && defined( OASIS_BLENDSHAPE_NORMAL )
vertexElementOffset+=1;normal+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#endif
#if defined( O3_HAS_TANGENT ) && defined(OASIS_BLENDSHAPE_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
vertexElementOffset+=1;tangent.xyz+=getBlendShapeVertexElement(i,vertexElementOffset)*weight;
#endif
#endif
}
#else
position.xyz+=POSITION_BS0*u_blendShapeWeights[0];position.xyz+=POSITION_BS1*u_blendShapeWeights[1];
#if defined( OASIS_BLENDSHAPE_NORMAL ) && defined( OASIS_BLENDSHAPE_TANGENT )
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
normal+=NORMAL_BS0*u_blendShapeWeights[0];normal+=NORMAL_BS1*u_blendShapeWeights[1];
#endif
#if defined( O3_HAS_TANGENT ) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
tangent.xyz+=TANGENT_BS0*u_blendShapeWeights[0];tangent.xyz+=TANGENT_BS1*u_blendShapeWeights[1];
#endif
#endif
#else
#if defined( OASIS_BLENDSHAPE_NORMAL ) || defined( OASIS_BLENDSHAPE_TANGENT )
#ifndef OMIT_NORMAL
position.xyz+=POSITION_BS2*u_blendShapeWeights[2];position.xyz+=POSITION_BS3*u_blendShapeWeights[3];
#if defined( OASIS_BLENDSHAPE_NORMAL ) && defined( O3_HAS_NORMAL )
normal+=NORMAL_BS0*u_blendShapeWeights[0];normal+=NORMAL_BS1*u_blendShapeWeights[1];normal+=NORMAL_BS2*u_blendShapeWeights[2];normal+=NORMAL_BS3*u_blendShapeWeights[3];
#endif
#if defined(OASIS_BLENDSHAPE_TANGENT) && defined( O3_HAS_TANGENT ) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
tangent.xyz+=TANGENT_BS0*u_blendShapeWeights[0];tangent.xyz+=TANGENT_BS1*u_blendShapeWeights[1];tangent.xyz+=TANGENT_BS2*u_blendShapeWeights[2];tangent.xyz+=TANGENT_BS3*u_blendShapeWeights[3];
#endif
#endif
#else
position.xyz+=POSITION_BS2*u_blendShapeWeights[2];position.xyz+=POSITION_BS3*u_blendShapeWeights[3];position.xyz+=POSITION_BS4*u_blendShapeWeights[4];position.xyz+=POSITION_BS5*u_blendShapeWeights[5];position.xyz+=POSITION_BS6*u_blendShapeWeights[6];position.xyz+=POSITION_BS7*u_blendShapeWeights[7];
#endif
#endif
#endif
#endif
`,B_=`#define GLSLIFY 1
#ifdef O3_HAS_UV
v_uv=TEXCOORD_0;
#else
v_uv=vec2(0.,0.);
#endif
#ifdef O3_HAS_UV1
v_uv1=TEXCOORD_1;
#endif
#ifdef O3_NEED_TILINGOFFSET
v_uv=v_uv*u_tilingOffset.xy+u_tilingOffset.zw;
#endif
`,V_=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
vec4 temp_pos=u_modelMat*position;v_pos=temp_pos.xyz/temp_pos.w;
#endif
`,D_=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
v_fogDepth=(u_MVMat*position).xyz;
#endif
`,L_=`#define GLSLIFY 1
#ifdef O3_DIRECT_LIGHT_COUNT
struct DirectLight{vec3 color;vec3 direction;};uniform vec3 u_directLightColor[O3_DIRECT_LIGHT_COUNT];uniform vec3 u_directLightDirection[O3_DIRECT_LIGHT_COUNT];
#endif
#ifdef O3_POINT_LIGHT_COUNT
struct PointLight{vec3 color;vec3 position;float distance;};uniform vec3 u_pointLightColor[O3_POINT_LIGHT_COUNT];uniform vec3 u_pointLightPosition[O3_POINT_LIGHT_COUNT];uniform float u_pointLightDistance[O3_POINT_LIGHT_COUNT];
#endif
#ifdef O3_SPOT_LIGHT_COUNT
struct SpotLight{vec3 color;vec3 position;vec3 direction;float distance;float angleCos;float penumbraCos;};uniform vec3 u_spotLightColor[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightPosition[O3_SPOT_LIGHT_COUNT];uniform vec3 u_spotLightDirection[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightDistance[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightAngleCos[O3_SPOT_LIGHT_COUNT];uniform float u_spotLightPenumbraCos[O3_SPOT_LIGHT_COUNT];
#endif
struct EnvMapLight{vec3 diffuse;float mipMapLevel;float diffuseIntensity;float specularIntensity;};uniform EnvMapLight u_envMapLight;
#ifdef O3_USE_SH
uniform vec3 u_env_sh[9];
#endif
#ifdef O3_USE_SPECULAR_ENV
uniform samplerCube u_env_specularSampler;
#endif
`,I_=`#define GLSLIFY 1
uniform vec4 u_emissiveColor;uniform vec4 u_baseColor;uniform vec4 u_specularColor;uniform float u_shininess;uniform float u_normalIntensity;uniform float u_alphaCutoff;
#ifdef EMISSIVETEXTURE
uniform sampler2D u_emissiveTexture;
#endif
#ifdef BASETEXTURE
uniform sampler2D u_baseTexture;
#endif
#ifdef O3_SPECULAR_TEXTURE
uniform sampler2D u_specularTexture;
#endif
#ifdef NORMALTEXTURE
uniform sampler2D u_normalTexture;
#endif
`,O_=`#define GLSLIFY 1
#ifdef O3_HAS_FOG
float fogDepth=length(v_fogDepth);
#ifdef O3_FOG_EXP2
float fogFactor=whiteCompliment(exp2(-u_fogDensity*u_fogDensity*fogDepth*fogDepth*LOG2));
#else
float fogFactor=smoothstep(u_fogNear,u_fogFar,fogDepth);
#endif
gl_FragColor.rgb=mix(gl_FragColor.rgb,u_fogColor,fogFactor);
#endif
`,N_=`#define GLSLIFY 1
vec4 ambient=vec4(0.0);vec4 emission=u_emissiveColor;vec4 diffuse=u_baseColor;vec4 specular=u_specularColor;
#ifdef EMISSIVETEXTURE
vec4 emissiveTextureColor=texture2D(u_emissiveTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
emissiveTextureColor=gammaToLinear(emissiveTextureColor);
#endif
emission*=emissiveTextureColor;
#endif
#ifdef BASETEXTURE
vec4 diffuseTextureColor=texture2D(u_baseTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
diffuseTextureColor=gammaToLinear(diffuseTextureColor);
#endif
diffuse*=diffuseTextureColor;
#endif
#ifdef O3_HAS_VERTEXCOLOR
diffuse*=v_color;
#endif
#ifdef O3_SPECULAR_TEXTURE
vec4 specularTextureColor=texture2D(u_specularTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
specularTextureColor=gammaToLinear(specularTextureColor);
#endif
specular*=specularTextureColor;
#endif
ambient=vec4(u_envMapLight.diffuse*u_envMapLight.diffuseIntensity,1.0)*diffuse;`,U_=`#define GLSLIFY 1
#ifdef O3_NEED_WORLDPOS
vec3 V=normalize(u_cameraPos-v_pos);
#endif
`,k_=`#define GLSLIFY 1
#ifdef NORMALTEXTURE
mat3 tbn=getTBN();vec3 N=getNormalByNormalTexture(tbn,u_normalTexture,u_normalIntensity,v_uv);
#else
vec3 N=getNormal();
#endif
vec3 lightDiffuse=vec3(0.0,0.0,0.0);vec3 lightSpecular=vec3(0.0,0.0,0.0);float shadowAttenuation=1.0;
#ifdef O3_DIRECT_LIGHT_COUNT
shadowAttenuation=1.0;
#ifdef OASIS_CALCULATE_SHADOWS
shadowAttenuation*=sampleShadowMap();int sunIndex=int(u_shadowInfo.z);
#endif
DirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];
#ifdef OASIS_CALCULATE_SHADOWS
if(i==sunIndex){directionalLight.color*=shadowAttenuation;}
#endif
directionalLight.direction=u_directLightDirection[i];float d=max(dot(N,-directionalLight.direction),0.0);lightDiffuse+=directionalLight.color*d;vec3 halfDir=normalize(V-directionalLight.direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess);lightSpecular+=directionalLight.color*s;}
#endif
#ifdef O3_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];vec3 direction=v_pos-pointLight.position;float dist=length(direction);direction/=dist;float decay=clamp(1.0-pow(dist/pointLight.distance,4.0),0.0,1.0);float d=max(dot(N,-direction),0.0)*decay;lightDiffuse+=pointLight.color*d;vec3 halfDir=normalize(V-direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decay;lightSpecular+=pointLight.color*s;}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];vec3 direction=spotLight.position-v_pos;float lightDistance=length(direction);direction/=lightDistance;float angleCos=dot(direction,-spotLight.direction);float decay=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayTotal=decay*spotEffect;float d=max(dot(N,direction),0.0)*decayTotal;lightDiffuse+=spotLight.color*d;vec3 halfDir=normalize(V+direction);float s=pow(clamp(dot(N,halfDir),0.0,1.0),u_shininess)*decayTotal;lightSpecular+=spotLight.color*s;}
#endif
diffuse*=vec4(lightDiffuse,1.0);specular*=vec4(lightSpecular,1.0);
#ifdef ALPHA_CUTOFF
if(diffuse.a<u_alphaCutoff){discard;}
#endif
`,G_=`#define GLSLIFY 1
vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec2 mod289(vec2 x){return x-floor(x*(1.0/289.0))*289.0;}float mod289(float x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod7(vec4 x){return x-floor(x*(1.0/7.0))*7.0;}vec3 mod7(vec3 x){return x-floor(x*(1.0/7.0))*7.0;}vec4 permute(vec4 x){return mod289((34.0*x+1.0)*x);}vec3 permute(vec3 x){return mod289((34.0*x+1.0)*x);}float permute(float x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float taylorInvSqrt(float r){return 1.79284291400159-0.85373472095314*r;}vec4 fade(vec4 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec3 fade(vec3 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}vec2 fade(vec2 t){return t*t*t*(t*(t*6.0-15.0)+10.0);}
#define K 0.142857142857
#define Ko 0.428571428571
#define K2 0.020408163265306
#define Kd2 0.0714285714285
#define Kz 0.166666666667
#define Kzo 0.416666666667
#define jitter 1.0
#define jitter1 0.8
`,H_=`#define GLSLIFY 1
vec2 cellular(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec3 oi=vec3(-1.0,0.0,1.0);vec3 of=vec3(-0.5,0.5,1.5);vec3 px=permute(Pi.x+oi);vec3 p=permute(px.x+Pi.y+oi);vec3 ox=fract(p*K)-Ko;vec3 oy=mod7(floor(p*K))*K-Ko;vec3 dx=Pf.x+0.5+jitter*ox;vec3 dy=Pf.y-of+jitter*oy;vec3 d1=dx*dx+dy*dy;p=permute(px.y+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-0.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d2=dx*dx+dy*dy;p=permute(px.z+Pi.y+oi);ox=fract(p*K)-Ko;oy=mod7(floor(p*K))*K-Ko;dx=Pf.x-1.5+jitter*ox;dy=Pf.y-of+jitter*oy;vec3 d3=dx*dx+dy*dy;vec3 d1a=min(d1,d2);d2=max(d1,d2);d2=min(d2,d3);d1=min(d1a,d2);d2=max(d1a,d2);d1.xy=(d1.x<d1.y)? d1.xy : d1.yx;d1.xz=(d1.x<d1.z)? d1.xz : d1.zx;d1.yz=min(d1.yz,d2.yz);d1.y=min(d1.y,d1.z);d1.y=min(d1.y,d2.x);return sqrt(d1.xy);}`,W_=`#define GLSLIFY 1
vec2 cellular2x2(vec2 P){vec2 Pi=mod289(floor(P));vec2 Pf=fract(P);vec4 Pfx=Pf.x+vec4(-0.5,-1.5,-0.5,-1.5);vec4 Pfy=Pf.y+vec4(-0.5,-0.5,-1.5,-1.5);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 ox=mod7(p)*K+Kd2;vec4 oy=mod7(floor(p*K))*K+Kd2;vec4 dx=Pfx+jitter1*ox;vec4 dy=Pfy+jitter1*oy;vec4 d=dx*dx+dy*dy;d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.y=min(d.y,d.z);d.y=min(d.y,d.w);return sqrt(d.xy);}`,X_=`#define GLSLIFY 1
vec2 cellular2x2x2(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P);vec4 Pfx=Pf.x+vec4(0.0,-1.0,0.0,-1.0);vec4 Pfy=Pf.y+vec4(0.0,0.0,-1.0,-1.0);vec4 p=permute(Pi.x+vec4(0.0,1.0,0.0,1.0));p=permute(p+Pi.y+vec4(0.0,0.0,1.0,1.0));vec4 p1=permute(p+Pi.z);vec4 p2=permute(p+Pi.z+vec4(1.0));vec4 ox1=fract(p1*K)-Ko;vec4 oy1=mod7(floor(p1*K))*K-Ko;vec4 oz1=floor(p1*K2)*Kz-Kzo;vec4 ox2=fract(p2*K)-Ko;vec4 oy2=mod7(floor(p2*K))*K-Ko;vec4 oz2=floor(p2*K2)*Kz-Kzo;vec4 dx1=Pfx+jitter1*ox1;vec4 dy1=Pfy+jitter1*oy1;vec4 dz1=Pf.z+jitter1*oz1;vec4 dx2=Pfx+jitter1*ox2;vec4 dy2=Pfy+jitter1*oy2;vec4 dz2=Pf.z-1.0+jitter1*oz2;vec4 d1=dx1*dx1+dy1*dy1+dz1*dz1;vec4 d2=dx2*dx2+dy2*dy2+dz2*dz2;vec4 d=min(d1,d2);d2=max(d1,d2);d.xy=(d.x<d.y)? d.xy : d.yx;d.xz=(d.x<d.z)? d.xz : d.zx;d.xw=(d.x<d.w)? d.xw : d.wx;d.yzw=min(d.yzw,d2.yzw);d.y=min(d.y,d.z);d.y=min(d.y,d.w);d.y=min(d.y,d2.x);return sqrt(d.xy);}`,q_=`#define GLSLIFY 1
vec2 cellular(vec3 P){vec3 Pi=mod289(floor(P));vec3 Pf=fract(P)-0.5;vec3 Pfx=Pf.x+vec3(1.0,0.0,-1.0);vec3 Pfy=Pf.y+vec3(1.0,0.0,-1.0);vec3 Pfz=Pf.z+vec3(1.0,0.0,-1.0);vec3 p=permute(Pi.x+vec3(-1.0,0.0,1.0));vec3 p1=permute(p+Pi.y-1.0);vec3 p2=permute(p+Pi.y);vec3 p3=permute(p+Pi.y+1.0);vec3 p11=permute(p1+Pi.z-1.0);vec3 p12=permute(p1+Pi.z);vec3 p13=permute(p1+Pi.z+1.0);vec3 p21=permute(p2+Pi.z-1.0);vec3 p22=permute(p2+Pi.z);vec3 p23=permute(p2+Pi.z+1.0);vec3 p31=permute(p3+Pi.z-1.0);vec3 p32=permute(p3+Pi.z);vec3 p33=permute(p3+Pi.z+1.0);vec3 ox11=fract(p11*K)-Ko;vec3 oy11=mod7(floor(p11*K))*K-Ko;vec3 oz11=floor(p11*K2)*Kz-Kzo;vec3 ox12=fract(p12*K)-Ko;vec3 oy12=mod7(floor(p12*K))*K-Ko;vec3 oz12=floor(p12*K2)*Kz-Kzo;vec3 ox13=fract(p13*K)-Ko;vec3 oy13=mod7(floor(p13*K))*K-Ko;vec3 oz13=floor(p13*K2)*Kz-Kzo;vec3 ox21=fract(p21*K)-Ko;vec3 oy21=mod7(floor(p21*K))*K-Ko;vec3 oz21=floor(p21*K2)*Kz-Kzo;vec3 ox22=fract(p22*K)-Ko;vec3 oy22=mod7(floor(p22*K))*K-Ko;vec3 oz22=floor(p22*K2)*Kz-Kzo;vec3 ox23=fract(p23*K)-Ko;vec3 oy23=mod7(floor(p23*K))*K-Ko;vec3 oz23=floor(p23*K2)*Kz-Kzo;vec3 ox31=fract(p31*K)-Ko;vec3 oy31=mod7(floor(p31*K))*K-Ko;vec3 oz31=floor(p31*K2)*Kz-Kzo;vec3 ox32=fract(p32*K)-Ko;vec3 oy32=mod7(floor(p32*K))*K-Ko;vec3 oz32=floor(p32*K2)*Kz-Kzo;vec3 ox33=fract(p33*K)-Ko;vec3 oy33=mod7(floor(p33*K))*K-Ko;vec3 oz33=floor(p33*K2)*Kz-Kzo;vec3 dx11=Pfx+jitter*ox11;vec3 dy11=Pfy.x+jitter*oy11;vec3 dz11=Pfz.x+jitter*oz11;vec3 dx12=Pfx+jitter*ox12;vec3 dy12=Pfy.x+jitter*oy12;vec3 dz12=Pfz.y+jitter*oz12;vec3 dx13=Pfx+jitter*ox13;vec3 dy13=Pfy.x+jitter*oy13;vec3 dz13=Pfz.z+jitter*oz13;vec3 dx21=Pfx+jitter*ox21;vec3 dy21=Pfy.y+jitter*oy21;vec3 dz21=Pfz.x+jitter*oz21;vec3 dx22=Pfx+jitter*ox22;vec3 dy22=Pfy.y+jitter*oy22;vec3 dz22=Pfz.y+jitter*oz22;vec3 dx23=Pfx+jitter*ox23;vec3 dy23=Pfy.y+jitter*oy23;vec3 dz23=Pfz.z+jitter*oz23;vec3 dx31=Pfx+jitter*ox31;vec3 dy31=Pfy.z+jitter*oy31;vec3 dz31=Pfz.x+jitter*oz31;vec3 dx32=Pfx+jitter*ox32;vec3 dy32=Pfy.z+jitter*oy32;vec3 dz32=Pfz.y+jitter*oz32;vec3 dx33=Pfx+jitter*ox33;vec3 dy33=Pfy.z+jitter*oy33;vec3 dz33=Pfz.z+jitter*oz33;vec3 d11=dx11*dx11+dy11*dy11+dz11*dz11;vec3 d12=dx12*dx12+dy12*dy12+dz12*dz12;vec3 d13=dx13*dx13+dy13*dy13+dz13*dz13;vec3 d21=dx21*dx21+dy21*dy21+dz21*dz21;vec3 d22=dx22*dx22+dy22*dy22+dz22*dz22;vec3 d23=dx23*dx23+dy23*dy23+dz23*dz23;vec3 d31=dx31*dx31+dy31*dy31+dz31*dz31;vec3 d32=dx32*dx32+dy32*dy32+dz32*dz32;vec3 d33=dx33*dx33+dy33*dy33+dz33*dz33;vec3 d1a=min(d11,d12);d12=max(d11,d12);d11=min(d1a,d13);d13=max(d1a,d13);d12=min(d12,d13);vec3 d2a=min(d21,d22);d22=max(d21,d22);d21=min(d2a,d23);d23=max(d2a,d23);d22=min(d22,d23);vec3 d3a=min(d31,d32);d32=max(d31,d32);d31=min(d3a,d33);d33=max(d3a,d33);d32=min(d32,d33);vec3 da=min(d11,d21);d21=max(d11,d21);d11=min(da,d31);d31=max(da,d31);d11.xy=(d11.x<d11.y)? d11.xy : d11.yx;d11.xz=(d11.x<d11.z)? d11.xz : d11.zx;d12=min(d12,d21);d12=min(d12,d22);d12=min(d12,d31);d12=min(d12,d32);d11.yz=min(d11.yz,d12.xy);d11.y=min(d11.y,d12.z);d11.y=min(d11.y,d11.z);return sqrt(d11.xy);}`,j_=`#define GLSLIFY 1
#include <noise_cellular_2D>
#include <noise_cellular_3D>
#include <noise_cellular_2x2>
#include <noise_cellular_2x2x2>
`,$_=`#define GLSLIFY 1
float perlin(vec2 P){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}float perlin(vec2 P,vec2 rep){vec4 Pi=floor(P.xyxy)+vec4(0.0,0.0,1.0,1.0);vec4 Pf=fract(P.xyxy)-vec4(0.0,0.0,1.0,1.0);Pi=mod(Pi,rep.xyxy);Pi=mod289(Pi);vec4 ix=Pi.xzxz;vec4 iy=Pi.yyww;vec4 fx=Pf.xzxz;vec4 fy=Pf.yyww;vec4 i=permute(permute(ix)+iy);vec4 gx=fract(i*(1.0/41.0))*2.0-1.0;vec4 gy=abs(gx)-0.5;vec4 tx=floor(gx+0.5);gx=gx-tx;vec2 g00=vec2(gx.x,gy.x);vec2 g10=vec2(gx.y,gy.y);vec2 g01=vec2(gx.z,gy.z);vec2 g11=vec2(gx.w,gy.w);vec4 norm=taylorInvSqrt(vec4(dot(g00,g00),dot(g01,g01),dot(g10,g10),dot(g11,g11)));g00*=norm.x;g01*=norm.y;g10*=norm.z;g11*=norm.w;float n00=dot(g00,vec2(fx.x,fy.x));float n10=dot(g10,vec2(fx.y,fy.y));float n01=dot(g01,vec2(fx.z,fy.z));float n11=dot(g11,vec2(fx.w,fy.w));vec2 fade_xy=fade(Pf.xy);vec2 n_x=mix(vec2(n00,n01),vec2(n10,n11),fade_xy.x);float n_xy=mix(n_x.x,n_x.y,fade_xy.y);return 2.3*n_xy;}`,Y_=`#define GLSLIFY 1
float perlin(vec3 P){vec3 Pi0=floor(P);vec3 Pi1=Pi0+vec3(1.0);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}float perlin(vec3 P,vec3 rep){vec3 Pi0=mod(floor(P),rep);vec3 Pi1=mod(Pi0+vec3(1.0),rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec3 Pf0=fract(P);vec3 Pf1=Pf0-vec3(1.0);vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=Pi0.zzzz;vec4 iz1=Pi1.zzzz;vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 gx0=ixy0*(1.0/7.0);vec4 gy0=fract(floor(gx0)*(1.0/7.0))-0.5;gx0=fract(gx0);vec4 gz0=vec4(0.5)-abs(gx0)-abs(gy0);vec4 sz0=step(gz0,vec4(0.0));gx0-=sz0*(step(0.0,gx0)-0.5);gy0-=sz0*(step(0.0,gy0)-0.5);vec4 gx1=ixy1*(1.0/7.0);vec4 gy1=fract(floor(gx1)*(1.0/7.0))-0.5;gx1=fract(gx1);vec4 gz1=vec4(0.5)-abs(gx1)-abs(gy1);vec4 sz1=step(gz1,vec4(0.0));gx1-=sz1*(step(0.0,gx1)-0.5);gy1-=sz1*(step(0.0,gy1)-0.5);vec3 g000=vec3(gx0.x,gy0.x,gz0.x);vec3 g100=vec3(gx0.y,gy0.y,gz0.y);vec3 g010=vec3(gx0.z,gy0.z,gz0.z);vec3 g110=vec3(gx0.w,gy0.w,gz0.w);vec3 g001=vec3(gx1.x,gy1.x,gz1.x);vec3 g101=vec3(gx1.y,gy1.y,gz1.y);vec3 g011=vec3(gx1.z,gy1.z,gz1.z);vec3 g111=vec3(gx1.w,gy1.w,gz1.w);vec4 norm0=taylorInvSqrt(vec4(dot(g000,g000),dot(g010,g010),dot(g100,g100),dot(g110,g110)));g000*=norm0.x;g010*=norm0.y;g100*=norm0.z;g110*=norm0.w;vec4 norm1=taylorInvSqrt(vec4(dot(g001,g001),dot(g011,g011),dot(g101,g101),dot(g111,g111)));g001*=norm1.x;g011*=norm1.y;g101*=norm1.z;g111*=norm1.w;float n000=dot(g000,Pf0);float n100=dot(g100,vec3(Pf1.x,Pf0.yz));float n010=dot(g010,vec3(Pf0.x,Pf1.y,Pf0.z));float n110=dot(g110,vec3(Pf1.xy,Pf0.z));float n001=dot(g001,vec3(Pf0.xy,Pf1.z));float n101=dot(g101,vec3(Pf1.x,Pf0.y,Pf1.z));float n011=dot(g011,vec3(Pf0.x,Pf1.yz));float n111=dot(g111,Pf1);vec3 fade_xyz=fade(Pf0);vec4 n_z=mix(vec4(n000,n100,n010,n110),vec4(n001,n101,n011,n111),fade_xyz.z);vec2 n_yz=mix(n_z.xy,n_z.zw,fade_xyz.y);float n_xyz=mix(n_yz.x,n_yz.y,fade_xyz.x);return 2.2*n_xyz;}`,Q_=`#define GLSLIFY 1
float perlin(vec4 P){vec4 Pi0=floor(P);vec4 Pi1=Pi0+1.0;Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}float perlin(vec4 P,vec4 rep){vec4 Pi0=mod(floor(P),rep);vec4 Pi1=mod(Pi0+1.0,rep);Pi0=mod289(Pi0);Pi1=mod289(Pi1);vec4 Pf0=fract(P);vec4 Pf1=Pf0-1.0;vec4 ix=vec4(Pi0.x,Pi1.x,Pi0.x,Pi1.x);vec4 iy=vec4(Pi0.yy,Pi1.yy);vec4 iz0=vec4(Pi0.zzzz);vec4 iz1=vec4(Pi1.zzzz);vec4 iw0=vec4(Pi0.wwww);vec4 iw1=vec4(Pi1.wwww);vec4 ixy=permute(permute(ix)+iy);vec4 ixy0=permute(ixy+iz0);vec4 ixy1=permute(ixy+iz1);vec4 ixy00=permute(ixy0+iw0);vec4 ixy01=permute(ixy0+iw1);vec4 ixy10=permute(ixy1+iw0);vec4 ixy11=permute(ixy1+iw1);vec4 gx00=ixy00*(1.0/7.0);vec4 gy00=floor(gx00)*(1.0/7.0);vec4 gz00=floor(gy00)*(1.0/6.0);gx00=fract(gx00)-0.5;gy00=fract(gy00)-0.5;gz00=fract(gz00)-0.5;vec4 gw00=vec4(0.75)-abs(gx00)-abs(gy00)-abs(gz00);vec4 sw00=step(gw00,vec4(0.0));gx00-=sw00*(step(0.0,gx00)-0.5);gy00-=sw00*(step(0.0,gy00)-0.5);vec4 gx01=ixy01*(1.0/7.0);vec4 gy01=floor(gx01)*(1.0/7.0);vec4 gz01=floor(gy01)*(1.0/6.0);gx01=fract(gx01)-0.5;gy01=fract(gy01)-0.5;gz01=fract(gz01)-0.5;vec4 gw01=vec4(0.75)-abs(gx01)-abs(gy01)-abs(gz01);vec4 sw01=step(gw01,vec4(0.0));gx01-=sw01*(step(0.0,gx01)-0.5);gy01-=sw01*(step(0.0,gy01)-0.5);vec4 gx10=ixy10*(1.0/7.0);vec4 gy10=floor(gx10)*(1.0/7.0);vec4 gz10=floor(gy10)*(1.0/6.0);gx10=fract(gx10)-0.5;gy10=fract(gy10)-0.5;gz10=fract(gz10)-0.5;vec4 gw10=vec4(0.75)-abs(gx10)-abs(gy10)-abs(gz10);vec4 sw10=step(gw10,vec4(0.0));gx10-=sw10*(step(0.0,gx10)-0.5);gy10-=sw10*(step(0.0,gy10)-0.5);vec4 gx11=ixy11*(1.0/7.0);vec4 gy11=floor(gx11)*(1.0/7.0);vec4 gz11=floor(gy11)*(1.0/6.0);gx11=fract(gx11)-0.5;gy11=fract(gy11)-0.5;gz11=fract(gz11)-0.5;vec4 gw11=vec4(0.75)-abs(gx11)-abs(gy11)-abs(gz11);vec4 sw11=step(gw11,vec4(0.0));gx11-=sw11*(step(0.0,gx11)-0.5);gy11-=sw11*(step(0.0,gy11)-0.5);vec4 g0000=vec4(gx00.x,gy00.x,gz00.x,gw00.x);vec4 g1000=vec4(gx00.y,gy00.y,gz00.y,gw00.y);vec4 g0100=vec4(gx00.z,gy00.z,gz00.z,gw00.z);vec4 g1100=vec4(gx00.w,gy00.w,gz00.w,gw00.w);vec4 g0010=vec4(gx10.x,gy10.x,gz10.x,gw10.x);vec4 g1010=vec4(gx10.y,gy10.y,gz10.y,gw10.y);vec4 g0110=vec4(gx10.z,gy10.z,gz10.z,gw10.z);vec4 g1110=vec4(gx10.w,gy10.w,gz10.w,gw10.w);vec4 g0001=vec4(gx01.x,gy01.x,gz01.x,gw01.x);vec4 g1001=vec4(gx01.y,gy01.y,gz01.y,gw01.y);vec4 g0101=vec4(gx01.z,gy01.z,gz01.z,gw01.z);vec4 g1101=vec4(gx01.w,gy01.w,gz01.w,gw01.w);vec4 g0011=vec4(gx11.x,gy11.x,gz11.x,gw11.x);vec4 g1011=vec4(gx11.y,gy11.y,gz11.y,gw11.y);vec4 g0111=vec4(gx11.z,gy11.z,gz11.z,gw11.z);vec4 g1111=vec4(gx11.w,gy11.w,gz11.w,gw11.w);vec4 norm00=taylorInvSqrt(vec4(dot(g0000,g0000),dot(g0100,g0100),dot(g1000,g1000),dot(g1100,g1100)));g0000*=norm00.x;g0100*=norm00.y;g1000*=norm00.z;g1100*=norm00.w;vec4 norm01=taylorInvSqrt(vec4(dot(g0001,g0001),dot(g0101,g0101),dot(g1001,g1001),dot(g1101,g1101)));g0001*=norm01.x;g0101*=norm01.y;g1001*=norm01.z;g1101*=norm01.w;vec4 norm10=taylorInvSqrt(vec4(dot(g0010,g0010),dot(g0110,g0110),dot(g1010,g1010),dot(g1110,g1110)));g0010*=norm10.x;g0110*=norm10.y;g1010*=norm10.z;g1110*=norm10.w;vec4 norm11=taylorInvSqrt(vec4(dot(g0011,g0011),dot(g0111,g0111),dot(g1011,g1011),dot(g1111,g1111)));g0011*=norm11.x;g0111*=norm11.y;g1011*=norm11.z;g1111*=norm11.w;float n0000=dot(g0000,Pf0);float n1000=dot(g1000,vec4(Pf1.x,Pf0.yzw));float n0100=dot(g0100,vec4(Pf0.x,Pf1.y,Pf0.zw));float n1100=dot(g1100,vec4(Pf1.xy,Pf0.zw));float n0010=dot(g0010,vec4(Pf0.xy,Pf1.z,Pf0.w));float n1010=dot(g1010,vec4(Pf1.x,Pf0.y,Pf1.z,Pf0.w));float n0110=dot(g0110,vec4(Pf0.x,Pf1.yz,Pf0.w));float n1110=dot(g1110,vec4(Pf1.xyz,Pf0.w));float n0001=dot(g0001,vec4(Pf0.xyz,Pf1.w));float n1001=dot(g1001,vec4(Pf1.x,Pf0.yz,Pf1.w));float n0101=dot(g0101,vec4(Pf0.x,Pf1.y,Pf0.z,Pf1.w));float n1101=dot(g1101,vec4(Pf1.xy,Pf0.z,Pf1.w));float n0011=dot(g0011,vec4(Pf0.xy,Pf1.zw));float n1011=dot(g1011,vec4(Pf1.x,Pf0.y,Pf1.zw));float n0111=dot(g0111,vec4(Pf0.x,Pf1.yzw));float n1111=dot(g1111,Pf1);vec4 fade_xyzw=fade(Pf0);vec4 n_0w=mix(vec4(n0000,n1000,n0100,n1100),vec4(n0001,n1001,n0101,n1101),fade_xyzw.w);vec4 n_1w=mix(vec4(n0010,n1010,n0110,n1110),vec4(n0011,n1011,n0111,n1111),fade_xyzw.w);vec4 n_zw=mix(n_0w,n_1w,fade_xyzw.z);vec2 n_yzw=mix(n_zw.xy,n_zw.zw,fade_xyzw.y);float n_xyzw=mix(n_yzw.x,n_yzw.y,fade_xyzw.x);return 2.2*n_xyzw;}`,J_=`#define GLSLIFY 1
#include <noise_perlin_2D>
#include <noise_perlin_3D>
#include <noise_perlin_4D>
`,Z_=`#define GLSLIFY 1
vec2 rgrad2(vec2 p,float rot){float u=permute(permute(p.x)+p.y)*0.0243902439+rot;u=fract(u)*6.28318530718;return vec2(cos(u),sin(u));}vec3 psrdnoise(vec2 pos,vec2 per,float rot){pos.y+=0.01;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 psdnoise(vec2 pos,vec2 per){return psrdnoise(pos,per,0.0);}float psrnoise(vec2 pos,vec2 per,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 xw=mod(vec3(p0.x,p1.x,p2.x),per.x);vec3 yw=mod(vec3(p0.y,p1.y,p2.y),per.y);vec3 iuw=xw+0.5*yw;vec3 ivw=yw;vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float psnoise(vec2 pos,vec2 per){return psrnoise(pos,per,0.0);}vec3 srdnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));vec3 dtdx=-2.0*vec3(d0.x,d1.x,d2.x);vec3 dtdy=-2.0*vec3(d0.y,d1.y,d2.y);if(t.x<0.0){dtdx.x=0.0;dtdy.x=0.0;t.x=0.0;}if(t.y<0.0){dtdx.y=0.0;dtdy.y=0.0;t.y=0.0;}if(t.z<0.0){dtdx.z=0.0;dtdy.z=0.0;t.z=0.0;}vec3 t2=t*t;vec3 t4=t2*t2;vec3 t3=t2*t;float n=dot(t4,w);vec2 dt0=vec2(dtdx.x,dtdy.x)*4.0*t3.x;vec2 dn0=t4.x*g0+dt0*w.x;vec2 dt1=vec2(dtdx.y,dtdy.y)*4.0*t3.y;vec2 dn1=t4.y*g1+dt1*w.y;vec2 dt2=vec2(dtdx.z,dtdy.z)*4.0*t3.z;vec2 dn2=t4.z*g2+dt2*w.z;return 11.0*vec3(n,dn0+dn1+dn2);}vec3 sdnoise(vec2 pos){return srdnoise(pos,0.0);}float srnoise(vec2 pos,float rot){pos.y+=0.001;vec2 uv=vec2(pos.x+pos.y*0.5,pos.y);vec2 i0=floor(uv);vec2 f0=fract(uv);vec2 i1=(f0.x>f0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec2 p0=vec2(i0.x-i0.y*0.5,i0.y);vec2 p1=vec2(p0.x+i1.x-i1.y*0.5,p0.y+i1.y);vec2 p2=vec2(p0.x+0.5,p0.y+1.0);i1=i0+i1;vec2 i2=i0+vec2(1.0,1.0);vec2 d0=pos-p0;vec2 d1=pos-p1;vec2 d2=pos-p2;vec3 x=vec3(p0.x,p1.x,p2.x);vec3 y=vec3(p0.y,p1.y,p2.y);vec3 iuw=x+0.5*y;vec3 ivw=y;iuw=mod289(iuw);ivw=mod289(ivw);vec2 g0=rgrad2(vec2(iuw.x,ivw.x),rot);vec2 g1=rgrad2(vec2(iuw.y,ivw.y),rot);vec2 g2=rgrad2(vec2(iuw.z,ivw.z),rot);vec3 w=vec3(dot(g0,d0),dot(g1,d1),dot(g2,d2));vec3 t=0.8-vec3(dot(d0,d0),dot(d1,d1),dot(d2,d2));t=max(t,0.0);vec3 t2=t*t;vec3 t4=t2*t2;float n=dot(t4,w);return 11.0*n;}float snoise(vec2 pos){return srnoise(pos,0.0);}`,K_=`#define GLSLIFY 1
float simplex(vec2 v){const vec4 C=vec4(0.211324865405187,0.366025403784439,-0.577350269189626,0.024390243902439);vec2 i=floor(v+dot(v,C.yy));vec2 x0=v-i+dot(i,C.xx);vec2 i1;i1=(x0.x>x0.y)? vec2(1.0,0.0): vec2(0.0,1.0);vec4 x12=x0.xyxy+C.xxzz;x12.xy-=i1;i=mod289(i);vec3 p=permute(permute(i.y+vec3(0.0,i1.y,1.0))+i.x+vec3(0.0,i1.x,1.0));vec3 m=max(0.5-vec3(dot(x0,x0),dot(x12.xy,x12.xy),dot(x12.zw,x12.zw)),0.0);m=m*m;m=m*m;vec3 x=2.0*fract(p*C.www)-1.0;vec3 h=abs(x)-0.5;vec3 ox=floor(x+0.5);vec3 a0=x-ox;m*=1.79284291400159-0.85373472095314*(a0*a0+h*h);vec3 g;g.x=a0.x*x0.x+h.x*x0.y;g.yz=a0.yz*x12.xz+h.yz*x12.yw;return 130.0*dot(m,g);}`,eh=`#define GLSLIFY 1
float simplex(vec3 v,out vec3 gradient){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);vec4 m2=m*m;vec4 m4=m2*m2;vec4 pdotx=vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3));vec4 temp=m2*m*pdotx;gradient=-8.0*(temp.x*x0+temp.y*x1+temp.z*x2+temp.w*x3);gradient+=m4.x*p0+m4.y*p1+m4.z*p2+m4.w*p3;gradient*=42.0;return 42.0*dot(m4,pdotx);}`,th=`#define GLSLIFY 1
float simplex(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`,rh=`#define GLSLIFY 1
vec4 grad4(float j,vec4 ip){const vec4 ones=vec4(1.0,1.0,1.0,-1.0);vec4 p,s;p.xyz=floor(fract(vec3(j)*ip.xyz)*7.0)*ip.z-1.0;p.w=1.5-dot(abs(p.xyz),ones.xyz);s=vec4(lessThan(p,vec4(0.0)));p.xyz=p.xyz+(s.xyz*2.0-1.0)*s.www;return p;}
#define F4 0.309016994374947451
float simplex(vec4 v){const vec4 C=vec4(0.138196601125011,0.276393202250021,0.414589803375032,-0.447213595499958);vec4 i=floor(v+dot(v,vec4(F4)));vec4 x0=v-i+dot(i,C.xxxx);vec4 i0;vec3 isX=step(x0.yzw,x0.xxx);vec3 isYZ=step(x0.zww,x0.yyz);i0.x=isX.x+isX.y+isX.z;i0.yzw=1.0-isX;i0.y+=isYZ.x+isYZ.y;i0.zw+=1.0-isYZ.xy;i0.z+=isYZ.z;i0.w+=1.0-isYZ.z;vec4 i3=clamp(i0,0.0,1.0);vec4 i2=clamp(i0-1.0,0.0,1.0);vec4 i1=clamp(i0-2.0,0.0,1.0);vec4 x1=x0-i1+C.xxxx;vec4 x2=x0-i2+C.yyyy;vec4 x3=x0-i3+C.zzzz;vec4 x4=x0+C.wwww;i=mod289(i);float j0=permute(permute(permute(permute(i.w)+i.z)+i.y)+i.x);vec4 j1=permute(permute(permute(permute(i.w+vec4(i1.w,i2.w,i3.w,1.0))+i.z+vec4(i1.z,i2.z,i3.z,1.0))+i.y+vec4(i1.y,i2.y,i3.y,1.0))+i.x+vec4(i1.x,i2.x,i3.x,1.0));vec4 ip=vec4(1.0/294.0,1.0/49.0,1.0/7.0,0.0);vec4 p0=grad4(j0,ip);vec4 p1=grad4(j1.x,ip);vec4 p2=grad4(j1.y,ip);vec4 p3=grad4(j1.z,ip);vec4 p4=grad4(j1.w,ip);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;p4*=taylorInvSqrt(dot(p4,p4));vec3 m0=max(0.6-vec3(dot(x0,x0),dot(x1,x1),dot(x2,x2)),0.0);vec2 m1=max(0.6-vec2(dot(x3,x3),dot(x4,x4)),0.0);m0=m0*m0;m1=m1*m1;return 49.0*(dot(m0*m0,vec3(dot(p0,x0),dot(p1,x1),dot(p2,x2)))+dot(m1*m1,vec2(dot(p3,x3),dot(p4,x4))));}`,nh=`#define GLSLIFY 1
#include <noise_simplex_2D>
#include <noise_simplex_3D>
#include <noise_simplex_3D_grad>
#include <noise_simplex_4D>
`,ih=`#define GLSLIFY 1
uniform float u_alphaCutoff;uniform vec4 u_baseColor;uniform float u_metal;uniform float u_roughness;uniform vec3 u_PBRSpecularColor;uniform float u_glossiness;uniform vec3 u_emissiveColor;
#ifdef CLEARCOAT
uniform float u_clearCoat;uniform float u_clearCoatRoughness;
#endif
uniform float u_normalIntensity;uniform float u_occlusionIntensity;uniform float u_occlusionTextureCoord;
#ifdef BASETEXTURE
uniform sampler2D u_baseTexture;
#endif
#ifdef NORMALTEXTURE
uniform sampler2D u_normalTexture;
#endif
#ifdef EMISSIVETEXTURE
uniform sampler2D u_emissiveTexture;
#endif
#ifdef ROUGHNESSMETALLICTEXTURE
uniform sampler2D u_roughnessMetallicTexture;
#endif
#ifdef SPECULARGLOSSINESSTEXTURE
uniform sampler2D u_specularGlossinessTexture;
#endif
#ifdef OCCLUSIONTEXTURE
uniform sampler2D u_occlusionTexture;
#endif
#ifdef HAS_CLEARCOATTEXTURE
uniform sampler2D u_clearCoatTexture;
#endif
#ifdef HAS_CLEARCOATROUGHNESSTEXTURE
uniform sampler2D u_clearCoatRoughnessTexture;
#endif
#ifdef HAS_CLEARCOATNORMALTEXTURE
uniform sampler2D u_clearCoatNormalTexture;
#endif
struct ReflectedLight{vec3 directDiffuse;vec3 directSpecular;vec3 indirectDiffuse;vec3 indirectSpecular;};struct Geometry{vec3 position;vec3 normal;vec3 viewDir;float dotNV;
#ifdef CLEARCOAT
vec3 clearCoatNormal;float clearCoatDotNV;
#endif
};struct Material{vec3 diffuseColor;float roughness;vec3 specularColor;float opacity;
#ifdef CLEARCOAT
float clearCoat;float clearCoatRoughness;
#endif
};`,ah=`#define GLSLIFY 1
#include <normal_get>
float computeSpecularOcclusion(float ambientOcclusion,float roughness,float dotNV){return saturate(pow(dotNV+ambientOcclusion,exp2(-16.0*roughness-1.0))-1.0+ambientOcclusion);}float getAARoughnessFactor(vec3 normal){
#ifdef HAS_DERIVATIVES
vec3 dxy=max(abs(dFdx(normal)),abs(dFdy(normal)));return 0.04+max(max(dxy.x,dxy.y),dxy.z);
#else
return 0.04;
#endif
}void initGeometry(out Geometry geometry){geometry.position=v_pos;geometry.viewDir=normalize(u_cameraPos-v_pos);
#if defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE)
mat3 tbn=getTBN();
#endif
#ifdef NORMALTEXTURE
geometry.normal=getNormalByNormalTexture(tbn,u_normalTexture,u_normalIntensity,v_uv);
#else
geometry.normal=getNormal();
#endif
geometry.dotNV=saturate(dot(geometry.normal,geometry.viewDir));
#ifdef CLEARCOAT
#ifdef HAS_CLEARCOATNORMALTEXTURE
geometry.clearCoatNormal=getNormalByNormalTexture(tbn,u_clearCoatNormalTexture,u_normalIntensity,v_uv);
#else
geometry.clearCoatNormal=getNormal();
#endif
geometry.clearCoatDotNV=saturate(dot(geometry.clearCoatNormal,geometry.viewDir));
#endif
}void initMaterial(out Material material,const in Geometry geometry){vec4 baseColor=u_baseColor;float metal=u_metal;float roughness=u_roughness;vec3 specularColor=u_PBRSpecularColor;float glossiness=u_glossiness;float alphaCutoff=u_alphaCutoff;
#ifdef BASETEXTURE
vec4 baseTextureColor=texture2D(u_baseTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
baseTextureColor=gammaToLinear(baseTextureColor);
#endif
baseColor*=baseTextureColor;
#endif
#ifdef O3_HAS_VERTEXCOLOR
baseColor*=v_color;
#endif
#ifdef ALPHA_CUTOFF
if(baseColor.a<alphaCutoff){discard;}
#endif
#ifdef ROUGHNESSMETALLICTEXTURE
vec4 metalRoughMapColor=texture2D(u_roughnessMetallicTexture,v_uv);roughness*=metalRoughMapColor.g;metal*=metalRoughMapColor.b;
#endif
#ifdef SPECULARGLOSSINESSTEXTURE
vec4 specularGlossinessColor=texture2D(u_specularGlossinessTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
specularGlossinessColor=gammaToLinear(specularGlossinessColor);
#endif
specularColor*=specularGlossinessColor.rgb;glossiness*=specularGlossinessColor.a;
#endif
#ifdef IS_METALLIC_WORKFLOW
material.diffuseColor=baseColor.rgb*(1.0-metal);material.specularColor=mix(vec3(0.04),baseColor.rgb,metal);material.roughness=roughness;
#else
float specularStrength=max(max(specularColor.r,specularColor.g),specularColor.b);material.diffuseColor=baseColor.rgb*(1.0-specularStrength);material.specularColor=specularColor;material.roughness=1.0-glossiness;
#endif
material.roughness=max(material.roughness,getAARoughnessFactor(geometry.normal));
#ifdef CLEARCOAT
material.clearCoat=u_clearCoat;material.clearCoatRoughness=u_clearCoatRoughness;
#ifdef HAS_CLEARCOATTEXTURE
material.clearCoat*=texture2D(u_clearCoatTexture,v_uv).r;
#endif
#ifdef HAS_CLEARCOATROUGHNESSTEXTURE
material.clearCoatRoughness*=texture2D(u_clearCoatRoughnessTexture,v_uv).g;
#endif
material.clearCoat=saturate(material.clearCoat);material.clearCoatRoughness=max(material.clearCoatRoughness,getAARoughnessFactor(geometry.clearCoatNormal));
#endif
material.opacity=baseColor.a;}
#include <brdf>
#include <direct_irradiance_frag_define>
#include <ibl_frag_define>
`,oh=`#define GLSLIFY 1
float F_Schlick(float dotLH){return 0.04+0.96*(pow(1.0-dotLH,5.0));}vec3 F_Schlick(vec3 specularColor,float dotLH){float fresnel=exp2((-5.55473*dotLH-6.98316)*dotLH);return(1.0-specularColor)*fresnel+specularColor;}float G_GGX_SmithCorrelated(float alpha,float dotNL,float dotNV){float a2=pow2(alpha);float gv=dotNL*sqrt(a2+(1.0-a2)*pow2(dotNV));float gl=dotNV*sqrt(a2+(1.0-a2)*pow2(dotNL));return 0.5/max(gv+gl,EPSILON);}float D_GGX(float alpha,float dotNH){float a2=pow2(alpha);float denom=pow2(dotNH)*(a2-1.0)+1.0;return RECIPROCAL_PI*a2/pow2(denom);}vec3 BRDF_Specular_GGX(vec3 incidentDirection,vec3 viewDir,vec3 normal,vec3 specularColor,float roughness){float alpha=pow2(roughness);vec3 halfDir=normalize(incidentDirection+viewDir);float dotNL=saturate(dot(normal,incidentDirection));float dotNV=saturate(dot(normal,viewDir));float dotNH=saturate(dot(normal,halfDir));float dotLH=saturate(dot(incidentDirection,halfDir));vec3 F=F_Schlick(specularColor,dotLH);float G=G_GGX_SmithCorrelated(alpha,dotNL,dotNV);float D=D_GGX(alpha,dotNH);return F*(G*D);}vec3 BRDF_Diffuse_Lambert(vec3 diffuseColor){return RECIPROCAL_PI*diffuseColor;}`,sh=`#define GLSLIFY 1
#include <shadow_frag_share>
void addDirectRadiance(vec3 incidentDirection,vec3 color,Geometry geometry,Material material,inout ReflectedLight reflectedLight){float attenuation=1.0;
#ifdef CLEARCOAT
float clearCoatDotNL=saturate(dot(geometry.clearCoatNormal,incidentDirection));vec3 clearCoatIrradiance=clearCoatDotNL*color;reflectedLight.directSpecular+=material.clearCoat*clearCoatIrradiance*BRDF_Specular_GGX(incidentDirection,geometry.viewDir,geometry.clearCoatNormal,vec3(0.04),material.clearCoatRoughness);attenuation-=material.clearCoat*F_Schlick(geometry.clearCoatDotNV);
#endif
float dotNL=saturate(dot(geometry.normal,incidentDirection));vec3 irradiance=dotNL*color*PI;reflectedLight.directSpecular+=attenuation*irradiance*BRDF_Specular_GGX(incidentDirection,geometry.viewDir,geometry.normal,material.specularColor,material.roughness);reflectedLight.directDiffuse+=attenuation*irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);}
#ifdef O3_DIRECT_LIGHT_COUNT
void addDirectionalDirectLightRadiance(DirectLight directionalLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 color=directionalLight.color;vec3 direction=-directionalLight.direction;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef O3_POINT_LIGHT_COUNT
void addPointDirectLightRadiance(PointLight pointLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=pointLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);vec3 color=pointLight.color;color*=clamp(1.0-pow(lightDistance/pointLight.distance,4.0),0.0,1.0);addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
void addSpotDirectLightRadiance(SpotLight spotLight,Geometry geometry,Material material,inout ReflectedLight reflectedLight){vec3 lVector=spotLight.position-geometry.position;vec3 direction=normalize(lVector);float lightDistance=length(lVector);float angleCos=dot(direction,-spotLight.direction);float spotEffect=smoothstep(spotLight.penumbraCos,spotLight.angleCos,angleCos);float decayEffect=clamp(1.0-pow(lightDistance/spotLight.distance,4.0),0.0,1.0);vec3 color=spotLight.color;color*=spotEffect*decayEffect;addDirectRadiance(direction,color,geometry,material,reflectedLight);}
#endif
void addTotalDirectRadiance(Geometry geometry,Material material,inout ReflectedLight reflectedLight){float shadowAttenuation=1.0;
#ifdef O3_DIRECT_LIGHT_COUNT
shadowAttenuation=1.0;
#ifdef OASIS_CALCULATE_SHADOWS
shadowAttenuation*=sampleShadowMap();int sunIndex=int(u_shadowInfo.z);
#endif
DirectLight directionalLight;for(int i=0;i<O3_DIRECT_LIGHT_COUNT;i++){directionalLight.color=u_directLightColor[i];
#ifdef OASIS_CALCULATE_SHADOWS
if(i==sunIndex){directionalLight.color*=shadowAttenuation;}
#endif
directionalLight.direction=u_directLightDirection[i];addDirectionalDirectLightRadiance(directionalLight,geometry,material,reflectedLight);}
#endif
#ifdef O3_POINT_LIGHT_COUNT
PointLight pointLight;for(int i=0;i<O3_POINT_LIGHT_COUNT;i++){pointLight.color=u_pointLightColor[i];pointLight.position=u_pointLightPosition[i];pointLight.distance=u_pointLightDistance[i];addPointDirectLightRadiance(pointLight,geometry,material,reflectedLight);}
#endif
#ifdef O3_SPOT_LIGHT_COUNT
SpotLight spotLight;for(int i=0;i<O3_SPOT_LIGHT_COUNT;i++){spotLight.color=u_spotLightColor[i];spotLight.position=u_spotLightPosition[i];spotLight.direction=u_spotLightDirection[i];spotLight.distance=u_spotLightDistance[i];spotLight.angleCos=u_spotLightAngleCos[i];spotLight.penumbraCos=u_spotLightPenumbraCos[i];addSpotDirectLightRadiance(spotLight,geometry,material,reflectedLight);}
#endif
}`,lh=`#define GLSLIFY 1
vec3 getLightProbeIrradiance(vec3 sh[9],vec3 normal){normal.x=-normal.x;vec3 result=sh[0]+sh[1]*(normal.y)+sh[2]*(normal.z)+sh[3]*(normal.x)+sh[4]*(normal.y*normal.x)+sh[5]*(normal.y*normal.z)+sh[6]*(3.0*normal.z*normal.z-1.0)+sh[7]*(normal.z*normal.x)+sh[8]*(normal.x*normal.x-normal.y*normal.y);return max(result,vec3(0.0));}vec3 envBRDFApprox(vec3 specularColor,float roughness,float dotNV){const vec4 c0=vec4(-1,-0.0275,-0.572,0.022);const vec4 c1=vec4(1,0.0425,1.04,-0.04);vec4 r=roughness*c0+c1;float a004=min(r.x*r.x,exp2(-9.28*dotNV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}float getSpecularMIPLevel(float roughness,int maxMIPLevel){return roughness*float(maxMIPLevel);}vec3 getLightProbeRadiance(vec3 viewDir,vec3 normal,float roughness,int maxMIPLevel,float specularIntensity){
#ifndef O3_USE_SPECULAR_ENV
return vec3(0);
#else
vec3 reflectVec=reflect(-viewDir,normal);reflectVec.x=-reflectVec.x;float specularMIPLevel=getSpecularMIPLevel(roughness,maxMIPLevel);
#ifdef HAS_TEX_LOD
vec4 envMapColor=textureCubeLodEXT(u_env_specularSampler,reflectVec,specularMIPLevel);
#else
vec4 envMapColor=textureCube(u_env_specularSampler,reflectVec,specularMIPLevel);
#endif
#ifdef O3_DECODE_ENV_RGBM
envMapColor.rgb=RGBMToLinear(envMapColor,5.0).rgb;
#ifdef OASIS_COLORSPACE_GAMMA
envMapColor=linearToGamma(envMapColor);
#endif
#else
#ifndef OASIS_COLORSPACE_GAMMA
envMapColor=gammaToLinear(envMapColor);
#endif
#endif
return envMapColor.rgb*specularIntensity;
#endif
}`,ch=`#define GLSLIFY 1
Geometry geometry;Material material;ReflectedLight reflectedLight=ReflectedLight(vec3(0.0),vec3(0.0),vec3(0.0),vec3(0.0));initGeometry(geometry);initMaterial(material,geometry);addTotalDirectRadiance(geometry,material,reflectedLight);
#ifdef O3_USE_SH
vec3 irradiance=getLightProbeIrradiance(u_env_sh,geometry.normal);
#ifdef OASIS_COLORSPACE_GAMMA
irradiance=linearToGamma(vec4(irradiance,1.0)).rgb;
#endif
irradiance*=u_envMapLight.diffuseIntensity;
#else
vec3 irradiance=u_envMapLight.diffuse*u_envMapLight.diffuseIntensity;irradiance*=PI;
#endif
reflectedLight.indirectDiffuse+=irradiance*BRDF_Diffuse_Lambert(material.diffuseColor);vec3 radiance=getLightProbeRadiance(geometry.viewDir,geometry.normal,material.roughness,int(u_envMapLight.mipMapLevel),u_envMapLight.specularIntensity);float radianceAttenuation=1.0;
#ifdef CLEARCOAT
vec3 clearCoatRadiance=getLightProbeRadiance(geometry.viewDir,geometry.clearCoatNormal,material.clearCoatRoughness,int(u_envMapLight.mipMapLevel),u_envMapLight.specularIntensity);reflectedLight.indirectSpecular+=clearCoatRadiance*material.clearCoat*envBRDFApprox(vec3(0.04),material.clearCoatRoughness,geometry.clearCoatDotNV);radianceAttenuation-=material.clearCoat*F_Schlick(geometry.clearCoatDotNV);
#endif
reflectedLight.indirectSpecular+=radianceAttenuation*radiance*envBRDFApprox(material.specularColor,material.roughness,geometry.dotNV);
#ifdef OCCLUSIONTEXTURE
vec2 aoUV=v_uv;
#ifdef O3_HAS_UV1
if(u_occlusionTextureCoord==1.0){aoUV=v_uv1;}
#endif
float ambientOcclusion=(texture2D(u_occlusionTexture,aoUV).r-1.0)*u_occlusionIntensity+1.0;reflectedLight.indirectDiffuse*=ambientOcclusion;
#ifdef O3_USE_SPECULAR_ENV
reflectedLight.indirectSpecular*=computeSpecularOcclusion(ambientOcclusion,material.roughness,geometry.dotNV);
#endif
#endif
vec3 emissiveRadiance=u_emissiveColor;
#ifdef EMISSIVETEXTURE
vec4 emissiveColor=texture2D(u_emissiveTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
emissiveColor=gammaToLinear(emissiveColor);
#endif
emissiveRadiance*=emissiveColor.rgb;
#endif
vec3 totalRadiance=reflectedLight.directDiffuse+reflectedLight.indirectDiffuse+reflectedLight.directSpecular+reflectedLight.indirectSpecular+emissiveRadiance;vec4 targetColor=vec4(totalRadiance,material.opacity);
#ifndef OASIS_COLORSPACE_GAMMA
targetColor=linearToGamma(targetColor);
#endif
gl_FragColor=targetColor;`,uh={pbr_frag_define:ih,pbr_helper:ah,brdf:oh,direct_irradiance_frag_define:sh,ibl_frag_define:lh,pbr_frag:ch},_h=`#define GLSLIFY 1
#if defined(CASCADED_SHADOW_MAP)&&defined(OASIS_RECEIVE_SHADOWS)
#define OASIS_CALCULATE_SHADOWS
#endif
#ifdef OASIS_CALCULATE_SHADOWS
uniform vec3 u_shadowInfo;uniform mat4 u_viewProjMatFromLight[4];uniform vec4 u_shadowSplitSpheres[4];varying vec3 view_pos;
#ifdef GRAPHICS_API_WEBGL2
const vec2 offsets[4]=vec2[](vec2(0,0),vec2(0.5,0),vec2(0,0.5),vec2(0.5,0.5));uniform mediump sampler2DShadow u_shadowMap;
#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) textureLod(textureName, coord3 , 0.0)
#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2DShadow shadowMap
#else
uniform sampler2D u_shadowMap;
#ifdef OASIS_NO_DEPTH_TEXTURE
const vec4 bitShift=vec4(1.0,1.0/256.0,1.0/(256.0*256.0),1.0/(256.0*256.0*256.0));float unpack(const in vec4 rgbaDepth){return dot(rgbaDepth,bitShift);}
#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (unpack(texture2D(textureName, coord3.xy)) < coord3.z ? 0.0 : 1.0)
#else
#define SAMPLE_TEXTURE2D_SHADOW(textureName, coord3) (texture2D(textureName, coord3.xy).r < coord3.z ? 0.0 : 1.0)
#endif
#define TEXTURE2D_SHADOW_PARAM(shadowMap) mediump sampler2D shadowMap
#endif
mediump int computeCascadeIndex(vec3 positionWS){vec3 fromCenter0=positionWS-u_shadowSplitSpheres[0].xyz;vec3 fromCenter1=positionWS-u_shadowSplitSpheres[1].xyz;vec3 fromCenter2=positionWS-u_shadowSplitSpheres[2].xyz;vec3 fromCenter3=positionWS-u_shadowSplitSpheres[3].xyz;mediump vec4 comparison=vec4(dot(fromCenter0,fromCenter0)<u_shadowSplitSpheres[0].w,dot(fromCenter1,fromCenter1)<u_shadowSplitSpheres[1].w,dot(fromCenter2,fromCenter2)<u_shadowSplitSpheres[2].w,dot(fromCenter3,fromCenter3)<u_shadowSplitSpheres[3].w);comparison.yzw=clamp(comparison.yzw-comparison.xyz,0.0,1.0);mediump vec4 indexCoefficient=vec4(4.0,3.0,2.0,1.0);mediump int index=4-int(dot(comparison,indexCoefficient));return index;}vec3 getShadowCoord(){int cascadeIndex=computeCascadeIndex(v_pos);
#ifdef GRAPHICS_API_WEBGL2
vec2 offsets=offsets[cascadeIndex];mat4 viewProjMatFromLight=u_viewProjMatFromLight[cascadeIndex];
#else
vec2 offsets=vec2(0.0);mat4 viewProjMatFromLight;if(cascadeIndex==0){viewProjMatFromLight=u_viewProjMatFromLight[0];offsets=vec2(0.0,0.0);}else if(cascadeIndex==1){viewProjMatFromLight=u_viewProjMatFromLight[1];offsets=vec2(0.5,0.0);}else if(cascadeIndex==2){viewProjMatFromLight=u_viewProjMatFromLight[2];offsets=vec2(0.0,0.5);}else{viewProjMatFromLight=u_viewProjMatFromLight[3];offsets=vec2(0.5,0.5);}
#endif
#if CASCADED_COUNT == 1
float scaleX=1.0;float scaleY=1.0;
#endif
#if CASCADED_COUNT == 2
float scaleX=0.5;float scaleY=1.0;
#endif
#if CASCADED_COUNT == 4
float scaleX=0.5;float scaleY=0.5;
#endif
vec4 positionFromLight=viewProjMatFromLight*vec4(v_pos,1.0);vec3 shadowCoord=positionFromLight.xyz/positionFromLight.w;shadowCoord=shadowCoord*0.5+0.5;vec3 coord=shadowCoord.xyz;coord.x*=scaleX;coord.y*=scaleY;coord.xy+=offsets;return coord;}
#if SHADOW_MODE == 2
float sampleShadowMapFiltered4(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,float size){vec2 shadowMapSize=vec2(0.5)/vec2(size,size);float attenuation;vec4 attenuation4;vec2 offset=shadowMapSize.xy/2.0;vec3 shadowCoord0=shadowCoord+vec3(-offset,0.0);vec3 shadowCoord1=shadowCoord+vec3(offset.x,-offset.y,0.0);vec3 shadowCoord2=shadowCoord+vec3(-offset.x,offset.y,0.0);vec3 shadowCoord3=shadowCoord+vec3(offset,0.0);attenuation4.x=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord0);attenuation4.y=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord1);attenuation4.z=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord2);attenuation4.w=SAMPLE_TEXTURE2D_SHADOW(shadowMap,shadowCoord3);attenuation=dot(attenuation4,vec4(0.25));return attenuation;}
#endif
#if SHADOW_MODE == 3
#include <shadow_sample_tent>
float sampleShadowMapFiltered9(TEXTURE2D_SHADOW_PARAM(shadowMap),vec3 shadowCoord,float size){float attenuation;float fetchesWeights[9];vec2 fetchesUV[9];sampleShadowComputeSamplesTent5x5(size,shadowCoord.xy,fetchesWeights,fetchesUV);attenuation=fetchesWeights[0]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[0].xy,shadowCoord.z));attenuation+=fetchesWeights[1]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[1].xy,shadowCoord.z));attenuation+=fetchesWeights[2]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[2].xy,shadowCoord.z));attenuation+=fetchesWeights[3]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[3].xy,shadowCoord.z));attenuation+=fetchesWeights[4]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[4].xy,shadowCoord.z));attenuation+=fetchesWeights[5]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[5].xy,shadowCoord.z));attenuation+=fetchesWeights[6]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[6].xy,shadowCoord.z));attenuation+=fetchesWeights[7]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[7].xy,shadowCoord.z));attenuation+=fetchesWeights[8]*SAMPLE_TEXTURE2D_SHADOW(shadowMap,vec3(fetchesUV[8].xy,shadowCoord.z));return attenuation;}
#endif
float sampleShadowMap(){vec3 shadowCoord=getShadowCoord();float attenuation=1.0;if(shadowCoord.z>0.0&&shadowCoord.z<1.0){
#if SHADOW_MODE == 1
attenuation=SAMPLE_TEXTURE2D_SHADOW(u_shadowMap,shadowCoord);
#endif
#if SHADOW_MODE == 2
attenuation=sampleShadowMapFiltered4(u_shadowMap,shadowCoord,u_shadowInfo.y);
#endif
#if SHADOW_MODE == 3
attenuation=sampleShadowMapFiltered9(u_shadowMap,shadowCoord,u_shadowInfo.y);
#endif
attenuation=mix(1.0,attenuation,u_shadowInfo.x);}return attenuation;}
#endif
`,hh=`#define GLSLIFY 1
float sampleShadowGetIRTriangleTexelArea(float triangleHeight){return triangleHeight-0.5;}void sampleShadowGetTexelAreasTent3x3(float offset,out vec4 computedArea,out vec4 computedAreaUncut){float a=offset+0.5;float offsetSquaredHalved=a*a*0.5;computedAreaUncut.x=computedArea.x=offsetSquaredHalved-offset;computedAreaUncut.w=computedArea.w=offsetSquaredHalved;computedAreaUncut.y=sampleShadowGetIRTriangleTexelArea(1.5-offset);float clampedOffsetLeft=min(offset,0.0);float areaOfSmallLeftTriangle=clampedOffsetLeft*clampedOffsetLeft;computedArea.y=computedAreaUncut.y-areaOfSmallLeftTriangle;computedAreaUncut.z=sampleShadowGetIRTriangleTexelArea(1.5+offset);float clampedOffsetRight=max(offset,0.0);float areaOfSmallRightTriangle=clampedOffsetRight*clampedOffsetRight;computedArea.z=computedAreaUncut.z-areaOfSmallRightTriangle;}void sampleShadowGetTexelWeightsTent5x5(float offset,out vec3 texelsWeightsA,out vec3 texelsWeightsB){vec4 areaFrom3texelTriangle;vec4 areaUncutFrom3texelTriangle;sampleShadowGetTexelAreasTent3x3(offset,areaFrom3texelTriangle,areaUncutFrom3texelTriangle);texelsWeightsA.x=0.16*(areaFrom3texelTriangle.x);texelsWeightsA.y=0.16*(areaUncutFrom3texelTriangle.y);texelsWeightsA.z=0.16*(areaFrom3texelTriangle.y+1.0);texelsWeightsB.x=0.16*(areaFrom3texelTriangle.z+1.0);texelsWeightsB.y=0.16*(areaUncutFrom3texelTriangle.z);texelsWeightsB.z=0.16*(areaFrom3texelTriangle.w);}void sampleShadowComputeSamplesTent5x5(float size,vec2 coord,out float fetchesWeights[9],out vec2 fetchesUV[9]){float invSize=1.0/size;vec2 tentCenterInTexelSpace=coord.xy*size;vec2 centerOfFetchesInTexelSpace=floor(tentCenterInTexelSpace+0.5);vec2 offsetFromTentCenterToCenterOfFetches=tentCenterInTexelSpace-centerOfFetchesInTexelSpace;vec3 texelsWeightsUA,texelsWeightsUB;vec3 texelsWeightsVA,texelsWeightsVB;sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.x,texelsWeightsUA,texelsWeightsUB);sampleShadowGetTexelWeightsTent5x5(offsetFromTentCenterToCenterOfFetches.y,texelsWeightsVA,texelsWeightsVB);vec3 fetchesWeightsU=vec3(texelsWeightsUA.xz,texelsWeightsUB.y)+vec3(texelsWeightsUA.y,texelsWeightsUB.xz);vec3 fetchesWeightsV=vec3(texelsWeightsVA.xz,texelsWeightsVB.y)+vec3(texelsWeightsVA.y,texelsWeightsVB.xz);vec3 fetchesOffsetsU=vec3(texelsWeightsUA.y,texelsWeightsUB.xz)/fetchesWeightsU.xyz+vec3(-2.5,-0.5,1.5);vec3 fetchesOffsetsV=vec3(texelsWeightsVA.y,texelsWeightsVB.xz)/fetchesWeightsV.xyz+vec3(-2.5,-0.5,1.5);fetchesOffsetsU*=invSize;fetchesOffsetsV*=invSize;vec2 bilinearFetchOrigin=centerOfFetchesInTexelSpace*invSize;fetchesUV[0]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.x);fetchesUV[1]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.x);fetchesUV[2]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.x);fetchesUV[3]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.y);fetchesUV[4]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.y);fetchesUV[5]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.y);fetchesUV[6]=bilinearFetchOrigin+vec2(fetchesOffsetsU.x,fetchesOffsetsV.z);fetchesUV[7]=bilinearFetchOrigin+vec2(fetchesOffsetsU.y,fetchesOffsetsV.z);fetchesUV[8]=bilinearFetchOrigin+vec2(fetchesOffsetsU.z,fetchesOffsetsV.z);fetchesWeights[0]=fetchesWeightsU.x*fetchesWeightsV.x;fetchesWeights[1]=fetchesWeightsU.y*fetchesWeightsV.x;fetchesWeights[2]=fetchesWeightsU.z*fetchesWeightsV.x;fetchesWeights[3]=fetchesWeightsU.x*fetchesWeightsV.y;fetchesWeights[4]=fetchesWeightsU.y*fetchesWeightsV.y;fetchesWeights[5]=fetchesWeightsU.z*fetchesWeightsV.y;fetchesWeights[6]=fetchesWeightsU.x*fetchesWeightsV.z;fetchesWeights[7]=fetchesWeightsU.y*fetchesWeightsV.z;fetchesWeights[8]=fetchesWeightsU.z*fetchesWeightsV.z;}`,dh={shadow_frag_share:_h,shadow_sample_tent:hh},fh=`#define GLSLIFY 1
vec3 getNormal(){
#ifdef O3_HAS_NORMAL
vec3 normal=normalize(v_normal);
#elif defined(HAS_DERIVATIVES)
vec3 pos_dx=dFdx(v_pos);vec3 pos_dy=dFdy(v_pos);vec3 normal=normalize(cross(pos_dx,pos_dy));
#else
vec3 normal=vec3(0,0,1);
#endif
normal*=float(gl_FrontFacing)*2.0-1.0;return normal;}vec3 getNormalByNormalTexture(mat3 tbn,sampler2D normalTexture,float normalIntensity,vec2 uv){vec3 normal=texture2D(normalTexture,uv).rgb;normal=normalize(tbn*((2.0*normal-1.0)*vec3(normalIntensity,normalIntensity,1.0)));normal*=float(gl_FrontFacing)*2.0-1.0;return normal;}mat3 getTBN(){
#if defined(O3_HAS_NORMAL) && defined(O3_HAS_TANGENT) && ( defined(NORMALTEXTURE) || defined(HAS_CLEARCOATNORMALTEXTURE) )
mat3 tbn=v_TBN;
#else
vec3 normal=getNormal();vec3 position=v_pos;vec2 uv=gl_FrontFacing? v_uv:-v_uv;
#ifdef HAS_DERIVATIVES
vec3 dp1=dFdx(position);vec3 dp2=dFdy(position);vec2 duv1=dFdx(uv);vec2 duv2=dFdy(uv);vec3 dp2perp=cross(dp2,normal);vec3 dp1perp=cross(normal,dp1);vec3 tangent=dp2perp*duv1.x+dp1perp*duv2.x;vec3 binormal=dp2perp*duv1.y+dp1perp*duv2.y;float invmax=inversesqrt(max(dot(tangent,tangent),dot(binormal,binormal)));mat3 tbn=mat3(tangent*invmax,binormal*invmax,normal);
#else
mat3 tbn=mat3(vec3(0.0),vec3(0.0),normal);
#endif
#endif
return tbn;}`,vh=ki(ki(ki({common:g_,common_vert:m_,common_frag:y_,color_share:x_,normal_share:w_,uv_share:b_,worldpos_share:C_,fog_share:S_,begin_normal_vert:T_,begin_position_vert:A_,position_vert:P_,color_vert:M_,normal_vert:E_,skinning_vert:R_,blendShape_input:z_,blendShape_vert:F_,uv_vert:B_,worldpos_vert:V_,fog_vert:D_,light_frag_define:L_,mobile_material_frag:I_,fog_frag:O_,begin_mobile_frag:N_,begin_viewdir_frag:U_,mobile_blinnphong_frag:k_,noise_common:G_,noise_cellular_2D:H_,noise_cellular_2x2:W_,noise_cellular_2x2x2:X_,noise_cellular_3D:q_,noise_cellular:j_,noise_perlin_2D:$_,noise_perlin_3D:Y_,noise_perlin_4D:Q_,noise_perlin:J_,noise_psrd_2D:Z_,noise_simplex_2D:K_,noise_simplex_3D_grad:eh,noise_simplex_3D:th,noise_simplex_4D:rh,noise_simplex:nh},dh),uh),{},{normal_get:fh}),Xr=function(){function n(){}return n.parseCustomMacros=function(a){return a.map(function(t){return"#define "+t+`
`}).join("")},n.parseIncludes=function(a){var t=/^[ \t]*#include +<([\w\d.]+)>/gm;function e(r,i){var o=vh[i];return o===void 0?(ce.error('Shader slice "'+r.trim()+'" not founded.'),""):n.parseIncludes(o)}return a.replace(t,e)},n.parseExtension=function(a){return a.map(function(t){return"#extension "+t+` : enable
`}).join("")},n.convertTo300=function(a,t){if(a=a.replace(/\battribute\b/g,"in"),a=a.replace(/\bvarying\b/g,t?"in":"out"),a=a.replace(/\btexture(2D|Cube)\b/g,"texture"),a=a.replace(/\btexture(2D|Cube)LodEXT\b/g,"textureLod"),t){var e=/\bgl_FragData\[.+?\]/g.test(a);if(e){a=a.replace(/\bgl_FragColor\b/g,"gl_FragData[0]");var r=a.match(/\bgl_FragData\[.+?\]/g);a=this._replaceMRTShader(a,r)}else a=a.replace(/void\s+?main\s*\(/g,`out vec4 glFragColor;
void main(`),a=a.replace(/\bgl_FragColor\b/g,"glFragColor")}return a},n._replaceMRTShader=function(a,t){for(var e="",r=new Set,i=0;i<t.length;i++){var o=t[i].match(/\bgl_FragData\[(.+?)\]/);r.add(o[1])}return r.forEach(function(s){e+="layout(location="+s+") out vec4 fragOutColor"+s+`;
`}),e+="void main(",a=a.replace(/\bgl_FragData\[(.+?)\]/g,"fragOutColor$1"),a=a.replace(/void\s+?main\s*\(/g,e),a},n}(),qt;(function(n){n[n.Scene=0]="Scene",n[n.Camera=1]="Camera",n[n.Renderer=2]="Renderer",n[n.Material=3]="Material"})(qt||(qt={}));var ph=function(){function n(a){this.name=void 0,this.propertyId=void 0,this.location=void 0,this.applyFunc=void 0,this.cacheValue=void 0,this.textureIndex=void 0,this.textureDefault=void 0,this.textureUseComporeMode=!1,this._rhi=void 0,this._gl=void 0,this._colorSpace=void 0;var t=a._hardwareRenderer;this._rhi=t,this._gl=t.gl,this._colorSpace=a.settings.colorSpace}var l=n.prototype;return l.upload1f=function(t,e){this.cacheValue!==e&&(this._gl.uniform1f(t.location,e),this.cacheValue=e)},l.upload1fv=function(t,e){this._gl.uniform1fv(t.location,e)},l.upload2f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._colorSpace===zr.Linear?this._gl.uniform2f(t.location,re.gammaToLinearSpace(e.r),re.gammaToLinearSpace(e.g)):this._gl.uniform2f(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2f(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},l.upload2fv=function(t,e){this._gl.uniform2fv(t.location,e)},l.upload3f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._colorSpace===zr.Linear?this._gl.uniform3f(t.location,re.gammaToLinearSpace(e.r),re.gammaToLinearSpace(e.g),re.gammaToLinearSpace(e.b)):this._gl.uniform3f(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3f(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},l.upload3fv=function(t,e){this._gl.uniform3fv(t.location,e)},l.upload4f=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._colorSpace===zr.Linear?this._gl.uniform4f(t.location,re.gammaToLinearSpace(e.r),re.gammaToLinearSpace(e.g),re.gammaToLinearSpace(e.b),e.a):this._gl.uniform4f(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4f(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},l.upload4fv=function(t,e){this._gl.uniform4fv(t.location,e)},l.upload1i=function(t,e){this.cacheValue!==e&&(this._gl.uniform1i(t.location,e),this.cacheValue=e)},l.upload1iv=function(t,e){this._gl.uniform1iv(t.location,e)},l.upload2i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g)&&(this._gl.uniform2i(t.location,e.r,e.g),r.x=e.r,r.y=e.g):(r.x!==e.x||r.y!==e.y)&&(this._gl.uniform2i(t.location,e.x,e.y),r.x=e.x,r.y=e.y)},l.upload2iv=function(t,e){this._gl.uniform2iv(t.location,e)},l.upload3i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b)&&(this._gl.uniform3i(t.location,e.r,e.g,e.b),r.x=e.r,r.y=e.g,r.z=e.b):(r.x!==e.x||r.y!==e.y||r.z!==e.z)&&(this._gl.uniform3i(t.location,e.x,e.y,e.z),r.x=e.x,r.y=e.y,r.z=e.z)},l.upload3iv=function(t,e){this._gl.uniform3iv(t.location,e)},l.upload4i=function(t,e){var r=this.cacheValue;e.r!==void 0?(r.x!==e.r||r.y!==e.g||r.z!==e.b||r.w!==e.a)&&(this._gl.uniform4i(t.location,e.r,e.g,e.b,e.a),r.x=e.r,r.y=e.g,r.z=e.b,r.w=e.a):(r.x!==e.x||r.y!==e.y||r.z!==e.z||r.w!==e.w)&&(this._gl.uniform4i(t.location,e.x,e.y,e.z,e.w),r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w)},l.upload4iv=function(t,e){this._gl.uniform4iv(t.location,e)},l.uploadMat4=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e.elements)},l.uploadMat4v=function(t,e){this._gl.uniformMatrix4fv(t.location,!1,e)},l.uploadTexture=function(t,e){var r=this._rhi;r.activeTexture(t.textureIndex),r.bindTexture(e._platformTexture),e._setUseDepthCompareMode(t.textureUseComporeMode)},l.uploadTextureArray=function(t,e){for(var r=this._rhi,i=t.textureIndex,o=0;o<e.length;o++){var s=e[o];r.activeTexture(i[o]),r.bindTexture(s._platformTexture),s._setUseDepthCompareMode(t.textureUseComporeMode)}},n}(),Mn=function(){this.constUniforms=[],this.textureUniforms=[]},hu=function(){n._addLineNum=function(t){var e=t.split(`
`),r=(e.length+1).toString().length+6,i;return e.map(function(o,s){if(i="0:"+(s+1),i.length>=r)return i.substring(0,r)+o;for(var c=0;c<r-i.length;c++)i+=" ";return i+o}).join(`
`)};function n(a,t,e){this.id=void 0,this.sceneUniformBlock=new Mn,this.cameraUniformBlock=new Mn,this.rendererUniformBlock=new Mn,this.materialUniformBlock=new Mn,this.otherUniformBlock=new Mn,this._uploadRenderCount=-1,this._uploadScene=void 0,this._uploadCamera=void 0,this._uploadRenderer=void 0,this._uploadMaterial=void 0,this.attributeLocation=Object.create(null),this._isValid=void 0,this._engine=void 0,this._gl=void 0,this._vertexShader=void 0,this._fragmentShader=void 0,this._glProgram=void 0,this._activeTextureUint=0,this._engine=a,this._gl=a._hardwareRenderer.gl,this._glProgram=this._createProgram(t,e),this._glProgram?(this._isValid=!0,this._recordLocation()):this._isValid=!1,this.id=n._counter++}var l=n.prototype;return l.uploadAll=function(t,e){this.uploadUniforms(t,e),this.uploadTextures(t,e)},l.uploadUniforms=function(t,e){for(var r=e._propertyValueMap,i=t.constUniforms,o=0,s=i.length;o<s;o++){var c=i[o],u=r[c.propertyId];u!=null&&c.applyFunc(c,u)}},l.uploadTextures=function(t,e){var r=e._propertyValueMap,i=t.textureUniforms;if(i)for(var o=0,s=i.length;o<s;o++){var c=i[o],u=r[c.propertyId];u&&!u.destroyed?c.applyFunc(c,u):c.applyFunc(c,c.textureDefault)}},l.uploadUnGroupTextures=function(){var t=this.otherUniformBlock.textureUniforms;if(t)for(var e=0,r=t.length;e<r;e++){var i=t[e];i.applyFunc(i,i.textureDefault)}},l.groupingOtherUniformBlock=function(){var t=this.otherUniformBlock,e=t.constUniforms,r=t.textureUniforms;e.length>0&&this._groupingSubOtherUniforms(e,!1),r.length>0&&this._groupingSubOtherUniforms(r,!0)},l.bind=function(){var t=this._engine._hardwareRenderer;return t._currentBind!==this?(this._gl.useProgram(this._glProgram),t._currentBind=this,!0):!1},l.destroy=function(){var t=this._gl;this._vertexShader&&t.deleteShader(this._vertexShader),this._fragmentShader&&t.deleteShader(this._fragmentShader),this._glProgram&&t.deleteProgram(this._glProgram)},l._groupingSubOtherUniforms=function(t,e){for(var r=t.length-1;r>=0;r--){var i=t[r],o=O._getShaderPropertyGroup(i.name);o!==void 0&&(t.splice(t.indexOf(i),1),this._groupingUniform(i,o,e))}},l._groupingUniform=function(t,e,r){switch(e){case qt.Scene:r?this.sceneUniformBlock.textureUniforms.push(t):this.sceneUniformBlock.constUniforms.push(t);break;case qt.Camera:r?this.cameraUniformBlock.textureUniforms.push(t):this.cameraUniformBlock.constUniforms.push(t);break;case qt.Renderer:r?this.rendererUniformBlock.textureUniforms.push(t):this.rendererUniformBlock.constUniforms.push(t);break;case qt.Material:r?this.materialUniformBlock.textureUniforms.push(t):this.materialUniformBlock.constUniforms.push(t);break;default:r?this.otherUniformBlock.textureUniforms.push(t):this.otherUniformBlock.constUniforms.push(t)}},l._createProgram=function(t,e){var r=this._gl,i=this._createShader(r.VERTEX_SHADER,t);if(!i)return null;var o=this._createShader(r.FRAGMENT_SHADER,e);if(!o)return null;var s=r.createProgram();return r.attachShader(s,i),r.attachShader(s,o),r.linkProgram(s),r.validateProgram(s),r.isContextLost()?(ce.error("Context lost while linking program."),r.deleteShader(i),r.deleteShader(o),null):ce.isEnabled&&!r.getProgramParameter(s,r.LINK_STATUS)?(ce.error(`Could not link WebGL program. 
`+r.getProgramInfoLog(s)),r.deleteProgram(s),null):(this._vertexShader=i,this._fragmentShader=o,s)},l._createShader=function(t,e){var r=this._gl,i=r.createShader(t);return i?(r.shaderSource(i,e),r.compileShader(i),r.isContextLost()?(ce.error("Context lost while compiling shader."),r.deleteShader(i),null):ce.isEnabled&&!r.getShaderParameter(i,r.COMPILE_STATUS)?(ce.error(`Could not compile WebGL shader.
`+r.getShaderInfoLog(i),n._addLineNum(e)),r.deleteShader(i),null):i):(ce.error("Context lost while create shader."),null)},l._recordLocation=function(){var t=this,e=this._gl,r=this._glProgram,i=this._getUniformInfos(),o=this._getAttributeInfos();i.forEach(function(s){var c=s.name,u=s.size,_=s.type,h=new ph(t._engine),d=!1,f=!1;c.indexOf("[0]")>0&&(c=c.substr(0,c.length-3),d=!0);var p=e.getUniformLocation(r,c);switch(h.name=c,h.propertyId=O.getPropertyByName(c)._uniqueId,h.location=p,_){case e.FLOAT:d?h.applyFunc=h.upload1fv:(h.applyFunc=h.upload1f,h.cacheValue=0);break;case e.FLOAT_VEC2:d?h.applyFunc=h.upload2fv:(h.applyFunc=h.upload2f,h.cacheValue=new X(0,0));break;case e.FLOAT_VEC3:d?h.applyFunc=h.upload3fv:(h.applyFunc=h.upload3f,h.cacheValue=new w(0,0,0));break;case e.FLOAT_VEC4:d?h.applyFunc=h.upload4fv:(h.applyFunc=h.upload4f,h.cacheValue=new ve(0,0,0,0));break;case e.BOOL:case e.INT:d?h.applyFunc=h.upload1iv:(h.applyFunc=h.upload1i,h.cacheValue=0);break;case e.BOOL_VEC2:case e.INT_VEC2:d?h.applyFunc=h.upload2iv:(h.applyFunc=h.upload2i,h.cacheValue=new X(0,0));break;case e.BOOL_VEC3:case e.INT_VEC3:h.applyFunc=d?h.upload3iv:h.upload3i,h.cacheValue=new w(0,0,0);break;case e.BOOL_VEC4:case e.INT_VEC4:d?h.applyFunc=h.upload4iv:(h.applyFunc=h.upload4i,h.cacheValue=new ve(0,0,0));break;case e.FLOAT_MAT4:h.applyFunc=d?h.uploadMat4v:h.uploadMat4;break;case e.SAMPLER_2D:case e.SAMPLER_CUBE:case e.SAMPLER_2D_ARRAY:case e.SAMPLER_2D_SHADOW:var v;switch(_){case e.SAMPLER_2D:v=t._engine._magentaTexture2D;break;case e.SAMPLER_CUBE:v=t._engine._magentaTextureCube;break;case e.SAMPLER_2D_ARRAY:v=t._engine._magentaTexture2DArray;break;case e.SAMPLER_2D_SHADOW:v=t._engine._depthTexture2D,h.textureUseComporeMode=!0;break}if(f=!0,d){for(var m=new Array(u),g=new Int32Array(u),y=new Array(u),x=0;x<u;x++)m[x]=v,g[x]=t._activeTextureUint,y[x]=e.TEXTURE0+t._activeTextureUint++;h.textureDefault=m,h.textureIndex=y,h.applyFunc=h.uploadTextureArray,t.bind(),e.uniform1iv(p,g)}else{var b=e.TEXTURE0+t._activeTextureUint;h.textureDefault=v,h.textureIndex=b,h.applyFunc=h.uploadTexture,t.bind(),e.uniform1i(p,t._activeTextureUint++)}break}var S=O._getShaderPropertyGroup(c);t._groupingUniform(h,S,f)}),o.forEach(function(s){var c=s.name;t.attributeLocation[c]=e.getAttribLocation(r,c)})},l._getUniformInfos=function(){for(var t=this._gl,e=this._glProgram,r=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),i=new Array(r),o=0;o<r;++o){var s=t.getActiveUniform(e,o);i[o]=s}return i},l._getAttributeInfos=function(){for(var t=this._gl,e=this._glProgram,r=new Array,i=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),o=0;o<i;++o){var s=t.getActiveAttrib(e,o);r[o]=s}return r},j(n,[{key:"isValid",get:function(){return this._isValid}}]),n}();hu._counter=0;var ha=function(){function n(a,t){this._shaderPassId=0,this._vertexSource=void 0,this._fragmentSource=void 0,this._shaderPassId=n._shaderPassCounter++,this._vertexSource=a,this._fragmentSource=t}var l=n.prototype;return l._getShaderProgram=function(t,e){var r=t._getShaderProgramPool(this),i=r.get(e);if(i)return i;var o=t._hardwareRenderer.isWebGL2,s=[];O._getNamesByMacros(e,s);var c=Xr.parseCustomMacros(s),u=o?"#version 300 es":"#version 100",_=o?"#define GRAPHICS_API_WEBGL2":"#define GRAPHICS_API_WEBGL1",h=`
    #ifdef GL_FRAGMENT_PRECISION_HIGH
      precision highp float;
      precision highp int;
    #else
      precision mediump float;
      precision mediump int;
    #endif
    `;t._hardwareRenderer.canIUse(J.shaderTextureLod)&&(h+=`#define HAS_TEX_LOD
`),t._hardwareRenderer.canIUse(J.standardDerivatives)&&(h+=`#define HAS_DERIVATIVES
`);var d=Xr.parseIncludes(" "+u+`
        `+_+`
        `+h+`
        `+c+`
      `+this._vertexSource),f=Xr.parseIncludes(" "+u+`
        `+_+`
        `+(o?"":Xr.parseExtension(O._shaderExtension))+`
        `+h+`
        `+c+`
      `+this._fragmentSource);return o&&(d=Xr.convertTo300(d),f=Xr.convertTo300(f,!0)),i=new hu(t,d,f),r.cache(i),i},n}();ha._shaderPassCounter=0;var da=function(){function n(l){this._uniqueId=void 0,this._group=void 0,this._type=void 0,this.name=void 0,this.name=l,this._uniqueId=n._propertyNameCounter++}return j(n,[{key:"type",get:function(){return this._type}}]),n}();da._propertyNameCounter=0;var O=function(){n.create=function(t,e,r){var i=n._shaderMap;if(i[t])throw'Shader named "'+t+'" already exists.';return i[t]=new n(t,e,r)},n.find=function(t){return n._shaderMap[t]},n.getMacroByName=function(t,e){var r=e?t+" "+e:t,i=n._macroMap[r];if(!i){var o=n._macroMaskMap,s=n._macroCounter,c=Math.floor(s/32),u=s%32;i=new Ei(t,e,c,1<<u),n._macroMap[r]=i,c==o.length&&(o.length++,o[c]=new Array(32)),o[c][u]=r,n._macroCounter++}return i},n.getPropertyByName=function(t){var e=n._propertyNameMap;if(e[t]!=null)return e[t];var r=new da(t);return e[t]=r,n._propertyIdMap[r._uniqueId]=r,r},n._getShaderPropertyGroup=function(t){var e=n._propertyNameMap[t];return e==null?void 0:e._group},n._getNamesByMacros=function(t,e){var r=n._macroMaskMap,i=t._mask;e.length=0;for(var o=0,s=t._length;o<s;o++)for(var c=r[o],u=i[o],_=u<0?32:Math.floor(Math.log2(u))+1,h=0;h<_;h++)u&1<<h&&e.push(c[h])};function n(a,t,e){if(this.name=void 0,this._passes=[],this.name=a,typeof t=="string")this._passes.push(new ha(t,e));else{var r=t.length;if(r<1)throw"Shader pass count must large than 0.";for(var i=0;i<r;i++)this._passes.push(t[i])}}var l=n.prototype;return l.compileVariant=function(t,e){var r=n._compileMacros;r.clear();for(var i=0,o=e.length;i<o;i++)r.enable(n.getMacroByName(e[i]));for(var s=!0,c=this._passes,u=0,_=c.length;u<_;u++)s&&(s=c[u]._getShaderProgram(t,r).isValid);return s},j(n,[{key:"passes",get:function(){return this._passes}}]),n}();O._compileMacros=new Et;O._shaderExtension=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives","GL_EXT_draw_buffers"];O._propertyIdMap=Object.create(null);O._shaderMap=Object.create(null);O._propertyNameMap=Object.create(null);O._macroMaskMap=[];O._macroCounter=0;O._macroMap=Object.create(null);var Qn=function(){function n(a){this._group=void 0,this._propertyValueMap=Object.create(null),this._macroCollection=new Et,this._macroMap=Object.create(null),this._refCount=0,this._group=a}var l=n.prototype;return l.getFloat=function(t){return this.getPropertyValue(t)},l.setFloat=function(t,e){this._setPropertyValue(t,ht.Float,e)},l.getInt=function(t){return this.getPropertyValue(t)},l.setInt=function(t,e){this._setPropertyValue(t,ht.Int,e)},l.getFloatArray=function(t){return this.getPropertyValue(t)},l.setFloatArray=function(t,e){this._setPropertyValue(t,ht.FloatArray,e)},l.getIntArray=function(t){return this.getPropertyValue(t)},l.setIntArray=function(t,e){this._setPropertyValue(t,ht.IntArray,e)},l.getVector2=function(t){return this.getPropertyValue(t)},l.setVector2=function(t,e){this._setPropertyValue(t,ht.Vector2,e)},l.getVector3=function(t){return this.getPropertyValue(t)},l.setVector3=function(t,e){this._setPropertyValue(t,ht.Vector3,e)},l.getVector4=function(t){return this.getPropertyValue(t)},l.setVector4=function(t,e){this._setPropertyValue(t,ht.Vector4,e)},l.getMatrix=function(t){return this.getPropertyValue(t)},l.setMatrix=function(t,e){this._setPropertyValue(t,ht.Matrix,e)},l.getColor=function(t){return this.getPropertyValue(t)},l.setColor=function(t,e){this._setPropertyValue(t,ht.Color,e)},l.getTexture=function(t){return this.getPropertyValue(t)},l.setTexture=function(t,e){if(this._getRefCount()>0){var r=this.getPropertyValue(t);r&&r._addRefCount(-1),e&&e._addRefCount(1)}this._setPropertyValue(t,ht.Texture,e)},l.getTextureArray=function(t){return this.getPropertyValue(t)},l.setTextureArray=function(t,e){if(this._getRefCount()>0){var r=this.getPropertyValue(t);if(r)for(var i=0,o=r.length;i<o;i++)r[i]._addRefCount(-1);if(e)for(var s=0,c=e.length;s<c;s++)e[s]._addRefCount(1)}this._setPropertyValue(t,ht.TextureArray,e)},l.getPropertyValue=function(t){return typeof t=="string"&&(t=O.getPropertyByName(t)),this._propertyValueMap[t._uniqueId]},l.enableMacro=function(t,e){typeof t=="string"&&(t=O.getMacroByName(t,e));var r=t._nameId,i=this._macroMap[r];if(i!==t){var o=this._macroCollection;i&&o.disable(i),o.enable(t),this._macroMap[r]=t}},l.disableMacro=function(t){var e;if(typeof t=="string"){if(e=Ei._macroNameIdMap[t],e===void 0)return}else e=t._nameId;var r=this._macroMap[e];r&&(this._macroCollection.disable(r),delete this._macroMap[e])},l.getMacros=function(t){if(t){var e=this._macroMap;t.length=0;for(var r in e)t.push(e[r])}else return Object.values(this._macroMap)},l.getProperties=function(t){var e;t?(t.length=0,e=t):e=[];var r=this._propertyValueMap,i=O._propertyIdMap;for(var o in r)e.push(i[o]);if(!t)return e},l.clone=function(){var t=new n(this._group);return this.cloneTo(t),t},l.cloneTo=function(t){Nt.deepCloneObject(this._macroCollection,t._macroCollection),On(t._macroMap,this._macroMap);for(var e=this._propertyValueMap,r=t._propertyValueMap,i=Object.keys(e),o=0,s=i.length;o<s;o++){var c=i[o],u=e[c];if(u!=null)if(typeof u=="number")r[c]=u;else if(u instanceof rr)r[c]=u;else if(u instanceof Array||u instanceof Float32Array||u instanceof Int32Array)r[c]=u.slice();else{var _=r[c];_?_.copyFrom(u):r[c]=u.clone()}else r[c]=u}},l._setPropertyValue=function(t,e,r){if(typeof t=="string"&&(t=O.getPropertyByName(t)),t._group!==this._group)if(t._group===void 0)t._group=this._group;else throw"Shader property "+t.name+" has been used as "+qt[t._group]+" group.";if(t._type!==e)if(t._type===void 0)t._type=e;else throw"Shader property "+t.name+" has been used as "+ht[t._type]+" type.";this._propertyValueMap[t._uniqueId]=r},l._getRefCount=function(){return this._refCount},l._addRefCount=function(t){this._refCount+=t;var e=this._propertyValueMap;for(var r in e){var i=e[r];i&&i instanceof rr&&i._addRefCount(t)}},n}(),Xi,yo,qi,vt=(Xi=(qi=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.intensity=1,t.shadowType=Br.None,t.shadowBias=1,t.shadowNormalBias=1,t.shadowNearPlane=.1,t.shadowStrength=1,U(t,"_lightIndex",yo,L(t)),t._color=new re(1,1,1,1),t._viewMat=void 0,t._inverseViewMat=void 0,t._lightColor=new re,t}var a=l.prototype;return a._getLightColor=function(){return this._lightColor.r=this.color.r*this.intensity,this._lightColor.g=this.color.g*this.intensity,this._lightColor.b=this.color.b*this.intensity,this._lightColor.a=this.color.a*this.intensity,this._lightColor},j(l,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"viewMatrix",get:function(){return this._viewMat||(this._viewMat=new te),te.invert(this.entity.transform.worldMatrix,this._viewMat),this._viewMat}},{key:"inverseViewMatrix",get:function(){return this._inverseViewMat||(this._inverseViewMat=new te),te.invert(this.viewMatrix,this._inverseViewMat),this._inverseViewMat}}]),l}(ir),qi._maxLight=10,qi),yo=N(Xi.prototype,"_lightIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Xi),Vr=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t._forward=new w,t._reverseDirection=new w,t}l._updateShaderData=function(e){var r=l._combinedData;e.setFloatArray(l._colorProperty,r.color),e.setFloatArray(l._directionProperty,r.direction)};var a=l.prototype;return a._appendData=function(e){var r=e*3,i=e*3,o=this._getLightColor(),s=this.direction,c=l._combinedData;c.color[r]=o.r,c.color[r+1]=o.g,c.color[r+2]=o.b,c.direction[i]=s.x,c.direction[i+1]=s.y,c.direction[i+2]=s.z},a._onEnable=function(){this.engine._lightManager._attachDirectLight(this)},a._onDisable=function(){this.engine._lightManager._detachDirectLight(this)},j(l,[{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return w.scale(this.direction,-1,this._reverseDirection),this._reverseDirection}},{key:"_shadowProjectionMatrix",get:function(){throw"Unknown!"}}]),l}(vt);Vr._colorProperty=O.getPropertyByName("u_directLightColor");Vr._directionProperty=O.getPropertyByName("u_directLightDirection");Vr._combinedData={color:new Float32Array(3*vt._maxLight),direction:new Float32Array(3*vt._maxLight)};var Lr=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.distance=100,t}l._updateShaderData=function(e){var r=l._combinedData;e.setFloatArray(l._colorProperty,r.color),e.setFloatArray(l._positionProperty,r.position),e.setFloatArray(l._distanceProperty,r.distance)};var a=l.prototype;return a._appendData=function(e){var r=e*3,i=e*3,o=e,s=this._getLightColor(),c=this.position,u=l._combinedData;u.color[r]=s.r,u.color[r+1]=s.g,u.color[r+2]=s.b,u.position[i]=c.x,u.position[i+1]=c.y,u.position[i+2]=c.z,u.distance[o]=this.distance},a._onEnable=function(){this.engine._lightManager._attachPointLight(this)},a._onDisable=function(){this.engine._lightManager._detachPointLight(this)},j(l,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"_shadowProjectionMatrix",get:function(){throw"Unknown!"}}]),l}(vt);Lr._colorProperty=O.getPropertyByName("u_pointLightColor");Lr._positionProperty=O.getPropertyByName("u_pointLightPosition");Lr._distanceProperty=O.getPropertyByName("u_pointLightDistance");Lr._combinedData={color:new Float32Array(3*vt._maxLight),position:new Float32Array(3*vt._maxLight),distance:new Float32Array(vt._maxLight)};var Ut=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.distance=100,t.angle=Math.PI/6,t.penumbra=Math.PI/12,t._forward=new w,t._inverseDirection=new w,t._projectMatrix=new te,t}l._updateShaderData=function(e){var r=l._combinedData;e.setFloatArray(l._colorProperty,r.color),e.setFloatArray(l._positionProperty,r.position),e.setFloatArray(l._directionProperty,r.direction),e.setFloatArray(l._distanceProperty,r.distance),e.setFloatArray(l._angleCosProperty,r.angleCos),e.setFloatArray(l._penumbraCosProperty,r.penumbraCos)};var a=l.prototype;return a._appendData=function(e){var r=e*3,i=e*3,o=e*3,s=e,c=e,u=e,_=this._getLightColor(),h=this.position,d=this.direction,f=l._combinedData;f.color[r]=_.r,f.color[r+1]=_.g,f.color[r+2]=_.b,f.position[i]=h.x,f.position[i+1]=h.y,f.position[i+2]=h.z,f.direction[o]=d.x,f.direction[o+1]=d.y,f.direction[o+2]=d.z,f.distance[s]=this.distance,f.angleCos[u]=Math.cos(this.angle),f.penumbraCos[c]=Math.cos(this.angle+this.penumbra)},a._onEnable=function(){this.engine._lightManager._attachSpotLight(this)},a._onDisable=function(){this.engine._lightManager._detachSpotLight(this)},j(l,[{key:"position",get:function(){return this.entity.transform.worldPosition}},{key:"direction",get:function(){return this.entity.transform.getWorldForward(this._forward),this._forward}},{key:"reverseDirection",get:function(){return w.scale(this.direction,-1,this._inverseDirection),this._inverseDirection}},{key:"_shadowProjectionMatrix",get:function(){var e=this._projectMatrix,r=Math.min(Math.PI/2,this.angle*2*Math.sqrt(2));return te.perspective(r,1,this.shadowNearPlane,this.distance+this.shadowNearPlane,e),e}}]),l}(vt);Ut._colorProperty=O.getPropertyByName("u_spotLightColor");Ut._positionProperty=O.getPropertyByName("u_spotLightPosition");Ut._directionProperty=O.getPropertyByName("u_spotLightDirection");Ut._distanceProperty=O.getPropertyByName("u_spotLightDistance");Ut._angleCosProperty=O.getPropertyByName("u_spotLightAngleCos");Ut._penumbraCosProperty=O.getPropertyByName("u_spotLightPenumbraCos");Ut._combinedData={color:new Float32Array(3*vt._maxLight),position:new Float32Array(3*vt._maxLight),direction:new Float32Array(3*vt._maxLight),distance:new Float32Array(vt._maxLight),angleCos:new Float32Array(vt._maxLight),penumbraCos:new Float32Array(vt._maxLight)};var gh=function(){function n(){this._spotLights=new Ne,this._pointLights=new Ne,this._directLights=new Ne}var l=n.prototype;return l._attachSpotLight=function(t){t._lightIndex=this._spotLights.length,this._spotLights.add(t)},l._detachSpotLight=function(t){var e=this._spotLights.deleteByIndex(t._lightIndex);e&&(e._lightIndex=t._lightIndex),t._lightIndex=-1},l._attachPointLight=function(t){t._lightIndex=this._pointLights.length,this._pointLights.add(t)},l._detachPointLight=function(t){var e=this._pointLights.deleteByIndex(t._lightIndex);e&&(e._lightIndex=t._lightIndex),t._lightIndex=-1},l._attachDirectLight=function(t){t._lightIndex=this._directLights.length,this._directLights.add(t)},l._detachDirectLight=function(t){var e=this._directLights.deleteByIndex(t._lightIndex);e&&(e._lightIndex=t._lightIndex),t._lightIndex=-1},l._getSunLightIndex=function(){for(var t=this._directLights,e=-1,r=Number.NEGATIVE_INFINITY,i=!1,o=0,s=t.length;o<s;o++){var c=t.get(o);c.shadowType!==Br.None&&!i&&(r=Number.NEGATIVE_INFINITY,i=!0);var u=c.intensity*c.color.getBrightness();i?c.shadowType!==Br.None&&r<u&&(r=u,e=o):r<u&&(r=u,e=o)}return e},l._updateShaderData=function(t){for(var e=this._spotLights,r=this._pointLights,i=this._directLights,o=e.length,s=r.length,c=i.length,u=0,_=o;u<_;u++){var h=e.get(u);h._appendData(u)}for(var d=0,f=s;d<f;d++){var p=r.get(d);p._appendData(d)}for(var v=0,m=c;v<m;v++){var g=i.get(v);g._appendData(v)}c?(Vr._updateShaderData(t),t.enableMacro("O3_DIRECT_LIGHT_COUNT",c.toString())):t.disableMacro("O3_DIRECT_LIGHT_COUNT"),s?(Lr._updateShaderData(t),t.enableMacro("O3_POINT_LIGHT_COUNT",s.toString())):t.disableMacro("O3_POINT_LIGHT_COUNT"),o?(Ut._updateShaderData(t),t.enableMacro("O3_SPOT_LIGHT_COUNT",o.toString())):t.disableMacro("O3_SPOT_LIGHT_COUNT")},n}(),mh=function(){this.enabled=!1,this.colorBlendOperation=St.Add,this.alphaBlendOperation=St.Add,this.sourceColorBlendFactor=oe.One,this.sourceAlphaBlendFactor=oe.One,this.destinationColorBlendFactor=oe.Zero,this.destinationAlphaBlendFactor=oe.Zero,this.colorWriteMask=Xt.All},yh=function(){function n(){this.targetBlendState=new mh,this.blendColor=new re(0,0,0,0),this.alphaToCoverage=!1}n._getGLBlendFactor=function(t,e){var r=t.gl;switch(e){case oe.Zero:return r.ZERO;case oe.One:return r.ONE;case oe.SourceColor:return r.SRC_COLOR;case oe.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case oe.DestinationColor:return r.DST_COLOR;case oe.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case oe.SourceAlpha:return r.SRC_ALPHA;case oe.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case oe.DestinationAlpha:return r.DST_ALPHA;case oe.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case oe.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case oe.BlendColor:return r.CONSTANT_COLOR;case oe.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}},n._getGLBlendOperation=function(t,e){var r=t.gl;switch(e){case St.Add:return r.FUNC_ADD;case St.Subtract:return r.FUNC_SUBTRACT;case St.ReverseSubtract:return r.FUNC_REVERSE_SUBTRACT;case St.Min:if(!t.canIUse(J.blendMinMax))throw new Error("BlendOperation.Min is not supported in this context");return r.MIN;case St.Max:if(!t.canIUse(J.blendMinMax))throw new Error("BlendOperation.Max is not supported in this context");return r.MAX}};var l=n.prototype;return l._apply=function(t,e){this._platformApply(t,e.blendState)},l._platformApply=function(t,e){var r=t.gl,i=e.targetBlendState,o=this.targetBlendState,s=o.enabled,c=o.colorBlendOperation,u=o.alphaBlendOperation,_=o.sourceColorBlendFactor,h=o.destinationColorBlendFactor,d=o.sourceAlphaBlendFactor,f=o.destinationAlphaBlendFactor,p=o.colorWriteMask;if(s!==i.enabled&&(s?r.enable(r.BLEND):r.disable(r.BLEND),i.enabled=s),s){(_!==i.sourceColorBlendFactor||h!==i.destinationColorBlendFactor||d!==i.sourceAlphaBlendFactor||f!==i.destinationAlphaBlendFactor)&&(r.blendFuncSeparate(n._getGLBlendFactor(t,_),n._getGLBlendFactor(t,h),n._getGLBlendFactor(t,d),n._getGLBlendFactor(t,f)),i.sourceColorBlendFactor=_,i.destinationColorBlendFactor=h,i.sourceAlphaBlendFactor=d,i.destinationAlphaBlendFactor=f),(c!==i.colorBlendOperation||u!==i.alphaBlendOperation)&&(r.blendEquationSeparate(n._getGLBlendOperation(t,c),n._getGLBlendOperation(t,u)),i.colorBlendOperation=c,i.alphaBlendOperation=u);var v=this.blendColor;re.equals(e.blendColor,v)||(r.blendColor(v.r,v.g,v.b,v.a),e.blendColor.copyFrom(v))}p!==i.colorWriteMask&&(r.colorMask((p&Xt.Red)!==0,(p&Xt.Green)!==0,(p&Xt.Blue)!==0,(p&Xt.Alpha)!==0),i.colorWriteMask=p);var m=this.alphaToCoverage;m!==e.alphaToCoverage&&(m?r.enable(r.SAMPLE_ALPHA_TO_COVERAGE):r.disable(r.SAMPLE_ALPHA_TO_COVERAGE),e.alphaToCoverage=m)},n}(),xh=function(){function n(){this.enabled=!0,this.writeEnabled=!0,this.compareFunction=be.Less}n._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case be.Never:return r.NEVER;case be.Less:return r.LESS;case be.Equal:return r.EQUAL;case be.LessEqual:return r.LEQUAL;case be.Greater:return r.GREATER;case be.NotEqual:return r.NOTEQUAL;case be.GreaterEqual:return r.GEQUAL;case be.Always:return r.ALWAYS}};var l=n.prototype;return l._apply=function(t,e){this._platformApply(t,e.depthState)},l._platformApply=function(t,e){var r=t.gl,i=this.enabled,o=this.compareFunction,s=this.writeEnabled;i!=e.enabled&&(i?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),e.enabled=i),i&&(o!=e.compareFunction&&(r.depthFunc(n._getGLCompareFunction(t,o)),e.compareFunction=o),s!=e.writeEnabled&&(r.depthMask(s),e.writeEnabled=s))},n}(),wh=function(){function n(){this.cullMode=Pt.Back,this.depthBias=0,this.slopeScaledDepthBias=0,this._cullFaceEnable=!0,this._frontFaceInvert=!1}var l=n.prototype;return l._apply=function(t,e,r){this._platformApply(t,e.rasterState,r)},l._platformApply=function(t,e,r){var i=t.gl,o=this.cullMode,s=this.depthBias,c=this.slopeScaledDepthBias,u=o!==Pt.Off;u!==e._cullFaceEnable&&(u?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE),e._cullFaceEnable=u),u&&o!==e.cullMode&&(o==Pt.Back?i.cullFace(i.BACK):i.cullFace(i.FRONT),e.cullMode=o),r!==e._frontFaceInvert&&(r?i.frontFace(i.CW):i.frontFace(i.CCW),e._frontFaceInvert=r),(s!==e.depthBias||c!==e.slopeScaledDepthBias)&&(s!==0||c!==0?(i.enable(i.POLYGON_OFFSET_FILL),i.polygonOffset(c,s)):i.disable(i.POLYGON_OFFSET_FILL),e.depthBias=s,e.slopeScaledDepthBias=c)},n}(),bh=function(){function n(){this.enabled=!1,this.referenceValue=0,this.mask=255,this.writeMask=255,this.compareFunctionFront=be.Always,this.compareFunctionBack=be.Always,this.passOperationFront=He.Keep,this.passOperationBack=He.Keep,this.failOperationFront=He.Keep,this.failOperationBack=He.Keep,this.zFailOperationFront=He.Keep,this.zFailOperationBack=He.Keep}n._getGLCompareFunction=function(t,e){var r=t.gl;switch(e){case be.Never:return r.NEVER;case be.Less:return r.LESS;case be.Equal:return r.EQUAL;case be.LessEqual:return r.LEQUAL;case be.Greater:return r.GREATER;case be.NotEqual:return r.NOTEQUAL;case be.GreaterEqual:return r.GEQUAL;case be.Always:return r.ALWAYS}},n._getGLStencilOperation=function(t,e){var r=t.gl;switch(e){case He.Keep:return r.KEEP;case He.Zero:return r.ZERO;case He.Replace:return r.REPLACE;case He.IncrementSaturate:return r.INCR;case He.DecrementSaturate:return r.DECR;case He.Invert:return r.INVERT;case He.IncrementWrap:return r.INCR_WRAP;case He.DecrementWrap:return r.DECR_WRAP}};var l=n.prototype;return l._apply=function(t,e){this._platformApply(t,e.stencilState)},l._platformApply=function(t,e){var r=t.gl,i=this.enabled,o=this.referenceValue,s=this.mask,c=this.compareFunctionFront,u=this.compareFunctionBack,_=this.failOperationFront,h=this.zFailOperationFront,d=this.passOperationFront,f=this.failOperationBack,p=this.zFailOperationBack,v=this.passOperationBack,m=this.writeMask;if(i!=e.enabled&&(i?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),e.enabled=i),i){var g=o!==e.referenceValue||s!==e.mask;(g||c!==e.compareFunctionFront)&&(r.stencilFuncSeparate(r.FRONT,n._getGLCompareFunction(t,c),o,s),e.compareFunctionFront=c),(g||u!==e.compareFunctionBack)&&(r.stencilFuncSeparate(r.BACK,n._getGLCompareFunction(t,u),o,s),e.compareFunctionBack=this.compareFunctionBack),g&&(e.referenceValue=this.referenceValue,e.mask=this.mask),(_!==e.failOperationFront||h!==e.zFailOperationFront||d!==e.passOperationFront)&&(r.stencilOpSeparate(r.FRONT,n._getGLStencilOperation(t,_),n._getGLStencilOperation(t,h),n._getGLStencilOperation(t,d)),e.failOperationFront=_,e.zFailOperationFront=h,e.passOperationFront=d),(f!==e.failOperationBack||p!==e.zFailOperationBack||v!==e.passOperationBack)&&(r.stencilOpSeparate(r.BACK,n._getGLStencilOperation(t,f),n._getGLStencilOperation(t,p),n._getGLStencilOperation(t,v)),e.failOperationBack=f,e.zFailOperationBack=p,e.passOperationBack=v),m!==e.writeMask&&(r.stencilMask(m),e.writeMask=m)}},n}(),fa=function(){function n(){this.blendState=new yh,this.depthState=new xh,this.stencilState=new bh,this.rasterState=new wh,this.renderQueueType=rt.Opaque}var l=n.prototype;return l._apply=function(t,e){var r=t._hardwareRenderer,i=t._lastRenderState;this.blendState._apply(r,i),this.depthState._apply(r,i),this.stencilState._apply(r,i),this.rasterState._apply(r,i,e)},n}(),dr=function(n){$(l,n);function l(t,e){var r;return r=n.call(this,t)||this,r.name=void 0,r.shaderData=new Qn(qt.Material),r._shader=void 0,r._renderStates=[],r.shader=e,r}var a=l.prototype;return a.clone=function(){var e=new l(this._engine,this.shader);return this.cloneTo(e),e},a.cloneTo=function(e){e.shader=this.shader,this.shaderData.cloneTo(e.shaderData),Nt.deepCloneObject(this.renderStates,e.renderStates)},a._addRefCount=function(e){n.prototype._addRefCount.call(this,e),this.shaderData._addRefCount(e)},a._preRender=function(e){},a._onDestroy=function(){},j(l,[{key:"shader",get:function(){return this._shader},set:function(e){this._shader=e;var r=this._renderStates,i=r.length,o=e.passes.length;if(i<o)for(var s=i;s<o;s++)r.push(new fa);else r.length=o}},{key:"renderState",get:function(){return this._renderStates[0]}},{key:"renderStates",get:function(){return this._renderStates}}]),l}(wr),$r=function(){function n(a){this._elementPoolIndex=0,this._elementPool=[],this._type=void 0,this._type=a}var l=n.prototype;return l.getFromPool=function(){var t=this._elementPoolIndex,e=this._elementPool;if(this._elementPoolIndex++,e.length===t){var r=new this._type;return e.push(r),r}else return e[t]},l.resetPool=function(){this._elementPoolIndex=0},n}(),Ri=function(){this.component=void 0,this.material=void 0,this.multiRenderData=void 0,this.renderState=void 0,this.shaderPass=void 0},du=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.mesh=void 0,t.subMesh=void 0,t}var a=l.prototype;return a.setValue=function(e,r,i,o,s,c){this.component=e,this.mesh=r,this.subMesh=i,this.material=o,this.renderState=s,this.shaderPass=c},l}(Ri),Kr=function(){function n(){this.camera=void 0,this.viewMatrix=void 0,this.projectionMatrix=void 0,this.viewProjectMatrix=void 0}var l=n.prototype;return l.applyViewProjectMatrix=function(t,e,r){var i=this.camera.shaderData;i.setMatrix(n._viewMatrixProperty,t),i.setMatrix(n._projectionMatrixProperty,e),i.setMatrix(n._vpMatrixProperty,r),this.viewMatrix=t,this.projectionMatrix=e,this.viewProjectMatrix=r},n}();Kr._vpMatrixProperty=O.getPropertyByName("u_VPMat");Kr._viewMatrixProperty=O.getPropertyByName("u_viewMat");Kr._projectionMatrixProperty=O.getPropertyByName("u_projMat");var fu=function(n){$(l,n);function l(){var t;return t=n.call(this)||this,t.renderData=void 0,t.texture=void 0,t.multiRenderData=!1,t}var a=l.prototype;return a.setValue=function(e,r,i,o,s,c){this.component=e,this.renderData=r,this.material=i,this.texture=o,this.renderState=s,this.shaderPass=c},l}(Ri),Ch=function(n){$(l,n);function l(){var t;return t=n.call(this)||this,t.renderData=void 0,t.isAdd=!0,t.multiRenderData=!1,t}var a=l.prototype;return a.setValue=function(e,r,i){this.component=e,this.renderData=r,this.material=i},l}(Ri),Ot;(function(n){n[n.None=0]="None",n[n.VisibleInsideMask=1]="VisibleInsideMask",n[n.VisibleOutsideMask=2]="VisibleOutsideMask"})(Ot||(Ot={}));var xo,wo,Fe,bo,Co,So,To,Ao,Po,Mo,Eo,Ro,zo,Fo,Bo,Vo,Do,Lo,Io,Oo,sr,Jn=(xo=Yn(At),xo(wo=(Fe=(sr=function(n){$(l,n);function l(t){var e;e=n.call(this,t)||this,U(e,"shaderData",bo,L(e)),U(e,"isCulled",Co,L(e)),U(e,"_distanceForSort",So,L(e)),U(e,"_onUpdateIndex",To,L(e)),U(e,"_rendererIndex",Ao,L(e)),U(e,"_globalShaderMacro",Po,L(e)),U(e,"_bounds",Mo,L(e)),U(e,"_overrideUpdate",Eo,L(e)),U(e,"_materials",Ro,L(e)),U(e,"_dirtyUpdateFlag",zo,L(e)),U(e,"_mvMatrix",Fo,L(e)),U(e,"_mvpMatrix",Bo,L(e)),U(e,"_mvInvMatrix",Vo,L(e)),U(e,"_normalMatrix",Do,L(e)),U(e,"_materialsInstanced",Lo,L(e)),U(e,"_priority",Io,L(e)),U(e,"_receiveShadows",Oo,L(e)),e.castShadows=!0;var r=l.prototype;return e._overrideUpdate=e.update!==r.update,e.shaderData._addRefCount(1),e._onTransformChanged=e._onTransformChanged.bind(L(e)),e._registerEntityTransformListener(),e.shaderData.enableMacro(l._receiveShadowMacro),e}var a=l.prototype;return a.getInstanceMaterial=function(e){e===void 0&&(e=0);var r=this._materials;if(r.length>e){var i=r[e];if(i)return this._materialsInstanced[e]?i:this._createInstanceMaterial(i,e)}return null},a.getMaterial=function(e){return e===void 0&&(e=0),this._materials[e]||null},a.setMaterial=function(e,r){r===void 0&&(r=null),typeof e=="number"?this._setMaterial(e,r):this._setMaterial(0,e)},a.getInstanceMaterials=function(){for(var e=this._materials,r=this._materialsInstanced,i=0,o=e.length;i<o;i++)r[i]||this._createInstanceMaterial(this._materials[i],i);return e},a.getMaterials=function(){return this._materials},a.setMaterials=function(e){for(var r=e.length,i=this._materials,o=this._materialsInstanced,s=r,c=i.length;s<c;s++){var u=i[s];u&&u._addRefCount(-1)}i.length!==r&&(i.length=r),o.length!==0&&(o.length=0);for(var _=0;_<r;_++){var h=i[_],d=e[_];h!==d&&(i[_]=d,h&&h._addRefCount(-1),d&&d._addRefCount(1))}},a.update=function(e){},a._updateShaderData=function(e){var r=this.entity.transform.worldMatrix;this._updateTransformShaderData(e,r)},a._onEnable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.addOnUpdateRenderers(this),e.addRenderer(this)},a._onDisable=function(){var e=this.engine._componentsManager;this._overrideUpdate&&e.removeOnUpdateRenderers(this),e.removeRenderer(this)},a._render=function(e){throw"not implement"},a._onDestroy=function(){this.entity.transform._updateFlagManager.removeListener(this._onTransformChanged),this.shaderData._addRefCount(-1);for(var e=this._materials,r=0,i=e.length;r<i;r++){var o;(o=e[r])===null||o===void 0||o._addRefCount(-1)}},a._updateTransformShaderData=function(e,r){var i=this.shaderData,o=this._mvMatrix,s=this._mvpMatrix,c=this._mvInvMatrix,u=this._normalMatrix;te.multiply(e.viewMatrix,r,o),te.multiply(e.viewProjectMatrix,r,s),te.invert(o,c),te.invert(r,u),u.transpose(),i.setMatrix(l._localMatrixProperty,this.entity.transform.localMatrix),i.setMatrix(l._worldMatrixProperty,r),i.setMatrix(l._mvMatrixProperty,o),i.setMatrix(l._mvpMatrixProperty,s),i.setMatrix(l._mvInvMatrixProperty,c),i.setMatrix(l._normalMatrixProperty,u)},a._registerEntityTransformListener=function(){this.entity.transform._updateFlagManager.addListener(this._onTransformChanged)},a._updateBounds=function(e){},a._createInstanceMaterial=function(e,r){var i=e.clone();return i.name=i.name+"(Instance)",e._addRefCount(-1),i._addRefCount(1),this._materialsInstanced[r]=!0,this._materials[r]=i,i},a._setMaterial=function(e,r){var i=this._materials;e>=i.length&&(i.length=e+1);var o=i[e];if(o!==r){var s=this._materialsInstanced;e<s.length&&(s[e]=!1),o&&o._addRefCount(-1),r&&r._addRefCount(1),i[e]=r}},a._onTransformChanged=function(e){this._dirtyUpdateFlag|=Ve.WorldVolume},j(l,[{key:"receiveShadows",get:function(){return this._receiveShadows},set:function(e){this._receiveShadows!==e&&(e?this.shaderData.enableMacro(l._receiveShadowMacro):this.shaderData.disableMacro(l._receiveShadowMacro),this._receiveShadows=e)}},{key:"materialCount",get:function(){return this._materials.length},set:function(e){var r=this._materials,i=this._materialsInstanced;r.length!==e&&(r.length=e),i.length>e&&(i.length=e)}},{key:"bounds",get:function(){return this._dirtyUpdateFlag&Ve.WorldVolume&&(this._updateBounds(this._bounds),this._dirtyUpdateFlag&=~Ve.WorldVolume),this._bounds}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}}]),l}(ir),sr._receiveShadowMacro=O.getMacroByName("OASIS_RECEIVE_SHADOWS"),sr._localMatrixProperty=O.getPropertyByName("u_localMat"),sr._worldMatrixProperty=O.getPropertyByName("u_modelMat"),sr._mvMatrixProperty=O.getPropertyByName("u_MVMat"),sr._mvpMatrixProperty=O.getPropertyByName("u_MVPMat"),sr._mvInvMatrixProperty=O.getPropertyByName("u_MVInvMat"),sr._normalMatrixProperty=O.getPropertyByName("u_normalMat"),sr),bo=N(Fe.prototype,"shaderData",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Qn(qt.Renderer)}}),Co=N(Fe.prototype,"isCulled",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),So=N(Fe.prototype,"_distanceForSort",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),To=N(Fe.prototype,"_onUpdateIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ao=N(Fe.prototype,"_rendererIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Po=N(Fe.prototype,"_globalShaderMacro",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Et}}),Mo=N(Fe.prototype,"_bounds",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tt}}),Eo=N(Fe.prototype,"_overrideUpdate",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ro=N(Fe.prototype,"_materials",[au],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),zo=N(Fe.prototype,"_dirtyUpdateFlag",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Fo=N(Fe.prototype,"_mvMatrix",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),Bo=N(Fe.prototype,"_mvpMatrix",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),Vo=N(Fe.prototype,"_mvInvMatrix",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),Do=N(Fe.prototype,"_normalMatrix",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),Lo=N(Fe.prototype,"_materialsInstanced",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Io=N(Fe.prototype,"_priority",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Oo=N(Fe.prototype,"_receiveShadows",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),N(Fe.prototype,"_onTransformChanged",[q],Object.getOwnPropertyDescriptor(Fe.prototype,"_onTransformChanged"),Fe.prototype),Fe))||wo),Ve;(function(n){n[n.WorldVolume=1]="WorldVolume"})(Ve||(Ve={}));function Yt(){return function(n){}}var No,Uo,ri,Bn=(No=Yt(),No(Uo=(ri=function(){function n(){}return n.resetData=function(a){var t=a._renderData,e=t.vertexCount=4,r=t.positions,i=t.uvs;if(r.length<e)for(var o=r.length;o<e;o++)r.push(new w),i.push(new X);t.triangles=n._rectangleTriangles},n.updatePositions=function(a){var t=a.width,e=a.height,r=a.sprite,i=r.pivot,o=i.x,s=i.y,c=n._worldMatrix,u=c.elements,_=a.entity.transform.worldMatrix.elements,h=a.flipX?-t:t,d=a.flipY?-e:e;u[0]=_[0]*h,u[1]=_[1]*h,u[2]=_[2]*h,u[4]=_[4]*d,u[5]=_[5]*d,u[6]=_[6]*d,u[8]=_[8],u[9]=_[9],u[10]=_[10],u[12]=_[12]-o*u[0]-s*u[4],u[13]=_[13]-o*u[1]-s*u[5],u[14]=_[14]-o*u[2]-s*u[6];for(var f=r._getPositions(),p=a._renderData.positions,v=0;v<4;v++){var m=f[v],g=m.x,y=m.y;p[v].set(u[0]*g+u[4]*y+u[12],u[1]*g+u[5]*y+u[13],u[2]*g+u[6]*y+u[14])}Tt.transform(r._getBounds(),c,a._bounds)},n.updateUVs=function(a){var t=a.sprite._getUVs(),e=a._renderData.uvs,r=t[0],i=r.x,o=r.y,s=t[3],c=s.x,u=s.y;e[0].set(i,o),e[1].set(c,o),e[2].set(i,u),e[3].set(c,u)},n}(),ri._rectangleTriangles=[0,1,2,2,1,3],ri._worldMatrix=new te,ri))||Uo),va=function(l,a,t,e,r){e===void 0&&(e=null),r===void 0&&(r=null),this.vertexCount=l,this.positions=a,this.uvs=t,this.triangles=e,this.color=r},yn;(function(n){n[n.Layer0=1]="Layer0",n[n.Layer1=2]="Layer1",n[n.Layer2=4]="Layer2",n[n.Layer3=8]="Layer3",n[n.Layer4=16]="Layer4",n[n.Layer5=32]="Layer5",n[n.Layer6=64]="Layer6",n[n.Layer7=128]="Layer7",n[n.Layer8=256]="Layer8",n[n.Layer9=512]="Layer9",n[n.Layer10=1024]="Layer10",n[n.Layer11=2048]="Layer11",n[n.Layer12=4096]="Layer12",n[n.Layer13=8192]="Layer13",n[n.Layer14=16384]="Layer14",n[n.Layer15=32768]="Layer15",n[n.Layer16=65536]="Layer16",n[n.Layer17=131072]="Layer17",n[n.Layer18=262144]="Layer18",n[n.Layer19=524288]="Layer19",n[n.Layer20=1048576]="Layer20",n[n.Layer21=2097152]="Layer21",n[n.Layer22=4194304]="Layer22",n[n.Layer23=8388608]="Layer23",n[n.Layer24=16777216]="Layer24",n[n.Layer25=33554432]="Layer25",n[n.Layer26=67108864]="Layer26",n[n.Layer27=134217728]="Layer27",n[n.Layer28=268435456]="Layer28",n[n.Layer29=536870912]="Layer29",n[n.Layer30=1073741824]="Layer30",n[n.Layer31=2147483648]="Layer31",n[n.Everything=4294967295]="Everything"})(yn||(yn={}));var Se;(function(n){n[n.texture=1]="texture",n[n.size=2]="size",n[n.atlasRotate=4]="atlasRotate",n[n.atlasRegion=8]="atlasRegion",n[n.atlasRegionOffset=16]="atlasRegionOffset",n[n.region=32]="region",n[n.pivot=64]="pivot",n[n.border=128]="border"})(Se||(Se={}));var Ft,ko,Go,Ho,Wo,Xo,qo,jo,ni,wi=(Ft=(ni=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,U(e,"influenceLayers",ko,L(e)),e._maskElement=void 0,e._renderData=void 0,U(e,"_sprite",Go,L(e)),U(e,"_width",Ho,L(e)),U(e,"_height",Wo,L(e)),U(e,"_flipX",Xo,L(e)),U(e,"_flipY",qo,L(e)),U(e,"_alphaCutoff",jo,L(e)),e._renderData=new va(4,[],[]),Bn.resetData(L(e)),e.setMaterial(e._engine._spriteMaskDefaultMaterial),e.shaderData.setFloat(l._alphaCutoffProperty,e._alphaCutoff),e._onSpriteChange=e._onSpriteChange.bind(L(e)),e}var a=l.prototype;return a._onDestroy=function(){var e;(e=this._sprite)===null||e===void 0||e._updateFlagManager.removeListener(this._onSpriteChange),this._sprite=null,this._renderData=null,n.prototype._onDestroy.call(this)},a._render=function(e){var r;if(!(!((r=this.sprite)!==null&&r!==void 0&&r.texture)||!this.width||!this.height)){this._dirtyUpdateFlag&Ve.WorldVolume&&(Bn.updatePositions(this),this._dirtyUpdateFlag&=~Ve.WorldVolume),this._dirtyUpdateFlag&qr.UV&&(Bn.updateUVs(this),this._dirtyUpdateFlag&=~qr.UV);var i=this._engine._spriteMaskElementPool,o=i.getFromPool();o.setValue(this,this._renderData,this.getMaterial()),e.camera._renderPipeline._allSpriteMasks.add(this),this._maskElement=o}},a._cloneTo=function(e){e.sprite=this._sprite},a._updateBounds=function(e){var r;!((r=this.sprite)!==null&&r!==void 0&&r.texture)||!this.width||!this.height?(e.min.set(0,0,0),e.max.set(0,0,0)):Bn.updatePositions(this)},a._onSpriteChange=function(e){switch(e){case Se.texture:this.shaderData.setTexture(l._textureProperty,this.sprite.texture);break;case Se.region:case Se.atlasRegionOffset:this._dirtyUpdateFlag|=qr.All;break;case Se.atlasRegion:this._dirtyUpdateFlag|=qr.UV;break}},j(l,[{key:"width",get:function(){return this._width===void 0&&this._sprite&&(this.width=this._sprite.width),this._width},set:function(e){this._width!==e&&(this._width=e,this._dirtyUpdateFlag|=Ve.WorldVolume)}},{key:"height",get:function(){return this._height===void 0&&this._sprite&&(this.height=this._sprite.height),this._height},set:function(e){this._height!==e&&(this._height=e,this._dirtyUpdateFlag|=Ve.WorldVolume)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._dirtyUpdateFlag|=Ve.WorldVolume)}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._dirtyUpdateFlag|=Ve.WorldVolume)}},{key:"sprite",get:function(){return this._sprite},set:function(e){var r=this._sprite;r!==e&&(r&&r._updateFlagManager.removeListener(this._onSpriteChange),e?(e._updateFlagManager.addListener(this._onSpriteChange),this._dirtyUpdateFlag|=qr.All,this.shaderData.setTexture(l._textureProperty,e.texture)):this.shaderData.setTexture(l._textureProperty,null),this._sprite=e)}},{key:"alphaCutoff",get:function(){return this._alphaCutoff},set:function(e){this._alphaCutoff!==e&&(this._alphaCutoff=e,this.shaderData.setFloat(l._alphaCutoffProperty,e))}}]),l}(Jn),ni._textureProperty=O.getPropertyByName("u_maskTexture"),ni._alphaCutoffProperty=O.getPropertyByName("u_maskAlphaCutoff"),ni),ko=N(Ft.prototype,"influenceLayers",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yn.Everything}}),Go=N(Ft.prototype,"_sprite",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ho=N(Ft.prototype,"_width",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),Wo=N(Ft.prototype,"_height",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),Xo=N(Ft.prototype,"_flipX",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),qo=N(Ft.prototype,"_flipY",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jo=N(Ft.prototype,"_alphaCutoff",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return .5}}),N(Ft.prototype,"_onSpriteChange",[q],Object.getOwnPropertyDescriptor(Ft.prototype,"_onSpriteChange"),Ft.prototype),Ft),qr;(function(n){n[n.UV=2]="UV",n[n.All=3]="All"})(qr||(qr={}));var Z;(function(n){n[n.Float=0]="Float",n[n.Vector2=1]="Vector2",n[n.Vector3=2]="Vector3",n[n.Vector4=3]="Vector4",n[n.Byte4=4]="Byte4",n[n.UByte4=5]="UByte4",n[n.NormalizedByte4=6]="NormalizedByte4",n[n.NormalizedUByte4=7]="NormalizedUByte4",n[n.Short2=8]="Short2",n[n.UShort2=9]="UShort2",n[n.NormalizedShort2=10]="NormalizedShort2",n[n.NormalizedUShort2=11]="NormalizedUShort2",n[n.Short4=12]="Short4",n[n.UShort4=13]="UShort4",n[n.NormalizedShort4=14]="NormalizedShort4",n[n.NormalizedUShort4=15]="NormalizedUShort4"})(Z||(Z={}));var at;(function(n){n[n.Static=0]="Static",n[n.Dynamic=1]="Dynamic",n[n.Stream=2]="Stream"})(at||(at={}));var qe;(function(n){n[n.UInt8=0]="UInt8",n[n.UInt16=1]="UInt16",n[n.UInt32=2]="UInt32"})(qe||(qe={}));var Gn=function(){function n(){}return n._getGLBufferUsage=function(a,t){switch(t){case at.Static:return a.STATIC_DRAW;case at.Dynamic:return a.DYNAMIC_DRAW;case at.Stream:return a.STREAM_DRAW}},n._getGLIndexType=function(a){switch(a){case qe.UInt8:return Be.UNSIGNED_BYTE;case qe.UInt16:return Be.UNSIGNED_SHORT;case qe.UInt32:return Be.UNSIGNED_INT}},n._getGLIndexByteCount=function(a){switch(a){case qe.UInt8:return 1;case qe.UInt16:return 2;case qe.UInt32:return 4}},n._getElementInfo=function(a){var t,e,r=!1;switch(a){case Z.Float:t=1,e=Be.FLOAT;break;case Z.Vector2:t=2,e=Be.FLOAT;break;case Z.Vector3:t=3,e=Be.FLOAT;break;case Z.Vector4:t=4,e=Be.FLOAT;break;case Z.Byte4:t=4,e=Be.BYTE;break;case Z.UByte4:t=4,e=Be.UNSIGNED_BYTE;break;case Z.NormalizedByte4:t=4,e=Be.BYTE,r=!0;break;case Z.NormalizedUByte4:t=4,e=Be.UNSIGNED_BYTE,r=!0;break;case Z.Short2:t=2,e=Be.SHORT;break;case Z.UShort2:t=2,e=Be.UNSIGNED_SHORT;break;case Z.NormalizedShort2:t=2,e=Be.SHORT,r=!0;break;case Z.NormalizedUShort2:t=2,e=Be.UNSIGNED_SHORT,r=!0;break;case Z.Short4:t=4,e=Be.SHORT;break;case Z.UShort4:t=4,e=Be.UNSIGNED_SHORT;break;case Z.NormalizedShort4:t=4,e=Be.SHORT,r=!0;break;case Z.NormalizedUShort4:t=4,e=Be.UNSIGNED_SHORT,r=!0;break}return{size:t,type:e,normalized:r}},n}(),ge=function(){function n(l,a,t,e,r){r===void 0&&(r=0),this._glElementInfo=void 0,this._semantic=void 0,this._offset=void 0,this._format=void 0,this._bindingIndex=void 0,this._instanceStepRate=void 0,this._semantic=l,this._offset=a,this._format=t,this._bindingIndex=e,this._glElementInfo=Gn._getElementInfo(this.format),this._instanceStepRate=Math.floor(r)}return j(n,[{key:"semantic",get:function(){return this._semantic}},{key:"offset",get:function(){return this._offset},set:function(a){this._offset=a}},{key:"format",get:function(){return this._format}},{key:"bindingIndex",get:function(){return this._bindingIndex},set:function(a){this._bindingIndex=a}},{key:"instanceStepRate",get:function(){return this._instanceStepRate}}]),n}(),$t;(function(n){n[n.VertexBuffer=0]="VertexBuffer",n[n.IndexBuffer=1]="IndexBuffer"})($t||($t={}));var Hn;(function(n){n[n.None=0]="None",n[n.Discard=1]="Discard"})(Hn||(Hn={}));var gr=function(n){$(l,n);function l(t,e,r,i){var o;i===void 0&&(i=at.Static),o=n.call(this,t)||this,o._glBindTarget=void 0,o._glBufferUsage=void 0,o._nativeBuffer=void 0,o._hardwareRenderer=void 0,o._type=void 0,o._byteLength=void 0,o._bufferUsage=void 0,o._engine=t,o._type=e,o._bufferUsage=i;var s=t._hardwareRenderer,c=s.gl,u=Gn._getGLBufferUsage(c,i),_=e===$t.VertexBuffer?c.ARRAY_BUFFER:c.ELEMENT_ARRAY_BUFFER;return o._nativeBuffer=c.createBuffer(),o._hardwareRenderer=s,o._glBufferUsage=u,o._glBindTarget=_,o.bind(),typeof r=="number"?(o._byteLength=r,c.bufferData(_,r,u)):(o._byteLength=r.byteLength,c.bufferData(_,r,u)),c.bindBuffer(_,null),o}var a=l.prototype;return a.bind=function(){var e=this._hardwareRenderer.gl;e.bindBuffer(this._glBindTarget,this._nativeBuffer)},a.setData=function(e,r,i,o,s){r===void 0&&(r=0),i===void 0&&(i=0),s===void 0&&(s=Hn.None);var c=this._hardwareRenderer.gl,u=this._hardwareRenderer.isWebGL2,_=this._glBindTarget;this.bind(),s===Hn.Discard&&c.bufferData(_,this._byteLength,this._glBufferUsage);var h=e.BYTES_PER_ELEMENT||1,d=o?h*o:e.byteLength;if(i!==0||d<e.byteLength){var f=e.byteOffset!==void 0;if(u&&f)c.bufferSubData(_,r,e,i,d/h);else{var p=new Uint8Array(f?e.buffer:e,i*h,d);c.bufferSubData(_,r,p)}}else c.bufferSubData(_,r,e);c.bindBuffer(_,null)},a.getData=function(e,r,i,o){r===void 0&&(r=0),i===void 0&&(i=0);var s=this._hardwareRenderer.isWebGL2;if(s){var c=this._hardwareRenderer.gl;this.bind(),c.getBufferSubData(this._glBindTarget,r,e,i,o)}else throw"Buffer is write-only on WebGL1.0 platforms."},a._onDestroy=function(){var e=this._hardwareRenderer.gl;e.deleteBuffer(this._nativeBuffer),this._nativeBuffer=null,this._hardwareRenderer=null},a.resize=function(e){this.bind();var r=this._hardwareRenderer.gl;r.bufferData(this._glBindTarget,e,this._glBufferUsage),this._byteLength=e},j(l,[{key:"type",get:function(){return this._type}},{key:"byteLength",get:function(){return this._byteLength}},{key:"bufferUsage",get:function(){return this._bufferUsage}}]),l}(wr),rn;(function(n){n[n.Points=0]="Points",n[n.Lines=1]="Lines",n[n.LineLoop=2]="LineLoop",n[n.LineStrip=3]="LineStrip",n[n.Triangles=4]="Triangles",n[n.TriangleStrip=5]="TriangleStrip",n[n.TriangleFan=6]="TriangleFan"})(rn||(rn={}));var bi=function(){function n(l,a){this._buffer=void 0,this._format=void 0,this._buffer=l,this._format=a}return j(n,[{key:"buffer",get:function(){return this._buffer}},{key:"format",get:function(){return this._format}}]),n}(),pa=function(l,a,t){l===void 0&&(l=0),a===void 0&&(a=0),t===void 0&&(t=rn.Triangles),this.start=void 0,this.count=void 0,this.topology=void 0,this.start=l,this.count=a,this.topology=t},ga=function(n){$(l,n);function l(t,e){var r;r=n.call(this,t)||this,r.name=void 0,r._vertexElementMap={},r._glIndexType=void 0,r._glIndexByteCount=void 0,r._platformPrimitive=void 0,r._instanceCount=0,r._vertexBufferBindings=[],r._indexBufferBinding=null,r._vertexElements=[],r._enableVAO=!0,r._updateFlagManager=new mn,r._bounds=new Tt,r._subMeshes=[],r.name=e,r._platformPrimitive=r._engine._hardwareRenderer.createPlatformPrimitive(L(r)),r._onBoundsChanged=r._onBoundsChanged.bind(L(r));var i=r._bounds;return i.min._onValueChanged=r._onBoundsChanged,i.max._onValueChanged=r._onBoundsChanged,r}var a=l.prototype;return a.addSubMesh=function(e,r,i){return i===void 0&&(i=rn.Triangles),typeof e=="number"&&(e=new pa(e,r,i)),this._subMeshes.push(e),e},a.removeSubMesh=function(e){var r=this._subMeshes,i=r.indexOf(e);i!==-1&&r.splice(i,1)},a.clearSubMesh=function(){this._subMeshes.length=0},a._clearVertexElements=function(){this._vertexElements.length=0;var e=this._vertexElementMap;for(var r in e)delete e[r]},a._addVertexElement=function(e){var r=e.semantic;this._vertexElementMap[r]=e,this._vertexElements.push(e),this._updateFlagManager.dispatch(xn.VertexElements)},a._setVertexBufferBinding=function(e,r){if(this._getRefCount()>0){var i=this._vertexBufferBindings[e];i&&i._buffer._addRefCount(-1),r._buffer._addRefCount(1)}this._vertexBufferBindings[e]=r},a._draw=function(e,r){this._platformPrimitive.draw(e,r)},a._addRefCount=function(e){n.prototype._addRefCount.call(this,e);for(var r=this._vertexBufferBindings,i=0,o=r.length;i<o;i++)r[i]._buffer._addRefCount(e)},a._onDestroy=function(){this._vertexBufferBindings=null,this._indexBufferBinding=null,this._vertexElements=null,this._vertexElementMap=null,this._platformPrimitive.destroy()},a._setVertexElements=function(e){this._clearVertexElements();for(var r=0,i=e.length;r<i;r++)this._addVertexElement(e[r])},a._setIndexBufferBinding=function(e){e?(this._indexBufferBinding=e,this._glIndexType=Gn._getGLIndexType(e.format),this._glIndexByteCount=Gn._getGLIndexByteCount(e.format)):(this._indexBufferBinding=null,this._glIndexType=void 0)},a._onBoundsChanged=function(){this._updateFlagManager.dispatch(xn.Bounds)},j(l,[{key:"bounds",get:function(){return this._bounds},set:function(e){this._bounds!==e&&this._bounds.copyFrom(e)}},{key:"subMesh",get:function(){return this._subMeshes[0]||null}},{key:"subMeshes",get:function(){return this._subMeshes}}]),l}(wr),xn;(function(n){n[n.Bounds=1]="Bounds",n[n.VertexElements=2]="VertexElements"})(xn||(xn={}));var zi=function(){function n(l,a){this._buffer=void 0,this._stride=void 0,this._buffer=l,this._stride=a}return j(n,[{key:"buffer",get:function(){return this._buffer}},{key:"stride",get:function(){return this._stride}}]),n}(),Ir=function(){function n(a,t){this._blendShapeCount=0,this._blendShapes=[],this._blendShapeNames=void 0,this._subDataDirtyFlags=[],this._vertexTexture=void 0,this._vertexBuffers=[],this._vertices=void 0,this._useBlendNormal=!1,this._useBlendTangent=!1,this._vertexElementCount=0,this._vertexElementOffset=void 0,this._storeInVertexBufferInfo=[],this._maxCountSingleVertexBuffer=0,this._engine=void 0,this._modelMesh=void 0,this._lastCreateHostInfo=new w(0,0,0),this._canUseTextureStoreData=!0,this._dataTextureInfo=new w,this._engine=a,this._modelMesh=t,this._canUseTextureStoreData=this._engine._hardwareRenderer.capability.canUseFloatTextureBlendShape,this._updateLayoutChange=this._updateLayoutChange.bind(this)}var l=n.prototype;return l._addBlendShape=function(t){this._blendShapes.push(t),this._blendShapeCount++,t._layoutChangeManager.addListener(this._layoutOrCountChange),this._updateLayoutChange(t),this._subDataDirtyFlags.push(t._createSubDataDirtyFlag())},l._clearBlendShapes=function(){for(var t=this._blendShapes,e=0,r=t.length;e<r;e++)t[e]._layoutChangeManager.removeListener(this._layoutOrCountChange);this._useBlendNormal=!1,this._useBlendTangent=!1,this._vertexElementCount=0,this._blendShapes.length=0,this._blendShapeCount=0;for(var i=this._subDataDirtyFlags,o=0,s=i.length;o<s;o++)i[o].destroy();i.length=0},l._updateShaderData=function(t,e){var r=this._blendShapeCount;if(r>0){if(t.enableMacro(n._blendShapeMacro),this._useTextureMode())t.enableMacro(n._blendShapeTextureMacro),t.setTexture(n._blendShapeTextureProperty,this._vertexTexture),t.setVector3(n._blendShapeTextureInfoProperty,this._dataTextureInfo),t.setFloatArray(n._blendShapeWeightsProperty,e.blendShapeWeights);else{var i=this._getVertexBufferModeSupportCount();if(r>i){var o=e._condensedBlendShapeWeights;o||(o=new Float32Array(i),e._condensedBlendShapeWeights=o),this._filterCondensedBlendShapeWeights(e.blendShapeWeights,o),t.setFloatArray(n._blendShapeWeightsProperty,o),this._modelMesh._enableVAO=!1,r=i}else t.setFloatArray(n._blendShapeWeightsProperty,e.blendShapeWeights),this._modelMesh._enableVAO=!0;t.disableMacro(n._blendShapeTextureMacro)}t.enableMacro("OASIS_BLENDSHAPE_COUNT",r.toString()),this._useBlendNormal?t.enableMacro(n._blendShapeNormalMacro):t.disableMacro(n._blendShapeNormalMacro),this._useBlendTangent?t.enableMacro(n._blendShapeTangentMacro):t.disableMacro(n._blendShapeTangentMacro)}else t.disableMacro(n._blendShapeMacro),t.disableMacro("OASIS_BLENDSHAPE_COUNT")},l._useTextureMode=function(){return this._canUseTextureStoreData?this._blendShapeCount>this._getVertexBufferModeSupportCount():!1},l._layoutOrCountChange=function(){var t=this._lastCreateHostInfo;return t.x!==this._blendShapeCount||!!t.y!==this._useBlendNormal||!!t.z!==this._useBlendTangent},l._vertexElementsNeedUpdate=function(){var t=this._getVertexBufferModeSupportCount(),e=this._lastCreateHostInfo;return Math.min(e.x,t)!==Math.min(this._blendShapeCount,t)||!!e.y!==this._useBlendNormal||!!e.z!==this._useBlendTangent},l._needUpdateData=function(){for(var t=this._subDataDirtyFlags,e=0,r=t.length;e<r;e++)if(t[e].flag)return!0;return!1},l._addVertexElements=function(t){var e=0;this._vertexElementOffset=t._vertexElements.length;for(var r=0,i=Math.min(this._blendShapeCount,this._getVertexBufferModeSupportCount());r<i;r++)t._addVertexElement(new ge("POSITION_BS"+r,e,Z.Vector3,1)),e+=12,this._useBlendNormal&&(t._addVertexElement(new ge("NORMAL_BS"+r,e,Z.Vector3,1)),e+=12),this._useBlendTangent&&(t._addVertexElement(new ge("TANGENT_BS"+r,e,Z.Vector3,1)),e+=12)},l._update=function(t,e){var r=this._modelMesh.vertexCount,i=this._useTextureMode(),o=this._layoutOrCountChange()||t;o&&(i?this._createTextureArray(r):this._createVertexBuffers(r,e),this._lastCreateHostInfo.set(this._blendShapeCount,+this._useBlendNormal,+this._useBlendTangent)),this._needUpdateData()&&(i?this._updateTextureArray(r,o):this._updateVertexBuffers(r,o))},l._releaseMemoryCache=function(){for(var t=this._blendShapes,e=t.length,r=new Array(e),i=0;i<e;i++)r[i]=t[i].name;this._blendShapeNames=r;for(var o=0,s=t.length;o<s;o++)t[o]._layoutChangeManager.removeListener(this._layoutOrCountChange);for(var c=this._subDataDirtyFlags,u=0,_=c.length;u<_;u++)c[u].destroy();this._subDataDirtyFlags=null,this._blendShapes=null,this._vertices=null},l._createVertexBuffers=function(t,e){var r=this._engine,i=this._modelMesh,o=this._blendShapeCount,s=this._vertexBuffers,c=this._vertexElementCount*3,u=c*4,_=Math.floor(255/u),h=Math.ceil(o/_),d=c*t*Math.min(_,o);s.length=h,this._vertices=new Float32Array(d),this._maxCountSingleVertexBuffer=_,this._storeInVertexBufferInfo.length=o;for(var f=0;f<h;f++){var p=h-1,v=f===p?o-p*_:_,m=v*u,g=m*t,y=e?at.Static:at.Dynamic,x=new gr(r,$t.VertexBuffer,g,y);i._setVertexBufferBinding(f+1,new zi(x,m)),s[f]=x}},l._createTextureArray=function(t){var e=this._engine._hardwareRenderer.capability.maxTextureSize,r=this._vertexElementCount,i=r*t,o=1;i>e&&(o=Math.ceil(i/e),i=e);var s=this._vertexTexture,c=this._blendShapes.length;s&&s.destroy(),s=new _a(this._engine,i,o,c,H.R32G32B32A32,!1),s.filterMode=gt.Point,this._vertices=new Float32Array(c*i*o*4),this._vertexTexture=s,this._dataTextureInfo.set(r,i,o)},l._updateVertexBuffers=function(t,e){for(var r=this._blendShapes,i=this._maxCountSingleVertexBuffer,o=this._vertices,s=this._vertexBuffers,c=this._storeInVertexBufferInfo,u=this._subDataDirtyFlags,_=this._vertexElementCount*3,h=_*4,d=0,f=r.length;d<f;d++){var p=u[d];if(e||p.flag){var v=r[d].frames,m=v.length,g=v[m-1];if(m>0&&g.deltaPositions.length!==t)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";var y=Math.floor(d/i),x=d%i,b=s[y],S=b.byteLength/(t*4),P=x*_,T=c[d];T||(c[d]=T=new X),T.set(y+1,x*h);for(var E=g,M=E.deltaPositions,V=0;V<t;V++){var A=P+S*V,C=M[V];C&&(o[A]=C.x,o[A+1]=C.y,o[A+2]=C.z)}if(P+=3,this._useBlendNormal){var R=g,z=R.deltaNormals;if(z)for(var F=0;F<t;F++){var D=P+S*F,I=z[F];I&&(o[D]=I.x,o[D+1]=I.y,o[D+2]=I.z)}P+=3}if(this._useBlendTangent){var B=g,k=B.deltaTangents;if(k)for(var Y=0;Y<t;Y++){var K=P+S*Y,Q=k[Y];Q&&(o[K]=Q.x,o[K+1]=Q.y,o[K+2]=Q.z)}P+=3}(x===i-1||d===f-1)&&b.setData(o,0,0,b.byteLength/4),p.flag=!1}}},l._updateTextureArray=function(t,e){for(var r=this._blendShapes,i=this._vertexTexture,o=this._vertices,s=this._subDataDirtyFlags,c=0,u=r.length;c<u;c++){var _=s[c],h=i.width*i.height*4;if(e||_.flag){var d=r[c].frames,f=d.length,p=d[f-1];if(f>0&&p.deltaPositions.length!==t)throw"BlendShape frame deltaPositions length must same with mesh vertexCount.";for(var v=p,m=v.deltaPositions,g=v.deltaNormals,y=v.deltaTangents,x=c*h,b=0;b<t;b++){var S=m[b];if(o[x]=S.x,o[x+1]=S.y,o[x+2]=S.z,x+=4,g){var P=g[b];o[x]=P.x,o[x+1]=P.y,o[x+2]=P.z,x+=4}if(y){var T=y[b];o[x]=T.x,o[x+1]=T.y,o[x+2]=T.z,x+=4}}_.flag=!1}}i.setPixelBuffer(0,o)},l._updateLayoutChange=function(t){var e=this._blendShapeCount>1,r=1,i=t._useBlendShapeNormal,o=t._useBlendShapeTangent;e&&(i&&(i=this._useBlendNormal),o&&(o=this._useBlendTangent)),i&&r++,o&&r++,this._useBlendNormal=i,this._useBlendTangent=o,this._vertexElementCount=r},l._attributeModeUpdateVertexElement=function(t,e,r,i){var o=this._vertexElementOffset+this._vertexElementCount*i,s=e[r],c=s.x,u=s.y,_=t[o];if(_.bindingIndex=c,_.offset=u,this._useBlendNormal){var h=t[++o];u+=12,h.bindingIndex=c,h.offset=u}if(this._useBlendTangent){var d=t[++o];u+=12,d.bindingIndex=c,d.offset=u}},l._getVertexBufferModeSupportCount=function(){return this._useBlendNormal&&this._useBlendTangent?2:this._useBlendNormal||this._useBlendTangent?4:8},l._filterCondensedBlendShapeWeights=function(t,e){for(var r=e.length,i=this._modelMesh._vertexElements,o=this._storeInVertexBufferInfo,s=Number.POSITIVE_INFINITY,c,u=0,_=Math.min(t.length,this._blendShapeCount);u<_;u++){var h=t[u];if(u<r)this._attributeModeUpdateVertexElement(i,o,u,u),e[u]=h,h<s&&(s=h,c=u);else if(h>s){this._attributeModeUpdateVertexElement(i,o,u,c),e[c]=h,s=Number.POSITIVE_INFINITY;for(var d=0;d<r;d++){var f=e[d];f<s&&(s=f,c=d)}}}},n}();Ir._blendShapeMacro=O.getMacroByName("OASIS_BLENDSHAPE");Ir._blendShapeTextureMacro=O.getMacroByName("OASIS_BLENDSHAPE_TEXTURE");Ir._blendShapeNormalMacro=O.getMacroByName("OASIS_BLENDSHAPE_NORMAL");Ir._blendShapeTangentMacro=O.getMacroByName("OASIS_BLENDSHAPE_TANGENT");Ir._blendShapeWeightsProperty=O.getPropertyByName("u_blendShapeWeights");Ir._blendShapeTextureProperty=O.getPropertyByName("u_blendShapeTexture");Ir._blendShapeTextureInfoProperty=O.getPropertyByName("u_blendShapeTextureInfo");var nt=function(n){$(l,n);function l(t,e){var r;return r=n.call(this,t)||this,r._blendShapeManager=void 0,r._vertexCount=0,r._accessible=!0,r._verticesFloat32=null,r._verticesUint8=null,r._indices=null,r._indicesFormat=null,r._vertexSlotChanged=!0,r._vertexChangeFlag=0,r._indicesChangeFlag=!1,r._vertexStrideFloat=0,r._lastUploadVertexCount=-1,r._positions=[],r._normals=null,r._colors=null,r._tangents=null,r._uv=null,r._uv1=null,r._uv2=null,r._uv3=null,r._uv4=null,r._uv5=null,r._uv6=null,r._uv7=null,r._boneWeights=null,r._boneIndices=null,r.name=e,r._blendShapeManager=new Ir(t,L(r)),r}var a=l.prototype;return a.setPositions=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._positions=e,this._vertexCount=e.length,this._vertexChangeFlag|=ye.Position},a.getPositions=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._positions},a.setNormals=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._normals!=!!e,this._vertexChangeFlag|=ye.Normal,this._normals=e},a.getNormals=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._normals},a.setColors=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._colors!=!!e,this._vertexChangeFlag|=ye.Color,this._colors=e},a.getColors=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._colors},a.setBoneWeights=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=e!=null,this._vertexChangeFlag|=ye.BoneWeight,this._boneWeights=e},a.getBoneWeights=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneWeights},a.setBoneIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._boneIndices!=!!e,this._vertexChangeFlag|=ye.BoneIndex,this._boneIndices=e},a.getBoneIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._boneIndices},a.setTangents=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";this._vertexSlotChanged=!!this._tangents!=!!e,this._vertexChangeFlag|=ye.Tangent,this._tangents=e},a.getTangents=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._tangents},a.setUVs=function(e,r){var i;if(!this._accessible)throw"Not allowed to access data while accessible is false.";if(e.length!==this._vertexCount)throw"The array provided needs to be the same size as vertex count.";switch(r=(i=r)!=null?i:0,r){case 0:this._vertexSlotChanged=!!this._uv!=!!e,this._vertexChangeFlag|=ye.UV,this._uv=e;break;case 1:this._vertexSlotChanged=!!this._uv1!=!!e,this._vertexChangeFlag|=ye.UV1,this._uv1=e;break;case 2:this._vertexSlotChanged=!!this._uv2!=!!e,this._vertexChangeFlag|=ye.UV2,this._uv2=e;break;case 3:this._vertexSlotChanged=!!this._uv3!=!!e,this._vertexChangeFlag|=ye.UV3,this._uv3=e;break;case 4:this._vertexSlotChanged=!!this._uv4!=!!e,this._vertexChangeFlag|=ye.UV4,this._uv4=e;break;case 5:this._vertexSlotChanged=!!this._uv5!=!!e,this._vertexChangeFlag|=ye.UV5,this._uv5=e;break;case 6:this._vertexSlotChanged=!!this._uv6!=!!e,this._vertexChangeFlag|=ye.UV6,this._uv6=e;break;case 7:this._vertexSlotChanged=!!this._uv7!=!!e,this._vertexChangeFlag|=ye.UV7,this._uv7=e;break;default:throw"The index of channel needs to be in range [0 - 7]."}},a.getUVs=function(e){var r;if(!this._accessible)throw"Not allowed to access data while accessible is false.";switch(e=(r=e)!=null?r:0,e){case 0:return this._uv;case 1:return this._uv1;case 2:return this._uv2;case 3:return this._uv3;case 4:return this._uv4;case 5:return this._uv5;case 6:return this._uv6;case 7:return this._uv7}throw"The index of channel needs to be in range [0 - 7]."},a.setIndices=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._indices!==e&&(this._indices=e,e instanceof Uint8Array?this._indicesFormat=qe.UInt8:e instanceof Uint16Array?this._indicesFormat=qe.UInt16:e instanceof Uint32Array&&(this._indicesFormat=qe.UInt32)),this._indicesChangeFlag=!0},a.getIndices=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._indices},a.addBlendShape=function(e){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._blendShapeManager._addBlendShape(e)},a.clearBlendShapes=function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";this._blendShapeManager._clearBlendShapes()},a.getBlendShapeName=function(e){if(this._accessible){var r=this._blendShapeManager._blendShapes;return r[e].name}else return this._blendShapeManager._blendShapeNames[e]},a.uploadData=function(e){var r,i;if(!this._accessible)throw"Not allowed to access data while accessible is false.";var o=this._vertexCount,s=this._updateVertexElements(),c=this._lastUploadVertexCount!==o,u=(r=this._vertexBufferBindings[0])===null||r===void 0?void 0:r._buffer;if(c){u==null||u.destroy();var _=this._vertexStrideFloat,h=_*o,d=new Float32Array(h);this._verticesFloat32=d,this._verticesUint8=new Uint8Array(d.buffer),this._updateVertices(d,!0);var f=new gr(this._engine,$t.VertexBuffer,d,e?at.Static:at.Dynamic);this._setVertexBufferBinding(0,new zi(f,_*4)),this._lastUploadVertexCount=o}else if(this._vertexChangeFlag&ye.All){var p=this._verticesFloat32;this._updateVertices(p,s),u.setData(p)}var v=this._indices,m=(i=this._indexBufferBinding)===null||i===void 0?void 0:i._buffer;if(v)if(!m||v.byteLength!=m.byteLength){m==null||m.destroy();var g=new gr(this._engine,$t.IndexBuffer,v);this._setIndexBufferBinding(new bi(g,this._indicesFormat)),this._indicesChangeFlag=!1}else this._indicesChangeFlag&&(m.setData(v),this._indexBufferBinding._format!==this._indicesFormat&&this._setIndexBufferBinding(new bi(m,this._indicesFormat)),this._indicesChangeFlag=!1);else m&&(m.destroy(),this._setIndexBufferBinding(null));var y=this._blendShapeManager;y._blendShapeCount>0&&y._update(c,e),e&&(this._accessible=!1,this._releaseCache())},a.calculateTangents=function(){if(!this._normals||!this._uv)throw"Set normal and uv before calculation.";for(var e=this._indices,r=this._positions,i=this._normals,o=this._uv,s=this._vertexCount,c=l._tempVec0,u=l._tempVec1,_=l._tempVec2,h=l._tempVec3,d=l._tempVec4,f=e?e.length/3:r.length/3,p=new Array(s),v=new Array(s),m=0;m<s;m++)p[m]=new ve,v[m]=new w;for(var g=0;g<f;g++){var y=3*g,x=3*g+1,b=3*g+2;e&&(y=e[y],x=e[x],b=e[b]);var S=r[y],P=r[x],T=r[b],E=o[y],M=o[x],V=o[b];w.subtract(P,S,c),w.subtract(T,S,u);var A=M.x-E.x,C=V.x-E.x,R=M.y-E.y,z=V.y-E.y,F=1/(A*z-C*R);w.scale(c,z*F,_),w.scale(u,R*F,d),w.subtract(_,d,_),w.scale(u,A*F,h),w.scale(c,C*F,d),w.subtract(h,d,h);var D=p[y];D.set(D.x+_.x,D.y+_.y,D.z+_.z,1),D=p[x],D.set(D.x+_.x,D.y+_.y,D.z+_.z,1),D=p[b],D.set(D.x+_.x,D.y+_.y,D.z+_.z,1),v[y].add(h),v[x].add(h),v[b].add(h)}for(var I=0;I<s;I++){var B=i[I],k=v[I],Y=p[I];_.set(Y.x,Y.y,Y.z),w.cross(_,k,d);var K=w.dot(d,B)>0?1:-1;w.scale(B,w.dot(_,B),d),w.subtract(_,d,_),_.normalize(),Y.set(_.x,_.y,_.z,K)}this.setTangents(p)},a._onDestroy=function(){n.prototype._onDestroy.call(this),this._accessible&&this._releaseCache()},a._updateVertexElements=function(){var e=this._blendShapeManager,r=!e._useTextureMode();if(this._vertexSlotChanged||r&&e._vertexElementsNeedUpdate()){var i=12,o=3;return this._clearVertexElements(),this._addVertexElement(Sh),this._normals&&(this._addVertexElement(new ge("NORMAL",i,Z.Vector3,0)),i+=12,o+=3),this._colors&&(this._addVertexElement(new ge("COLOR_0",i,Z.Vector4,0)),i+=16,o+=4),this._boneWeights&&(this._addVertexElement(new ge("WEIGHTS_0",i,Z.Vector4,0)),i+=16,o+=4),this._boneIndices&&(this._addVertexElement(new ge("JOINTS_0",i,Z.UByte4,0)),i+=4,o+=1),this._tangents&&(this._addVertexElement(new ge("TANGENT",i,Z.Vector4,0)),i+=16,o+=4),this._uv&&(this._addVertexElement(new ge("TEXCOORD_0",i,Z.Vector2,0)),i+=8,o+=2),this._uv1&&(this._addVertexElement(new ge("TEXCOORD_1",i,Z.Vector2,0)),i+=8,o+=2),this._uv2&&(this._addVertexElement(new ge("TEXCOORD_2",i,Z.Vector2,0)),i+=8,o+=2),this._uv3&&(this._addVertexElement(new ge("TEXCOORD_3",i,Z.Vector2,0)),i+=8,o+=2),this._uv4&&(this._addVertexElement(new ge("TEXCOORD_4",i,Z.Vector2,0)),i+=8,o+=2),this._uv5&&(this._addVertexElement(new ge("TEXCOORD_5",i,Z.Vector2,0)),i+=8,o+=2),this._uv6&&(this._addVertexElement(new ge("TEXCOORD_6",i,Z.Vector2,0)),i+=8,o+=2),this._uv7&&(this._addVertexElement(new ge("TEXCOORD_7",i,Z.Vector2,0)),i+=8,o+=2),r&&e._blendShapeCount>0&&e._addVertexElements(this),this._vertexSlotChanged=!1,this._vertexStrideFloat=o,!0}return!1},a._updateVertices=function(e,r){var i=this._vertexStrideFloat,o=this._vertexCount,s=this._positions,c=this._normals,u=this._colors,_=this._vertexChangeFlag,h=this._boneWeights,d=this._boneIndices,f=this._tangents,p=this._uv,v=this._uv1,m=this._uv2,g=this._uv3,y=this._uv4,x=this._uv5,b=this._uv6,S=this._uv7;if(r&&(this._vertexChangeFlag=ye.All),_&ye.Position)for(var P=0;P<o;P++){var T=i*P,E=s[P];e[T]=E.x,e[T+1]=E.y,e[T+2]=E.z}var M=3;if(c){if(_&ye.Normal)for(var V=0;V<o;V++){var A=i*V+M,C=c[V];C&&(e[A]=C.x,e[A+1]=C.y,e[A+2]=C.z)}M+=3}if(u){if(_&ye.Color)for(var R=0;R<o;R++){var z=i*R+M,F=u[R];F&&(e[z]=F.r,e[z+1]=F.g,e[z+2]=F.b,e[z+3]=F.a)}M+=4}if(h){if(_&ye.BoneWeight)for(var D=0;D<o;D++){var I=i*D+M,B=h[D];B&&(e[I]=B.x,e[I+1]=B.y,e[I+2]=B.z,e[I+3]=B.w)}M+=4}if(d){if(_&ye.BoneIndex)for(var k=this._verticesUint8,Y=0;Y<o;Y++){var K=i*Y+M,Q=d[Y];if(Q){var ee=K*4;k[ee]=Q.x,k[ee+1]=Q.y,k[ee+2]=Q.z,k[ee+3]=Q.w}}M+=1}if(f){if(_&ye.Tangent)for(var de=0;de<o;de++){var pe=i*de+M,me=f[de];me&&(e[pe]=me.x,e[pe+1]=me.y,e[pe+2]=me.z,e[pe+3]=me.w)}M+=4}if(p){if(_&ye.UV)for(var Re=0;Re<o;Re++){var zt=i*Re+M,Le=p[Re];Le&&(e[zt]=Le.x,e[zt+1]=Le.y)}M+=2}if(v){if(_&ye.UV1)for(var ke=0;ke<o;ke++){var Je=i*ke+M,st=v[ke];st&&(e[Je]=st.x,e[Je+1]=st.y)}M+=2}if(m){if(_&ye.UV2)for(var Ae=0;Ae<o;Ae++){var mt=i*Ae+M,yt=m[Ae];yt&&(e[mt]=yt.x,e[mt+1]=yt.y)}M+=2}if(g){if(_&ye.UV3)for(var Ze=0;Ze<o;Ze++){var xt=i*Ze+M,Jt=g[Ze];Jt&&(e[xt]=Jt.x,e[xt+1]=Jt.y)}M+=2}if(y){if(_&ye.UV4)for(var lt=0;lt<o;lt++){var Sr=i*lt+M,on=y[lt];on&&(e[Sr]=on.x,e[Sr+1]=on.y)}M+=2}if(x){if(_&ye.UV5)for(var sn=0;sn<o;sn++){var ln=i*sn+M,cn=x[sn];cn&&(e[ln]=cn.x,e[ln+1]=cn.y)}M+=2}if(b){if(_&ye.UV6)for(var or=0;or<o;or++){var un=i*or+M,_n=b[or];_n&&(e[un]=_n.x,e[un+1]=_n.y)}M+=2}if(S){if(_&ye.UV7)for(var Or=0;Or<o;Or++){var Nr=i*Or+M,Ui=S[Or];Ui&&(e[Nr]=Ui.x,e[Nr+1]=Ui.y)}M+=2}this._vertexChangeFlag=0},a._releaseCache=function(){this._verticesUint8=null,this._indices=null,this._verticesFloat32=null,this._positions.length=0,this._tangents=null,this._normals=null,this._colors=null,this._uv=null,this._uv1=null,this._uv2=null,this._uv3=null,this._uv4=null,this._uv5=null,this._uv6=null,this._uv7=null,this._blendShapeManager._releaseMemoryCache()},j(l,[{key:"accessible",get:function(){return this._accessible}},{key:"vertexCount",get:function(){return this._vertexCount}},{key:"blendShapes",get:function(){if(!this._accessible)throw"Not allowed to access data while accessible is false.";return this._blendShapeManager._blendShapes}},{key:"blendShapeCount",get:function(){return this._blendShapeManager._blendShapeCount}}]),l}(ga);nt._tempVec0=new w;nt._tempVec1=new w;nt._tempVec2=new w;nt._tempVec3=new w;nt._tempVec4=new w;var Sh=new ge("POSITION",0,Z.Vector3,0),ye;(function(n){n[n.Position=1]="Position",n[n.Normal=2]="Normal",n[n.Color=4]="Color",n[n.Tangent=8]="Tangent",n[n.BoneWeight=16]="BoneWeight",n[n.BoneIndex=32]="BoneIndex",n[n.UV=64]="UV",n[n.UV1=128]="UV1",n[n.UV2=256]="UV2",n[n.UV3=512]="UV3",n[n.UV4=1024]="UV4",n[n.UV5=2048]="UV5",n[n.UV6=4096]="UV6",n[n.UV7=8192]="UV7",n[n.All=65535]="All"})(ye||(ye={}));var vu=function(n){$(l,n);function l(a){var t;return t=n.call(this,null)||this,t.name=a,t.inverseBindMatrices=void 0,t.joints=void 0,t.skeleton=void 0,t.inverseBindMatrices=[],t.joints=[],t.skeleton="none",t}return l}(xr),hn,$o,kr,Tn=(hn=(kr=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,U(e,"_mesh",$o,L(e)),e._onMeshChanged=e._onMeshChanged.bind(L(e)),e}var a=l.prototype;return a._render=function(e){var r=this._mesh;if(r){if(this._dirtyUpdateFlag&vn.VertexElementMacro){var i=this.shaderData,o=r._vertexElements;i.disableMacro(l._uvMacro),i.disableMacro(l._uv1Macro),i.disableMacro(l._normalMacro),i.disableMacro(l._tangentMacro),i.disableMacro(l._vertexColorMacro);for(var s=0,c=o.length;s<c;s++)switch(o[s].semantic){case"TEXCOORD_0":i.enableMacro(l._uvMacro);break;case"TEXCOORD_1":i.enableMacro(l._uv1Macro);break;case"NORMAL":i.enableMacro(l._normalMacro);break;case"TANGENT":i.enableMacro(l._tangentMacro);break;case"COLOR_0":i.enableMacro(l._vertexColorMacro);break}this._dirtyUpdateFlag&=~vn.VertexElementMacro}for(var u=r.subMeshes,_=e.camera._renderPipeline,h=this._engine._renderElementPool,d=0,f=u.length;d<f;d++){var p=this._materials[d];if(p)for(var v=p.renderStates,m=p.shader.passes,g=0,y=m.length;g<y;g++){var x=h.getFromPool();x.setValue(this,r,u[d],p,v[g],m[g]),_.pushPrimitive(x)}}}else ce.error("mesh is null.")},a._onDestroy=function(){n.prototype._onDestroy.call(this);var e=this._mesh;e&&!e.destroyed&&(e._addRefCount(-1),this._mesh=null)},a._cloneTo=function(e){e.mesh=this._mesh},a._updateBounds=function(e){var r=this._mesh;if(r){var i=r.bounds,o=this._entity.transform.worldMatrix;Tt.transform(i,o,e)}else e.min.set(0,0,0),e.max.set(0,0,0)},a._setMesh=function(e){var r=this._mesh;r&&(r._addRefCount(-1),r._updateFlagManager.removeListener(this._onMeshChanged)),e&&(e._addRefCount(1),e._updateFlagManager.addListener(this._onMeshChanged),this._dirtyUpdateFlag|=vn.All),this._mesh=e},a._onMeshChanged=function(e){e&xn.Bounds&&(this._dirtyUpdateFlag|=Ve.WorldVolume),e&xn.VertexElements&&(this._dirtyUpdateFlag|=vn.VertexElementMacro)},j(l,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&this._setMesh(e)}}]),l}(Jn),kr._uvMacro=O.getMacroByName("O3_HAS_UV"),kr._uv1Macro=O.getMacroByName("O3_HAS_UV1"),kr._normalMacro=O.getMacroByName("O3_HAS_NORMAL"),kr._tangentMacro=O.getMacroByName("O3_HAS_TANGENT"),kr._vertexColorMacro=O.getMacroByName("O3_HAS_VERTEXCOLOR"),kr),$o=N(hn.prototype,"_mesh",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),N(hn.prototype,"_onMeshChanged",[q],Object.getOwnPropertyDescriptor(hn.prototype,"_onMeshChanged"),hn.prototype),hn),vn;(function(n){n[n.VertexElementMacro=2]="VertexElementMacro",n[n.All=3]="All"})(vn||(vn={}));var ct,Yo,Qo,Jo,Zo,Ko,es,ts,rs,ns,is,Gr,ma=(ct=(Gr=function(n){$(l,n),l._matrixMultiply=function(e,r,i,o,s){var c=e.elements,u=c[0],_=c[1],h=c[2],d=c[3],f=c[4],p=c[5],v=c[6],m=c[7],g=c[8],y=c[9],x=c[10],b=c[11],S=c[12],P=c[13],T=c[14],E=c[15],M=r[i],V=r[i+1],A=r[i+2],C=r[i+3],R=r[i+4],z=r[i+5],F=r[i+6],D=r[i+7],I=r[i+8],B=r[i+9],k=r[i+10],Y=r[i+11],K=r[i+12],Q=r[i+13],ee=r[i+14],de=r[i+15];o[s]=u*M+f*V+g*A+S*C,o[s+1]=_*M+p*V+y*A+P*C,o[s+2]=h*M+v*V+x*A+T*C,o[s+3]=d*M+m*V+b*A+E*C,o[s+4]=u*R+f*z+g*F+S*D,o[s+5]=_*R+p*z+y*F+P*D,o[s+6]=h*R+v*z+x*F+T*D,o[s+7]=d*R+m*z+b*F+E*D,o[s+8]=u*I+f*B+g*k+S*Y,o[s+9]=_*I+p*B+y*k+P*Y,o[s+10]=h*I+v*B+x*k+T*Y,o[s+11]=d*I+m*B+b*k+E*Y,o[s+12]=u*K+f*Q+g*ee+S*de,o[s+13]=_*K+p*Q+y*ee+P*de,o[s+14]=h*K+v*Q+x*ee+T*de,o[s+15]=d*K+m*Q+b*ee+E*de};function l(t){var e;e=n.call(this,t)||this,U(e,"_hasInitJoints",Yo,L(e)),U(e,"_useJointTexture",Qo,L(e)),e._skin=void 0,U(e,"_blendShapeWeights",Jo,L(e)),U(e,"_maxVertexUniformVectors",Zo,L(e)),U(e,"_rootBone",Ko,L(e)),U(e,"_localBounds",es,L(e)),U(e,"_jointMatrixs",ts,L(e)),U(e,"_jointTexture",rs,L(e)),U(e,"_jointEntitys",ns,L(e)),U(e,"_condensedBlendShapeWeights",is,L(e)),e._skin=null;var r=e.entity.engine._hardwareRenderer,i=r.renderStates.getParameter(r.gl.MAX_VERTEX_UNIFORM_VECTORS);r.renderer==="Apple GPU"&&(i=Math.min(i,256)),e._maxVertexUniformVectors=i,e._onLocalBoundsChanged=e._onLocalBoundsChanged.bind(L(e));var o=e._localBounds;return o.min._onValueChanged=e._onLocalBoundsChanged,o.max._onValueChanged=e._onLocalBoundsChanged,e}var a=l.prototype;return a.update=function(){if(this._hasInitJoints||(this._initJoints(),this._hasInitJoints=!0),this._skin){for(var e=this._skin.inverseBindMatrices,r=this._rootBone.getInvModelMatrix(),i=this._jointEntitys,o=this._jointMatrixs,s=i.length-1;s>=0;s--){var c=i[s],u=s*16;c?l._matrixMultiply(c.transform.worldMatrix,e[s].elements,0,o,u):o.set(e[s].elements,u),l._matrixMultiply(r,o,u,o,u)}this._useJointTexture&&this._createJointTexture()}},a._updateShaderData=function(e){var r=this._rootBone?this._rootBone.transform.worldMatrix:this.entity.transform.worldMatrix;this._updateTransformShaderData(e,r);var i=this.shaderData;!this._useJointTexture&&this._jointMatrixs&&i.setFloatArray(l._jointMatrixProperty,this._jointMatrixs);var o=this.mesh;o._blendShapeManager._updateShaderData(i,this)},a._cloneTo=function(e){n.prototype._cloneTo.call(this,e),this._blendShapeWeights&&(e._blendShapeWeights=this._blendShapeWeights.slice())},a._registerEntityTransformListener=function(){},a._updateBounds=function(e){if(this._rootBone){var r=this._localBounds,i=this._rootBone.transform.worldMatrix;Tt.transform(r,i,e)}else n.prototype._updateBounds.call(this,e)},a._createJointTexture=function(){if(!this._jointTexture){var e=this.engine,r=e._hardwareRenderer;if(!r)return;this._jointTexture=new Mt(e,4,this._jointEntitys.length,H.R32G32B32A32,!1),this._jointTexture.filterMode=gt.Point,this.shaderData.enableMacro("O3_USE_JOINT_TEXTURE"),this.shaderData.setTexture(l._jointSamplerProperty,this._jointTexture)}this._jointTexture.setPixelBuffer(this._jointMatrixs)},a._initJoints=function(){var e=this.entity.engine._hardwareRenderer;if(!!e){var r=this._skin,i=this.shaderData;if(!r){i.disableMacro("O3_HAS_SKIN");return}for(var o=r.joints,s=o.length,c=new Array(s),u=s-1;u>=0;u--)c[u]=this._findByEntityName(this.entity,o[u]);this._jointEntitys=c,this._jointMatrixs=new Float32Array(s*16);var _=this._rootBone,h=this._findByEntityName(this.entity,r.skeleton);_&&_.transform._updateFlagManager.removeListener(this._onTransformChanged),h.transform._updateFlagManager.addListener(this._onTransformChanged);var d=o.indexOf(r.skeleton);if(d!==-1)Tt.transform(this._mesh.bounds,r.inverseBindMatrices[d],this._localBounds);else{var f=l._tempMatrix;te.invert(h.transform.worldMatrix,f),Tt.transform(this._mesh.bounds,f,this._localBounds)}this._rootBone=h;var p=Math.floor((this._maxVertexUniformVectors-30)/4);if(s)if(i.enableMacro("O3_HAS_SKIN"),i.setInt(l._jointCountProperty,s),s>p)e.canIUseMoreJoints?this._useJointTexture=!0:ce.error("component's joints count("+s+") greater than device's MAX_VERTEX_UNIFORM_VECTORS number "+this._maxVertexUniformVectors+", and don't support jointTexture in this device. suggest joint count less than "+p+".",this);else{var v=Math.max(l._maxJoints,s);l._maxJoints=v,i.disableMacro("O3_USE_JOINT_TEXTURE"),i.enableMacro("O3_JOINTS_NUM",v.toString())}else i.disableMacro("O3_HAS_SKIN")}},a._findByEntityName=function(e,r){if(!e)return null;var i=e.findByName(r);return i||this._findByEntityName(e.parent,r)},a._checkBlendShapeWeightLength=function(){var e=this._mesh,r=e?e.blendShapeCount:0,i=this._blendShapeWeights;if(i){if(i.length!==r){var o=new Float32Array(r);if(r>i.length)o.set(i);else for(var s=0,c=i.length;s<c;s++)i[s]=o[s];this._blendShapeWeights=o}}else this._blendShapeWeights=new Float32Array(r)},a._onLocalBoundsChanged=function(){this._dirtyUpdateFlag|=Ve.WorldVolume},j(l,[{key:"blendShapeWeights",get:function(){return this._checkBlendShapeWeightLength(),this._blendShapeWeights},set:function(e){this._checkBlendShapeWeightLength();var r=this._blendShapeWeights;if(e.length<=r.length)r.set(e);else for(var i=0,o=r.length;i<o;i++)r[i]=e[i]}},{key:"skin",get:function(){return this._skin},set:function(e){this._skin!==e&&(this._skin=e,this._hasInitJoints=!1)}},{key:"localBounds",get:function(){return this._localBounds},set:function(e){this._localBounds!==e&&this._localBounds.copyFrom(e)}},{key:"rootBone",get:function(){return this._rootBone},set:function(e){this._rootBone=e,this._dirtyUpdateFlag|=Ve.WorldVolume}}]),l}(Tn),Gr._tempMatrix=new te,Gr._jointCountProperty=O.getPropertyByName("u_jointCount"),Gr._jointSamplerProperty=O.getPropertyByName("u_jointSampler"),Gr._jointMatrixProperty=O.getPropertyByName("u_jointMatrix"),Gr._maxJoints=0,Gr),Yo=N(ct.prototype,"_hasInitJoints",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Qo=N(ct.prototype,"_useJointTexture",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Jo=N(ct.prototype,"_blendShapeWeights",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Zo=N(ct.prototype,"_maxVertexUniformVectors",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ko=N(ct.prototype,"_rootBone",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),es=N(ct.prototype,"_localBounds",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tt}}),ts=N(ct.prototype,"_jointMatrixs",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rs=N(ct.prototype,"_jointTexture",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),ns=N(ct.prototype,"_jointEntitys",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),is=N(ct.prototype,"_condensedBlendShapeWeights",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),N(ct.prototype,"_onLocalBoundsChanged",[q],Object.getOwnPropertyDescriptor(ct.prototype,"_onLocalBoundsChanged"),ct.prototype),ct),pu=function(){function n(){}return n.createSphere=function(a,t,e,r){t===void 0&&(t=.5),e===void 0&&(e=18),r===void 0&&(r=!0);var i=new nt(a);e=Math.max(2,Math.floor(e));for(var o=e+1,s=o*o,c=e*e,u=n._generateIndices(a,s,c*6),_=Math.PI,h=_*2,d=1/o,f=1/e,p=new Array(s),v=new Array(s),m=new Array(s),g=0;g<s;++g){var y=g%o,x=g*d|0,b=y*f,S=x*f,P=b*h,T=S*_,E=Math.sin(T),M=-t*Math.cos(P)*E,V=t*Math.cos(T),A=t*Math.sin(P)*E;p[g]=new w(M,V,A),v[g]=new w(M,V,A),m[g]=new X(b,S)}for(var C=0,R=0;R<c;++R){var z=R%e,F=R*f|0,D=F*o+z,I=D+1,B=D+o,k=B+1;u[C++]=I,u[C++]=D,u[C++]=k,u[C++]=D,u[C++]=B,u[C++]=k}var Y=i.bounds;return Y.min.set(-t,-t,-t),Y.max.set(t,t,t),n._initialize(i,p,v,m,u,r),i},n.createCuboid=function(a,t,e,r,i){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),i===void 0&&(i=!0);var o=new nt(a),s=t/2,c=e/2,u=r/2,_=new Array(24),h=new Array(24),d=new Array(24);_[0]=new w(-s,c,-u),_[1]=new w(s,c,-u),_[2]=new w(s,c,u),_[3]=new w(-s,c,u),h[0]=new w(0,1,0),h[1]=new w(0,1,0),h[2]=new w(0,1,0),h[3]=new w(0,1,0),d[0]=new X(0,0),d[1]=new X(1,0),d[2]=new X(1,1),d[3]=new X(0,1),_[4]=new w(-s,-c,-u),_[5]=new w(s,-c,-u),_[6]=new w(s,-c,u),_[7]=new w(-s,-c,u),h[4]=new w(0,-1,0),h[5]=new w(0,-1,0),h[6]=new w(0,-1,0),h[7]=new w(0,-1,0),d[4]=new X(0,1),d[5]=new X(1,1),d[6]=new X(1,0),d[7]=new X(0,0),_[8]=new w(-s,c,-u),_[9]=new w(-s,c,u),_[10]=new w(-s,-c,u),_[11]=new w(-s,-c,-u),h[8]=new w(-1,0,0),h[9]=new w(-1,0,0),h[10]=new w(-1,0,0),h[11]=new w(-1,0,0),d[8]=new X(0,0),d[9]=new X(1,0),d[10]=new X(1,1),d[11]=new X(0,1),_[12]=new w(s,c,-u),_[13]=new w(s,c,u),_[14]=new w(s,-c,u),_[15]=new w(s,-c,-u),h[12]=new w(1,0,0),h[13]=new w(1,0,0),h[14]=new w(1,0,0),h[15]=new w(1,0,0),d[12]=new X(1,0),d[13]=new X(0,0),d[14]=new X(0,1),d[15]=new X(1,1),_[16]=new w(-s,c,u),_[17]=new w(s,c,u),_[18]=new w(s,-c,u),_[19]=new w(-s,-c,u),h[16]=new w(0,0,1),h[17]=new w(0,0,1),h[18]=new w(0,0,1),h[19]=new w(0,0,1),d[16]=new X(0,0),d[17]=new X(1,0),d[18]=new X(1,1),d[19]=new X(0,1),_[20]=new w(-s,c,-u),_[21]=new w(s,c,-u),_[22]=new w(s,-c,-u),_[23]=new w(-s,-c,-u),h[20]=new w(0,0,-1),h[21]=new w(0,0,-1),h[22]=new w(0,0,-1),h[23]=new w(0,0,-1),d[20]=new X(1,0),d[21]=new X(0,0),d[22]=new X(0,1),d[23]=new X(1,1);var f=new Uint16Array(36);f[0]=0,f[1]=2,f[2]=1,f[3]=2,f[4]=0,f[5]=3,f[6]=4,f[7]=6,f[8]=7,f[9]=6,f[10]=4,f[11]=5,f[12]=8,f[13]=10,f[14]=9,f[15]=10,f[16]=8,f[17]=11,f[18]=12,f[19]=14,f[20]=15,f[21]=14,f[22]=12,f[23]=13,f[24]=16,f[25]=18,f[26]=17,f[27]=18,f[28]=16,f[29]=19,f[30]=20,f[31]=22,f[32]=23,f[33]=22,f[34]=20,f[35]=21;var p=o.bounds;return p.min.set(-s,-c,-u),p.max.set(s,c,u),n._initialize(o,_,h,d,f,i),o},n.createPlane=function(a,t,e,r,i,o){t===void 0&&(t=1),e===void 0&&(e=1),r===void 0&&(r=1),i===void 0&&(i=1),o===void 0&&(o=!0);var s=new nt(a);r=Math.max(1,Math.floor(r)),i=Math.max(1,Math.floor(i));for(var c=r+1,u=i+1,_=t/2,h=e/2,d=t/r,f=e/i,p=c*u,v=i*r,m=n._generateIndices(a,p,v*6),g=1/c,y=1/r,x=1/i,b=new Array(p),S=new Array(p),P=new Array(p),T=0;T<p;++T){var E=T%c,M=T*g|0;b[T]=new w(E*d-_,0,M*f-h),S[T]=new w(0,1,0),P[T]=new X(E*y,M*x)}for(var V=0,A=0;A<v;++A){var C=A%r,R=A*y|0,z=R*c+C,F=z+1,D=z+c,I=D+1;m[V++]=z,m[V++]=D,m[V++]=F,m[V++]=D,m[V++]=I,m[V++]=F}var B=s.bounds;return B.min.set(-_,0,-h),B.max.set(_,0,h),n._initialize(s,b,S,P,m,o),s},n.createCylinder=function(a,t,e,r,i,o,s){t===void 0&&(t=.5),e===void 0&&(e=.5),r===void 0&&(r=2),i===void 0&&(i=20),o===void 0&&(o=1),s===void 0&&(s=!0);var c=new nt(a);i=Math.floor(i),o=Math.floor(o);for(var u=i+1,_=o+1,h=r*.5,d=r/o,f=u*_,p=i*o,v=i*2,m=f+2+v,g=n._generateIndices(a,m,p*6+v*3),y=1/u,x=1/i,b=1/o,S=new Array(m),P=new Array(m),T=new Array(m),E=0,M=Math.PI,V=Math.PI*2,A=e-t,C=A/r,R=A/o,z=0;z<f;++z){var F=z%u,D=z*y|0,I=F*x,B=D*b,k=M+I*V,Y=Math.sin(k),K=Math.cos(k),Q=e-D*R,ee=Q*Y,de=D*d-h,pe=Q*K;S[z]=new w(ee,de,pe),P[z]=new w(Y,C,K),T[z]=new X(I,1-B)}for(var me=0;me<p;++me){var Re=me%i,zt=me*x|0,Le=zt*u+Re,ke=Le+1,Je=Le+u,st=Je+1;g[E++]=ke,g[E++]=Je,g[E++]=Le,g[E++]=ke,g[E++]=st,g[E++]=Je}S[f]=new w(0,-h,0),P[f]=new w(0,-1,0),T[f]=new X(.5,.5),S[f+1]=new w(0,h,0),P[f+1]=new w(0,1,0),T[f+1]=new X(.5,.5);for(var Ae=f+2,mt=1/(t*2),yt=1/(e*2),Ze=u*o,xt=0;xt<i;++xt){var Jt=S[xt],lt=Jt.x,Sr=Jt.z;S[Ae]=new w(lt,-h,Sr),P[Ae]=new w(0,-1,0),T[Ae++]=new X(lt*yt+.5,.5-Sr*yt);var on=S[xt+Ze];lt=on.x,Sr=on.z,S[Ae]=new w(lt,h,Sr),P[Ae]=new w(0,1,0),T[Ae++]=new X(lt*mt+.5,Sr*mt+.5)}for(var sn=f+1,ln=f+2,cn=ln+1,or=0;or<i;++or){var un=or*2,_n=or===i-1?0:un+2;g[E++]=f,g[E++]=ln+_n,g[E++]=ln+un,g[E++]=sn,g[E++]=cn+un,g[E++]=cn+_n}var Or=c.bounds,Nr=Math.max(t,e);return Or.min.set(-Nr,-h,-Nr),Or.max.set(Nr,h,Nr),n._initialize(c,S,P,T,g,s),c},n.createTorus=function(a,t,e,r,i,o,s){t===void 0&&(t=.5),e===void 0&&(e=.1),r===void 0&&(r=30),i===void 0&&(i=30),o===void 0&&(o=360),s===void 0&&(s=!0);var c=new nt(a);r=Math.floor(r),i=Math.floor(i);var u=(r+1)*(i+1),_=r*i,h=n._generateIndices(a,u,_*6),d=new Array(u),f=new Array(u),p=new Array(u);o=o/180*Math.PI;for(var v=0,m=0;m<=r;m++)for(var g=0;g<=i;g++){var y=g/i*o,x=m/r*Math.PI*2,b=Math.cos(x),S=Math.sin(x),P=Math.cos(y),T=Math.sin(y),E=new w((t+e*b)*P,(t+e*b)*T,e*S);d[v]=E;var M=t*P,V=t*T;f[v]=new w(E.x-M,E.y-V,E.z).normalize(),p[v++]=new X(g/i,m/r)}v=0;for(var A=1;A<=r;A++)for(var C=1;C<=i;C++){var R=(i+1)*A+C-1,z=(i+1)*(A-1)+C-1,F=(i+1)*(A-1)+C,D=(i+1)*A+C;h[v++]=R,h[v++]=z,h[v++]=D,h[v++]=z,h[v++]=F,h[v++]=D}var I=c.bounds,B=t+e;return I.min.set(-B,-B,-e),I.max.set(B,B,e),n._initialize(c,d,f,p,h,s),c},n.createCone=function(a,t,e,r,i,o){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=20),i===void 0&&(i=1),o===void 0&&(o=!0);var s=new nt(a);r=Math.floor(r),i=Math.floor(i);for(var c=r+1,u=i+1,_=e*.5,h=e/i,d=c*u,f=r*i,p=d+1+r,v=n._generateIndices(a,p,f*6+r*3),m=1/c,g=1/r,y=1/i,x=new Array(p),b=new Array(p),S=new Array(p),P=0,T=Math.PI,E=Math.PI*2,M=t/e,V=0;V<d;++V){var A=V%c,C=V*m|0,R=A*g,z=C*y,F=T+R*E,D=Math.sin(F),I=Math.cos(F),B=t-C*t,k=B*D,Y=C*h-_,K=B*I;x[V]=new w(k,Y,K),b[V]=new w(D,M,I),S[V]=new X(R,1-z)}for(var Q=0;Q<f;++Q){var ee=Q%r,de=Q*g|0,pe=de*c+ee,me=pe+1,Re=pe+c,zt=Re+1;v[P++]=me,v[P++]=Re,v[P++]=pe,v[P++]=me,v[P++]=zt,v[P++]=Re}x[d]=new w(0,-_,0),b[d]=new w(0,-1,0),S[d]=new X(.5,.5);for(var Le=d+1,ke=1/(t*2),Je=0;Je<r;++Je){var st=x[Je],Ae=st.x,mt=st.z;x[Le]=new w(Ae,-_,mt),b[Le]=new w(0,-1,0),S[Le++]=new X(Ae*ke+.5,.5-mt*ke)}for(var yt=d+1,Ze=0;Ze<r;++Ze){var xt=Ze,Jt=Ze===r-1?0:xt+1;v[P++]=d,v[P++]=yt+Jt,v[P++]=yt+xt}var lt=s.bounds;return lt.min.set(-t,-_,-t),lt.max.set(t,_,t),n._initialize(s,x,b,S,v,o),s},n.createCapsule=function(a,t,e,r,i,o){t===void 0&&(t=.5),e===void 0&&(e=2),r===void 0&&(r=6),i===void 0&&(i=1),o===void 0&&(o=!0);var s=new nt(a);r=Math.max(2,Math.floor(r)),i=Math.floor(i);for(var c=r+1,u=i+1,_=e*.5,h=e/i,d=c*u,f=r*i,p=c*c,v=r*r,m=d+2*p,g=n._generateIndices(a,m,(f+2*v)*6),y=1/c,x=1/r,b=1/i,S=Math.PI,P=Math.PI*2,T=new Array(m),E=new Array(m),M=new Array(m),V=0,A=0;A<d;++A){var C=A%c,R=A*y|0,z=C*x,F=R*b,D=S+z*P,I=Math.sin(D),B=Math.cos(D);T[A]=new w(t*I,R*h-_,t*B),E[A]=new w(I,0,B),M[A]=new X(z,1-F)}for(var k=0;k<f;++k){var Y=k%r,K=k*x|0,Q=K*c+Y,ee=Q+1,de=Q+c,pe=de+1;g[V++]=ee,g[V++]=de,g[V++]=Q,g[V++]=ee,g[V++]=pe,g[V++]=de}n._createCapsuleCap(t,e,r,P,d,1,T,E,M,g,V),n._createCapsuleCap(t,e,r,-P,d+p,-1,T,E,M,g,V+6*v);var me=s.bounds;return me.min.set(-t,-t-_,-t),me.max.set(t,t+_,t),n._initialize(s,T,E,M,g,o),s},n._initialize=function(a,t,e,r,i,o){a.setPositions(t),a.setNormals(e),a.setUVs(r),a.setIndices(i),a.calculateTangents(),a.uploadData(o),a.addSubMesh(0,i.length)},n._generateIndices=function(a,t,e){var r=null;if(t>65535)if(a._hardwareRenderer.canIUse(J.elementIndexUint))r=new Uint32Array(e);else throw Error("The vertex count is over limit.");else r=new Uint16Array(e);return r},n._createCapsuleCap=function(a,t,e,r,i,o,s,c,u,_,h){for(var d=e+1,f=t*.5*o,p=d*d,v=e*e,m=1/d,g=1/e,y=0;y<p;++y){var x=y%d,b=y*m|0,S=x*g,P=b*g,T=S*r,E=P*Math.PI/2,M=Math.sin(E),V=-a*Math.cos(T)*M,A=a*Math.cos(E)*o+f,C=a*Math.sin(T)*M,R=y+i;s[R]=new w(V,A,C),c[R]=new w(V,A-f,C),u[R]=new X(S,P)}for(var z=0;z<v;++z){var F=z%e,D=z*g|0,I=D*d+F+i,B=I+1,k=I+d,Y=k+1;_[h++]=B,_[h++]=I,_[h++]=Y,_[h++]=I,_[h++]=k,_[h++]=Y}},n}(),Fi=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.setVertexElements=function(e){this._setVertexElements(e)},a.setVertexBufferBinding=function(e,r,i){r===void 0&&(r=0),i===void 0&&(i=0);var o=e,s=o.buffer!==void 0;s||(o=new zi(e,r));var c=this._vertexBufferBindings;c.length<=i&&(c.length=i+1),this._setVertexBufferBinding(s?r:i,o)},a.setVertexBufferBindings=function(e,r){r===void 0&&(r=0);var i=this._vertexBufferBindings,o=e.length,s=r+o;i.length<s&&(i.length=s);for(var c=0;c<o;c++)this._setVertexBufferBinding(r+c,e[c])},a.setIndexBufferBinding=function(e,r){var i=e;if(i){var o=i.buffer!==void 0;o||(i=new bi(e,r))}this._setIndexBufferBinding(i)},j(l,[{key:"instanceCount",get:function(){return this._instanceCount},set:function(e){this._instanceCount=e}},{key:"vertexBufferBindings",get:function(){return this._vertexBufferBindings}},{key:"indexBufferBinding",get:function(){return this._indexBufferBinding}},{key:"vertexElements",get:function(){return this._vertexElements}}]),l}(ga),gu=function(l,a,t,e){if(t===void 0&&(t=null),e===void 0&&(e=null),this.weight=void 0,this.deltaPositions=void 0,this.deltaNormals=void 0,this.deltaTangents=void 0,t&&t.length!==a.length)throw"deltaNormals length must same with deltaPositions length.";if(e&&e.length!==a.length)throw"deltaTangents length must same with deltaPositions length.";this.weight=l,this.deltaPositions=a,this.deltaNormals=t,this.deltaTangents=e},ya=function(){function n(a){this.name=void 0,this._useBlendShapeNormal=!0,this._useBlendShapeTangent=!0,this._layoutChangeManager=new mn,this._dataChangeManager=new mn,this._frames=[],this.name=a}var l=n.prototype;return l.addFrame=function(t,e,r,i){if(typeof t=="number"){var o=new gu(t,e,r,i);return this._addFrame(o),o}else this._addFrame(t)},l.clearFrames=function(){this._frames.length=0,this._updateUseNormalAndTangent(!0,!0),this._dataChangeManager.dispatch()},l._addDataDirtyFlag=function(t){this._dataChangeManager.addFlag(t)},l._createSubDataDirtyFlag=function(){return this._dataChangeManager.createFlag(Ai)},l._addFrame=function(t){var e=this._frames,r=e.length;if(r>0&&t.deltaPositions.length!==e[r-1].deltaPositions.length)throw"Frame's deltaPositions length must same with before frame deltaPositions length.";this._frames.push(t),this._updateUseNormalAndTangent(!!t.deltaNormals,!!t.deltaTangents),this._dataChangeManager.dispatch()},l._updateUseNormalAndTangent=function(t,e){var r=this._useBlendShapeNormal&&t,i=this._useBlendShapeTangent&&e;(this._useBlendShapeNormal!==r||this._useBlendShapeTangent!==i)&&(this._useBlendShapeNormal=r,this._useBlendShapeTangent=i,this._layoutChangeManager.dispatch(0,this))},j(n,[{key:"frames",get:function(){return this._frames}}]),n}(),Bi=function(){function n(a){this._engine=void 0,this._subMeshPool=new $r(pa),this._batchedQueue=[],this._meshes=[],this._meshCount=1,this._vertexBuffers=[],this._indiceBuffers=[],this._vertices=void 0,this._indices=void 0,this._flushId=0,this._vertexCount=0,this._elementCount=0,this._engine=a;var t=n.MAX_VERTEX_COUNT;this._vertices=new Float32Array(t*9),this._indices=new Uint16Array(t*3);for(var e=this._meshes,r=this._meshCount,i=0;i<r;i++)e[i]=this._createMesh(a,i)}var l=n.prototype;return l.drawElement=function(t,e,r){if(t.multiRenderData)for(var i=t.charElements,o=0,s=i.length;o<s;++o)this._drawSubElement(i[o],e,r);else this._drawSubElement(t,e,r)},l._drawSubElement=function(t,e,r){var i=t.renderData.vertexCount;this._vertexCount+i>n.MAX_VERTEX_COUNT&&this.flush(e,r),this._vertexCount+=i,this._batchedQueue[this._elementCount++]=t},l.flush=function(t,e){var r=this._batchedQueue;r.length!==0&&(this._updateData(this._engine),this.drawBatches(t,e),n._canUploadSameBuffer||this._flushId++,r.length=0,this._subMeshPool.resetPool(),this._vertexCount=0,this._elementCount=0)},l.clear=function(){this._flushId=0,this._vertexCount=0,this._elementCount=0,this._batchedQueue.length=0},l.destroy=function(){this._batchedQueue=null;for(var t=this._meshes,e=this._vertexBuffers,r=this._indiceBuffers,i=0,o=t.length;i<o;++i)t[i].destroy();this._meshes=null;for(var s=0,c=e.length;s<c;++s)e[s].destroy();this._vertexBuffers=null;for(var u=0,_=r.length;u<_;++u)r[u].destroy();this._indiceBuffers=null},l._createMesh=function(t,e){var r=n.MAX_VERTEX_COUNT,i=new Fi(t,"BufferMesh"+e),o=[],s=this.createVertexElements(o);return this._vertexBuffers[e]=new gr(t,$t.VertexBuffer,r*4*s,at.Dynamic),this._indiceBuffers[e]=new gr(t,$t.IndexBuffer,r*3,at.Dynamic),i.setVertexBufferBinding(this._vertexBuffers[e],s),i.setIndexBufferBinding(this._indiceBuffers[e],qe.UInt16),i.setVertexElements(o),i},l._updateData=function(t){var e=this._meshes,r=this._flushId;!n._canUploadSameBuffer&&this._meshCount<=r&&(this._meshCount++,e[r]=this._createMesh(t,r));var i=this._batchedQueue,o=this._vertices,s=this._indices,c=e[r];c.clearSubMesh();for(var u=0,_=0,h=0,d=0,f=0,p=0,v=null,m=0,g=i.length;m<g;m++){var y=i[m];u=this.updateVertices(y,o,u);for(var x=y.renderData.triangles,b=x.length,S=0;S<b;S++)s[_++]=x[S]+f;f+=y.renderData.vertexCount,v===null||this.canBatch(v,y)?d+=b:(c.addSubMesh(this._getSubMeshFromPool(h,d)),h+=d,d=b,i[p++]=v),v=y}c.addSubMesh(this._getSubMeshFromPool(h,d)),i[p]=v,this._vertexBuffers[r].setData(o,0,0,u),this._indiceBuffers[r].setData(s,0,0,_)},l._getSubMeshFromPool=function(t,e){var r=this._subMeshPool.getFromPool();return r.start=t,r.count=e,r.topology=rn.Triangles,r},n}();Bi.MAX_VERTEX_COUNT=4096;Bi._canUploadSameBuffer=!0;var Th=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.createVertexElements=function(e){return e[0]=new ge("POSITION",0,Z.Vector3,0),e[1]=new ge("TEXCOORD_0",12,Z.Vector2,0),20},a.canBatch=function(e,r){if(e.isAdd!==r.isAdd)return!1;var i=e.component.shaderData,o=r.component.shaderData,s=wi._textureProperty,c=wi._alphaCutoffProperty;return i.getTexture(s)===o.getTexture(s)&&i.getTexture(c)===o.getTexture(c)},a.updateVertices=function(e,r,i){for(var o=e.renderData,s=o.positions,c=o.uvs,u=o.vertexCount,_=0;_<u;_++){var h=s[_],d=c[_];r[i++]=h.x,r[i++]=h.y,r[i++]=h.z,r[i++]=d.x,r[i++]=d.y}return i},a.drawBatches=function(e){for(var r=this._engine,i=this._batchedQueue,o=this._meshes[this._flushId],s=o.subMeshes,c=e.scene.shaderData,u=e.shaderData,_=0,h=s.length;_<h;_++){var d=s[_],f=i[_];if(!d||!f)return;var p=f.component,v=f.material,m=O._compileMacros;Et.unionCollection(p._globalShaderMacro,v.shaderData._macroCollection,m);var g=v.renderState.stencilState,y=f.isAdd?He.IncrementSaturate:He.DecrementSaturate;g.passOperationFront=y,g.passOperationBack=y;var x=v.shader.passes[0]._getShaderProgram(r,m);if(!x.isValid)return;x.bind(),x.groupingOtherUniformBlock(),x.uploadAll(x.sceneUniformBlock,c),x.uploadAll(x.cameraUniformBlock,u),x.uploadAll(x.rendererUniformBlock,p.shaderData),x.uploadAll(x.materialUniformBlock,v.shaderData),v.renderState._apply(r,!1),r._hardwareRenderer.drawPrimitive(o,d,x)}},l}(Bi),Ah=function(){function n(a){this._batcher=void 0,this._preMaskLayer=0,this._batcher=new Th(a)}var l=n.prototype;return l.clear=function(){this._preMaskLayer=0,this._batcher.clear()},l.preRender=function(t,e){e.maskInteraction!==Ot.None&&(this._batcher.clear(),this._processMasksDiff(t,e),this._batcher.flush(t,null))},l.postRender=function(t){t.maskInteraction!==Ot.None&&(this._preMaskLayer=t.maskLayer)},l.destroy=function(){this._batcher.destroy(),this._batcher=null},l._processMasksDiff=function(t,e){var r=this._preMaskLayer,i=e.maskLayer;if(r!==i)for(var o=t._renderPipeline._allSpriteMasks,s=r&i,c=i&~r,u=r&~i,_=o._elements,h=0,d=o.length;h<d;h++){var f=_[h],p=f.influenceLayers;if(!(p&s)){if(p&c){var v=f._maskElement;v.isAdd=!0,this._batcher.drawElement(v,t,null);continue}if(p&u){var m=f._maskElement;m.isAdd=!1,this._batcher.drawElement(m,t,null)}}}},n}(),Ph=function(n){$(l,n);function l(){var a;return a=n.call(this)||this,a.charElements=[],a.multiRenderData=!0,a}return l}(Ri),pr;(function(n){n[n.SolidColor=0]="SolidColor",n[n.Sky=1]="Sky",n[n.Texture=2]="Texture"})(pr||(pr={}));var Er;(function(n){n[n.AspectFitWidth=0]="AspectFitWidth",n[n.AspectFitHeight=1]="AspectFitHeight",n[n.Fill=2]="Fill"})(Er||(Er={}));var wn=function(){function n(){this.material=void 0,this.mesh=void 0}var l=n.prototype;return l._render=function(t){var e=this.material,r=this.mesh;if(!e){ce.warn("The material of sky is not defined.");return}if(!r){ce.warn("The mesh of sky is not defined.");return}var i=t.camera,o=i.engine,s=i.aspectRatio,c=i.fieldOfView,u=i.viewMatrix,_=i.shaderData,h=n._viewProjMatrix,d=n._projectionMatrix,f=o._hardwareRenderer,p=e.shaderData,v=e.shader,m=e.renderState;h.copyFrom(u);var g=h.elements;g[12]=g[13]=g[14]=0;var y=1/Math.tan(G.degreeToRadian(c)/2);d.elements[0]=y/s,d.elements[5]=y,te.multiply(d,h,h);var x=_.getMatrix(Kr._vpMatrixProperty);_.setMatrix(Kr._vpMatrixProperty,h);var b=O._compileMacros;Et.unionCollection(t.camera._globalShaderMacro,p._macroCollection,b);var S=v.passes[0]._getShaderProgram(o,b);S.bind(),S.groupingOtherUniformBlock(),S.uploadAll(S.cameraUniformBlock,_),S.uploadAll(S.materialUniformBlock,p),S.uploadUnGroupTextures(),m._apply(o,!1),f.drawPrimitive(r,r.subMesh,S),_.setMatrix(Kr._vpMatrixProperty,x)},n}();wn._epsilon=1e-6;wn._viewProjMatrix=new te;wn._projectionMatrix=new te(1,0,0,0,0,1,0,0,0,0,wn._epsilon-1,-1,0,0,0,0);var mu=function(){function n(a){this._engine=a,this.mode=pr.SolidColor,this.solidColor=new re(.25,.25,.25,1),this.sky=new wn,this._textureFillMode=Er.AspectFitHeight,this._mesh=void 0,this._texture=null,this._mesh=this._createPlane(a)}var l=n.prototype;return l._resizeBackgroundTexture=function(){if(!!this._texture){var t=this._engine.canvas,e=t.width,r=t.height,i=this._mesh,o=i.getPositions();switch(this._textureFillMode){case Er.Fill:o[0].set(-1,-1,1),o[1].set(1,-1,1),o[2].set(-1,1,1),o[3].set(1,1,1);break;case Er.AspectFitWidth:var s=this._texture.height*e/this.texture.width/r;o[0].set(-1,-s,1),o[1].set(1,-s,1),o[2].set(-1,s,1),o[3].set(1,s,1);break;case Er.AspectFitHeight:var c=this._texture.width*r/this.texture.height/e;o[0].set(-c,-1,1),o[1].set(c,-1,1),o[2].set(-c,1,1),o[3].set(c,1,1);break}i.setPositions(o),i.uploadData(!1)}},l._createPlane=function(t){var e=new nt(t);e.isGCIgnored=!0;for(var r=new Uint8Array([1,2,0,1,3,2]),i=new Array(4),o=new Array(4),s=0;s<4;++s)i[s]=new w,o[s]=new X(s%2,1-(s*.5|0));return e.setPositions(i),e.setUVs(o),e.setIndices(r),e.uploadData(!1),e.addSubMesh(0,r.length),e},j(n,[{key:"texture",get:function(){return this._texture},set:function(t){this._texture!==t&&(this._texture=t,this._engine._backgroundTextureMaterial.shaderData.setTexture("u_baseTexture",t))}},{key:"textureFillMode",get:function(){return this._textureFillMode},set:function(t){t!==this._textureFillMode&&(this._textureFillMode=t,this._resizeBackgroundTexture())}}]),n}(),bn;(function(n){n[n.SolidColor=0]="SolidColor",n[n.SphericalHarmonics=1]="SphericalHarmonics"})(bn||(bn={}));var kt=function(){function n(){this._diffuseSphericalHarmonics=void 0,this._diffuseSolidColor=new re(.212,.227,.259),this._diffuseIntensity=1,this._specularTexture=void 0,this._specularIntensity=1,this._diffuseMode=bn.SolidColor,this._shArray=new Float32Array(27),this._scenes=[],this._specularTextureDecodeRGBM=!1}var l=n.prototype;return l._addToScene=function(t){this._scenes.push(t);var e=t.shaderData;e.setColor(n._diffuseColorProperty,this._diffuseSolidColor),e.setFloat(n._diffuseIntensityProperty,this._diffuseIntensity),e.setFloat(n._specularIntensityProperty,this._specularIntensity),e.setFloatArray(n._diffuseSHProperty,this._shArray),this._setDiffuseMode(e),this._setSpecularTextureDecodeRGBM(e),this._setSpecularTexture(e)},l._removeFromScene=function(t){var e=this._scenes,r=e.indexOf(t);e.splice(r,1)},l._setDiffuseMode=function(t){this._diffuseMode===bn.SphericalHarmonics?t.enableMacro(n._shMacro):t.disableMacro(n._shMacro)},l._setSpecularTexture=function(t){this._specularTexture?(t.setTexture(n._specularTextureProperty,this._specularTexture),t.setFloat(n._mipLevelProperty,this._specularTexture.mipmapCount-1),t.enableMacro(n._specularMacro)):t.disableMacro(n._specularMacro)},l._setSpecularTextureDecodeRGBM=function(t){this._specularTextureDecodeRGBM?t.enableMacro(n._decodeRGBMMacro):t.disableMacro(n._decodeRGBMMacro)},l._preComputeSH=function(t,e){var r=t.coefficients;e[0]=r[0]*.886227,e[1]=r[1]*.886227,e[2]=r[2]*.886227,e[3]=r[3]*-1.023327,e[4]=r[4]*-1.023327,e[5]=r[5]*-1.023327,e[6]=r[6]*1.023327,e[7]=r[7]*1.023327,e[8]=r[8]*1.023327,e[9]=r[9]*-1.023327,e[10]=r[10]*-1.023327,e[11]=r[11]*-1.023327,e[12]=r[12]*.858086,e[13]=r[13]*.858086,e[14]=r[14]*.858086,e[15]=r[15]*-.858086,e[16]=r[16]*-.858086,e[17]=r[17]*-.858086,e[18]=r[18]*.247708,e[19]=r[19]*.247708,e[20]=r[20]*.247708,e[21]=r[21]*-.858086,e[22]=r[22]*-.858086,e[23]=r[23]*-.858086,e[24]=r[24]*.429042,e[25]=r[25]*.429042,e[26]=r[26]*.429042},j(n,[{key:"specularTextureDecodeRGBM",get:function(){return this._specularTextureDecodeRGBM},set:function(t){this._specularTextureDecodeRGBM=t;for(var e=this._scenes,r=0,i=e.length;r<i;r++)this._setSpecularTextureDecodeRGBM(e[r].shaderData)}},{key:"diffuseMode",get:function(){return this._diffuseMode},set:function(t){this._diffuseMode=t;for(var e=this._scenes,r=0,i=e.length;r<i;r++)this._setDiffuseMode(e[r].shaderData)}},{key:"diffuseSolidColor",get:function(){return this._diffuseSolidColor},set:function(t){t!==this._diffuseSolidColor&&this._diffuseSolidColor.copyFrom(t)}},{key:"diffuseSphericalHarmonics",get:function(){return this._diffuseSphericalHarmonics},set:function(t){if(this._diffuseSphericalHarmonics=t,t){this._preComputeSH(t,this._shArray);for(var e=this._scenes,r=0,i=e.length;r<i;r++)e[r].shaderData.setFloatArray(n._diffuseSHProperty,this._shArray)}}},{key:"diffuseIntensity",get:function(){return this._diffuseIntensity},set:function(t){this._diffuseIntensity=t;for(var e=this._scenes,r=0,i=e.length;r<i;r++)e[r].shaderData.setFloat(n._diffuseIntensityProperty,t)}},{key:"specularTexture",get:function(){return this._specularTexture},set:function(t){this._specularTexture=t;for(var e=this._scenes,r=0,i=e.length;r<i;r++)this._setSpecularTexture(e[r].shaderData)}},{key:"specularIntensity",get:function(){return this._specularIntensity},set:function(t){this._specularIntensity=t;for(var e=0,r=this._scenes.length;e<r;e++)this._scenes[e].shaderData.setFloat(n._specularIntensityProperty,t)}}]),n}();kt._shMacro=O.getMacroByName("O3_USE_SH");kt._specularMacro=O.getMacroByName("O3_USE_SPECULAR_ENV");kt._decodeRGBMMacro=O.getMacroByName("O3_DECODE_ENV_RGBM");kt._diffuseColorProperty=O.getPropertyByName("u_envMapLight.diffuse");kt._diffuseSHProperty=O.getPropertyByName("u_env_sh");kt._diffuseIntensityProperty=O.getPropertyByName("u_envMapLight.diffuseIntensity");kt._specularTextureProperty=O.getPropertyByName("u_env_specularSampler");kt._specularIntensityProperty=O.getPropertyByName("u_envMapLight.specularIntensity");kt._mipLevelProperty=O.getPropertyByName("u_envMapLight.mipMapLevel");var xa=function(n){$(l,n);function l(t,e){var r;r=n.call(this,t)||this,r.name=void 0,r.background=new mu(r._engine),r.shaderData=new Qn(qt.Scene),r.castShadows=!0,r.shadowResolution=Mr.Medium,r.shadowTwoCascadeSplits=1/3,r.shadowFourCascadeSplits=new w(1/15,3/15,7/15),r.shadowDistance=50,r._activeCameras=[],r._isActiveInEngine=!1,r._globalShaderMacro=new Et,r._rootEntities=[],r._sunLight=void 0,r._shadowCascades=Dt.NoCascades,r._ambientLight=void 0,r.name=e||"";var i=r.shaderData;return i._addRefCount(1),r.ambientLight=new kt,t.sceneManager._allScenes.push(L(r)),r.shaderData.enableMacro("CASCADED_COUNT",r.shadowCascades.toString()),r}var a=l.prototype;return a.createRootEntity=function(e){var r=new hr(this._engine,e);return this.addRootEntity(r),r},a.addRootEntity=function(e,r){var i;typeof e=="number"?i=e:(i=void 0,r=e);var o=r._isRoot;o||(r._isRoot=!0,r._removeFromParent());var s=r._scene;s!==this?(s&&o&&s._removeFromEntityList(r),this._addToRootEntityList(i,r),hr._traverseSetOwnerScene(r,this)):o||this._addToRootEntityList(i,r),this._isActiveInEngine?!r._isActiveInHierarchy&&r._isActive&&r._processActive():r._isActiveInHierarchy&&r._processInActive()},a.removeRootEntity=function(e){e._isRoot&&e._scene==this&&(this._removeFromEntityList(e),e._isRoot=!1,this._isActiveInEngine&&e._isActiveInHierarchy&&e._processInActive(),hr._traverseSetOwnerScene(e,null))},a.getRootEntity=function(e){return e===void 0&&(e=0),this._rootEntities[e]},a.findEntityByName=function(e){for(var r=this._rootEntities,i=r.length-1;i>=0;i--){var o=r[i];if(o.name===e)return o}for(var s=r.length-1;s>=0;s--){var c=r[s],u=c.findByName(e);if(u)return u}return null},a.findEntityByPath=function(e){for(var r=e.split("/").filter(Boolean),i=0,o=this.rootEntitiesCount;i<o;i++){var s=this.getRootEntity(i);if(s.name==r[0]){for(var c=1,u=r.length;c<u&&(s=hr._findChildByName(s,r[c]),!!s);++c);return s}}return null},a.destroy=function(){if(!this._destroyed){this._destroy();var e=this.engine.sceneManager._allScenes;e.splice(e.indexOf(this),1)}},a._attachRenderCamera=function(e){var r=this._activeCameras.indexOf(e);r===-1?this._activeCameras.push(e):ce.warn("Camera already attached.")},a._detachRenderCamera=function(e){var r=this._activeCameras.indexOf(e);r!==-1&&this._activeCameras.splice(r,1)},a._processActive=function(e){this._isActiveInEngine=e;for(var r=this._rootEntities,i=r.length-1;i>=0;i--){var o=r[i];o._isActive&&(e?o._processActive():o._processInActive())}},a._updateShaderData=function(){var e=this.shaderData,r=this._engine._lightManager;r._updateShaderData(this.shaderData);var i=r._getSunLightIndex();i!==-1&&(this._sunLight=r._directLights.get(i)),this.castShadows&&this._sunLight&&this._sunLight.shadowType!==Br.None?(e.enableMacro("CASCADED_SHADOW_MAP"),this.shaderData.enableMacro("SHADOW_MODE",this._sunLight.shadowType.toString())):e.disableMacro("CASCADED_SHADOW_MAP"),Et.unionCollection(this.engine._macroCollection,e._macroCollection,this._globalShaderMacro)},a._removeFromEntityList=function(e){var r=this._rootEntities,i=e._siblingIndex;r.splice(i,1);for(var o=r.length;i<o;i++)r[i]._siblingIndex--;e._siblingIndex=-1},a._destroy=function(){for(this._isActiveInEngine&&(this._engine.sceneManager.activeScene=null);this.rootEntitiesCount>0;)this._rootEntities[0].destroy();this._activeCameras.length=0,this.shaderData._addRefCount(-1)},a._addToRootEntityList=function(e,r){var i=this._rootEntities,o=i.length;if(e===void 0)r._siblingIndex=o,i.push(r);else{if(e<0||e>o)throw"The index "+e+" is out of child list bounds "+o;r._siblingIndex=e,i.splice(e,0,r);for(var s=e+1,c=o+1;s<c;s++)i[s]._siblingIndex++}},j(l,[{key:"shadowCascades",get:function(){return this._shadowCascades},set:function(e){this._shadowCascades!==e&&(this.shaderData.enableMacro("CASCADED_COUNT",e.toString()),this._shadowCascades=e)}},{key:"ambientLight",get:function(){return this._ambientLight},set:function(e){if(!e){ce.warn("The scene must have one ambient light");return}var r=this._ambientLight;r!==e&&(r&&r._removeFromScene(this),e._addToScene(this),this._ambientLight=e)}},{key:"rootEntitiesCount",get:function(){return this._rootEntities.length}},{key:"rootEntities",get:function(){return this._rootEntities}}]),l}(xr),yu=function(){function n(a){this.engine=a,this._allScenes=[],this._activeScene=void 0}var l=n.prototype;return l.loadScene=function(t,e){var r=this;e===void 0&&(e=!0);var i=this.engine.resourceManager.load(t);return i.then(function(o){var s=r._activeScene;r.activeScene=o,s&&e&&s.destroy()}),i},l.mergeScenes=function(t,e){for(var r=t.rootEntities,i=0,o=r.length;i<o;i++)e.addRootEntity(r[i])},l._destroyAllScene=function(){for(var t=this._allScenes,e=0,r=t.length;e<r;e++)t[e]._destroy();t.length=0},j(n,[{key:"activeScene",get:function(){return this._activeScene},set:function(t){var e=this._activeScene;e!==t&&(e&&e._processActive(!1),t&&t._processActive(!0),this._activeScene=t)}}]),n}(),Mh=`#define GLSLIFY 1
#include <common>
#include <common_frag>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <shadow_frag_share>
#include <mobile_material_frag>
#include <fog_share>
#include <normal_get>
void main(){
#include <begin_mobile_frag>
#include <begin_viewdir_frag>
#include <mobile_blinnphong_frag>
gl_FragColor=emission+ambient+diffuse+specular;gl_FragColor.a=diffuse.a;
#ifndef OASIS_COLORSPACE_GAMMA
gl_FragColor=linearToGamma(gl_FragColor);
#endif
#include <fog_frag>
}`,Eh=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <position_vert>
#include <fog_vert>
}`,Rh=`#define GLSLIFY 1
varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;uniform sampler2D u_texture;void main(){if(v_lifeLeft==1.0){discard;}float alphaFactor=1.0;
#ifdef fadeIn
float fadeInFactor=step(0.5,v_lifeLeft);alphaFactor=2.0*fadeInFactor*(1.0-v_lifeLeft)+(1.0-fadeInFactor);
#endif
#ifdef fadeOut
float fadeOutFactor=step(0.5,v_lifeLeft);alphaFactor=alphaFactor*2.0*(1.0-fadeOutFactor)*v_lifeLeft+alphaFactor*fadeOutFactor;
#endif
#ifdef particleTexture
vec4 tex=texture2D(u_texture,v_uv);
#ifdef useOriginColor
gl_FragColor=vec4(tex.rgb,alphaFactor*tex.a*v_color.w);
#else
gl_FragColor=vec4(v_color.xyz*tex.rgb,alphaFactor*tex.a*v_color.w);
#endif
#else
gl_FragColor=vec4(v_color.xyz,alphaFactor*v_color.w);
#endif
}`,zh=`#define GLSLIFY 1
attribute vec3 a_position;attribute vec3 a_velocity;attribute vec3 a_acceleration;attribute vec4 a_color;attribute vec4 a_lifeAndSize;attribute vec2 a_rotation;attribute vec3 a_uv;attribute vec2 a_normalizedUv;uniform float u_time;uniform bool u_once;uniform mat4 u_MVPMat;varying vec4 v_color;varying float v_lifeLeft;varying vec2 v_uv;
#ifdef is2d
uniform mat4 u_viewInvMat;uniform mat4 u_projMat;uniform mat4 u_viewMat;uniform mat4 u_modelMat;
#endif
mat2 rotation2d(float angle){float s=sin(angle);float c=cos(angle);return mat2(c,-s,s,c);}void main(){v_color=a_color;v_uv=a_uv.xy;float life=a_lifeAndSize.y;float startTime=a_lifeAndSize.x;float deltaTime=max(mod(u_time-startTime,life),0.0);if((u_once&&u_time>life+startTime)){deltaTime=0.0;}v_lifeLeft=1.0-deltaTime/life;float scale=a_lifeAndSize.z;vec3 position=a_position+(a_velocity+a_acceleration*deltaTime*0.5)*deltaTime;
#ifdef isScaleByLifetime
scale*=v_lifeLeft;
#else
scale*=pow(a_lifeAndSize.w,deltaTime);
#endif
#ifdef rotateToVelocity
vec3 v=a_velocity+a_acceleration*deltaTime;float angle=atan(v.z,v.x)*2.0;
#else
float deltaAngle=deltaTime*a_rotation.y;float angle=a_rotation.x+deltaAngle;
#endif
#ifdef is2d
vec2 rotatedPoint=rotation2d(angle)*vec2(a_normalizedUv.x,a_normalizedUv.y*a_uv.z);vec3 basisX=u_viewInvMat[0].xyz;vec3 basisZ=u_viewInvMat[1].xyz;vec3 localPosition=vec3(basisX*rotatedPoint.x+basisZ*rotatedPoint.y)*scale+position;gl_Position=u_projMat*u_viewMat*vec4(localPosition+u_modelMat[3].xyz,1.);
#else
#ifdef rotateToVelocity
float s=sin(angle);float c=cos(angle);
#else
float s=sin(angle);float c=cos(angle);
#endif
vec4 rotatedPoint=vec4((a_normalizedUv.x*c+a_normalizedUv.y*a_uv.z*s)*scale,0.,(a_normalizedUv.x*s-a_normalizedUv.y*a_uv.z*c)*scale,1.);vec4 orientation=vec4(0,0,0,1);vec4 q2=orientation+orientation;vec4 qx=orientation.xxxw*q2.xyzx;vec4 qy=orientation.xyyw*q2.xyzy;vec4 qz=orientation.xxzw*q2.xxzz;mat4 localMatrix=mat4((1.0-qy.y)-qz.z,qx.y+qz.w,qx.z-qy.w,0,qx.y-qz.w,(1.0-qx.x)-qz.z,qy.z+qx.w,0,qx.z+qy.w,qy.z-qx.w,(1.0-qx.x)-qy.y,0,position.x,position.y,position.z,1);rotatedPoint=localMatrix*rotatedPoint;gl_Position=u_MVPMat*rotatedPoint;
#endif
}`,Fh=`#define GLSLIFY 1
#define IS_METALLIC_WORKFLOW
#include <common>
#include <common_frag>
#include <fog_share>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <fog_frag>
}`,Bh=`#define GLSLIFY 1
#include <common>
#include <common_frag>
#include <fog_share>
#include <uv_share>
#include <normal_share>
#include <color_share>
#include <worldpos_share>
#include <light_frag_define>
#include <pbr_frag_define>
#include <pbr_helper>
void main(){
#include <pbr_frag>
#include <fog_frag>
}`,as=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <color_share>
#include <normal_share>
#include <worldpos_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <color_vert>
#include <normal_vert>
#include <worldpos_vert>
#include <position_vert>
#include <fog_vert>
}`,Vh=`#define GLSLIFY 1
#ifdef OASIS_NO_DEPTH_TEXTURE
vec4 pack(float depth){const vec4 bitShift=vec4(1.0,256.0,256.0*256.0,256.0*256.0*256.0);const vec4 bitMask=vec4(1.0/256.0,1.0/256.0,1.0/256.0,0.0);vec4 rgbaDepth=fract(depth*bitShift);rgbaDepth-=rgbaDepth.gbaa*bitMask;return rgbaDepth;}
#endif
void main(){
#ifdef OASIS_NO_DEPTH_TEXTURE
gl_FragColor=pack(gl_FragCoord.z);
#else
gl_FragColor=vec4(0.0,0.0,0.0,0.0);
#endif
}`,Dh=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <normal_share>
uniform mat4 u_VPMat;uniform vec2 u_shadowBias;uniform vec3 u_lightDirection;vec3 applyShadowBias(vec3 positionWS){positionWS-=u_lightDirection*u_shadowBias.x;return positionWS;}vec3 applyShadowNormalBias(vec3 positionWS,vec3 normalWS){float invNdotL=1.0-clamp(dot(-u_lightDirection,normalWS),0.0,1.0);float scale=invNdotL*u_shadowBias.y;positionWS+=normalWS*vec3(scale);return positionWS;}void main(){
#include <begin_position_vert>
#include <begin_normal_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <normal_vert>
vec4 temp_pos=u_modelMat*position;vec3 v_pos=temp_pos.xyz/temp_pos.w;v_pos=applyShadowBias(v_pos);
#ifndef OMIT_NORMAL
#ifdef O3_HAS_NORMAL
v_pos=applyShadowNormalBias(v_pos,v_normal);
#endif
#endif
vec4 positionCS=u_VPMat*vec4(v_pos,1.0);positionCS.z=max(positionCS.z,-1.0);gl_Position=positionCS;}`,Lh=`#define GLSLIFY 1
#include <common>
uniform samplerCube u_cube;varying vec3 v_cubeUV;uniform vec4 u_cubeDecodeParam;void main(){vec4 textureColor=textureCube(u_cube,v_cubeUV);if(u_cubeDecodeParam.x>0.0){textureColor=RGBMToLinear(textureColor,u_cubeDecodeParam.y);textureColor=linearToGamma(textureColor);}gl_FragColor=textureColor;}`,Ih=`#define GLSLIFY 1
#include <common_vert>
uniform mat4 u_VPMat;varying vec3 v_cubeUV;void main(){v_cubeUV=vec3(-POSITION.x,POSITION.yz);gl_Position=u_VPMat*vec4(POSITION,1.0);}`,Oh=`#define GLSLIFY 1
uniform sampler2D u_maskTexture;uniform float u_maskAlphaCutoff;varying vec2 v_uv;void main(){vec4 color=texture2D(u_maskTexture,v_uv);if(color.a<u_maskAlphaCutoff){discard;}gl_FragColor=color;}`,Nh=`#define GLSLIFY 1
uniform mat4 u_VPMat;attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=u_VPMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,Uh=`#define GLSLIFY 1
#ifdef USE_CUSTOM_TEXTURE
uniform sampler2D u_cusTomTexture;
#else
uniform sampler2D u_spriteTexture;
#endif
varying vec2 v_uv;varying vec4 v_color;void main(){
#ifdef USE_CUSTOM_TEXTURE
vec4 baseColor=texture2D(u_cusTomTexture,v_uv);
#else
vec4 baseColor=texture2D(u_spriteTexture,v_uv);
#endif
gl_FragColor=baseColor*v_color;}`,kh=`#define GLSLIFY 1
#ifdef USE_MODEL_MATRIX
uniform mat4 u_MVPMat;
#else
uniform mat4 u_VPMat;
#endif
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;attribute vec4 COLOR_0;varying vec2 v_uv;varying vec4 v_color;void main(){
#ifdef USE_MODEL_MATRIX
gl_Position=u_MVPMat*vec4(POSITION,1.0);
#else
gl_Position=u_VPMat*vec4(POSITION,1.0);
#endif
v_uv=TEXCOORD_0;v_color=COLOR_0;}`,Gh=`#define GLSLIFY 1
#include <common>
#include <uv_share>
#include <fog_share>
uniform vec4 u_baseColor;uniform float u_alphaCutoff;
#ifdef BASETEXTURE
uniform sampler2D u_baseTexture;
#endif
void main(){vec4 baseColor=u_baseColor;
#ifdef BASETEXTURE
vec4 textureColor=texture2D(u_baseTexture,v_uv);
#ifndef OASIS_COLORSPACE_GAMMA
textureColor=gammaToLinear(textureColor);
#endif
baseColor*=textureColor;
#endif
#ifdef ALPHA_CUTOFF
if(baseColor.a<u_alphaCutoff){discard;}
#endif
#ifndef OASIS_COLORSPACE_GAMMA
baseColor=linearToGamma(baseColor);
#endif
gl_FragColor=baseColor;
#include <fog_frag>
}`,Hh=`#define GLSLIFY 1
#include <common>
#include <common_vert>
#include <blendShape_input>
#include <uv_share>
#include <fog_share>
void main(){
#include <begin_position_vert>
#include <blendShape_vert>
#include <skinning_vert>
#include <uv_vert>
#include <position_vert>
#include <fog_vert>
}`,Wh=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;void main(){gl_Position=vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`,Xh=`#define GLSLIFY 1
uniform sampler2D u_baseTexture;varying vec2 v_uv;void main(){gl_FragColor=texture2D(u_baseTexture,v_uv);}`,qh=function(){function n(){}return n.init=function(){O.create("blinn-phong",Eh,Mh),O.create("pbr",as,Fh),O.create("pbr-specular",as,Bh),O.create("unlit",Hh,Gh),O.create("shadow-map",Dh,Vh),O.create("skybox",Ih,Lh),O.create("particle-shader",zh,Rh),O.create("SpriteMask",Nh,Oh),O.create("Sprite",kh,Uh),O.create("background-texture",Wh,Xh)},n}(),jh=function(){function n(){this._cacheHierarchy=1,this._cacheMap=Object.create(null),this._lastQueryMap=void 0,this._lastQueryKey=void 0}var l=n.prototype;return l.get=function(t){var e=this._cacheMap,r=t._length;r>this._cacheHierarchy&&this._resizeCacheMapHierarchy(e,0,r);for(var i=t._mask,o=t._length-1,s=this._cacheHierarchy-1,c=0;c<s;c++){var u=o<c?0:i[c],_=e[u];_||(e[u]=_=Object.create(null)),e=_}var h=o<s?0:i[s],d=e[h];return d||(this._lastQueryKey=h,this._lastQueryMap=e),d},l.cache=function(t){this._lastQueryMap[this._lastQueryKey]=t},l._resizeCacheMapHierarchy=function(t,e,r){var i=this._cacheHierarchy-1;if(e==i){for(var o in t)for(var s=t[o],c=0,u=r-i;c<u;c++)c==u-1?t[0]=s:t=t[c==0?o:0]=Object.create(null);this._cacheHierarchy=r}else for(var _ in t)this._resizeCacheMapHierarchy(t[_],++e,r)},n}();qh.init();var mr=function(n){$(l,n);function l(t,e,r){var i;i=n.call(this)||this,i.physicsManager=void 0,i.inputManager=void 0,i._lightManager=new gh,i._componentsManager=new e_,i._hardwareRenderer=void 0,i._lastRenderState=new fa,i._renderElementPool=new $r(du),i._spriteElementPool=new $r(fu),i._spriteMaskElementPool=new $r(Ch),i._textElementPool=new $r(Ph),i._spriteDefaultMaterial=void 0,i._spriteMaskDefaultMaterial=void 0,i._textDefaultFont=void 0,i._renderContext=new Kr,i._magentaTexture2D=void 0,i._magentaTextureCube=void 0,i._magentaTexture2DArray=void 0,i._magentaMaterial=void 0,i._depthTexture2D=void 0,i._backgroundTextureMaterial=void 0,i._renderCount=0,i._shaderProgramPools=[],i._spriteMaskManager=void 0,i._canSpriteBatch=!0,i._macroCollection=new Et,i._canvas=void 0,i._settings={},i._resourceManager=new $n(L(i)),i._sceneManager=new yu(L(i)),i._vSyncCount=1,i._targetFrameRate=60,i._time=new su,i._isPaused=!0,i._requestId=void 0,i._timeoutId=void 0,i._vSyncCounter=1,i._targetFrameInterval=1e3/60,i._destroyed=!1,i._waittingDestroy=!1,i._animate=function(){i._vSyncCount?(i._requestId=requestAnimationFrame(i._animate),i._vSyncCounter++%i._vSyncCount===0&&(i.update(),i._vSyncCounter=1)):(i._timeoutId=window.setTimeout(i._animate,i._targetFrameInterval),i.update())},i._hardwareRenderer=e,i._hardwareRenderer.init(t),i.physicsManager=new bt(L(i)),i._canvas=t,i._sceneManager.activeScene=new xa(L(i),"DefaultScene"),i._spriteMaskManager=new Ah(L(i)),i._spriteDefaultMaterial=i._createSpriteMaterial(),i._spriteMaskDefaultMaterial=i._createSpriteMaskMaterial(),i._textDefaultFont=tn.createFromOS(L(i),"Arial"),i._textDefaultFont.isGCIgnored=!1,i.inputManager=new _u(L(i));var o=new Uint8Array([255,0,255,255]),s=new Mt(L(i),1,1,H.R8G8B8A8,!1);s.setPixelBuffer(o),s.isGCIgnored=!0;var c=new Ct(L(i),1,H.R8G8B8A8,!1);if(c.setPixelBuffer(wt.PositiveX,o),c.setPixelBuffer(wt.NegativeX,o),c.setPixelBuffer(wt.PositiveY,o),c.setPixelBuffer(wt.NegativeY,o),c.setPixelBuffer(wt.PositiveZ,o),c.setPixelBuffer(wt.NegativeZ,o),c.isGCIgnored=!0,!e.canIUse(J.depthTexture))i._macroCollection.enable(l._noDepthTextureMacro);else{var u=new Mt(L(i),1,1,H.Depth16,!1);u.isGCIgnored=!0,i._depthTexture2D=u}if(i._magentaTexture2D=s,i._magentaTextureCube=c,e.isWebGL2){var _=new _a(L(i),1,1,1,H.R8G8B8A8,!1);_.setPixelBuffer(0,o),_.isGCIgnored=!0,i._magentaTexture2DArray=_}var h=new dr(L(i),O.find("unlit"));h.shaderData.setColor("u_baseColor",new ju(1,0,1.01,1)),i._magentaMaterial=h;var d=new dr(L(i),O.find("background-texture"));d.isGCIgnored=!0,d.renderState.depthState.compareFunction=be.LessEqual,i._backgroundTextureMaterial=d;var f=i._settings,p=(r==null?void 0:r.colorSpace)||zr.Linear;return p===zr.Gamma&&i._macroCollection.enable(l._gammaMacro),f.colorSpace=p,i}var a=l.prototype;return a.createEntity=function(e){return new hr(this,e)},a.pause=function(){this._isPaused=!0,cancelAnimationFrame(this._requestId),clearTimeout(this._timeoutId)},a.resume=function(){!this._isPaused||(this._isPaused=!1,this.time.reset(),this._requestId=requestAnimationFrame(this._animate))},a.update=function(){var e=this._time,r=e.deltaTime;e.tick(),this._renderElementPool.resetPool(),this._spriteElementPool.resetPool(),this._spriteMaskElementPool.resetPool(),this._textElementPool.resetPool();var i=this._sceneManager._activeScene,o=this._componentsManager;i&&(i._activeCameras.sort(function(s,c){return s.priority-c.priority}),o.callScriptOnStart(),this.physicsManager._initialized&&this.physicsManager._update(r/1e3),this.inputManager._update(),o.callScriptOnUpdate(r),o.callAnimationUpdate(r),o.callScriptOnLateUpdate(r),this._render(i)),this._waittingDestroy&&this._sceneManager._destroyAllScene(),o.handlingInvalidScripts(),this._waittingDestroy&&this._destroy()},a.run=function(){this.resume(),this.trigger(new ra("run",this))},a.destroy=function(){this._destroyed||(this._waittingDestroy=!0)},a._destroy=function(){this._resourceManager._destroy(),this._magentaTexture2D.destroy(!0),this._magentaTextureCube.destroy(!0),this._textDefaultFont.destroy(!0),this.inputManager._destroy(),this.trigger(new ra("shutdown",this)),this.pause(),this._animate=null,this._sceneManager=null,this._resourceManager=null,this._canvas=null,this._time=null,this._spriteMaskManager.destroy(),this.removeAllEventListeners(),this._waittingDestroy=!1,this._destroyed=!0},a._getShaderProgramPool=function(e){var r=e._shaderPassId,i=this._shaderProgramPools,o=i[r];if(!o){var s=r+1;s<i.length&&(i.length=s),i[r]=o=new jh}return o},a._render=function(e){var r=e._activeCameras,i=this._componentsManager,o=this.time.deltaTime;if(i.callRendererOnUpdate(o),e._updateShaderData(),r.length>0)for(var s=0,c=r.length;s<c;s++){var u=r[s];i.callCameraOnBeginRender(u),u.render(),i.callCameraOnEndRender(u)}else ce.debug("NO active camera.")},a._createSpriteMaterial=function(){var e=new dr(this,O.find("Sprite")),r=e.renderState,i=r.blendState.targetBlendState;return i.enabled=!0,i.sourceColorBlendFactor=oe.SourceAlpha,i.destinationColorBlendFactor=oe.OneMinusSourceAlpha,i.sourceAlphaBlendFactor=oe.One,i.destinationAlphaBlendFactor=oe.OneMinusSourceAlpha,i.colorBlendOperation=i.alphaBlendOperation=St.Add,r.depthState.writeEnabled=!1,r.rasterState.cullMode=Pt.Off,e.renderState.renderQueueType=rt.Transparent,e.isGCIgnored=!0,e},a._createSpriteMaskMaterial=function(){var e=new dr(this,O.find("SpriteMask")),r=e.renderState;return r.blendState.targetBlendState.colorWriteMask=Xt.None,r.rasterState.cullMode=Pt.Off,r.stencilState.enabled=!0,r.depthState.enabled=!1,e.isGCIgnored=!0,e},j(l,[{key:"settings",get:function(){return this._settings}},{key:"canvas",get:function(){return this._canvas}},{key:"resourceManager",get:function(){return this._resourceManager}},{key:"sceneManager",get:function(){return this._sceneManager}},{key:"time",get:function(){return this._time}},{key:"isPaused",get:function(){return this._isPaused}},{key:"vSyncCount",get:function(){return this._vSyncCount},set:function(e){this._vSyncCount=Math.max(0,Math.floor(e))}},{key:"targetFrameRate",get:function(){return this._targetFrameRate},set:function(e){e=Math.max(1e-6,e),this._targetFrameRate=e,this._targetFrameInterval=1e3/e}},{key:"destroyed",get:function(){return this._destroyed}}]),l}(ou);mr._gammaMacro=O.getMacroByName("OASIS_COLORSPACE_GAMMA");mr._noDepthTextureMacro=O.getMacroByName("OASIS_NO_DEPTH_TEXTURE");mr._pixelsPerUnit=100;var $h=function(){function n(){}return n._isIos=function(){if(!window)return!1;var a=window.navigator.userAgent.toLocaleLowerCase();return/iphone|ipad|ipod/.test(a)},j(n,null,[{key:"devicePixelRatio",get:function(){return window.devicePixelRatio}}]),n}(),Ht,os,ss,ls,cs,us,_s,hs,ds,fs,wa=(Ht=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,U(t,"_started",os,L(t)),U(t,"_onStartIndex",ss,L(t)),U(t,"_onUpdateIndex",ls,L(t)),U(t,"_onLateUpdateIndex",cs,L(t)),U(t,"_onPhysicsUpdateIndex",us,L(t)),U(t,"_onPreRenderIndex",_s,L(t)),U(t,"_onPostRenderIndex",hs,L(t)),U(t,"_entityScriptsIndex",ds,L(t)),U(t,"_waitHandlingInValid",fs,L(t)),t}var a=l.prototype;return a.onAwake=function(){},a.onEnable=function(){},a.onStart=function(){},a.onUpdate=function(e){},a.onLateUpdate=function(e){},a.onBeginRender=function(e){},a.onEndRender=function(e){},a.onPhysicsUpdate=function(){},a.onTriggerEnter=function(e){},a.onTriggerExit=function(e){},a.onTriggerStay=function(e){},a.onCollisionEnter=function(e){},a.onCollisionExit=function(e){},a.onCollisionStay=function(e){},a.onPointerDown=function(e){},a.onPointerUp=function(e){},a.onPointerClick=function(e){},a.onPointerEnter=function(e){},a.onPointerExit=function(e){},a.onPointerDrag=function(e){},a.onDisable=function(){},a.onDestroy=function(){},a._onAwake=function(){this.onAwake()},a._onEnable=function(){if(this._waitHandlingInValid)this._waitHandlingInValid=!1;else{var e=this.engine._componentsManager,r=l.prototype;this._started||e.addOnStartScript(this),this.onUpdate!==r.onUpdate&&e.addOnUpdateScript(this),this.onLateUpdate!==r.onLateUpdate&&e.addOnLateUpdateScript(this),this.onPhysicsUpdate!==r.onPhysicsUpdate&&e.addOnPhysicsUpdateScript(this),this._entity._addScript(this)}this.onEnable()},a._onDisable=function(){this._waitHandlingInValid=!0,this._engine._componentsManager.addDisableScript(this),this.onDisable()},a._onDestroy=function(){this._engine._componentsManager.addDestroyScript(this)},a._handlingInValid=function(){var e=this.engine._componentsManager,r=l.prototype;this.onUpdate!==r.onUpdate&&e.removeOnUpdateScript(this),this.onLateUpdate!==r.onLateUpdate&&e.removeOnLateUpdateScript(this),this.onPhysicsUpdate!==r.onPhysicsUpdate&&e.removeOnPhysicsUpdateScript(this),this._entity._removeScript(this),this._waitHandlingInValid=!1},l}(ir),os=N(Ht.prototype,"_started",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ss=N(Ht.prototype,"_onStartIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ls=N(Ht.prototype,"_onUpdateIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),cs=N(Ht.prototype,"_onLateUpdateIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),us=N(Ht.prototype,"_onPhysicsUpdateIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),_s=N(Ht.prototype,"_onPreRenderIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),hs=N(Ht.prototype,"_onPostRenderIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),ds=N(Ht.prototype,"_entityScriptsIndex",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),fs=N(Ht.prototype,"_waitHandlingInValid",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ht),vs;(function(n){n[n.Disjoint=0]="Disjoint",n[n.Contains=1]="Contains",n[n.Intersects=2]="Intersects"})(vs||(vs={}));var ps;(function(n){n[n.Back=0]="Back",n[n.Front=1]="Front",n[n.Intersecting=2]="Intersecting"})(ps||(ps={}));var gs;(function(n){n[n.Near=0]="Near",n[n.Far=1]="Far",n[n.Left=2]="Left",n[n.Right=3]="Right",n[n.Bottom=4]="Bottom",n[n.Top=5]="Top"})(gs||(gs={}));var Ie=function(){n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._z=t._z-e._z,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._z=t._z*e._z,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._z=t._z/e._z,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z},n.cross=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e._x,u=e._y,_=e._z;r.set(o*_-s*u,s*c-i*_,i*u-o*c)},n.distance=function(t,e){var r=e._x-t._x,i=e._y-t._y,o=e._z-t._z;return Math.sqrt(r*r+i*i+o*o)},n.distanceSquared=function(t,e){var r=e._x-t._x,i=e._y-t._y,o=e._z-t._z;return r*r+i*i+o*o},n.equals=function(t,e){return ne.equals(t._x,e._x)&&ne.equals(t._y,e._y)&&ne.equals(t._z,e._z)},n.lerp=function(t,e,r,i){var o=t._x,s=t._y,c=t._z;i._x=o+(e._x-o)*r,i._y=s+(e._y-s)*r,i._z=c+(e._z-c)*r,i._onValueChanged&&i._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._z=Math.max(t._z,e._z),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._z=Math.min(t._z,e._z),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,i=t._y,o=t._z,s=Math.sqrt(r*r+i*i+o*o);s>ne.zeroTolerance&&(s=1/s,e.set(r*s,i*s,o*s))},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._onValueChanged&&r._onValueChanged()},n.transformNormal=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e.elements;r._x=i*c[0]+o*c[4]+s*c[8],r._y=i*c[1]+o*c[5]+s*c[9],r._z=i*c[2]+o*c[6]+s*c[10],r._onValueChanged&&r._onValueChanged()},n.transformToVec3=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e.elements;r._x=i*c[0]+o*c[4]+s*c[8]+c[12],r._y=i*c[1]+o*c[5]+s*c[9]+c[13],r._z=i*c[2]+o*c[6]+s*c[10]+c[14],r._onValueChanged&&r._onValueChanged()},n.transformToVec4=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e.elements;r._x=i*c[0]+o*c[4]+s*c[8]+c[12],r._y=i*c[1]+o*c[5]+s*c[9]+c[13],r._z=i*c[2]+o*c[6]+s*c[10]+c[14],r._w=i*c[3]+o*c[7]+s*c[11]+c[15],r._onValueChanged&&r._onValueChanged()},n.transformCoordinate=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e.elements,u=i*c[3]+o*c[7]+s*c[11]+c[15];u=1/u,r._x=(i*c[0]+o*c[4]+s*c[8]+c[12])*u,r._y=(i*c[1]+o*c[5]+s*c[9]+c[13])*u,r._z=(i*c[2]+o*c[6]+s*c[10]+c[14])*u,r._onValueChanged&&r._onValueChanged()},n.transformByQuat=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=e._x,u=e._y,_=e._z,h=e._w,d=h*i+u*s-_*o,f=h*o+_*i-c*s,p=h*s+c*o-u*i,v=-c*i-u*o-_*s;r._x=d*h-v*c-f*_+p*u,r._y=f*h-v*u-p*c+d*_,r._z=p*h-v*_-d*u+f*c,r._onValueChanged&&r._onValueChanged()};function n(a,t,e){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),this._x=void 0,this._y=void 0,this._z=void 0,this._onValueChanged=null,this._x=a,this._y=t,this._z=e}var l=n.prototype;return l.set=function(t,e,r){return this._x=t,this._y=e,this._z=r,this._onValueChanged&&this._onValueChanged(),this},l.add=function(t){return this._x+=t._x,this._y+=t._y,this._z+=t._z,this._onValueChanged&&this._onValueChanged(),this},l.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._z-=t._z,this._onValueChanged&&this._onValueChanged(),this},l.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._z*=t._z,this._onValueChanged&&this._onValueChanged(),this},l.divide=function(t){return this._x/=t._x,this._y/=t._y,this._z/=t._z,this._onValueChanged&&this._onValueChanged(),this},l.length=function(){var t=this._x,e=this._y,r=this._z;return Math.sqrt(t*t+e*e+r*r)},l.lengthSquared=function(){var t=this._x,e=this._y,r=this._z;return t*t+e*e+r*r},l.negate=function(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this._onValueChanged&&this._onValueChanged(),this},l.normalize=function(){return n.normalize(this,this),this},l.scale=function(t){return this._x*=t,this._y*=t,this._z*=t,this._onValueChanged&&this._onValueChanged(),this},l.transformNormal=function(t){return n.transformNormal(this,t,this),this},l.transformToVec3=function(t){return n.transformToVec3(this,t,this),this},l.transformCoordinate=function(t){return n.transformCoordinate(this,t,this),this},l.transformByQuat=function(t){return n.transformByQuat(this,t,this),this},l.clone=function(){return new n(this._x,this._y,this._z)},l.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._onValueChanged&&this._onValueChanged(),this},l.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._onValueChanged&&this._onValueChanged(),this},l.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z},j(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}}]),n}();Ie._zero=new Ie(0,0,0);Ie._one=new Ie(1,1,1);new Ie;new Ie;new Ie;new Ie;new Ie;new Ie;var Yh=function(){n.add=function(t,e,r){var i=t.elements,o=e.elements,s=r.elements;s[0]=i[0]+o[0],s[1]=i[1]+o[1],s[2]=i[2]+o[2],s[3]=i[3]+o[3],s[4]=i[4]+o[4],s[5]=i[5]+o[5],s[6]=i[6]+o[6],s[7]=i[7]+o[7],s[8]=i[8]+o[8]},n.subtract=function(t,e,r){var i=t.elements,o=e.elements,s=r.elements;s[0]=i[0]-o[0],s[1]=i[1]-o[1],s[2]=i[2]-o[2],s[3]=i[3]-o[3],s[4]=i[4]-o[4],s[5]=i[5]-o[5],s[6]=i[6]-o[6],s[7]=i[7]-o[7],s[8]=i[8]-o[8]},n.multiply=function(t,e,r){var i=t.elements,o=e.elements,s=r.elements,c=i[0],u=i[1],_=i[2],h=i[3],d=i[4],f=i[5],p=i[6],v=i[7],m=i[8],g=o[0],y=o[1],x=o[2],b=o[3],S=o[4],P=o[5],T=o[6],E=o[7],M=o[8];s[0]=c*g+h*y+p*x,s[1]=u*g+d*y+v*x,s[2]=_*g+f*y+m*x,s[3]=c*b+h*S+p*P,s[4]=u*b+d*S+v*P,s[5]=_*b+f*S+m*P,s[6]=c*T+h*E+p*M,s[7]=u*T+d*E+v*M,s[8]=_*T+f*E+m*M},n.equals=function(t,e){var r=t.elements,i=e.elements;return ne.equals(r[0],i[0])&&ne.equals(r[1],i[1])&&ne.equals(r[2],i[2])&&ne.equals(r[3],i[3])&&ne.equals(r[4],i[4])&&ne.equals(r[5],i[5])&&ne.equals(r[6],i[6])&&ne.equals(r[7],i[7])&&ne.equals(r[8],i[8])},n.lerp=function(t,e,r,i){var o=t.elements,s=e.elements,c=i.elements,u=1-r;c[0]=o[0]*u+s[0]*r,c[1]=o[1]*u+s[1]*r,c[2]=o[2]*u+s[2]*r,c[3]=o[3]*u+s[3]*r,c[4]=o[4]*u+s[4]*r,c[5]=o[5]*u+s[5]*r,c[6]=o[6]*u+s[6]*r,c[7]=o[7]*u+s[7]*r,c[8]=o[8]*u+s[8]*r},n.rotationQuaternion=function(t,e){var r=e.elements,i=t._x,o=t._y,s=t._z,c=t._w,u=i+i,_=o+o,h=s+s,d=i*u,f=o*u,p=o*_,v=s*u,m=s*_,g=s*h,y=c*u,x=c*_,b=c*h;r[0]=1-p-g,r[3]=f-b,r[6]=v+x,r[1]=f+b,r[4]=1-d-g,r[7]=m-y,r[2]=v-x,r[5]=m+y,r[8]=1-d-p},n.scaling=function(t,e){var r=e.elements;r[0]=t._x,r[1]=0,r[2]=0,r[3]=0,r[4]=t._y,r[5]=0,r[6]=0,r[7]=0,r[8]=1},n.translation=function(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=t._x,r[7]=t._y,r[8]=1},n.invert=function(t,e){var r=t.elements,i=e.elements,o=r[0],s=r[1],c=r[2],u=r[3],_=r[4],h=r[5],d=r[6],f=r[7],p=r[8],v=p*_-h*f,m=-p*u+h*d,g=f*u-_*d,y=o*v+s*m+c*g;!y||(y=1/y,i[0]=v*y,i[1]=(-p*s+c*f)*y,i[2]=(h*s-c*_)*y,i[3]=m*y,i[4]=(p*o-c*d)*y,i[5]=(-h*o+c*u)*y,i[6]=g*y,i[7]=(-f*o+s*d)*y,i[8]=(_*o-s*u)*y)},n.normalMatrix=function(t,e){var r=t.elements,i=e.elements,o=r[0],s=r[1],c=r[2],u=r[3],_=r[4],h=r[5],d=r[6],f=r[7],p=r[8],v=r[9],m=r[10],g=r[11],y=r[12],x=r[13],b=r[14],S=r[15],P=o*h-s*_,T=o*d-c*_,E=o*f-u*_,M=s*d-c*h,V=s*f-u*h,A=c*f-u*d,C=p*x-v*y,R=p*b-m*y,z=p*S-g*y,F=v*b-m*x,D=v*S-g*x,I=m*S-g*b,B=P*I-T*D+E*F+M*z-V*R+A*C;if(!B)return null;B=1/B,i[0]=(h*I-d*D+f*F)*B,i[1]=(d*z-_*I-f*R)*B,i[2]=(_*D-h*z+f*C)*B,i[3]=(c*D-s*I-u*F)*B,i[4]=(o*I-c*z+u*R)*B,i[5]=(s*z-o*D-u*C)*B,i[6]=(x*A-b*V+S*M)*B,i[7]=(b*E-y*A-S*T)*B,i[8]=(y*V-x*E+S*P)*B},n.rotate=function(t,e,r){var i=t.elements,o=r.elements,s=Math.sin(e),c=Math.cos(e),u=i[0],_=i[1],h=i[2],d=i[3],f=i[4],p=i[5],v=i[6],m=i[7],g=i[8];o[0]=c*u+s*d,o[1]=c*_+s*f,o[2]=c*h+s*p,o[3]=c*d-s*u,o[4]=c*f-s*_,o[5]=c*p-s*h,o[6]=v,o[7]=m,o[8]=g},n.scale=function(t,e,r){var i=e._x,o=e._y,s=t.elements,c=r.elements;c[0]=i*s[0],c[1]=i*s[1],c[2]=i*s[2],c[3]=o*s[3],c[4]=o*s[4],c[5]=o*s[5],c[6]=s[6],c[7]=s[7],c[8]=s[8]},n.translate=function(t,e,r){var i=e._x,o=e._y,s=t.elements,c=r.elements,u=s[0],_=s[1],h=s[2],d=s[3],f=s[4],p=s[5],v=s[6],m=s[7],g=s[8];c[0]=u,c[1]=_,c[2]=h,c[3]=d,c[4]=f,c[5]=p,c[6]=i*u+o*d+v,c[7]=i*_+o*f+m,c[8]=i*h+o*p+g},n.transpose=function(t,e){var r=t.elements,i=e.elements;if(e===t){var o=r[1],s=r[2],c=r[5];i[1]=r[3],i[2]=r[6],i[3]=o,i[5]=r[7],i[6]=s,i[7]=c}else i[0]=r[0],i[1]=r[3],i[2]=r[6],i[3]=r[1],i[4]=r[4],i[5]=r[7],i[6]=r[2],i[7]=r[5],i[8]=r[8]};function n(a,t,e,r,i,o,s,c,u){a===void 0&&(a=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),i===void 0&&(i=1),o===void 0&&(o=0),s===void 0&&(s=0),c===void 0&&(c=0),u===void 0&&(u=1),this.elements=new Float32Array(9);var _=this.elements;_[0]=a,_[1]=t,_[2]=e,_[3]=r,_[4]=i,_[5]=o,_[6]=s,_[7]=c,_[8]=u}var l=n.prototype;return l.set=function(t,e,r,i,o,s,c,u,_){var h=this.elements;return h[0]=t,h[1]=e,h[2]=r,h[3]=i,h[4]=o,h[5]=s,h[6]=c,h[7]=u,h[8]=_,this},l.add=function(t){return n.add(this,t,this),this},l.subtract=function(t){return n.subtract(this,t,this),this},l.multiply=function(t){return n.multiply(this,t,this),this},l.determinant=function(){var t=this.elements,e=t[0],r=t[1],i=t[2],o=t[3],s=t[4],c=t[5],u=t[6],_=t[7],h=t[8],d=h*s-c*_,f=-h*o+c*u,p=_*o-s*u;return e*d+r*f+i*p},l.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},l.invert=function(){return n.invert(this,this),this},l.rotate=function(t){return n.rotate(this,t,this),this},l.scale=function(t){return n.scale(this,t,this),this},l.translate=function(t){return n.translate(this,t,this),this},l.transpose=function(){return n.transpose(this,this),this},l.clone=function(){var t=this.elements,e=new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]);return e},l.copyFrom=function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],this},l.copyFromArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,i=0;i<12;i++)r[i]=t[i+e];return this},l.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8]},l.copyFromMatrix=function(t){var e=t.elements,r=this.elements;return r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[4],r[4]=e[5],r[5]=e[6],r[6]=e[8],r[7]=e[9],r[8]=e[10],this},n}(),Ci=function(){n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._z=t._z+e._z,r._w=t._w+e._w,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=t._w,u=e._x,_=e._y,h=e._z,d=e._w;r._x=i*d+c*u+o*h-s*_,r._y=o*d+c*_+s*u-i*h,r._z=s*d+c*h+i*_-o*u,r._w=c*d-i*u-o*_-s*h,r._onValueChanged&&r._onValueChanged()},n.conjugate=function(t,e){e._x=-t._x,e._y=-t._y,e._z=-t._z,e._w=t._w,e._onValueChanged&&e._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y+t._z*e._z+t._w*e._w},n.equals=function(t,e){return ne.equals(t._x,e._x)&&ne.equals(t._y,e._y)&&ne.equals(t._z,e._z)&&ne.equals(t._w,e._w)},n.rotationAxisAngle=function(t,e,r){var i=n._tempVector3;Ie.normalize(t,i),e*=.5;var o=Math.sin(e);r._x=i._x*o,r._y=i._y*o,r._z=i._z*o,r._w=Math.cos(e),r._onValueChanged&&r._onValueChanged()},n.rotationEuler=function(t,e,r,i){n.rotationYawPitchRoll(e,t,r,i)},n.rotationYawPitchRoll=function(t,e,r,i){var o=r*.5,s=e*.5,c=t*.5,u=Math.sin(o),_=Math.cos(o),h=Math.sin(s),d=Math.cos(s),f=Math.sin(c),p=Math.cos(c),v=p*d,m=f*h;i._x=p*h*_+f*d*u,i._y=f*d*_-p*h*u,i._z=v*u-m*_,i._w=v*_+m*u,i._onValueChanged&&i._onValueChanged()},n.rotationMatrix3x3=function(t,e){var r=t.elements,i=r[0],o=r[1],s=r[2],c=r[3],u=r[4],_=r[5],h=r[6],d=r[7],f=r[8],p=i+u+f,v,m;p>0?(v=Math.sqrt(p+1),e._w=v*.5,v=.5/v,e._x=(_-d)*v,e._y=(h-s)*v,e._z=(o-c)*v):i>=u&&i>=f?(v=Math.sqrt(1+i-u-f),m=.5/v,e._x=.5*v,e._y=(o+c)*m,e._z=(s+h)*m,e._w=(_-d)*m):u>f?(v=Math.sqrt(1+u-i-f),m=.5/v,e._x=(c+o)*m,e._y=.5*v,e._z=(d+_)*m,e._w=(h-s)*m):(v=Math.sqrt(1+f-i-u),m=.5/v,e._x=(s+h)*m,e._y=(_+d)*m,e._z=.5*v,e._w=(o-c)*m),e._onValueChanged&&e._onValueChanged()},n.invert=function(t,e){var r=t._x,i=t._y,o=t._z,s=t._w,c=r*r+i*i+o*o+s*s;if(c>ne.zeroTolerance){var u=1/c;e._x=-r*u,e._y=-i*u,e._z=-o*u,e._w=s*u,e._onValueChanged&&e._onValueChanged()}},n.lerp=function(t,e,r,i){var o=1-r;n.dot(t,e)>=0?(i._x=t._x*o+e._x*r,i._y=t._y*o+e._y*r,i._z=t._z*o+e._z*r,i._w=t._w*o+e._w*r):(i._x=t._x*o-e._x*r,i._y=t._y*o-e._y*r,i._z=t._z*o-e._z*r,i._w=t._w*o-e._w*r),i.normalize()},n.slerp=function(t,e,r,i){var o,s,c=n.dot(t,e);if(Math.abs(c)>1-ne.zeroTolerance)s=1-r,o=r*Math.sign(c);else{var u=Math.acos(Math.abs(c)),_=1/Math.sin(u);s=Math.sin((1-r)*u)*_,o=Math.sin(r*u)*_*Math.sign(c)}i.x=s*t.x+o*e.x,i.y=s*t.y+o*e.y,i.z=s*t.z+o*e.z,i.w=s*t.w+o*e.w,i._onValueChanged&&i._onValueChanged()},n.normalize=function(t,e){var r=t._x,i=t._y,o=t._z,s=t._w,c=Math.sqrt(r*r+i*i+o*o+s*s);c>ne.zeroTolerance&&(c=1/c,e._x=r*c,e._y=i*c,e._z=o*c,e._w=s*c,e._onValueChanged&&e._onValueChanged())},n.rotationX=function(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e._x=r,e._y=0,e._z=0,e._w=i,e._onValueChanged&&e._onValueChanged()},n.rotationY=function(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e._x=0,e._y=r,e._z=0,e._w=i,e._onValueChanged&&e._onValueChanged()},n.rotationZ=function(t,e){t*=.5;var r=Math.sin(t),i=Math.cos(t);e._x=0,e._y=0,e._z=r,e._w=i,e._onValueChanged&&e._onValueChanged()},n.rotateX=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=t._w;e*=.5;var u=Math.sin(e),_=Math.cos(e);r._x=i*_+c*u,r._y=o*_+s*u,r._z=s*_-o*u,r._w=c*_-i*u,r._onValueChanged&&r._onValueChanged()},n.rotateY=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=t._w;e*=.5;var u=Math.sin(e),_=Math.cos(e);r._x=i*_-s*u,r._y=o*_+c*u,r._z=s*_+i*u,r._w=c*_-o*u,r._onValueChanged&&r._onValueChanged()},n.rotateZ=function(t,e,r){var i=t._x,o=t._y,s=t._z,c=t._w;e*=.5;var u=Math.sin(e),_=Math.cos(e);r._x=i*_+o*u,r._y=o*_-i*u,r._z=s*_+c*u,r._w=c*_-s*u,r._onValueChanged&&r._onValueChanged()},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._z=t._z*e,r._w=t._w*e,r._onValueChanged&&r._onValueChanged()};function n(a,t,e,r){a===void 0&&(a=0),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=1),this._x=void 0,this._y=void 0,this._z=void 0,this._w=void 0,this._onValueChanged=null,this._x=a,this._y=t,this._z=e,this._w=r}var l=n.prototype;return l.set=function(t,e,r,i){return this._x=t,this._y=e,this._z=r,this._w=i,this._onValueChanged&&this._onValueChanged(),this},l.conjugate=function(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onValueChanged&&this._onValueChanged(),this},l.getAxisAngle=function(t){var e=this._x,r=this._y,i=this._z,o=e*e+r*r+i*i;if(o<ne.zeroTolerance)return t._x=1,t._y=0,t._z=0,0;var s=1/o;return t._x=this._x*s,t._y=this._y*s,t._z=this._z*s,Math.acos(this._w)*2},l.identity=function(){return this._x=0,this._y=0,this._z=0,this._w=1,this._onValueChanged&&this._onValueChanged(),this},l.length=function(){var t=this._x,e=this._y,r=this._z,i=this._w;return Math.sqrt(t*t+e*e+r*r+i*i)},l.lengthSquared=function(){var t=this._x,e=this._y,r=this._z,i=this._w;return t*t+e*e+r*r+i*i},l.normalize=function(){return n.normalize(this,this),this},l.toEuler=function(t){this._toYawPitchRoll(t);var e=t._x;return t._x=t._y,t._y=e,t._onValueChanged&&t._onValueChanged(),t},l.toYawPitchRoll=function(t){return this._toYawPitchRoll(t),t._onValueChanged&&t._onValueChanged(),t},l.rotateX=function(t){return n.rotateX(this,t,this),this},l.rotateY=function(t){return n.rotateY(this,t,this),this},l.rotateZ=function(t){return n.rotateZ(this,t,this),this},l.rotationAxisAngle=function(t,e){return n.rotationAxisAngle(t,e,this),this},l.multiply=function(t){return n.multiply(this,t,this),this},l.invert=function(){return n.invert(this,this),this},l.dot=function(t){return n.dot(this,t)},l.lerp=function(t,e){return n.lerp(this,t,e,this),this},l.rotateAxisAngle=function(t,e){return n._tempQuat1.rotationAxisAngle(t,e),this.multiply(n._tempQuat1),this},l.clone=function(){return new n(this._x,this._y,this._z,this._w)},l.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onValueChanged&&this._onValueChanged(),this},l.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onValueChanged&&this._onValueChanged(),this},l.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w},l._toYawPitchRoll=function(t){var e=this._x,r=this._y,i=this._z,o=this._w,s=e*e,c=r*r,u=i*i,_=e*r,h=i*o,d=i*e,f=r*o,p=r*i,v=e*o;return t._y=Math.asin(2*(v-p)),Math.cos(t.y)>ne.zeroTolerance?(t._z=Math.atan2(2*(_+h),1-2*(u+s)),t._x=Math.atan2(2*(d+f),1-2*(c+s))):(t._z=Math.atan2(-2*(_-h),1-2*(c+u)),t._x=0),t},j(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}},{key:"z",get:function(){return this._z},set:function(t){this._z=t,this._onValueChanged&&this._onValueChanged()}},{key:"normalized",get:function(){return Math.abs(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w-1)<ne.zeroTolerance}},{key:"w",get:function(){return this._w},set:function(t){this._w=t,this._onValueChanged&&this._onValueChanged()}}]),n}();Ci._tempVector3=new Ie;Ci._tempQuat1=new Ci;var Cn=function(){n.multiply=function(t,e,r){var i=t.elements,o=e.elements,s=r.elements,c=i[0],u=i[1],_=i[2],h=i[3],d=i[4],f=i[5],p=i[6],v=i[7],m=i[8],g=i[9],y=i[10],x=i[11],b=i[12],S=i[13],P=i[14],T=i[15],E=o[0],M=o[1],V=o[2],A=o[3],C=o[4],R=o[5],z=o[6],F=o[7],D=o[8],I=o[9],B=o[10],k=o[11],Y=o[12],K=o[13],Q=o[14],ee=o[15];s[0]=c*E+d*M+m*V+b*A,s[1]=u*E+f*M+g*V+S*A,s[2]=_*E+p*M+y*V+P*A,s[3]=h*E+v*M+x*V+T*A,s[4]=c*C+d*R+m*z+b*F,s[5]=u*C+f*R+g*z+S*F,s[6]=_*C+p*R+y*z+P*F,s[7]=h*C+v*R+x*z+T*F,s[8]=c*D+d*I+m*B+b*k,s[9]=u*D+f*I+g*B+S*k,s[10]=_*D+p*I+y*B+P*k,s[11]=h*D+v*I+x*B+T*k,s[12]=c*Y+d*K+m*Q+b*ee,s[13]=u*Y+f*K+g*Q+S*ee,s[14]=_*Y+p*K+y*Q+P*ee,s[15]=h*Y+v*K+x*Q+T*ee},n.equals=function(t,e){var r=t.elements,i=e.elements;return ne.equals(r[0],i[0])&&ne.equals(r[1],i[1])&&ne.equals(r[2],i[2])&&ne.equals(r[3],i[3])&&ne.equals(r[4],i[4])&&ne.equals(r[5],i[5])&&ne.equals(r[6],i[6])&&ne.equals(r[7],i[7])&&ne.equals(r[8],i[8])&&ne.equals(r[9],i[9])&&ne.equals(r[10],i[10])&&ne.equals(r[11],i[11])&&ne.equals(r[12],i[12])&&ne.equals(r[13],i[13])&&ne.equals(r[14],i[14])&&ne.equals(r[15],i[15])},n.lerp=function(t,e,r,i){var o=t.elements,s=e.elements,c=i.elements,u=1-r;c[0]=o[0]*u+s[0]*r,c[1]=o[1]*u+s[1]*r,c[2]=o[2]*u+s[2]*r,c[3]=o[3]*u+s[3]*r,c[4]=o[4]*u+s[4]*r,c[5]=o[5]*u+s[5]*r,c[6]=o[6]*u+s[6]*r,c[7]=o[7]*u+s[7]*r,c[8]=o[8]*u+s[8]*r,c[9]=o[9]*u+s[9]*r,c[10]=o[10]*u+s[10]*r,c[11]=o[11]*u+s[11]*r,c[12]=o[12]*u+s[12]*r,c[13]=o[13]*u+s[13]*r,c[14]=o[14]*u+s[14]*r,c[15]=o[15]*u+s[15]*r},n.rotationQuaternion=function(t,e){var r=e.elements,i=t._x,o=t._y,s=t._z,c=t._w,u=i+i,_=o+o,h=s+s,d=i*u,f=o*u,p=o*_,v=s*u,m=s*_,g=s*h,y=c*u,x=c*_,b=c*h;r[0]=1-p-g,r[1]=f+b,r[2]=v-x,r[3]=0,r[4]=f-b,r[5]=1-d-g,r[6]=m+y,r[7]=0,r[8]=v+x,r[9]=m-y,r[10]=1-d-p,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},n.rotationAxisAngle=function(t,e,r){var i=r.elements,o=t._x,s=t._y,c=t._z,u=Math.sqrt(o*o+s*s+c*c),_,h,d;Math.abs(u)<ne.zeroTolerance||(u=1/u,o*=u,s*=u,c*=u,_=Math.sin(e),h=Math.cos(e),d=1-h,i[0]=o*o*d+h,i[1]=s*o*d+c*_,i[2]=c*o*d-s*_,i[3]=0,i[4]=o*s*d-c*_,i[5]=s*s*d+h,i[6]=c*s*d+o*_,i[7]=0,i[8]=o*c*d+s*_,i[9]=s*c*d-o*_,i[10]=c*c*d+h,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1)},n.rotationTranslation=function(t,e,r){n.rotationQuaternion(t,r);var i=r.elements;i[12]=e._x,i[13]=e._y,i[14]=e._z},n.affineTransformation=function(t,e,r,i){var o=i.elements,s=e._x,c=e._y,u=e._z,_=e._w,h=s+s,d=c+c,f=u+u,p=s*h,v=s*d,m=s*f,g=c*d,y=c*f,x=u*f,b=_*h,S=_*d,P=_*f,T=t._x,E=t._y,M=t._z;o[0]=(1-(g+x))*T,o[1]=(v+P)*T,o[2]=(m-S)*T,o[3]=0,o[4]=(v-P)*E,o[5]=(1-(p+x))*E,o[6]=(y+b)*E,o[7]=0,o[8]=(m+S)*M,o[9]=(y-b)*M,o[10]=(1-(p+g))*M,o[11]=0,o[12]=r._x,o[13]=r._y,o[14]=r._z,o[15]=1},n.scaling=function(t,e){var r=e.elements;r[0]=t._x,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=t._y,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=t._z,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1},n.translation=function(t,e){var r=e.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=1,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=1,r[11]=0,r[12]=t._x,r[13]=t._y,r[14]=t._z,r[15]=1},n.invert=function(t,e){var r=t.elements,i=e.elements,o=r[0],s=r[1],c=r[2],u=r[3],_=r[4],h=r[5],d=r[6],f=r[7],p=r[8],v=r[9],m=r[10],g=r[11],y=r[12],x=r[13],b=r[14],S=r[15],P=o*h-s*_,T=o*d-c*_,E=o*f-u*_,M=s*d-c*h,V=s*f-u*h,A=c*f-u*d,C=p*x-v*y,R=p*b-m*y,z=p*S-g*y,F=v*b-m*x,D=v*S-g*x,I=m*S-g*b,B=P*I-T*D+E*F+M*z-V*R+A*C;if(!B)return null;B=1/B,i[0]=(h*I-d*D+f*F)*B,i[1]=(c*D-s*I-u*F)*B,i[2]=(x*A-b*V+S*M)*B,i[3]=(m*V-v*A-g*M)*B,i[4]=(d*z-_*I-f*R)*B,i[5]=(o*I-c*z+u*R)*B,i[6]=(b*E-y*A-S*T)*B,i[7]=(p*A-m*E+g*T)*B,i[8]=(_*D-h*z+f*C)*B,i[9]=(s*z-o*D-u*C)*B,i[10]=(y*V-x*E+S*P)*B,i[11]=(v*E-p*V-g*P)*B,i[12]=(h*R-_*F-d*C)*B,i[13]=(o*F-s*R+c*C)*B,i[14]=(x*T-y*M-b*P)*B,i[15]=(p*M-v*T+m*P)*B},n.lookAt=function(t,e,r,i){var o=i.elements,s=n._tempVec30,c=n._tempVec31,u=n._tempVec32;Ie.subtract(t,e,u),u.normalize(),Ie.cross(r,u,s),s.normalize(),Ie.cross(u,s,c),o[0]=s._x,o[1]=c._x,o[2]=u._x,o[3]=0,o[4]=s._y,o[5]=c._y,o[6]=u._y,o[7]=0,o[8]=s._z,o[9]=c._z,o[10]=u._z,o[11]=0,o[12]=-Ie.dot(s,t),o[13]=-Ie.dot(c,t),o[14]=-Ie.dot(u,t),o[15]=1},n.ortho=function(t,e,r,i,o,s,c){var u=c.elements,_=1/(t-e),h=1/(r-i),d=1/(o-s);u[0]=-2*_,u[1]=0,u[2]=0,u[3]=0,u[4]=0,u[5]=-2*h,u[6]=0,u[7]=0,u[8]=0,u[9]=0,u[10]=2*d,u[11]=0,u[12]=(t+e)*_,u[13]=(i+r)*h,u[14]=(s+o)*d,u[15]=1},n.perspective=function(t,e,r,i,o){var s=o.elements,c=1/Math.tan(t/2),u=1/(r-i);s[0]=c/e,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=c,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=(i+r)*u,s[11]=-1,s[12]=0,s[13]=0,s[14]=2*i*r*u,s[15]=0},n.rotateAxisAngle=function(t,e,r,i){var o=e._x,s=e._y,c=e._z,u=Math.sqrt(o*o+s*s+c*c);if(!(Math.abs(u)<ne.zeroTolerance)){var _=t.elements,h=i.elements,d,f,p;u=1/u,o*=u,s*=u,c*=u,d=Math.sin(r),f=Math.cos(r),p=1-f;var v=_[0],m=_[1],g=_[2],y=_[3],x=_[4],b=_[5],S=_[6],P=_[7],T=_[8],E=_[9],M=_[10],V=_[11],A=o*o*p+f,C=s*o*p+c*d,R=c*o*p-s*d,z=o*s*p-c*d,F=s*s*p+f,D=c*s*p+o*d,I=o*c*p+s*d,B=s*c*p-o*d,k=c*c*p+f;h[0]=v*A+x*C+T*R,h[1]=m*A+b*C+E*R,h[2]=g*A+S*C+M*R,h[3]=y*A+P*C+V*R,h[4]=v*z+x*F+T*D,h[5]=m*z+b*F+E*D,h[6]=g*z+S*F+M*D,h[7]=y*z+P*F+V*D,h[8]=v*I+x*B+T*k,h[9]=m*I+b*B+E*k,h[10]=g*I+S*B+M*k,h[11]=y*I+P*B+V*k,t!==i&&(h[12]=_[12],h[13]=_[13],h[14]=_[14],h[15]=_[15])}},n.scale=function(t,e,r){var i=t.elements,o=r.elements,s=e._x,c=e._y,u=e._z;o[0]=i[0]*s,o[1]=i[1]*s,o[2]=i[2]*s,o[3]=i[3]*s,o[4]=i[4]*c,o[5]=i[5]*c,o[6]=i[6]*c,o[7]=i[7]*c,o[8]=i[8]*u,o[9]=i[9]*u,o[10]=i[10]*u,o[11]=i[11]*u,o[12]=i[12],o[13]=i[13],o[14]=i[14],o[15]=i[15]},n.translate=function(t,e,r){var i=t.elements,o=r.elements,s=e._x,c=e._y,u=e._z;if(t===r)o[12]=i[0]*s+i[4]*c+i[8]*u+i[12],o[13]=i[1]*s+i[5]*c+i[9]*u+i[13],o[14]=i[2]*s+i[6]*c+i[10]*u+i[14],o[15]=i[3]*s+i[7]*c+i[11]*u+i[15];else{var _=i[0],h=i[1],d=i[2],f=i[3],p=i[4],v=i[5],m=i[6],g=i[7],y=i[8],x=i[9],b=i[10],S=i[11];o[0]=_,o[1]=h,o[2]=d,o[3]=f,o[4]=p,o[5]=v,o[6]=m,o[7]=g,o[8]=y,o[9]=x,o[10]=b,o[11]=S,o[12]=_*s+p*c+y*u+i[12],o[13]=h*s+v*c+x*u+i[13],o[14]=d*s+m*c+b*u+i[14],o[15]=f*s+g*c+S*u+i[15]}},n.transpose=function(t,e){var r=t.elements,i=e.elements;if(e===t){var o=r[1],s=r[2],c=r[3],u=r[6],_=r[7],h=r[11];i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=o,i[6]=r[9],i[7]=r[13],i[8]=s,i[9]=u,i[11]=r[14],i[12]=c,i[13]=_,i[14]=h}else i[0]=r[0],i[1]=r[4],i[2]=r[8],i[3]=r[12],i[4]=r[1],i[5]=r[5],i[6]=r[9],i[7]=r[13],i[8]=r[2],i[9]=r[6],i[10]=r[10],i[11]=r[14],i[12]=r[3],i[13]=r[7],i[14]=r[11],i[15]=r[15]};function n(a,t,e,r,i,o,s,c,u,_,h,d,f,p,v,m){a===void 0&&(a=1),t===void 0&&(t=0),e===void 0&&(e=0),r===void 0&&(r=0),i===void 0&&(i=0),o===void 0&&(o=1),s===void 0&&(s=0),c===void 0&&(c=0),u===void 0&&(u=0),_===void 0&&(_=0),h===void 0&&(h=1),d===void 0&&(d=0),f===void 0&&(f=0),p===void 0&&(p=0),v===void 0&&(v=0),m===void 0&&(m=1),this.elements=new Float32Array(16);var g=this.elements;g[0]=a,g[1]=t,g[2]=e,g[3]=r,g[4]=i,g[5]=o,g[6]=s,g[7]=c,g[8]=u,g[9]=_,g[10]=h,g[11]=d,g[12]=f,g[13]=p,g[14]=v,g[15]=m}var l=n.prototype;return l.set=function(t,e,r,i,o,s,c,u,_,h,d,f,p,v,m,g){var y=this.elements;return y[0]=t,y[1]=e,y[2]=r,y[3]=i,y[4]=o,y[5]=s,y[6]=c,y[7]=u,y[8]=_,y[9]=h,y[10]=d,y[11]=f,y[12]=p,y[13]=v,y[14]=m,y[15]=g,this},l.multiply=function(t){return n.multiply(this,t,this),this},l.determinant=function(){var t=this.elements,e=t[0],r=t[1],i=t[2],o=t[3],s=t[4],c=t[5],u=t[6],_=t[7],h=t[8],d=t[9],f=t[10],p=t[11],v=t[12],m=t[13],g=t[14],y=t[15],x=e*c-r*s,b=e*u-i*s,S=e*_-o*s,P=r*u-i*c,T=r*_-o*c,E=i*_-o*u,M=h*m-d*v,V=h*g-f*v,A=h*y-p*v,C=d*g-f*m,R=d*y-p*m,z=f*y-p*g;return x*z-b*R+S*C+P*A-T*V+E*M},l.decompose=function(t,e,r){var i=n._tempMat30,o=this.elements,s=i.elements,c=o[0],u=o[1],_=o[2],h=o[3],d=o[4],f=o[5],p=o[6],v=o[7],m=o[8],g=o[9],y=o[10],x=o[11];t.set(o[12],o[13],o[14]);var b=Math.sign(c*u*_*h)<0?-1:1,S=Math.sign(d*f*p*v)<0?-1:1,P=Math.sign(m*g*y*x)<0?-1:1,T=b*Math.sqrt(c*c+u*u+_*_),E=S*Math.sqrt(d*d+f*f+p*p),M=P*Math.sqrt(m*m+g*g+y*y);if(r.set(T,E,M),Math.abs(T)<ne.zeroTolerance||Math.abs(E)<ne.zeroTolerance||Math.abs(M)<ne.zeroTolerance)return e.identity(),!1;var V=1/T,A=1/E,C=1/M;return s[0]=c*V,s[1]=u*V,s[2]=_*V,s[3]=d*A,s[4]=f*A,s[5]=p*A,s[6]=m*C,s[7]=g*C,s[8]=y*C,Ci.rotationMatrix3x3(i,e),!0},l.getRotation=function(t){var e=this.elements,r=e[0]+e[5]+e[10];if(r>ne.zeroTolerance){var i=Math.sqrt(r+1)*2;t._w=.25*i,t._x=(e[6]-e[9])/i,t._y=(e[8]-e[2])/i,t._z=(e[1]-e[4])/i}else if(e[0]>e[5]&&e[0]>e[10]){var o=Math.sqrt(1+e[0]-e[5]-e[10])*2;t._w=(e[6]-e[9])/o,t._x=.25*o,t._y=(e[1]+e[4])/o,t._z=(e[8]+e[2])/o}else if(e[5]>e[10]){var s=Math.sqrt(1+e[5]-e[0]-e[10])*2;t._w=(e[8]-e[2])/s,t._x=(e[1]+e[4])/s,t._y=.25*s,t._z=(e[6]+e[9])/s}else{var c=Math.sqrt(1+e[10]-e[0]-e[5])*2;t._w=(e[1]-e[4])/c,t._x=(e[8]+e[2])/c,t._y=(e[6]+e[9])/c,t._z=.25*c}return t._onValueChanged&&t._onValueChanged(),t},l.getScaling=function(t){var e=this.elements,r=e[0],i=e[1],o=e[2],s=e[4],c=e[5],u=e[6],_=e[8],h=e[9],d=e[10];return t.set(Math.sqrt(r*r+i*i+o*o),Math.sqrt(s*s+c*c+u*u),Math.sqrt(_*_+h*h+d*d)),t},l.getTranslation=function(t){var e=this.elements;return t.set(e[12],e[13],e[14]),t},l.identity=function(){var t=this.elements;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},l.invert=function(){return n.invert(this,this),this},l.rotateAxisAngle=function(t,e){return n.rotateAxisAngle(this,t,e,this),this},l.scale=function(t){return n.scale(this,t,this),this},l.translate=function(t){return n.translate(this,t,this),this},l.transpose=function(){return n.transpose(this,this),this},l.clone=function(){var t=this.elements,e=new n(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]);return e},l.copyFrom=function(t){var e=this.elements,r=t.elements;return e[0]=r[0],e[1]=r[1],e[2]=r[2],e[3]=r[3],e[4]=r[4],e[5]=r[5],e[6]=r[6],e[7]=r[7],e[8]=r[8],e[9]=r[9],e[10]=r[10],e[11]=r[11],e[12]=r[12],e[13]=r[13],e[14]=r[14],e[15]=r[15],this},l.copyFromArray=function(t,e){e===void 0&&(e=0);for(var r=this.elements,i=0;i<16;i++)r[i]=t[i+e];return this},l.copyToArray=function(t,e){e===void 0&&(e=0);var r=this.elements;t[e]=r[0],t[e+1]=r[1],t[e+2]=r[2],t[e+3]=r[3],t[e+4]=r[4],t[e+5]=r[5],t[e+6]=r[6],t[e+7]=r[7],t[e+8]=r[8],t[e+9]=r[9],t[e+10]=r[10],t[e+11]=r[11],t[e+12]=r[12],t[e+13]=r[13],t[e+14]=r[14],t[e+15]=r[15]},n}();Cn._tempVec30=new Ie;Cn._tempVec31=new Ie;Cn._tempVec32=new Ie;Cn._tempMat30=new Yh;Cn._identity=new Cn(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1);var tr=function(){n.add=function(t,e,r){r._x=t._x+e._x,r._y=t._y+e._y,r._onValueChanged&&r._onValueChanged()},n.subtract=function(t,e,r){r._x=t._x-e._x,r._y=t._y-e._y,r._onValueChanged&&r._onValueChanged()},n.multiply=function(t,e,r){r._x=t._x*e._x,r._y=t._y*e._y,r._onValueChanged&&r._onValueChanged()},n.divide=function(t,e,r){r._x=t._x/e._x,r._y=t._y/e._y,r._onValueChanged&&r._onValueChanged()},n.dot=function(t,e){return t._x*e._x+t._y*e._y},n.distance=function(t,e){var r=e._x-t._x,i=e._y-t._y;return Math.sqrt(r*r+i*i)},n.distanceSquared=function(t,e){var r=e._x-t._x,i=e._y-t._y;return r*r+i*i},n.equals=function(t,e){return ne.equals(t._x,e._x)&&ne.equals(t._y,e._y)},n.lerp=function(t,e,r,i){var o=t._x,s=t._y;i._x=o+(e._x-o)*r,i._y=s+(e._y-s)*r,i._onValueChanged&&i._onValueChanged()},n.max=function(t,e,r){r._x=Math.max(t._x,e._x),r._y=Math.max(t._y,e._y),r._onValueChanged&&r._onValueChanged()},n.min=function(t,e,r){r._x=Math.min(t._x,e._x),r._y=Math.min(t._y,e._y),r._onValueChanged&&r._onValueChanged()},n.negate=function(t,e){e._x=-t._x,e._y=-t._y,e._onValueChanged&&e._onValueChanged()},n.normalize=function(t,e){var r=t._x,i=t._y,o=Math.sqrt(r*r+i*i);o>ne.zeroTolerance&&(o=1/o,e._x=r*o,e._y=i*o,e._onValueChanged&&e._onValueChanged())},n.scale=function(t,e,r){r._x=t._x*e,r._y=t._y*e,r._onValueChanged&&r._onValueChanged()};function n(a,t){a===void 0&&(a=0),t===void 0&&(t=0),this._x=void 0,this._y=void 0,this._onValueChanged=null,this._x=a,this._y=t}var l=n.prototype;return l.set=function(t,e){return this._x=t,this._y=e,this._onValueChanged&&this._onValueChanged(),this},l.add=function(t){return this._x+=t._x,this._y+=t._y,this._onValueChanged&&this._onValueChanged(),this},l.subtract=function(t){return this._x-=t._x,this._y-=t._y,this._onValueChanged&&this._onValueChanged(),this},l.multiply=function(t){return this._x*=t._x,this._y*=t._y,this._onValueChanged&&this._onValueChanged(),this},l.divide=function(t){return this._x/=t._x,this._y/=t._y,this._onValueChanged&&this._onValueChanged(),this},l.length=function(){var t=this._x,e=this._y;return Math.sqrt(t*t+e*e)},l.lengthSquared=function(){var t=this._x,e=this._y;return t*t+e*e},l.negate=function(){return this._x=-this._x,this._y=-this._y,this._onValueChanged&&this._onValueChanged(),this},l.normalize=function(){return n.normalize(this,this),this},l.scale=function(t){return this._x*=t,this._y*=t,this._onValueChanged&&this._onValueChanged(),this},l.clone=function(){return new n(this._x,this._y)},l.copyFrom=function(t){return this._x=t.x,this._y=t.y,this._onValueChanged&&this._onValueChanged(),this},l.copyFromArray=function(t,e){return e===void 0&&(e=0),this._x=t[e],this._y=t[e+1],this._onValueChanged&&this._onValueChanged(),this},l.copyToArray=function(t,e){e===void 0&&(e=0),t[e]=this._x,t[e+1]=this._y},j(n,[{key:"x",get:function(){return this._x},set:function(t){this._x=t,this._onValueChanged&&this._onValueChanged()}},{key:"y",get:function(){return this._y},set:function(t){this._y=t,this._onValueChanged&&this._onValueChanged()}}]),n}();tr._zero=new tr(0,0);tr._one=new tr(1,1);var xu=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.createVertexElements=function(e){return e[0]=new ge("POSITION",0,Z.Vector3,0),e[1]=new ge("TEXCOORD_0",12,Z.Vector2,0),e[2]=new ge("COLOR_0",20,Z.Vector4,0),36},a.canBatch=function(e,r){if(!this._engine._canSpriteBatch)return!1;var i=e.component,o=r.component;return!this.checkBatchWithMask(i,o)||e.texture!==r.texture?!1:e.material===r.material},a.checkBatchWithMask=function(e,r){var i=e.maskInteraction;return i!==r.maskInteraction?!1:i===Ot.None?!0:e.maskLayer===r.maskLayer},a.updateVertices=function(e,r,i){for(var o=e.renderData,s=o.positions,c=o.uvs,u=o.color,_=o.vertexCount,h=0;h<_;h++){var d=s[h],f=c[h];r[i++]=d.x,r[i++]=d.y,r[i++]=d.z,r[i++]=f.x,r[i++]=f.y,r[i++]=u.r,r[i++]=u.g,r[i++]=u.b,r[i++]=u.a}return i},a.drawBatches=function(e,r){for(var i=this._engine,o=this._batchedQueue,s=this._meshes[this._flushId],c=s.subMeshes,u=i._spriteMaskManager,_=e.scene.shaderData,h=e.shaderData,d=0,f=c.length;d<f;d++){var p=c[d],v=o[d];if(!p||!v)return;var m=v.component,g=v.material;u.preRender(e,m);var y=O._compileMacros;Et.unionCollection(m._globalShaderMacro,g.shaderData._macroCollection,y),(r||g)._preRender(v);var x=v.shaderPass._getShaderProgram(i,y);if(!x.isValid)return;m.shaderData.setTexture(l._textureProperty,v.texture),x.bind(),x.groupingOtherUniformBlock(),x.uploadAll(x.sceneUniformBlock,_),x.uploadAll(x.cameraUniformBlock,h),x.uploadAll(x.rendererUniformBlock,m.shaderData),x.uploadAll(x.materialUniformBlock,g.shaderData),v.renderState._apply(i,!1),i._hardwareRenderer.drawPrimitive(s,p,x),u.postRender(m)}},a.destroy=function(){this._batchedQueue=null;for(var e=this._meshes,r=this._vertexBuffers,i=this._indiceBuffers,o=0,s=e.length;o<s;++o)e[o].destroy();this._meshes=null;for(var c=0,u=r.length;c<u;++c)r[c].destroy();this._vertexBuffers=null;for(var _=0,h=i.length;_<h;++_)i[_].destroy();this._indiceBuffers=null},l}(Bi);xu._textureProperty=O.getPropertyByName("u_spriteTexture");var _r=function(){n._compareFromNearToFar=function(t,e){return t.component.priority-e.component.priority||t.component._distanceForSort-e.component._distanceForSort},n._compareFromFarToNear=function(t,e){return t.component.priority-e.component.priority||e.component._distanceForSort-t.component._distanceForSort};function n(a){this.items=[],this._spriteBatcher=void 0,this._spriteBatcher=new xu(a)}var l=n.prototype;return l.pushPrimitive=function(t){this.items.push(t)},l.render=function(t,e,r,i){var o=this.items;if(o.length!==0){for(var s=t.engine,c=t.scene,u=s._renderCount,_=s._hardwareRenderer,h=c.shaderData,d=t.shaderData,f=0,p=o.length;f<p;f++){var v=o[f],m=v.component.entity.layer;if(!!(m&r))if(v.mesh){this._spriteBatcher.flush(t,e);var g=O._compileMacros,y=v,x=y.component,b=y.material.destroyed?s._magentaMaterial:y.material,S=x.shaderData,P=b.shaderData;(e||b)._preRender(y),Et.unionCollection(x._globalShaderMacro,P._macroCollection,g);var T=((i==null?void 0:i.passes[0])||(e==null?void 0:e.shader.passes[0])||y.shaderPass)._getShaderProgram(s,g);if(!T.isValid)continue;var E=T.bind(),M=u!==T._uploadRenderCount;M?(T.groupingOtherUniformBlock(),T.uploadAll(T.sceneUniformBlock,h),T.uploadAll(T.cameraUniformBlock,d),T.uploadAll(T.rendererUniformBlock,S),T.uploadAll(T.materialUniformBlock,P),T.uploadUnGroupTextures(),T._uploadScene=c,T._uploadCamera=t,T._uploadRenderer=x,T._uploadMaterial=b,T._uploadRenderCount=u):(T._uploadScene!==c?(T.uploadAll(T.sceneUniformBlock,h),T._uploadScene=c):E&&T.uploadTextures(T.sceneUniformBlock,h),T._uploadCamera!==t?(T.uploadAll(T.cameraUniformBlock,d),T._uploadCamera=t):E&&T.uploadTextures(T.cameraUniformBlock,d),T._uploadRenderer!==x?(T.uploadAll(T.rendererUniformBlock,S),T._uploadRenderer=x):E&&T.uploadTextures(T.rendererUniformBlock,S),T._uploadMaterial!==b?(T.uploadAll(T.materialUniformBlock,P),T._uploadMaterial=b):E&&T.uploadTextures(T.materialUniformBlock,P),E&&T.uploadUnGroupTextures()),y.renderState._apply(s,x.entity.transform._isFrontFaceInvert()),_.drawPrimitive(y.mesh,y.subMesh,T)}else{var V=v;this._spriteBatcher.drawElement(V,t,e)}}this._spriteBatcher.flush(t,e)}},l.clear=function(){this.items.length=0,this._spriteBatcher.clear()},l.destroy=function(){this._spriteBatcher.destroy(),this._spriteBatcher=null},l.sort=function(t){this._quickSort(this.items,0,this.items.length,t)},l._quickSort=function(t,e,r,i){for(;;){if(r-e<=10){this._insertionSort(t,e,r,i);return}var o=e+r>>1,s=t[e],c=t[r-1],u=t[o],_=i(s,c);if(_>0){var h=s;s=c,c=h}var d=i(s,u);if(d>=0){var f=s;s=u,u=c,c=f}else{var p=i(c,u);if(p>0){var v=c;c=u,u=v}}t[e]=s,t[r-1]=u;var m=c,g=e+1,y=r-1;t[o]=t[g],t[g]=m;e:for(var x=g+1;x<y;x++){var b=t[x],S=i(b,m);if(S<0)t[x]=t[g],t[g]=b,g++;else if(S>0){do{if(y--,y==x)break e;var P=t[y];S=i(P,m)}while(S>0);t[x]=t[y],t[y]=b,S<0&&(b=t[x],t[x]=t[g],t[g]=b,g++)}}r-y<g-e?(this._quickSort(t,y,r,i),r=g):(this._quickSort(t,e,g,i),e=y)}},l._insertionSort=function(t,e,r,i){for(var o=e+1;o<r;o++){var s=void 0,c=t[o];for(s=o-1;s>=e;s--){var u=t[s],_=i(u,c);if(_>0)t[s+1]=u;else break}t[s+1]=c}},n}(),Qh=function(){this.position=new w,this.resolution=void 0,this.viewMatrix=new te,this.projectionMatrix=new te,this.viewProjectMatrix=new te,this.cullPlanes=[new We(new w),new We(new w),new We(new w),new We(new w),new We(new w),new We(new w),new We(new w),new We(new w),new We(new w),new We(new w)],this.cullPlaneCount=void 0,this.splitBoundSphere=new iu(new w,0),this.sphereCenterZ=void 0},W;(function(n){n[n.FarBottomLeft=0]="FarBottomLeft",n[n.FarTopLeft=1]="FarTopLeft",n[n.FarTopRight=2]="FarTopRight",n[n.FarBottomRight=3]="FarBottomRight",n[n.nearBottomLeft=4]="nearBottomLeft",n[n.nearTopLeft=5]="nearTopLeft",n[n.nearTopRight=6]="nearTopRight",n[n.nearBottomRight=7]="nearBottomRight",n[n.unknown=8]="unknown"})(W||(W={}));var ft=function(){function n(){}return n.shadowResolution=function(a){switch(a){case Mr.Low:return 512;case Mr.Medium:return 1024;case Mr.High:return 2048;case Mr.VeryHigh:return 4096}},n.shadowDepthFormat=function(a,t){return t?H.Depth16:H.R8G8B8A8},n.cullingRenderBounds=function(a,t,e){for(var r=a.min,i=a.max,o=0;o<t;o++){var s=e[o],c=s.normal;if(c.x*(c.x>=0?i.x:r.x)+c.y*(c.y>=0?i.y:r.y)+c.z*(c.z>=0?i.z:r.z)<-s.distance)return!1}return!0},n.shadowCullFrustum=function(a,t,e){var r=n._edgePlanePoint2;t.castShadows&&n.cullingRenderBounds(t.bounds,e.cullPlaneCount,e.cullPlanes)&&(t.bounds.getCenter(r),t._distanceForSort=w.distance(r,e.position),t._updateShaderData(a),t._render(a))},n.getBoundSphereByFrustum=function(a,t,e,r,i){var o=e.aspectRatio,s=e.fieldOfView,c,u,_=Math.sqrt(1+o*o)*Math.tan(G.degreeToRadian(s)/2),h=_*_,d=t-a,f=t+a;h>d/f?(c=t,u=t*_):(c=.5*f*(1+h),u=.5*Math.sqrt(d*d+2*(t*t+a*a)*h+f*f*h*h));var p=i.splitBoundSphere.center;i.splitBoundSphere.radius=u,w.scale(r,c,p),w.add(e.entity.transform.worldPosition,p,p),i.sphereCenterZ=c},n.getDirectionLightShadowCullPlanes=function(a,t,e,r,i){var o=n._frustumCorners,s=n._backPlaneFaces,c=n._frustumPlaneNeighbors,u=n._frustumTwoPlaneCorners,_=n._edgePlanePoint2,h=i.cullPlanes,d=a.getPlane(le.Near),f=a.getPlane(le.Far),p=a.getPlane(le.Left),v=a.getPlane(le.Right),m=a.getPlane(le.Bottom),g=a.getPlane(le.Top),y=t-e,x=n._adjustNearPlane,b=n._adjustFarPlane;x.normal.copyFrom(d.normal),b.normal.copyFrom(f.normal),x.distance=d.distance-y,b.distance=Math.min(-d.distance+i.sphereCenterZ+i.splitBoundSphere.radius,f.distance),tt.intersectionPointThreePlanes(x,m,v,o[W.nearBottomRight]),tt.intersectionPointThreePlanes(x,g,v,o[W.nearTopRight]),tt.intersectionPointThreePlanes(x,g,p,o[W.nearTopLeft]),tt.intersectionPointThreePlanes(x,m,p,o[W.nearBottomLeft]),tt.intersectionPointThreePlanes(b,m,v,o[W.FarBottomRight]),tt.intersectionPointThreePlanes(b,g,v,o[W.FarTopRight]),tt.intersectionPointThreePlanes(b,g,p,o[W.FarTopLeft]),tt.intersectionPointThreePlanes(b,m,p,o[W.FarBottomLeft]);for(var S=0,P=0;P<6;P++){var T=void 0;switch(P){case le.Near:T=x;break;case le.Far:T=b;break;default:T=a.getPlane(P);break}w.dot(T.normal,r)<0&&(h[S].copyFrom(T),s[S]=P,S++)}for(var E=S,M=0;M<S;M++)for(var V=s[M],A=c[V],C=0;C<4;C++){for(var R=A[C],z=!0,F=0;F<S;F++)if(R==s[F]){z=!1;break}if(z){var D=u[V][R],I=o[D[0]],B=o[D[1]];w.add(I,r,_),We.fromPoints(I,B,_,h[E++])}}i.cullPlaneCount=E},n.getDirectionalLightMatrices=function(a,t,e,r,i,o,s){var c=s.splitBoundSphere;s.resolution=o;var u=c.center,_=c.radius,h=o/2,d=_*h/(h-n.atlasBorderSize),f=d*2,p=o/f,v=f/o,m=Math.ceil(w.dot(u,a)*p)*v,g=Math.ceil(w.dot(u,t)*p)*v,y=w.dot(u,e);u.x=a.x*m+t.x*g+e.x*y,u.y=a.y*m+t.y*g+e.y*y,u.z=a.z*m+t.z*g+e.z*y;var x=s.position,b=s.viewMatrix,S=s.projectionMatrix,P=s.viewProjectMatrix;w.scale(e,_+i,x),w.subtract(u,x,x),te.lookAt(x,u,a,b),te.ortho(-d,d,-d,d,0,_*2+i,S),te.multiply(S,b,P)},n.getMaxTileResolutionInAtlas=function(a,t,e){for(var r=Math.min(a,t),i=Math.floor(a/r)*Math.floor(t/r);i<e;)r=Math.floor(r>>1),i=Math.floor(a/r)*Math.floor(t/r);return r},n}();ft._frustumCorners=[new w,new w,new w,new w,new w,new w,new w,new w];ft._adjustNearPlane=new We(new w);ft._adjustFarPlane=new We(new w);ft._backPlaneFaces=new Array(5);ft._edgePlanePoint2=new w;ft._frustumPlaneNeighbors=[[le.Left,le.Right,le.Top,le.Bottom],[le.Left,le.Right,le.Top,le.Bottom],[le.Near,le.Far,le.Top,le.Bottom],[le.Near,le.Far,le.Top,le.Bottom],[le.Near,le.Far,le.Left,le.Right],[le.Near,le.Far,le.Left,le.Right]];ft._frustumTwoPlaneCorners=[[[W.unknown,W.unknown],[W.unknown,W.unknown],[W.nearBottomLeft,W.nearTopLeft],[W.nearTopRight,W.nearBottomRight],[W.nearBottomRight,W.nearBottomLeft],[W.nearTopLeft,W.nearTopRight]],[[W.unknown,W.unknown],[W.unknown,W.unknown],[W.FarTopLeft,W.FarBottomLeft],[W.FarBottomRight,W.FarTopRight],[W.FarBottomLeft,W.FarBottomRight],[W.FarTopRight,W.FarTopLeft]],[[W.nearTopLeft,W.nearBottomLeft],[W.FarBottomLeft,W.FarTopLeft],[W.unknown,W.unknown],[W.unknown,W.unknown],[W.nearBottomLeft,W.FarBottomLeft],[W.FarTopLeft,W.nearTopLeft]],[[W.nearBottomRight,W.nearTopRight],[W.FarTopRight,W.FarBottomRight],[W.unknown,W.unknown],[W.unknown,W.unknown],[W.FarBottomRight,W.nearBottomRight],[W.nearTopRight,W.FarTopRight]],[[W.nearBottomLeft,W.nearBottomRight],[W.FarBottomRight,W.FarBottomLeft],[W.FarBottomLeft,W.nearBottomLeft],[W.nearBottomRight,W.FarBottomRight],[W.unknown,W.unknown],[W.unknown,W.unknown]],[[W.nearTopRight,W.nearTopLeft],[W.FarTopLeft,W.FarTopRight],[W.nearTopLeft,W.FarTopLeft],[W.FarTopRight,W.nearTopRight],[W.unknown,W.unknown],[W.unknown,W.unknown]]];ft.atlasBorderSize=4;var Rt=function(){function n(a){this._camera=void 0,this._engine=void 0,this._shadowCasterShader=void 0,this._supportDepthTexture=void 0,this._shadowMapResolution=void 0,this._shadowMapSize=new tr,this._shadowTileResolution=void 0,this._shadowBias=new tr,this._shadowMapFormat=void 0,this._shadowCascadeMode=void 0,this._shadowSliceData=new Qh,this._lightUp=new w,this._lightSide=new w,this._lightForward=new w,this._existShadowMap=!1,this._splitBoundSpheres=new Float32Array(4*n._maxCascades),this._vpMatrix=new Float32Array(64),this._shadowInfos=new w,this._depthTexture=void 0,this._renderTargets=void 0,this._viewportOffsets=[new tr,new tr,new tr,new tr],this._camera=a,this._engine=a.engine,this._supportDepthTexture=a.engine._hardwareRenderer.canIUse(J.depthTexture),this._shadowCasterShader=O.find("shadow-map")}var l=n.prototype;return l._render=function(t){this._updateShadowSettings(),this._existShadowMap=!1,this._renderDirectShadowMap(t),this._existShadowMap&&this._updateReceiversShaderData()},l._renderDirectShadowMap=function(t){var e=this._engine,r=this._camera,i=this._shadowCasterShader,o=this._viewportOffsets,s=this._shadowSliceData,c=this._splitBoundSpheres,u=this._vpMatrix,_=r._renderPipeline,h=_._opaqueQueue,d=_._alphaTestQueue,f=_._transparentQueue,p=e._componentsManager,v=e._hardwareRenderer,m=r.scene.shadowCascades,g=n._cascadesSplitDistance,y=s.splitBoundSphere,x=n._tempMatrix0,b=x.elements,S=this._lightUp,P=this._lightSide,T=this._lightForward,E=e._lightManager._getSunLightIndex();if(E!==-1){var M=r.scene._sunLight,V=Math.min(r.scene.shadowDistance,r.farClipPlane);this._getCascadesSplitDistance(V);var A=this._getAvailableRenderTarget();v.activeRenderTarget(A,null,0),this._supportDepthTexture?v.clearRenderTarget(e,It.Depth,null):v.clearRenderTarget(e,It.All,n._clearColor),this._shadowInfos.x=M.shadowStrength,this._shadowInfos.y=this._shadowTileResolution,this._shadowInfos.z=E,te.rotationQuaternion(M.entity.transform.worldRotationQuaternion,x),P.set(b[0],b[1],b[2]),S.set(b[4],b[5],b[6]),T.set(-b[8],-b[9],-b[10]),r.entity.transform.getWorldForward(n._tempVector);for(var C=0;C<m;C++){ft.getBoundSphereByFrustum(g[C],g[C+1],r,n._tempVector.normalize(),s),ft.getDirectionLightShadowCullPlanes(r._frustum,g[C],r.nearClipPlane,T,s),ft.getDirectionalLightMatrices(S,P,T,C,M.shadowNearPlane,this._shadowTileResolution,s),this._updateSingleShadowCasterShaderData(M,s,t);var R=y.center,z=y.radius,F=C*4;c[F]=R.x,c[F+1]=R.y,c[F+2]=R.z,c[F+3]=z*z,u.set(s.viewProjectMatrix.elements,16*C),h.clear(),d.clear(),f.clear();for(var D=p._renderers,I=D._elements,B=D.length-1;B>=0;--B)ft.shadowCullFrustum(t,I[B],s);h.sort(_r._compareFromNearToFar),d.sort(_r._compareFromNearToFar);var k=o[C];v.viewport(k.x,k.y,this._shadowTileResolution,this._shadowTileResolution),e._renderCount++,h.render(r,null,nr.Everything,i),d.render(r,null,nr.Everything,i)}this._existShadowMap=!0}},l._updateReceiversShaderData=function(){for(var t=this._splitBoundSpheres,e=this._camera.scene,r=e.shadowCascades,i=r*4,o=4*4;i<o;i++)t[i]=0;var s=e.shaderData;s.setFloatArray(n._viewProjMatFromLightProperty,this._vpMatrix),s.setVector3(n._shadowInfosProperty,this._shadowInfos),s.setTexture(n._shadowMapsProperty,this._depthTexture),s.setFloatArray(n._shadowSplitSpheresProperty,this._splitBoundSpheres)},l._getCascadesSplitDistance=function(t){var e=n._cascadesSplitDistance,r=this._camera.scene,i=r.shadowTwoCascadeSplits,o=r.shadowFourCascadeSplits,s=r.shadowCascades,c=this._camera,u=c.nearClipPlane,_=c.aspectRatio,h=c.fieldOfView;e[0]=u;var d=t-u,f=Math.tan(G.degreeToRadian(h)*.5),p=1+f*f*(_*_+1);switch(s){case Dt.NoCascades:e[1]=this._getFarWithRadius(t,p);break;case Dt.TwoCascades:e[1]=this._getFarWithRadius(u+d*i,p),e[2]=this._getFarWithRadius(t,p);break;case Dt.FourCascades:e[1]=this._getFarWithRadius(u+d*o.x,p),e[2]=this._getFarWithRadius(u+d*o.y,p),e[3]=this._getFarWithRadius(u+d*o.z,p),e[4]=this._getFarWithRadius(t,p);break}},l._getFarWithRadius=function(t,e){return Math.sqrt(t*t/e)},l._getAvailableRenderTarget=function(){var t,e,r,i=this._engine,o=this._shadowMapFormat,s=this._shadowMapSize,c=s.x,u=s.y,_=this._depthTexture,h=this._renderTargets;return(h==null||((t=_)===null||t===void 0?void 0:t.width)!==c||((e=_)===null||e===void 0?void 0:e.height)!==u||((r=_)===null||r===void 0?void 0:r.format)!==o)&&(_=this._depthTexture=new Mt(i,c,u,o,!1),_.wrapModeV=_.wrapModeU=pt.Clamp,i._hardwareRenderer._isWebGL2&&(_.depthCompareFunction=Vt.Less),this._supportDepthTexture?h=this._renderTargets=new Nn(i,c,u,null,_):h=this._renderTargets=new Nn(i,c,u,_)),h},l._updateShadowSettings=function(){var t=this._camera.scene,e=ft.shadowDepthFormat(t.shadowResolution,this._supportDepthTexture),r=ft.shadowResolution(t.shadowResolution),i=t.shadowCascades;if(e!==this._shadowMapFormat||r!==this._shadowMapResolution||i!==this._shadowCascadeMode){if(this._shadowMapFormat=e,this._shadowMapResolution=r,this._shadowCascadeMode=i,i==Dt.NoCascades)this._shadowTileResolution=r,this._shadowMapSize.set(r,r);else{var o=ft.getMaxTileResolutionInAtlas(r,r,i);this._shadowTileResolution=o,this._shadowMapSize.set(o*2,i==Dt.TwoCascades?o:o*2)}this._renderTargets=null;var s=this._viewportOffsets,c=this._shadowTileResolution;switch(i){case Dt.NoCascades:s[0].set(0,0);break;case Dt.TwoCascades:s[0].set(0,0),s[1].set(c,0);break;case Dt.FourCascades:s[0].set(0,0),s[1].set(c,0),s[2].set(0,c),s[3].set(c,c)}}},l._updateSingleShadowCasterShaderData=function(t,e,r){var i=2/e.projectionMatrix.elements[0],o=i/this._shadowTileResolution;this._shadowBias.set(-t.shadowBias*o,-t.shadowNormalBias*o);var s=this._camera.scene.shaderData;s.setVector2(n._lightShadowBiasProperty,this._shadowBias),s.setVector3(n._lightDirectionProperty,t.direction),r.applyViewProjectMatrix(e.viewMatrix,e.projectionMatrix,e.viewProjectMatrix)},n}();Rt._lightShadowBiasProperty=O.getPropertyByName("u_shadowBias");Rt._lightDirectionProperty=O.getPropertyByName("u_lightDirection");Rt._viewProjMatFromLightProperty=O.getPropertyByName("u_viewProjMatFromLight");Rt._shadowInfosProperty=O.getPropertyByName("u_shadowInfo");Rt._shadowMapsProperty=O.getPropertyByName("u_shadowMap");Rt._shadowSplitSpheresProperty=O.getPropertyByName("u_shadowSplitSpheres");Rt._maxCascades=4;Rt._cascadesSplitDistance=new Array(Rt._maxCascades+1);Rt._clearColor=new re(1,1,1,1);Rt._tempVector=new w;Rt._tempMatrix0=new te;var Jh=0,Vn=function(){function n(a,t,e,r,i){a===void 0&&(a="RENDER_PASS"+Jh++),t===void 0&&(t=0),e===void 0&&(e=null),r===void 0&&(r=null),i===void 0&&(i=null),this.name=void 0,this.enabled=void 0,this.priority=void 0,this.renderTarget=void 0,this.replaceMaterial=void 0,this.mask=void 0,this.renderOverride=void 0,this.clearFlags=void 0,this.clearColor=void 0,this.name=a,this.enabled=!0,this.priority=t,this.renderTarget=e,this.replaceMaterial=r,this.mask=i||nr.Everything,this.renderOverride=!1}var l=n.prototype;return l.render=function(t,e,r,i){},l.preRender=function(t,e,r,i){},l.postRender=function(t,e,r,i){},n}(),Vi=function(){function n(a){this._opaqueQueue=void 0,this._transparentQueue=void 0,this._alphaTestQueue=void 0,this._allSpriteMasks=new Ne,this._camera=void 0,this._defaultPass=void 0,this._renderPassArray=void 0,this._lastCanvasSize=new X,this._cascadedShadowCaster=void 0,this._camera=a;var t=a.engine;this._opaqueQueue=new _r(t),this._alphaTestQueue=new _r(t),this._transparentQueue=new _r(t),this._cascadedShadowCaster=new Rt(a),this._renderPassArray=[],this._defaultPass=new Vn("default",0,null,null,0),this.addRenderPass(this._defaultPass)}var l=n.prototype;return l.addRenderPass=function(t,e,r,i,o){if(e===void 0&&(e=null),r===void 0&&(r=null),i===void 0&&(i=null),o===void 0&&(o=null),typeof t=="string"){var s=new Vn(t,e,r,i,o);this._renderPassArray.push(s)}else t instanceof Vn&&this._renderPassArray.push(t);this._renderPassArray.sort(function(c,u){return c.priority-u.priority})},l.removeRenderPass=function(t){var e;if(typeof t=="string"?e=this.getRenderPass(t):t instanceof Vn&&(e=t),e){var r=this._renderPassArray.indexOf(e);this._renderPassArray.splice(r,1)}},l.getRenderPass=function(t){for(var e=0,r=this._renderPassArray.length;e<r;e++){var i=this._renderPassArray[e];if(i.name===t)return i}return null},l.destroy=function(){this._opaqueQueue.destroy(),this._alphaTestQueue.destroy(),this._transparentQueue.destroy(),this._allSpriteMasks=null,this._renderPassArray=null,this._defaultPass=null,this._camera=null},l.render=function(t,e,r){var i,o=this._camera,s=o.scene,c=this._opaqueQueue,u=this._alphaTestQueue,_=this._transparentQueue;o.engine._spriteMaskManager.clear(),s.castShadows&&((i=s._sunLight)===null||i===void 0?void 0:i.shadowType)!==Br.None&&this._cascadedShadowCaster._render(t),c.clear(),u.clear(),_.clear(),this._allSpriteMasks.length=0,t.applyViewProjectMatrix(o.viewMatrix,o.projectionMatrix,o._viewProjectionMatrix),this._callRender(t),c.sort(_r._compareFromNearToFar),u.sort(_r._compareFromNearToFar),_.sort(_r._compareFromFarToNear);for(var h=0,d=this._renderPassArray.length;h<d;h++)this._drawRenderPass(t,this._renderPassArray[h],o,e,r)},l._drawRenderPass=function(t,e,r,i,o){if(e.preRender(r,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue),e.enabled){var s,c,u=r.engine,_=r.scene,h=_.background,d=u._hardwareRenderer,f=r.renderTarget||e.renderTarget;d.activeRenderTarget(f,r.viewport,o),f==null||f._setRenderTargetInfo(i,o);var p=(s=e.clearFlags)!=null?s:r.clearFlags,v=(c=e.clearColor)!=null?c:h.solidColor;p!==It.None&&d.clearRenderTarget(r.engine,p,v),e.renderOverride?e.render(r,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue):(this._opaqueQueue.render(r,e.replaceMaterial,e.mask,null),this._alphaTestQueue.render(r,e.replaceMaterial,e.mask,null),r.clearFlags&It.Color&&(h.mode===pr.Sky?h.sky._render(t):h.mode===pr.Texture&&h.texture&&this._drawBackgroundTexture(u,h)),this._transparentQueue.render(r,e.replaceMaterial,e.mask,null)),f==null||f._blitRenderTarget(),f==null||f.generateMipmaps()}e.postRender(r,this._opaqueQueue,this._alphaTestQueue,this._transparentQueue)},l.pushPrimitive=function(t){switch(t.renderState.renderQueueType){case rt.Transparent:this._transparentQueue.pushPrimitive(t);break;case rt.AlphaTest:this._alphaTestQueue.pushPrimitive(t);break;case rt.Opaque:this._opaqueQueue.pushPrimitive(t);break}},l._drawBackgroundTexture=function(t,e){var r=t._hardwareRenderer,i=t._backgroundTextureMaterial,o=t.canvas,s=e._mesh;(this._lastCanvasSize.x!==o.width||this._lastCanvasSize.y!==o.height)&&e._textureFillMode!==Er.Fill&&(this._lastCanvasSize.set(o.width,o.height),e._resizeBackgroundTexture());var c=i.shader.passes[0]._getShaderProgram(t,O._compileMacros);c.bind(),c.uploadAll(c.materialUniformBlock,i.shaderData),c.uploadUnGroupTextures(),i.renderState._apply(t,!1),r.drawPrimitive(s,s.subMesh,c)},l._callRender=function(t){for(var e=this._camera.engine._componentsManager._renderers,r=t.camera,i=e._elements,o=e.length-1;o>=0;--o){var s=i[o];if(!!(r.cullingMask&s._entity.layer)&&!(r.enableFrustumCulling&&(s.isCulled=!r._frustum.intersectsBox(s.bounds),s.isCulled))){var c=r.entity.transform,u=c.worldPosition,_=s.bounds.getCenter(n._tempVector0);if(r.isOrthographic){var h=c.getWorldForward(n._tempVector1);w.subtract(_,u,_),s._distanceForSort=w.dot(_,h)}else s._distanceForSort=w.distanceSquared(_,u);s._updateShaderData(t),s._render(t),Et.unionCollection(r._globalShaderMacro,s.shaderData._macroCollection,s._globalShaderMacro)}}},j(n,[{key:"defaultRenderPass",get:function(){return this._defaultPass}}]),n}();Vi._tempVector0=new w;Vi._tempVector1=new w;var ms,ys,ut,xs,ws,bs,Cs,Ss,Ts,As,Ps,Ms,Es,Rs,zs,Fs,ii,Yr=function(){};Yr.tempVec4=new ve;Yr.tempVec3=new w;Yr.tempVec2=new X;var ba=(ms=Yn(At),ms(ys=(ut=(ii=function(n){$(l,n);function l(t){var e;e=n.call(this,t)||this,e.shaderData=new Qn(qt.Camera),e.priority=0,e.enableFrustumCulling=!0,e.clearFlags=It.All,e.cullingMask=nr.Everything,e._globalShaderMacro=new Et,U(e,"_frustum",xs,L(e)),U(e,"_renderPipeline",ws,L(e)),U(e,"_viewProjectionMatrix",bs,L(e)),e._isOrthographic=!1,e._isProjMatSetting=!1,e._nearClipPlane=.1,e._farClipPlane=100,e._fieldOfView=45,e._orthographicSize=10,e._isProjectionDirty=!0,e._isInvProjMatDirty=!0,e._isFrustumProjectDirty=!0,e._customAspectRatio=void 0,e._renderTarget=null,U(e,"_frustumViewChangeFlag",Cs,L(e)),U(e,"_transform",Ss,L(e)),U(e,"_isViewMatrixDirty",Ts,L(e)),U(e,"_isInvViewProjDirty",As,L(e)),U(e,"_projectionMatrix",Ps,L(e)),U(e,"_viewMatrix",Ms,L(e)),U(e,"_viewport",Es,L(e)),U(e,"_inverseProjectionMatrix",Rs,L(e)),U(e,"_lastAspectSize",zs,L(e)),U(e,"_invViewProjMat",Fs,L(e));var r=e.entity.transform;return e._transform=r,e._isViewMatrixDirty=r.registerWorldChangeFlag(),e._isInvViewProjDirty=r.registerWorldChangeFlag(),e._frustumViewChangeFlag=r.registerWorldChangeFlag(),e._renderPipeline=new Vi(L(e)),e.shaderData._addRefCount(1),e}var a=l.prototype;return a.resetProjectionMatrix=function(){this._isProjMatSetting=!1,this._projMatChange()},a.resetAspectRatio=function(){this._customAspectRatio=void 0,this._projMatChange()},a.worldToViewportPoint=function(e,r){var i=Yr.tempVec3,o=Yr.tempVec4;w.transformCoordinate(e,this.viewMatrix,i),w.transformToVec4(i,this.projectionMatrix,o);var s=o.w;return r.set((o.x/s+1)*.5,(1-o.y/s)*.5,-i.z),r},a.viewportToWorldPoint=function(e,r){var i=this.nearClipPlane,o=this.farClipPlane,s=1/(i-o),c;if(this.isOrthographic)c=-e.z*2*s,c+=(o+i)*s;else{var u=e.z;c=-u*(i+o)*s,c+=2*i*o*s,c=c/u}return this._innerViewportToWorldPoint(e.x,e.y,(c+1)/2,this._getInvViewProjMat(),r),r},a.viewportPointToRay=function(e,r){var i=this._getInvViewProjMat(),o=this._innerViewportToWorldPoint(e.x,e.y,0,i,r.origin),s=this._innerViewportToWorldPoint(e.x,e.y,1,i,r.direction);return w.subtract(s,o,s),s.normalize(),r},a.screenToViewportPoint=function(e,r){var i=this.engine.canvas,o=this.viewport;return r.x=(e.x/i.width-o.x)/o.z,r.y=(e.y/i.height-o.y)/o.w,e.z!==void 0&&(r.z=e.z),r},a.viewportToScreenPoint=function(e,r){var i=this.engine.canvas,o=this.viewport;return r.x=(o.x+e.x*o.z)*i.width,r.y=(o.y+e.y*o.w)*i.height,e.z!==void 0&&(r.z=e.z),r},a.worldToScreenPoint=function(e,r){return this.worldToViewportPoint(e,r),this.viewportToScreenPoint(r,r)},a.screenToWorldPoint=function(e,r){return this.screenToViewportPoint(e,r),this.viewportToWorldPoint(r,r)},a.screenPointToRay=function(e,r){var i=Yr.tempVec2;return this.screenToViewportPoint(e,i),this.viewportPointToRay(i,r)},a.render=function(e,r){r===void 0&&(r=0);var i=this.engine._renderContext;i.camera=this,te.multiply(this.projectionMatrix,this.viewMatrix,this._viewProjectionMatrix),this.enableFrustumCulling&&(this._frustumViewChangeFlag.flag||this._isFrustumProjectDirty)&&(this._frustum.calculateFromMatrix(this._viewProjectionMatrix),this._frustumViewChangeFlag.flag=!1,this._isFrustumProjectDirty=!1),this._updateShaderData(),Et.unionCollection(this.scene._globalShaderMacro,this.shaderData._macroCollection,this._globalShaderMacro),r>0&&!this.engine._hardwareRenderer.isWebGL2&&(r=0,ce.error("mipLevel only take effect in WebGL2.0")),this._renderPipeline.render(i,e,r),this._engine._renderCount++},a._onEnable=function(){this.entity.scene._attachRenderCamera(this)},a._onDisable=function(){this.entity.scene._detachRenderCamera(this)},a._onDestroy=function(){var e;(e=this._renderPipeline)===null||e===void 0||e.destroy(),this._isInvViewProjDirty.destroy(),this._isViewMatrixDirty.destroy(),this.shaderData._addRefCount(-1)},a._projMatChange=function(){this._isFrustumProjectDirty=!0,this._isProjectionDirty=!0,this._isInvProjMatDirty=!0,this._isInvViewProjDirty.flag=!0},a._innerViewportToWorldPoint=function(e,r,i,o,s){var c=Yr.tempVec3;return c.set(e*2-1,1-r*2,i*2-1),w.transformCoordinate(c,o,s),s},a._updateShaderData=function(){var e=this.shaderData;e.setMatrix(l._inverseViewMatrixProperty,this._transform.worldMatrix),e.setVector3(l._cameraPositionProperty,this._transform.worldPosition)},a._getInvViewProjMat=function(){return this._isInvViewProjDirty.flag&&(this._isInvViewProjDirty.flag=!1,te.multiply(this._transform.worldMatrix,this._getInverseProjectionMatrix(),this._invViewProjMat)),this._invViewProjMat},a._getInverseProjectionMatrix=function(){return this._isInvProjMatDirty&&(this._isInvProjMatDirty=!1,te.invert(this.projectionMatrix,this._inverseProjectionMatrix)),this._inverseProjectionMatrix},j(l,[{key:"nearClipPlane",get:function(){return this._nearClipPlane},set:function(e){this._nearClipPlane=e,this._projMatChange()}},{key:"farClipPlane",get:function(){return this._farClipPlane},set:function(e){this._farClipPlane=e,this._projMatChange()}},{key:"fieldOfView",get:function(){return this._fieldOfView},set:function(e){this._fieldOfView=e,this._projMatChange()}},{key:"aspectRatio",get:function(){var e,r=this._entity.engine.canvas;return(e=this._customAspectRatio)!=null?e:r.width*this._viewport.z/(r.height*this._viewport.w)},set:function(e){this._customAspectRatio=e,this._projMatChange()}},{key:"viewport",get:function(){return this._viewport},set:function(e){e!==this._viewport&&this._viewport.copyFrom(e),this._projMatChange()}},{key:"isOrthographic",get:function(){return this._isOrthographic},set:function(e){this._isOrthographic=e,this._projMatChange()}},{key:"orthographicSize",get:function(){return this._orthographicSize},set:function(e){this._orthographicSize=e,this._projMatChange()}},{key:"viewMatrix",get:function(){return this._isViewMatrixDirty.flag&&(this._isViewMatrixDirty.flag=!1,te.rotationTranslation(this._transform.worldRotationQuaternion,this._transform.worldPosition,this._viewMatrix),this._viewMatrix.invert()),this._viewMatrix}},{key:"projectionMatrix",get:function(){var e=this._entity.engine.canvas;if((!this._isProjectionDirty||this._isProjMatSetting)&&this._lastAspectSize.x===e.width&&this._lastAspectSize.y===e.height)return this._projectionMatrix;this._isProjectionDirty=!1,this._lastAspectSize.x=e.width,this._lastAspectSize.y=e.height;var r=this.aspectRatio;if(!this._isOrthographic)te.perspective(G.degreeToRadian(this._fieldOfView),r,this._nearClipPlane,this._farClipPlane,this._projectionMatrix);else{var i=this._orthographicSize*r,o=this._orthographicSize;te.ortho(-i,i,-o,o,this._nearClipPlane,this._farClipPlane,this._projectionMatrix)}return this._projectionMatrix},set:function(e){this._projectionMatrix=e,this._isProjMatSetting=!0,this._projMatChange()}},{key:"enableHDR",get:function(){return console.log("not implementation"),!1},set:function(e){console.log("not implementation")}},{key:"renderTarget",get:function(){return this._renderTarget},set:function(e){this._renderTarget=e}}]),l}(ir),ii._inverseViewMatrixProperty=O.getPropertyByName("u_viewInvMat"),ii._cameraPositionProperty=O.getPropertyByName("u_cameraPos"),ii),xs=N(ut.prototype,"_frustum",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Hu}}),ws=N(ut.prototype,"_renderPipeline",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),bs=N(ut.prototype,"_viewProjectionMatrix",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),Cs=N(ut.prototype,"_frustumViewChangeFlag",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ss=N(ut.prototype,"_transform",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ts=N(ut.prototype,"_isViewMatrixDirty",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),As=N(ut.prototype,"_isInvViewProjDirty",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ps=N(ut.prototype,"_projectionMatrix",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),Ms=N(ut.prototype,"_viewMatrix",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),Es=N(ut.prototype,"_viewport",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ve(0,0,1,1)}}),Rs=N(ut.prototype,"_inverseProjectionMatrix",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),zs=N(ut.prototype,"_lastAspectSize",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new X(0,0)}}),Fs=N(ut.prototype,"_invViewProjMat",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new te}}),ut))||ys),Zh={json:"json",gltf:"json",mtl:"json",prefab:"json",txt:"text",bin:"arraybuffer",png:"image",webp:"image",jpg:"image"},Kh=1,ed=1/0,td=500;function Dn(n,l){return l===void 0&&(l={}),new Ee(function(a,t,e){var r,i,o,s,c=(r=l.retryCount)!=null?r:Kh,u=(i=l.retryInterval)!=null?i:td;l.timeout=(o=l.timeout)!=null?o:ed,l.type=(s=l.type)!=null?s:id(n);var _=l.type==="image"?rd:nd,h,d=new ad(function(){return _(n,l).onProgress(e).then(function(f){a(f),d.stop()}).catch(function(f){return h=f})},c,u);d.start(function(){t(h)})})}function rd(n,l){return new Ee(function(a,t){var e=l.timeout,r=new Image,i=function(){t(new Error("request "+n+" fail"))};r.onerror=i,r.onabort=i;var o=-1;e!=1/0&&(o=window.setTimeout(function(){t(new Error("request "+n+" timeout"))},e)),r.onload=function(s){return function(){requestAnimationFrame(function(){a(r),r.onload=null,r.onerror=null,r.onabort=null}),clearTimeout(s)}}(o),r.crossOrigin="anonymous",r.src=n})}function nd(n,l){return new Ee(function(a,t,e){var r,i=new XMLHttpRequest;i.timeout=l.timeout,l.method=(r=l.method)!=null?r:"get",i.onload=function(){var s;if(i.status<200||i.status>=300){t(new Error("request failed from: "+n));return}var c=(s=i.response)!=null?s:i.responseText;a(c)},i.onerror=function(){t(new Error("request failed from: "+n))},i.ontimeout=function(){t(new Error("request timeout from: "+n))},i.onprogress=function(s){e(s.loaded/s.total)},i.open(l.method,n,!0),i.withCredentials=l.credentials==="include",i.responseType=l.type;var o=l.headers;o&&Object.keys(o).forEach(function(s){i.setRequestHeader(s,o[s])}),i.send(l.body)})}function id(n){var l=n.substring(n.lastIndexOf(".")+1);return Zh[l]}var ad=function(){function n(a,t,e){this.execFunc=a,this.totalCount=t,this.interval=e,this._timeoutId=-100,this._currentCount=0,this.done=void 0,this.exec=this.exec.bind(this)}var l=n.prototype;return l.start=function(t){this.done=t,this.exec()},l.stop=function(){clearTimeout(this._timeoutId)},l.exec=function(){var t=this;if(this._currentCount>=this.totalCount){this.done&&this.done();return}this._currentCount++,this.execFunc(this._currentCount).then(function(){t._timeoutId=setTimeout(t.exec,t.interval)})},n}(),Te=function(){n.registerClass=function(a,t){this._engineObjects[a]=t},n.getClass=function(a){return this._engineObjects[a]};function n(l){this.useCache=l,this.request=Dn}return n}();Te._engineObjects={};var Me;(function(n){n.Text="text",n.JSON="json",n.Buffer="buffer",n.Texture2D="texture2d",n.TextureCube="texture-cube",n.Material="material",n.Mesh="mesh",n.AnimationClip="AnimationClip",n.AnimatorController="AnimatorController",n.Prefab="prefab",n.KTX="ktx",n.KTXCube="ktx-cube",n.Sprite="sprite",n.SpriteAtlas="sprite-atlas",n.Env="environment",n.Scene="scene",n.HDR="HDR",n.Font="font",n.SourceFont="source-font"})(Me||(Me={}));var Qr;(function(n){n[n.Normal=0]="Normal",n[n.Additive=1]="Additive"})(Qr||(Qr={}));var fr;(function(n){n[n.Front=0]="Front",n[n.Back=1]="Back",n[n.Double=2]="Double"})(fr||(fr={}));var ot=function(n){$(l,n);function l(t,e){var r;return r=n.call(this,t,e)||this,r._renderFace=fr.Front,r._isTransparent=!1,r._blendMode=Qr.Normal,r.shaderData.setFloat(l._alphaCutoffProp,0),r}var a=l.prototype;return a.setIsTransparent=function(e,r){var i=this.renderStates;if(i.length<e)throw"Pass should less than pass count.";var o=i[e];r?(o.blendState.targetBlendState.enabled=!0,o.depthState.writeEnabled=!1,o.renderQueueType=rt.Transparent):(o.blendState.targetBlendState.enabled=!1,o.depthState.writeEnabled=!0,o.renderQueueType=this.shaderData.getFloat(l._alphaCutoffProp)?rt.AlphaTest:rt.Opaque)},a.setBlendMode=function(e,r){var i=this.renderStates;if(i.length<e)throw"Pass should less than pass count.";var o=i[e].blendState.targetBlendState;switch(r){case Qr.Normal:o.sourceColorBlendFactor=oe.SourceAlpha,o.destinationColorBlendFactor=oe.OneMinusSourceAlpha,o.sourceAlphaBlendFactor=oe.One,o.destinationAlphaBlendFactor=oe.OneMinusSourceAlpha,o.colorBlendOperation=o.alphaBlendOperation=St.Add;break;case Qr.Additive:o.sourceColorBlendFactor=oe.SourceAlpha,o.destinationColorBlendFactor=oe.One,o.sourceAlphaBlendFactor=oe.One,o.destinationAlphaBlendFactor=oe.OneMinusSourceAlpha,o.colorBlendOperation=o.alphaBlendOperation=St.Add;break}},a.setRenderFace=function(e,r){var i=this.renderStates;if(i.length<e)throw"Pass should less than pass count.";switch(r){case fr.Front:i[e].rasterState.cullMode=Pt.Back;break;case fr.Back:i[e].rasterState.cullMode=Pt.Front;break;case fr.Double:i[e].rasterState.cullMode=Pt.Off;break}},a.clone=function(){var e=new l(this._engine,this.shader);return this.cloneTo(e),e},a.cloneTo=function(e){n.prototype.cloneTo.call(this,e),e._renderFace=this._renderFace,e._isTransparent=this._isTransparent,e._blendMode=this._blendMode},j(l,[{key:"shader",get:function(){return this._shader},set:function(e){this._shader=e;var r=this._renderStates,i=r.length,o=e.passes.length;if(i<o)for(var s=i;s<o;s++)r.push(new fa),this.setBlendMode(s,Qr.Normal);else r.length=o}},{key:"isTransparent",get:function(){return this._isTransparent},set:function(e){e!==this._isTransparent&&(this.setIsTransparent(0,e),this._isTransparent=e)}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){e!==this._blendMode&&(this.setBlendMode(0,e),this._blendMode=e)}},{key:"alphaCutoff",get:function(){return this.shaderData.getFloat(l._alphaCutoffProp)},set:function(e){var r=this.shaderData;if(r.getFloat(l._alphaCutoffProp)!==e){e?r.enableMacro(l._alphaCutoffMacro):r.disableMacro(l._alphaCutoffMacro);for(var i=this.renderStates,o=0,s=i.length;o<s;o++){var c=i[o];e>0?c.renderQueueType=c.blendState.targetBlendState.enabled?rt.Transparent:rt.AlphaTest:c.renderQueueType=c.blendState.targetBlendState.enabled?rt.Transparent:rt.Opaque}r.setFloat(l._alphaCutoffProp,e)}}},{key:"renderFace",get:function(){return this._renderFace},set:function(e){e!==this._renderFace&&(this.setRenderFace(0,e),this._renderFace=e)}}]),l}(dr);ot._baseColorProp=O.getPropertyByName("u_baseColor");ot._baseTextureProp=O.getPropertyByName("u_baseTexture");ot._baseTextureMacro=O.getMacroByName("BASETEXTURE");ot._tilingOffsetProp=O.getPropertyByName("u_tilingOffset");ot._normalTextureProp=O.getPropertyByName("u_normalTexture");ot._normalIntensityProp=O.getPropertyByName("u_normalIntensity");ot._normalTextureMacro=O.getMacroByName("NORMALTEXTURE");ot._emissiveColorProp=O.getPropertyByName("u_emissiveColor");ot._emissiveTextureProp=O.getPropertyByName("u_emissiveTexture");ot._emissiveTextureMacro=O.getMacroByName("EMISSIVETEXTURE");ot._alphaCutoffProp=O.getPropertyByName("u_alphaCutoff");ot._alphaCutoffMacro=O.getMacroByName("ALPHA_CUTOFF");var An=function(n){$(l,n);function l(t){var e;e=n.call(this,t,O.find("blinn-phong"))||this;var r=e.shaderData;return r.enableMacro("O3_NEED_WORLDPOS"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(l._baseColorProp,new re(1,1,1,1)),r.setColor(l._specularColorProp,new re(1,1,1,1)),r.setColor(l._emissiveColorProp,new re(0,0,0,1)),r.setVector4(l._tilingOffsetProp,new ve(1,1,0,0)),r.setFloat(l._shininessProp,16),r.setFloat(l._normalIntensityProp,1),e}var a=l.prototype;return a.clone=function(){var e=new l(this._engine);return this.cloneTo(e),e},j(l,[{key:"baseColor",get:function(){return this.shaderData.getColor(l._baseColorProp)},set:function(e){var r=this.shaderData.getColor(l._baseColorProp);e!==r&&r.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(l._baseTextureProp)},set:function(e){this.shaderData.setTexture(l._baseTextureProp,e),e?this.shaderData.enableMacro(l._baseTextureMacro):this.shaderData.disableMacro(l._baseTextureMacro)}},{key:"specularColor",get:function(){return this.shaderData.getColor(l._specularColorProp)},set:function(e){var r=this.shaderData.getColor(l._specularColorProp);e!==r&&r.copyFrom(e)}},{key:"specularTexture",get:function(){return this.shaderData.getTexture(l._specularTextureProp)},set:function(e){this.shaderData.setTexture(l._specularTextureProp,e),e?this.shaderData.enableMacro("O3_SPECULAR_TEXTURE"):this.shaderData.disableMacro("O3_SPECULAR_TEXTURE")}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(l._emissiveColorProp)},set:function(e){var r=this.shaderData.getColor(l._emissiveColorProp);e!==r&&r.copyFrom(e)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(l._emissiveTextureProp)},set:function(e){this.shaderData.setTexture(l._emissiveTextureProp,e),e?this.shaderData.enableMacro(l._emissiveTextureMacro):this.shaderData.disableMacro(l._emissiveTextureMacro)}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(l._normalTextureProp)},set:function(e){this.shaderData.setTexture(l._normalTextureProp,e),e?this.shaderData.enableMacro(l._normalTextureMacro):this.shaderData.disableMacro(l._normalTextureMacro)}},{key:"normalIntensity",get:function(){return this.shaderData.getFloat(l._normalIntensityProp)},set:function(e){this.shaderData.setFloat(l._normalIntensityProp,e)}},{key:"shininess",get:function(){return this.shaderData.getFloat(l._shininessProp)},set:function(e){this.shaderData.setFloat(l._shininessProp,Math.max(e,1e-4))}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(l._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(l._tilingOffsetProp);e!==r&&r.copyFrom(e)}}]),l}(ot);An._specularColorProp=O.getPropertyByName("u_specularColor");An._shininessProp=O.getPropertyByName("u_shininess");An._specularTextureProp=O.getPropertyByName("u_specularTexture");var Fr;(function(n){n[n.UV0=0]="UV0",n[n.UV1=1]="UV1",n[n.UV2=2]="UV2",n[n.UV3=3]="UV3",n[n.UV4=4]="UV4",n[n.UV5=5]="UV5",n[n.UV6=6]="UV6",n[n.UV7=7]="UV7"})(Fr||(Fr={}));var Qt=function(n){$(l,n);function l(a,t){var e;e=n.call(this,a,t)||this;var r=e.shaderData;return r.enableMacro("O3_NEED_WORLDPOS"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(l._baseColorProp,new re(1,1,1,1)),r.setColor(l._emissiveColorProp,new re(0,0,0,1)),r.setVector4(l._tilingOffsetProp,new ve(1,1,0,0)),r.setFloat(l._normalIntensityProp,1),r.setFloat(l._occlusionTextureIntensityProp,1),r.setFloat(l._occlusionTextureCoordProp,Fr.UV0),r.setFloat(l._clearCoatProp,0),r.setFloat(l._clearCoatRoughnessProp,0),e}return j(l,[{key:"baseColor",get:function(){return this.shaderData.getColor(l._baseColorProp)},set:function(t){var e=this.shaderData.getColor(l._baseColorProp);t!==e&&e.copyFrom(t)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(l._baseTextureProp)},set:function(t){this.shaderData.setTexture(l._baseTextureProp,t),t?this.shaderData.enableMacro(l._baseTextureMacro):this.shaderData.disableMacro(l._baseTextureMacro)}},{key:"normalTexture",get:function(){return this.shaderData.getTexture(l._normalTextureProp)},set:function(t){this.shaderData.setTexture(l._normalTextureProp,t),t?this.shaderData.enableMacro(l._normalTextureMacro):this.shaderData.disableMacro(l._normalTextureMacro)}},{key:"normalTextureIntensity",get:function(){return this.shaderData.getFloat(l._normalIntensityProp)},set:function(t){this.shaderData.setFloat(l._normalIntensityProp,t)}},{key:"emissiveColor",get:function(){return this.shaderData.getColor(l._emissiveColorProp)},set:function(t){var e=this.shaderData.getColor(l._emissiveColorProp);t!==e&&e.copyFrom(t)}},{key:"emissiveTexture",get:function(){return this.shaderData.getTexture(l._emissiveTextureProp)},set:function(t){this.shaderData.setTexture(l._emissiveTextureProp,t),t?this.shaderData.enableMacro(l._emissiveTextureMacro):this.shaderData.disableMacro(l._emissiveTextureMacro)}},{key:"occlusionTexture",get:function(){return this.shaderData.getTexture(l._occlusionTextureProp)},set:function(t){this.shaderData.setTexture(l._occlusionTextureProp,t),t?this.shaderData.enableMacro("OCCLUSIONTEXTURE"):this.shaderData.disableMacro("OCCLUSIONTEXTURE")}},{key:"occlusionTextureIntensity",get:function(){return this.shaderData.getFloat(l._occlusionTextureIntensityProp)},set:function(t){this.shaderData.setFloat(l._occlusionTextureIntensityProp,t)}},{key:"occlusionTextureCoord",get:function(){return this.shaderData.getFloat(l._occlusionTextureCoordProp)},set:function(t){t>Fr.UV1&&ce.warn("Occlusion texture uv coordinate must be UV0 or UV1."),this.shaderData.setFloat(l._occlusionTextureCoordProp,t)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(l._tilingOffsetProp)},set:function(t){var e=this.shaderData.getVector4(l._tilingOffsetProp);t!==e&&e.copyFrom(t)}},{key:"clearCoat",get:function(){return this.shaderData.getFloat(l._clearCoatProp)},set:function(t){!!this.shaderData.getFloat(l._clearCoatProp)!=!!t&&(t===0?this.shaderData.disableMacro("CLEARCOAT"):this.shaderData.enableMacro("CLEARCOAT")),this.shaderData.setFloat(l._clearCoatProp,t)}},{key:"clearCoatTexture",get:function(){return this.shaderData.getTexture(l._clearCoatTextureProp)},set:function(t){this.shaderData.setTexture(l._clearCoatTextureProp,t),t?this.shaderData.enableMacro("HAS_CLEARCOATTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATTEXTURE")}},{key:"clearCoatRoughness",get:function(){return this.shaderData.getFloat(l._clearCoatRoughnessProp)},set:function(t){this.shaderData.setFloat(l._clearCoatRoughnessProp,t)}},{key:"clearCoatRoughnessTexture",get:function(){return this.shaderData.getTexture(l._clearCoatRoughnessTextureProp)},set:function(t){this.shaderData.setTexture(l._clearCoatRoughnessTextureProp,t),t?this.shaderData.enableMacro("HAS_CLEARCOATROUGHNESSTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATROUGHNESSTEXTURE")}},{key:"clearCoatNormalTexture",get:function(){return this.shaderData.getTexture(l._clearCoatNormalTextureProp)},set:function(t){this.shaderData.setTexture(l._clearCoatNormalTextureProp,t),t?this.shaderData.enableMacro("HAS_CLEARCOATNORMALTEXTURE"):this.shaderData.disableMacro("HAS_CLEARCOATNORMALTEXTURE")}}]),l}(ot);Qt._occlusionTextureIntensityProp=O.getPropertyByName("u_occlusionIntensity");Qt._occlusionTextureCoordProp=O.getPropertyByName("u_occlusionTextureCoord");Qt._occlusionTextureProp=O.getPropertyByName("u_occlusionTexture");Qt._clearCoatProp=O.getPropertyByName("u_clearCoat");Qt._clearCoatTextureProp=O.getPropertyByName("u_clearCoatTexture");Qt._clearCoatRoughnessProp=O.getPropertyByName("u_clearCoatRoughness");Qt._clearCoatRoughnessTextureProp=O.getPropertyByName("u_clearCoatRoughnessTexture");Qt._clearCoatNormalTextureProp=O.getPropertyByName("u_clearCoatNormalTexture");var Pn=function(n){$(l,n);function l(t){var e;return e=n.call(this,t,O.find("pbr"))||this,e.shaderData.setFloat(l._metallicProp,1),e.shaderData.setFloat(l._roughnessProp,1),e}var a=l.prototype;return a.clone=function(){var e=new l(this._engine);return this.cloneTo(e),e},j(l,[{key:"metallic",get:function(){return this.shaderData.getFloat(l._metallicProp)},set:function(e){this.shaderData.setFloat(l._metallicProp,e)}},{key:"roughness",get:function(){return this.shaderData.getFloat(l._roughnessProp)},set:function(e){this.shaderData.setFloat(l._roughnessProp,e)}},{key:"roughnessMetallicTexture",get:function(){return this.shaderData.getTexture(l._roughnessMetallicTextureProp)},set:function(e){this.shaderData.setTexture(l._roughnessMetallicTextureProp,e),e?this.shaderData.enableMacro("ROUGHNESSMETALLICTEXTURE"):this.shaderData.disableMacro("ROUGHNESSMETALLICTEXTURE")}}]),l}(Qt);Pn._metallicProp=O.getPropertyByName("u_metal");Pn._roughnessProp=O.getPropertyByName("u_roughness");Pn._roughnessMetallicTextureProp=O.getPropertyByName("u_roughnessMetallicTexture");var an=function(n){$(l,n);function l(t){var e;return e=n.call(this,t,O.find("pbr-specular"))||this,e.shaderData.setColor(l._specularColorProp,new re(1,1,1,1)),e.shaderData.setFloat(l._glossinessProp,1),e}var a=l.prototype;return a.clone=function(){var e=new l(this._engine);return this.cloneTo(e),e},j(l,[{key:"specularColor",get:function(){return this.shaderData.getColor(l._specularColorProp)},set:function(e){var r=this.shaderData.getColor(l._specularColorProp);e!==r&&r.copyFrom(e)}},{key:"glossiness",get:function(){return this.shaderData.getFloat(l._glossinessProp)},set:function(e){this.shaderData.setFloat(l._glossinessProp,e)}},{key:"specularGlossinessTexture",get:function(){return this.shaderData.getTexture(l._specularGlossinessTextureProp)},set:function(e){this.shaderData.setTexture(l._specularGlossinessTextureProp,e),e?this.shaderData.enableMacro(l._specularGlossinessTextureMacro):this.shaderData.disableMacro(l._specularGlossinessTextureMacro)}}]),l}(Qt);an._specularColorProp=O.getPropertyByName("u_PBRSpecularColor");an._glossinessProp=O.getPropertyByName("u_glossiness");an._specularGlossinessTextureProp=O.getPropertyByName("u_specularGlossinessTexture");an._specularGlossinessTextureMacro=O.getMacroByName("SPECULARGLOSSINESSTEXTURE");var Ca=function(n){$(l,n);function l(t){var e;e=n.call(this,t,O.find("unlit"))||this;var r=e.shaderData;return r.enableMacro("OMIT_NORMAL"),r.enableMacro("O3_NEED_TILINGOFFSET"),r.setColor(l._baseColorProp,new re(1,1,1,1)),r.setVector4(l._tilingOffsetProp,new ve(1,1,0,0)),e}var a=l.prototype;return a.clone=function(){var e=new l(this._engine);return this.cloneTo(e),e},j(l,[{key:"baseColor",get:function(){return this.shaderData.getColor(l._baseColorProp)},set:function(e){var r=this.shaderData.getColor(l._baseColorProp);e!==r&&r.copyFrom(e)}},{key:"baseTexture",get:function(){return this.shaderData.getTexture(l._baseTextureProp)},set:function(e){this.shaderData.setTexture(l._baseTextureProp,e),e?this.shaderData.enableMacro(l._baseTextureMacro):this.shaderData.disableMacro(l._baseTextureMacro)}},{key:"tilingOffset",get:function(){return this.shaderData.getVector4(l._tilingOffsetProp)},set:function(e){var r=this.shaderData.getVector4(l._tilingOffsetProp);e!==r&&r.copyFrom(e)}}]),l}(ot),Jr;(function(n){n[n.Left=0]="Left",n[n.Center=1]="Center",n[n.Right=2]="Right"})(Jr||(Jr={}));var Zr;(function(n){n[n.Top=0]="Top",n[n.Center=1]="Center",n[n.Bottom=2]="Bottom"})(Zr||(Zr={}));var nn;(function(n){n[n.Overflow=0]="Overflow",n[n.Truncate=1]="Truncate"})(nn||(nn={}));var Rr;(function(n){n[n.None=0]="None",n[n.Bold=1]="Bold",n[n.Italic=2]="Italic"})(Rr||(Rr={}));var wu=function(n){$(a,n);var l=a.prototype;l.getSprite=function(e){var r=this._sprites[this._spriteNamesToIndex[e]];return r||console.warn("There is no sprite named "+e+" in the atlas."),r},l.getSprites=function(e,r){r.length=0;var i=this._spriteNamesToIndex[e];if(i!==void 0)for(var o=this._sprites;i>=0;i--){var s=o[i];s.name===e&&r.push(s)}else console.warn("The name of the sprite you want to find is not exit in SpriteAtlas.");return r};function a(t){var e;return e=n.call(this,t)||this,e._sprites=new Array,e._spriteNamesToIndex={},e}return l._addSprite=function(e){this._spriteNamesToIndex[e.name]=this._sprites.push(e)-1},l._onDestroy=function(){this._sprites=null,this._spriteNamesToIndex=null},j(a,[{key:"sprites",get:function(){return this._sprites}}]),a}(wr),Pr;(function(n){n[n.Simple=0]="Simple",n[n.Sliced=1]="Sliced"})(Pr||(Pr={}));var Sa=function(n){$(l,n);function l(t,e,r,i,o,s){var c;return e===void 0&&(e=null),r===void 0&&(r=null),i===void 0&&(i=null),o===void 0&&(o=null),s===void 0&&(s=null),c=n.call(this,t)||this,c.name=void 0,c._assetID=void 0,c._width=void 0,c._height=void 0,c._positions=[new X,new X,new X,new X],c._uvs=[new X,new X,new X,new X],c._bounds=new Tt,c._texture=null,c._atlasRotated=!1,c._atlasRegion=new ea(0,0,1,1),c._atlasRegionOffset=new ve(0,0,0,0),c._region=new ea(0,0,1,1),c._pivot=new X(.5,.5),c._border=new ve(0,0,0,0),c._dirtyUpdateFlag=Zt.all,c._updateFlagManager=new mn,c._texture=e,r&&c._region.copyFrom(r),i&&c._pivot.copyFrom(i),o&&c._border.copyFrom(o),c.name=s,c}var a=l.prototype;return a.clone=function(){var e=new l(this._engine,this._texture,this._region,this._pivot,this._border,this.name);return e._assetID=this._assetID,e._atlasRotated=this._atlasRotated,e._atlasRegion.copyFrom(this._atlasRegion),e._atlasRegionOffset.copyFrom(this._atlasRegionOffset),e},a._getPositions=function(){return this._dirtyUpdateFlag&Zt.positions&&this._updatePositions(),this._positions},a._getUVs=function(){return this._dirtyUpdateFlag&Zt.uvs&&this._updateUVs(),this._uvs},a._getBounds=function(){return this._dirtyUpdateFlag&Zt.positions&&this._updatePositions(),this._bounds},a._onDestroy=function(){this._texture&&(this._texture=null)},a._calDefaultSize=function(){if(this._texture){var e=this._texture,r=this._atlasRegion,i=this._atlasRegionOffset,o=this._region,s=1/mr._pixelsPerUnit;this.width=e.width*r.width/(1-i.x-i.z)*o.width*s,this.height=e.height*r.height/(1-i.y-i.w)*o.height*s}},a._updatePositions=function(){var e=this._atlasRegionOffset,r=this._region,i=r.x,o=r.y,s=r.width,c=r.height,u=1-i-s,_=1-o-c,h=Math.max(e.x-i,0)/s,d=Math.max(e.w-o,0)/c,f=1-Math.max(e.z-u,0)/s,p=1-Math.max(e.y-_,0)/c,v=this._positions;v[0].set(h,d),v[1].set(f,d),v[2].set(h,p),v[3].set(f,p);var m=this._bounds,g=m.min,y=m.max;g.set(h,d,0),y.set(f,p,0),this._dirtyUpdateFlag&=~Zt.positions},a._updateUVs=function(){var e=this._uvs,r=this._atlasRegionOffset,i=this._region,o=i.x,s=i.y,c=i.width,u=i.height,_=1-o-c,h=1-s-u,d=this._atlasRegion,f=d.x,p=d.y,v=d.width,m=d.height,g=r.x,y=r.y,x=r.z,b=r.w,S=v/(1-g-x),P=m/(1-y-b),T=Math.max(o-g,0)*S+f,E=Math.max(h-y,0)*P+p,M=v+f-Math.max(_-x,0)*S,V=m+p-Math.max(s-b,0)*P,A=this._border,C=A.x,R=A.y,z=A.z,F=A.w;e[0].set(T,V),e[1].set((o-g+C*c)*S+f,m+p-(s-b+R*u)*P),e[2].set(v+f-(_-x+z*c)*S,(h-y+F*u)*P+p),e[3].set(M,E),this._dirtyUpdateFlag&=~Zt.uvs},a._dispatchSpriteChange=function(e){switch(e){case Se.atlasRegionOffset:case Se.region:this._dirtyUpdateFlag|=Zt.all;break;case Se.atlasRegion:case Se.border:this._dirtyUpdateFlag|=Zt.uvs;break}this._updateFlagManager.dispatch(e)},j(l,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture!==e&&(this._texture=e,this._dispatchSpriteChange(Se.texture))}},{key:"width",get:function(){return this._width===void 0&&this._calDefaultSize(),this._width},set:function(e){this._width!==e&&(this._width=e,this._dispatchSpriteChange(Se.size))}},{key:"height",get:function(){return this._height===void 0&&this._calDefaultSize(),this._height},set:function(e){this._height!==e&&(this._height=e,this._dispatchSpriteChange(Se.size))}},{key:"atlasRotated",get:function(){return this._atlasRotated},set:function(e){this._atlasRotated!=e&&(this._atlasRotated=e)}},{key:"atlasRegion",get:function(){return this._atlasRegion},set:function(e){var r=G.clamp(e.x,0,1),i=G.clamp(e.y,0,1);this._atlasRegion.set(r,i,G.clamp(e.width,0,1-r),G.clamp(e.height,0,1-i)),this._dispatchSpriteChange(Se.atlasRegion)}},{key:"atlasRegionOffset",get:function(){return this._atlasRegionOffset},set:function(e){var r=G.clamp(e.x,0,1),i=G.clamp(e.y,0,1);this._atlasRegionOffset.set(r,i,G.clamp(e.z,0,1-r),G.clamp(e.w,0,1-i)),this._dispatchSpriteChange(Se.atlasRegionOffset)}},{key:"region",get:function(){return this._region},set:function(e){var r=this._region,i=G.clamp(e.x,0,1),o=G.clamp(e.y,0,1);r.set(i,o,G.clamp(e.width,0,1-i),G.clamp(e.height,0,1-o)),this._dispatchSpriteChange(Se.region)}},{key:"pivot",get:function(){return this._pivot},set:function(e){var r=this._pivot;if(r===e)this._dispatchSpriteChange(Se.pivot);else{var i=e.x,o=e.y;(r.x!==i||r.y!==o)&&(r.set(i,o),this._dispatchSpriteChange(Se.pivot))}}},{key:"border",get:function(){return this._border},set:function(e){var r=this._border,i=G.clamp(e.x,0,1),o=G.clamp(e.y,0,1);r.set(i,o,G.clamp(e.z,0,1-i),G.clamp(e.w,0,1-o)),this._dispatchSpriteChange(Se.border)}}]),l}(wr),Zt;(function(n){n[n.positions=1]="positions",n[n.uvs=2]="uvs",n[n.all=3]="all"})(Zt||(Zt={}));var Bs,Vs,ji,od=(Bs=Yt(),Bs(Vs=(ji=function(){function n(){}return n.resetData=function(a){var t=a._renderData,e=t.positions,r=t.uvs;if(e.length<16)for(var i=e.length;i<16;i++)e.push(new w),r.push(new X);t.triangles=[]},n.updatePositions=function(a){var t=a.width,e=a.height,r=a.sprite,i=a._renderData,o=i.positions,s=i.uvs,c=i.triangles,u=r.border,_=r._getUVs(),h=r._getPositions(),d=h[0],f=d.x,p=d.y,v=h[3],m=v.x,g=v.y,y=r.width,x=r.height,b=y*u.x,S=x*u.y,P=x*u.z,T=y*u.w,E,M;if(b+P>t){var V=t/(b+P);E=[y*f*V,b*V,b*V,t-y*(1-m)*V]}else E=[y*f,b,t-P,t-y*(1-m)];if(T+S>e){var A=e/(T+S);M=[x*p*A,S*A,S*A,e-x*(1-g)*A]}else M=[x*p,S,e-T,e-x*(1-g)];var C=a.sprite.pivot,R=C.x,z=C.y,F=a.width*R,D=a.height*z,I=n._worldMatrix,B=I.elements,k=a.entity.transform.worldMatrix.elements,Y=a.flipX?-1:1,K=a.flipY?-1:1;B[0]=k[0]*Y,B[1]=k[1]*Y,B[2]=k[2]*Y,B[4]=k[4]*K,B[5]=k[5]*K,B[6]=k[6]*K,B[8]=k[8],B[9]=k[9],B[10]=k[10],B[12]=k[12]-F*B[0]-D*B[4],B[13]=k[13]-F*B[1]-D*B[5],B[14]=k[14]-F*B[2]-D*B[6];for(var Q=0,ee=0,de=0;de<4;de++){for(var pe=E[de],me=_[de].x,Re=0;Re<4;Re++){var zt=M[Re];o[Q].set(B[0]*pe+B[4]*zt+B[12],B[1]*pe+B[5]*zt+B[13],B[2]*pe+B[6]*zt+B[14]),s[Q].set(me,_[Re].y),++Q}++ee}for(var Le=Q/ee,ke=0,Je=0;Je<ee-1;++Je)for(var st=0;st<Le-1;++st){var Ae=Je*Le+st;c[ke++]=Ae,c[ke++]=Ae+1,c[ke++]=Ae+Le,c[ke++]=Ae+1,c[ke++]=Ae+Le+1,c[ke++]=Ae+Le}a._renderData.vertexCount=ee*Le,c.length=(ee-1)*(Le-1)*6;var mt=a._bounds,yt=mt.min,Ze=mt.max;yt.set(E[0],M[0],0),Ze.set(E[3],M[3],0),a._bounds.transform(I)},n.updateUVs=function(a){},n}(),ji._worldMatrix=new te,ji))||Vs),Ke,Ds,Ls,Is,Os,Ns,Us,ks,Gs,Hs,Ws,Xs,$i,bu=(Ke=($i=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,U(e,"_renderData",Ds,L(e)),U(e,"_drawMode",Ls,L(e)),U(e,"_assembler",Is,L(e)),U(e,"_color",Os,L(e)),U(e,"_sprite",Ns,L(e)),U(e,"_width",Us,L(e)),U(e,"_height",ks,L(e)),U(e,"_flipX",Gs,L(e)),U(e,"_flipY",Hs,L(e)),U(e,"_maskLayer",Ws,L(e)),U(e,"_maskInteraction",Xs,L(e)),e._renderData=new va(4,[],[],null,e._color),e.drawMode=Pr.Simple,e.setMaterial(e._engine._spriteDefaultMaterial),e._onSpriteChange=e._onSpriteChange.bind(L(e)),e}var a=l.prototype;return a._render=function(e){var r;if(!(!((r=this.sprite)!==null&&r!==void 0&&r.texture)||!this.width||!this.height)){this._dirtyUpdateFlag&Ve.WorldVolume&&(this._assembler.updatePositions(this),this._dirtyUpdateFlag&=~Ve.WorldVolume),this._dirtyUpdateFlag&cr.UV&&(this._assembler.updateUVs(this),this._dirtyUpdateFlag&=~cr.UV);for(var i=this.getMaterial(),o=i.shader.passes,s=i.renderStates,c=this.sprite.texture,u=0,_=o.length;u<_;u++){var h=this._engine._spriteElementPool.getFromPool();h.setValue(this,this._renderData,i,c,s[u],o[u]),e.camera._renderPipeline.pushPrimitive(h)}}},a._cloneTo=function(e){e.sprite=this._sprite},a._onDestroy=function(){var e;(e=this._sprite)===null||e===void 0||e._updateFlagManager.removeListener(this._onSpriteChange),this._color=null,this._sprite=null,this._assembler=null,this._renderData=null,n.prototype._onDestroy.call(this)},a._updateBounds=function(e){var r;!((r=this.sprite)!==null&&r!==void 0&&r.texture)||!this.width||!this.height?(e.min.set(0,0,0),e.max.set(0,0,0)):this._assembler.updatePositions(this)},a._updateStencilState=function(){var e=this.getInstanceMaterial(),r=e.renderState.stencilState,i=this._maskInteraction;if(i===Ot.None)r.enabled=!1,r.writeMask=255,r.referenceValue=0,r.compareFunctionFront=r.compareFunctionBack=be.Always;else{r.enabled=!0,r.writeMask=0,r.referenceValue=1;var o=i===Ot.VisibleInsideMask?be.LessEqual:be.Greater;r.compareFunctionFront=o,r.compareFunctionBack=o}},a._onSpriteChange=function(e){switch(e){case Se.texture:this.shaderData.setTexture(l._textureProperty,this.sprite.texture);break;case Se.size:this._drawMode===Pr.Sliced&&(this._dirtyUpdateFlag|=Ve.WorldVolume);break;case Se.border:this._drawMode===Pr.Sliced&&(this._dirtyUpdateFlag|=cr.All);break;case Se.region:case Se.atlasRegionOffset:this._dirtyUpdateFlag|=cr.All;break;case Se.atlasRegion:this._dirtyUpdateFlag|=cr.UV;break;case Se.pivot:this._dirtyUpdateFlag|=Ve.WorldVolume;break}},j(l,[{key:"drawMode",get:function(){return this._drawMode},set:function(e){if(this._drawMode!==e){switch(this._drawMode=e,e){case Pr.Simple:this._assembler=Bn;break;case Pr.Sliced:this._assembler=od;break}this._assembler.resetData(this),this._dirtyUpdateFlag|=cr.All}}},{key:"sprite",get:function(){return this._sprite},set:function(e){var r=this._sprite;r!==e&&(r&&r._updateFlagManager.removeListener(this._onSpriteChange),e?(e._updateFlagManager.addListener(this._onSpriteChange),this._dirtyUpdateFlag|=cr.All,this.shaderData.setTexture(l._textureProperty,e.texture)):this.shaderData.setTexture(l._textureProperty,null),this._sprite=e)}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"width",get:function(){return this._width===void 0&&this._sprite&&(this.width=this._sprite.width),this._width},set:function(e){this._width!==e&&(this._width=e,this._dirtyUpdateFlag|=Ve.WorldVolume)}},{key:"height",get:function(){return this._height===void 0&&this._sprite&&(this.height=this._sprite.height),this._height},set:function(e){this._height!==e&&(this._height=e,this._dirtyUpdateFlag|=Ve.WorldVolume)}},{key:"flipX",get:function(){return this._flipX},set:function(e){this._flipX!==e&&(this._flipX=e,this._dirtyUpdateFlag|=Ve.WorldVolume)}},{key:"flipY",get:function(){return this._flipY},set:function(e){this._flipY!==e&&(this._flipY=e,this._dirtyUpdateFlag|=Ve.WorldVolume)}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._updateStencilState())}}]),l}(Jn),$i._textureProperty=O.getPropertyByName("u_spriteTexture"),$i),Ds=N(Ke.prototype,"_renderData",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Ls=N(Ke.prototype,"_drawMode",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Is=N(Ke.prototype,"_assembler",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Os=N(Ke.prototype,"_color",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new re(1,1,1,1)}}),Ns=N(Ke.prototype,"_sprite",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Us=N(Ke.prototype,"_width",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),ks=N(Ke.prototype,"_height",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),Gs=N(Ke.prototype,"_flipX",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hs=N(Ke.prototype,"_flipY",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Ws=N(Ke.prototype,"_maskLayer",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yn.Layer0}}),Xs=N(Ke.prototype,"_maskInteraction",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ot.None}}),N(Ke.prototype,"_onSpriteChange",[q],Object.getOwnPropertyDescriptor(Ke.prototype,"_onSpriteChange"),Ke.prototype),Ke),cr;(function(n){n[n.UV=2]="UV",n[n.All=3]="All"})(cr||(cr={}));var Cu=function n(){this.texture=void 0,this.localPositions=new ve,this.renderData=void 0;var l=[new w,new w,new w,new w];this.renderData=new va(4,l,null,n.triangles,null)};Cu.triangles=[0,2,1,2,0,3];var sd=function(){function n(a,t){this._elements=[],this._type=void 0,this._type=a;for(var e=this._elements,r=0;r<t;++r)e[r]=new a}var l=n.prototype;return l.get=function(){return this._elements.length>0?this._elements.pop():new this._type},l.put=function(t){this._elements.push(t)},n}(),yr=function(){function n(){}return n.textContext=function(){var a=n._textContext;if(!a){var t;try{t=new OffscreenCanvas(0,0)}catch{t=document.createElement("canvas")}var e=t.getContext("2d");a={canvas:t,context:e},n._textContext=a}return a},n.measureFont=function(a){var t=n._fontSizeInfoCache,e=t[a];return e||(e=n._measureFontOrChar(a),t[a]=e,e)},n.getNativeFontString=function(a,t,e){var r=e&Rr.Bold?"bold ":"";return e&Rr.Italic&&(r+="italic "),!/([\"\'])[^\'\"]+\1/.test(a)&&n._genericFontFamilies.indexOf(a)==-1&&(a='"'+a+'"'),r+=t+"px "+a,r},n.measureChar=function(a,t){return n._measureFontOrChar(t,a)},n.measureTextWithWrap=function(a){for(var t=a.fontSize,e=a.fontStyle,r=a._subFont,i=a.font.name,o=n.getNativeFontString(i,t,e),s=n.measureFont(o),c=a.text.split(/(?:\r\n|\r|\n)/),u=new Array,_=new Array,h=new Array,d=mr._pixelsPerUnit,f=s.size+a.lineSpacing*d,p=a.width*d,v=0,m=0,g=c.length;m<g;++m){for(var y=c[m],x="",b=0,S=-1,P=-1,T=0,E=y.length;T<E;++T){var M=y[T],V=n._getCharInfo(M,o,r),A=V.w,C=V.offsetY,R=V.h*.5,z=R+C,F=R-C;b+A>p?b===0?(u.push(M),_.push(A),h.push({ascent:z,descent:F,size:z+F})):(u.push(x),_.push(b),h.push({ascent:S,descent:P,size:S+P}),x=M,b=V.xAdvance,S=z,P=F):(x+=M,b+=V.xAdvance,S<z&&(S=z),P<F&&(P=F))}b>0&&(u.push(x),_.push(b),h.push({ascent:S,descent:P,size:S+P}))}var D=a.height*d;return a.overflowMode===nn.Overflow&&(D=f*u.length),{width:v,height:D,lines:u,lineWidths:_,lineHeight:f,lineMaxSizes:h}},n.measureTextWithoutWrap=function(a){var t=a.fontSize,e=a.fontStyle,r=a._subFont,i=a.font.name,o=n.getNativeFontString(i,t,e),s=n.measureFont(o),c=a.text.split(/(?:\r\n|\r|\n)/),u=c.length,_=new Array,h=new Array,d=mr._pixelsPerUnit,f=s.size+a.lineSpacing*d,p=0,v=a.height*d;a.overflowMode===nn.Overflow&&(v=f*u);for(var m=0;m<u;++m){for(var g=c[m],y=0,x=-1,b=-1,S=0,P=g.length;S<P;++S){var T=n._getCharInfo(g[S],o,r);y+=T.xAdvance;var E=T.offsetY,M=T.h*.5,V=M+E,A=M-E;x<V&&(x=V),b<A&&(b=A)}_[m]=y,h[m]={ascent:x,descent:b,size:x+b},y>p&&(p=y)}return{width:p,height:v,lines:c,lineWidths:_,lineHeight:f,lineMaxSizes:h}},n.getNativeFontHash=function(a,t,e){var r=e&Rr.Bold?"bold":"";return e&Rr.Italic&&(r+="italic"),!/([\"\'])[^\'\"]+\1/.test(a)&&n._genericFontFamilies.indexOf(a)==-1&&(a=""+a),r+=t+"px"+a,r},n._measureFontOrChar=function(a,t){t===void 0&&(t="");var e=n.textContext(),r=e.canvas,i=e.context;i.font=a;var o=t||n._measureString,s=Math.round(i.measureText(o).width),c=Math.ceil(i.measureText(n._measureBaseline).width),u=c*n._heightMultiplier;c=n._baselineMultiplier*c|0,r.width=s,r.height=u,i.font=a,i.fillStyle="#000",i.clearRect(0,0,s,u),i.textBaseline="middle",i.fillStyle="#fff",i.fillText(o,0,c);for(var _=i.getImageData(0,0,s,u).data,h=_.length,d=-1,f=-1,p,v=0,m=0,g=0,y=r.width,x=1/y,b=0;b<h;b+=4)if(_[b+3]!==0){var S=b*.25;p=~~(S*x),d===-1&&(d=p),p>f&&(f=p)}d!==-1&&f!==-1&&(v=c-d,m=f-c+1,g=v+m);var P={ascent:v,descent:m,size:g};if(t){var T=null;if(g>0){var E=y*4;T=new Uint8Array(_.buffer,d*E,g*E)}return{x:0,y:0,w:s,h:g,offsetX:0,offsetY:(v-m)*.5,xAdvance:s,uvs:[new X,new X,new X,new X],ascent:v,descent:m,index:0,data:T}}else return P},n._getCharInfo=function(a,t,e){var r=e._getCharInfo(a);return r||(r=n.measureChar(a,t),e._uploadCharTexture(r),e._addCharInfo(a,r)),r},n}();yr._genericFontFamilies=["serif","sans-serif","monospace","cursive","fantasy","system-ui","math","emoji","fangsong"];yr._measureString="|\xC9q\xC5";yr._measureBaseline="M";yr._heightMultiplier=2;yr._baselineMultiplier=1.4;yr._fontSizeInfoCache={};yr._textContext=null;var Oe,qs,js,$s,Ys,Qs,Js,Zs,Ks,el,tl,rl,nl,il,al,ol,sl,ll,cl,En,Su=(Oe=(En=function(n){$(l,n);function l(t){var e;e=n.call(this,t)||this,U(e,"_subFont",qs,L(e)),U(e,"_charRenderDatas",js,L(e)),U(e,"_dirtyFlag",$s,L(e)),U(e,"_color",Ys,L(e)),U(e,"_text",Qs,L(e)),U(e,"_width",Js,L(e)),U(e,"_height",Zs,L(e)),U(e,"_localBounds",Ks,L(e)),U(e,"_font",el,L(e)),U(e,"_fontSize",tl,L(e)),U(e,"_fontStyle",rl,L(e)),U(e,"_lineSpacing",nl,L(e)),U(e,"_horizontalAlignment",il,L(e)),U(e,"_verticalAlignment",al,L(e)),U(e,"_enableWrapping",ol,L(e)),U(e,"_overflowMode",sl,L(e)),U(e,"_maskInteraction",ll,L(e)),U(e,"_maskLayer",cl,L(e));var r=L(e),i=r.engine;return e._font=i._textDefaultFont,e._font._addRefCount(1),e.setMaterial(i._spriteDefaultMaterial),e}var a=l.prototype;return a._render=function(e){if(!(this._text===""||this.enableWrapping&&this.width<=0||this.overflowMode===nn.Truncate&&this.height<=0)){this._isContainDirtyFlag(we.MaskInteraction)&&(this._updateStencilState(),this._setDirtyFlagFalse(we.MaskInteraction)),this._isContainDirtyFlag(we.SubFont)&&(this._resetSubFont(),this._setDirtyFlagFalse(we.SubFont)),this._isContainDirtyFlag(we.LocalPositionBounds)&&(this._updateLocalData(),this._setDirtyFlagFalse(we.LocalPositionBounds)),this._isContainDirtyFlag(we.WorldPosition)&&(this._updatePosition(),this._setDirtyFlagFalse(we.WorldPosition));var r=this._engine._spriteElementPool,i=this._engine._textElementPool.getFromPool(),o=i.charElements,s=this.getMaterial(),c=this._charRenderDatas,u=c.length,_=s.shader.passes,h=s.renderStates;i.component=this,i.material=s,o.length=u,i.renderState=h[0];for(var d=0;d<u;++d){var f=c[d],p=r.getFromPool();p.setValue(this,f.renderData,s,f.texture,h[0],_[0]),o[d]=p}e.camera._renderPipeline.pushPrimitive(i)}},a._onDestroy=function(){for(var e=this._charRenderDatas,r=0,i=e.length;r<i;++r)l._charRenderDataPool.put(e[r]);e.length=0,this._font&&(this._font._addRefCount(-1),this._font=null),this._subFont&&(this._subFont=null),n.prototype._onDestroy.call(this)},a._cloneTo=function(e){e.font=this._font,e._subFont=this._subFont},a._isContainDirtyFlag=function(e){return(this._dirtyFlag&e)!=0},a._setDirtyFlagTrue=function(e){this._dirtyFlag|=e},a._setDirtyFlagFalse=function(e){this._dirtyFlag&=~e},a._updateBounds=function(e){Tt.transform(this._localBounds,this._entity.transform.worldMatrix,e)},a._updateStencilState=function(){var e=this.getInstanceMaterial(),r=e.renderState.stencilState,i=this._maskInteraction;if(i===Ot.None)r.enabled=!1,r.writeMask=255,r.referenceValue=0,r.compareFunctionFront=r.compareFunctionBack=be.Always;else{r.enabled=!0,r.writeMask=0,r.referenceValue=1;var o=i===Ot.VisibleInsideMask?be.LessEqual:be.Greater;r.compareFunctionFront=o,r.compareFunctionBack=o}},a._resetSubFont=function(){this._subFont=this._font._getSubFont(this.fontSize,this.fontStyle)},a._updatePosition=function(){for(var e=this.entity.transform,r=e.worldMatrix.elements,i=this._charRenderDatas,o=r[0],s=r[1],c=r[2],u=r[4],_=r[5],h=r[6],d=r[12],f=r[13],p=r[14],v=l._tempVec31.set(u,_,h),m=l._tempVec30.set(o,s,c),g=0,y=i.length;g<y;++g){var x=i[g],b=x.localPositions,S=x.renderData.positions,P=b.x,T=b.y,E=S[0];E.x=P*o+T*u+d,E.y=P*s+T*_+f,E.z=P*c+T*h+p;var M=S[1];w.scale(m,b.z-P,M),w.add(E,M,M);var V=S[2];w.scale(v,b.w-T,V),w.add(E,V,S[3]),w.add(M,V,V)}},a._updateLocalData=function(){var e=this.color,r=this.horizontalAlignment,i=this.verticalAlignment,o=this._charRenderDatas,s=this._localBounds,c=s.min,u=s.max;c.set(0,0,0),u.set(0,0,0);var _=mr._pixelsPerUnit,h=1/_,d=this._subFont,f=this.width*_,p=f*.5,v=this.height*_,m=this.enableWrapping?yr.measureTextWithWrap(this):yr.measureTextWithoutWrap(this),g=m.height,y=m.lines,x=m.lineWidths,b=m.lineHeight,S=m.lineMaxSizes,P=l._charRenderDataPool,T=b*.5,E=y.length,M=0,V=b*.5-S[0].ascent,A=b*.5-S[E-1].descent-1;switch(i){case Zr.Top:M=v*.5-T+V;break;case Zr.Center:M=g*.5-T-(A-V)*.5;break;case Zr.Bottom:M=g-v*.5-T-A;break}for(var C=0,R=Number.MAX_SAFE_INTEGER,z=Number.MAX_SAFE_INTEGER,F=Number.MIN_SAFE_INTEGER,D=Number.MIN_SAFE_INTEGER,I=E-1,B=0;B<E;++B){var k=y[B],Y=x[B],K=0;switch(r){case Jr.Left:K=-p;break;case Jr.Center:K=-Y*.5;break;case Jr.Right:K=p-Y;break}for(var Q=0,ee=k.length-1;Q<=ee;++Q){var de=k[Q],pe=d._getCharInfo(de);if(pe.h>0){var me=o[C]||P.get(),Re=me.renderData,zt=me.localPositions;me.texture=d._getTextureByIndex(pe.index),Re.color=e,Re.uvs=pe.uvs;var Le=pe.w,ke=pe.ascent,Je=pe.descent,st=K*h,Ae=(K+Le)*h,mt=(M+ke)*h,yt=(M-Je+1)*h;zt.set(st,mt,Ae,yt),o[C]=me,C++,B===0&&(D=Math.max(D,mt)),B===I&&(z=Math.min(z,yt)),Q===0&&(R=Math.min(R,st)),Q===ee&&(F=Math.max(F,Ae))}K+=pe.xAdvance}M-=b}c.set(R,z,0),u.set(F,D,0);var Ze=o.length;if(Ze>C){for(var xt=C;xt<Ze;++xt)P.put(o[xt]);o.length=C}d._getLastIndex()>0&&o.sort(function(Jt,lt){return Jt.texture.instanceId-lt.texture.instanceId})},a._onTransformChanged=function(e){n.prototype._onTransformChanged.call(this,e),this._setDirtyFlagTrue(we.WorldPosition|we.WorldBounds)},j(l,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.copyFrom(e)}},{key:"text",get:function(){return this._text},set:function(e){e=e||"",this._text!==e&&(this._text=e,this._setDirtyFlagTrue(we.Position))}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._setDirtyFlagTrue(we.Position))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=e,this._setDirtyFlagTrue(we.Position))}},{key:"font",get:function(){return this._font},set:function(e){var r=this._font;r!==e&&(r&&r._addRefCount(-1),e&&e._addRefCount(1),this._font=e,this._setDirtyFlagTrue(we.Font))}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._setDirtyFlagTrue(we.Font))}},{key:"fontStyle",get:function(){return this._fontStyle},set:function(e){this.fontStyle!==e&&(this._fontStyle=e,this._setDirtyFlagTrue(we.Font))}},{key:"lineSpacing",get:function(){return this._lineSpacing},set:function(e){this._lineSpacing!==e&&(this._lineSpacing=e,this._setDirtyFlagTrue(we.Position))}},{key:"horizontalAlignment",get:function(){return this._horizontalAlignment},set:function(e){this._horizontalAlignment!==e&&(this._horizontalAlignment=e,this._setDirtyFlagTrue(we.Position))}},{key:"verticalAlignment",get:function(){return this._verticalAlignment},set:function(e){this._verticalAlignment!==e&&(this._verticalAlignment=e,this._setDirtyFlagTrue(we.Position))}},{key:"enableWrapping",get:function(){return this._enableWrapping},set:function(e){this._enableWrapping!==e&&(this._enableWrapping=e,this._setDirtyFlagTrue(we.Position))}},{key:"overflowMode",get:function(){return this._overflowMode},set:function(e){this._overflowMode!==e&&(this._overflowMode=e,this._setDirtyFlagTrue(we.Position))}},{key:"maskInteraction",get:function(){return this._maskInteraction},set:function(e){this._maskInteraction!==e&&(this._maskInteraction=e,this._setDirtyFlagTrue(we.MaskInteraction))}},{key:"maskLayer",get:function(){return this._maskLayer},set:function(e){this._maskLayer=e}},{key:"bounds",get:function(){return this._isContainDirtyFlag(we.SubFont)&&this._resetSubFont(),this._isContainDirtyFlag(we.LocalPositionBounds)&&this._updateLocalData(),this._isContainDirtyFlag(we.WorldPosition)&&this._updatePosition(),this._isContainDirtyFlag(we.WorldBounds)&&this._updateBounds(this._bounds),this._setDirtyFlagFalse(we.Font),this._bounds}}]),l}(Jn),En._charRenderDataPool=new sd(Cu,50),En._tempVec30=new w,En._tempVec31=new w,En),qs=N(Oe.prototype,"_subFont",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),js=N(Oe.prototype,"_charRenderDatas",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$s=N(Oe.prototype,"_dirtyFlag",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return we.Font}}),Ys=N(Oe.prototype,"_color",[ze],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new re(1,1,1,1)}}),Qs=N(Oe.prototype,"_text",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Js=N(Oe.prototype,"_width",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Zs=N(Oe.prototype,"_height",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ks=N(Oe.prototype,"_localBounds",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Tt}}),el=N(Oe.prototype,"_font",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),tl=N(Oe.prototype,"_fontSize",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 24}}),rl=N(Oe.prototype,"_fontStyle",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Rr.None}}),nl=N(Oe.prototype,"_lineSpacing",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),il=N(Oe.prototype,"_horizontalAlignment",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jr.Center}}),al=N(Oe.prototype,"_verticalAlignment",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Zr.Center}}),ol=N(Oe.prototype,"_enableWrapping",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sl=N(Oe.prototype,"_overflowMode",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nn.Overflow}}),ll=N(Oe.prototype,"_maskInteraction",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ot.None}}),cl=N(Oe.prototype,"_maskLayer",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return yn.Layer0}}),Oe),we;(function(n){n[n.SubFont=1]="SubFont",n[n.LocalPositionBounds=2]="LocalPositionBounds",n[n.WorldPosition=4]="WorldPosition",n[n.WorldBounds=8]="WorldBounds",n[n.MaskInteraction=16]="MaskInteraction",n[n.Position=14]="Position",n[n.Font=15]="Font"})(we||(we={}));var ld=function(){function n(){this._mounted=void 0,this._propertyName=void 0}var l=n.prototype;return l.initialize=function(t){for(var e=t.component,r=t.property.split("."),i=r.length-1,o=0;o<i;o++)e=e[r[o]];this._mounted=e,this._propertyName=r[i]},l.getTargetValue=function(){return this._mounted[this._propertyName]},l.setTargetValue=function(t){this._mounted[this._propertyName]=t},n}(),Zn=function(){n.registerAssembler=function(t,e,r){var i=n._assemblerMap.get(t);i||(i={},n._assemblerMap.set(t,i)),i[e]=r},n.getAssemblerType=function(t,e){var r=n._assemblerMap.get(t),i=r?r[e]:void 0;return i!=null?i:ld};function n(a,t,e,r){this.target=void 0,this.type=void 0,this.property=void 0,this.component=void 0,this.crossCurveMark=0,this.crossCurveDataIndex=void 0,this.defaultValue=void 0,this.fixedPoseValue=void 0,this.baseTempValue=void 0,this.crossTempValue=void 0,this.hasSavedDefaultValue=!1,this.referenceTargetValue=void 0,this._assembler=void 0,this._cureType=void 0,this.target=a,this.type=t,this.property=e,this.component=a.getComponent(t),this._cureType=r;var i=n.getAssemblerType(t,e);this._assembler=new i,this._assembler.initialize(this),r._isReferenceType&&(this.referenceTargetValue=this._assembler.getTargetValue())}var l=n.prototype;return l.evaluateAndApplyValue=function(t,e,r,i){if(t.keys.length)if(i){var o=t._evaluateAdditive(e,this.baseTempValue),s=this._cureType;if(s._isReferenceType)s._additiveValue(o,r,this.referenceTargetValue);else{var c=this._assembler,u=c.getTargetValue(),_=s._additiveValue(o,r,u);c.setTargetValue(_)}}else{var h=t._evaluate(e,this.baseTempValue);this._applyValue(h,r)}},l.crossFadeAndApplyValue=function(t,e,r,i,o,s,c){var u=t&&t.keys.length?c?t._evaluateAdditive(r,this.baseTempValue):t._evaluate(r,this.baseTempValue):c?this._cureType._getZeroValue(this.baseTempValue):this.defaultValue,_=e&&e.keys.length?c?e._evaluateAdditive(i,this.crossTempValue):e._evaluate(i,this.crossTempValue):c?this._cureType._getZeroValue(this.crossTempValue):this.defaultValue;this._applyCrossValue(u,_,o,s,c)},l.crossFadeFromPoseAndApplyValue=function(t,e,r,i,o){var s=o?this._cureType._subtractValue(this.fixedPoseValue,this.defaultValue,this.baseTempValue):this.fixedPoseValue,c=t&&t.keys.length?o?t._evaluateAdditive(e,this.crossTempValue):t._evaluate(e,this.crossTempValue):o?this._cureType._getZeroValue(this.crossTempValue):this.defaultValue;this._applyCrossValue(s,c,r,i,o)},l.revertDefaultValue=function(){this._assembler.setTargetValue(this.defaultValue)},l.saveDefaultValue=function(){this._cureType._isReferenceType?this._cureType._copyValue(this.referenceTargetValue,this.defaultValue):this.defaultValue=this._assembler.getTargetValue(),this.hasSavedDefaultValue=!0},l.saveFixedPoseValue=function(){this._cureType._isReferenceType?this._cureType._copyValue(this.referenceTargetValue,this.fixedPoseValue):this.fixedPoseValue=this._assembler.getTargetValue()},l._applyValue=function(t,e){if(e===1)this._cureType._isReferenceType?this._cureType._copyValue(t,this.referenceTargetValue):this._assembler.setTargetValue(t);else if(this._cureType._isReferenceType){var r=this.referenceTargetValue;this._cureType._lerpValue(r,t,e,r)}else{var i=this._assembler.getTargetValue(),o=this._cureType._lerpValue(i,t,e);this._assembler.setTargetValue(o)}},l._applyCrossValue=function(t,e,r,i,o){var s;if(this._cureType._isReferenceType?(s=this.baseTempValue,this._cureType._lerpValue(t,e,r,s)):s=this._cureType._lerpValue(t,e,r),o)if(this._cureType._isReferenceType)this._cureType._additiveValue(s,i,this.referenceTargetValue);else{var c=this._assembler.getTargetValue(),u=this._cureType._additiveValue(s,i,c);this._assembler.setTargetValue(u)}else this._applyValue(s,i)},n}();Zn._assemblerMap=new Map;var cd=function(){function n(){this._transform=void 0}var l=n.prototype;return l.initialize=function(t){this._transform=t.target.transform},l.getTargetValue=function(){return this._transform.position},l.setTargetValue=function(t){this._transform.position=t},n}();Zn.registerAssembler(At,"position",cd);var ud=function(){function n(){this._transform=void 0}var l=n.prototype;return l.initialize=function(t){this._transform=t.target.transform},l.getTargetValue=function(){return this._transform.rotationQuaternion},l.setTargetValue=function(t){this._transform.rotationQuaternion=t},n}();Zn.registerAssembler(At,"rotationQuaternion",ud);var _d=function(){function n(){this._transform=void 0}var l=n.prototype;return l.initialize=function(t){this._transform=t.target.transform},l.getTargetValue=function(){return this._transform.scale},l.setTargetValue=function(t){this._transform.scale=t},n}();Zn.registerAssembler(At,"scale",_d);var Tu=function(){function n(){this.relativePath=void 0,this.type=void 0,this.property=void 0,this.curve=void 0,this._tempCurveOwner={}}var l=n.prototype;return l._createCurveOwner=function(t){var e=this.curve.constructor,r=new Zn(t,this.type,this.property,e);return e._initializeOwner(r),r},l._getTempCurveOwner=function(t){var e=t.instanceId;return this._tempCurveOwner[e]||(this._tempCurveOwner[e]=this._createCurveOwner(t)),this._tempCurveOwner[e]},n}(),Ta=function(){this.time=void 0,this.functionName=void 0,this.parameter=void 0},Aa=function(){function n(a){this.name=a,this._curveBindings=[],this._length=0,this._events=[]}var l=n.prototype;return l.addEvent=function(t,e,r){if(typeof t=="string"){var i=new Ta;i.functionName=t,i.time=e,i.parameter=r,this._events.push(i)}else this._events.push(t);this._events.sort(function(o,s){return o.time-s.time})},l.clearEvents=function(){this._events.length=0},l.addCurveBinding=function(t,e,r,i){var o=new Tu;o.relativePath=t,o.type=e,o.property=r,o.curve=i,i.length>this._length&&(this._length=i.length),this._curveBindings.push(o)},l.clearCurveBindings=function(){this._curveBindings.length=0,this._length=0},l._sampleAnimation=function(t,e){for(var r=this._curveBindings,i=r.length-1;i>=0;i--){var o=r[i],s=t.findByPath(o.relativePath);if(s){var c=o._getTempCurveOwner(s);c.evaluateAndApplyValue(o.curve,e,1,!1)}}},j(n,[{key:"events",get:function(){return this._events}},{key:"curveBindings",get:function(){return this._curveBindings}},{key:"length",get:function(){return this._length}}]),n}(),Ye;(function(n){n[n.Linear=0]="Linear",n[n.CubicSpine=1]="CubicSpine",n[n.Step=2]="Step",n[n.Hermite=3]="Hermite"})(Ye||(Ye={}));var ar=function(){function n(){this.keys=[],this._tempValue=void 0,this._length=0,this._currentIndex=0,this._interpolation=void 0,this._type=void 0;var a=this.constructor;this._interpolation=a._isInterpolationType?Ye.Linear:Ye.Step,this._type=a}var l=n.prototype;return l.addKey=function(t){var e=t.time;this.keys.push(t),e>this._length&&(this._length=e),this.keys.sort(function(r,i){return r.time-i.time})},l.evaluate=function(t){return this._evaluate(t,this._tempValue)},l.moveKey=function(t,e){this.keys[t]=e},l.removeKey=function(t){this.keys.splice(t,1);for(var e=this.keys,r=this.keys.length,i=0,o=r-1;o>=0;o--)e[o].time>length&&(i=e[o].time);this._length=i},l._evaluate=function(t,e){var r=this.keys,i=this.interpolation,o=this.keys.length,s=this._currentIndex;s!==-1&&t<r[s].time&&(s=-1);for(var c=s+1;c<o&&!(t<r[c].time);)s++,c++;this._currentIndex=s;var u;if(s===-1)u=this._type._copyValue(r[0].value,e);else if(c===o)u=this._type._copyValue(r[s].value,e);else{var _=r[s],h=r[c],d=_.time,f=h.time-d,p=(t-d)/f;switch(i){case Ye.Linear:u=this._type._lerpValue(_.value,h.value,p,e);break;case Ye.Step:u=this._type._copyValue(_.value,e);break;case Ye.CubicSpine:case Ye.Hermite:u=this._type._hermiteInterpolationValue(_,h,p,f,e);break}}return u},l._evaluateAdditive=function(t,e){var r=this._evaluate(t,e);return this._type._subtractValue(r,this.keys[0].value,e)},j(n,[{key:"interpolation",get:function(){return this._interpolation},set:function(t){!this._type._isInterpolationType&&t!==Ye.Step?(this._interpolation=Ye.Step,console.warn("The interpolation type must be `InterpolationType.Step`.")):this._interpolation=t}},{key:"length",get:function(){return this._length}}]),n}(),ul,_l,ai,Au=(ul=Yt(),ul(_l=(ai=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}return l._initializeOwner=function(t){t.defaultValue=[],t.fixedPoseValue=[],t.baseTempValue=[],t.crossTempValue=[]},l._lerpValue=function(t,e,r,i){for(var o=0,s=i.length;o<s;++o){var c=t[o];i[o]=c+(e[o]-c)*r}return i},l._subtractValue=function(t,e,r){for(var i=0,o=t.length;i<o;i++)r[i]=t[i]-e[i];return r},l._getZeroValue=function(t){for(var e=0,r=t.length;e<r;e++)t[e]=0;return t},l._additiveValue=function(t,e,r){for(var i=0,o=r.length;i<o;++i)r[i]+=t[i]*e;return r},l._copyValue=function(t,e){for(var r=0,i=e.length;r<i;++r)e[r]=t[r];return e},l._hermiteInterpolationValue=function(t,e,r,i,o){for(var s=t.outTangent,c=e.inTangent,u=t.value,_=e.value,h=r*r,d=h*r,f=2*d-3*h+1,p=d-2*h+r,v=d-h,m=-2*d+3*h,g=0,y=u.length;g<y;++g)Number.isFinite(s[g])&&Number.isFinite(c[g])?o[g]=f*u[g]+p*s[g]*i+v*c[g]*i+m*_[g]:o[g]=t.value[g];return o},l}(ar),ai._isReferenceType=!0,ai._isInterpolationType=!0,ai))||_l),hl,dl,oi,hd=(hl=Yt(),hl(dl=(oi=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}return l._initializeOwner=function(t){},l._lerpValue=function(t,e){return e},l._subtractValue=function(t,e,r){return t},l._getZeroValue=function(){return!1},l._additiveValue=function(t,e,r){return t},l._copyValue=function(t){return t},l._hermiteInterpolationValue=function(t){return t.value},l}(ar),oi._isReferenceType=!1,oi._isInterpolationType=!1,oi))||dl),fl,vl,si,Pu=(fl=Yt(),fl(vl=(si=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}return l._initializeOwner=function(t){t.defaultValue=new re,t.fixedPoseValue=new re,t.baseTempValue=new re,t.crossTempValue=new re},l._lerpValue=function(t,e,r,i){return re.lerp(t,e,r,i),i},l._subtractValue=function(t,e,r){return re.subtract(t,e,r),r},l._getZeroValue=function(t){return t.set(0,0,0,0),t},l._additiveValue=function(t,e,r){return re.scale(t,e,t),re.add(r,t,r),r},l._copyValue=function(t,e){return e.copyFrom(t),e},l._hermiteInterpolationValue=function(t,e,r,i,o){var s=t.value,c=t.outTangent,u=e.value,_=e.inTangent,h=r*r,d=h*r,f=2*d-3*h+1,p=d-2*h+r,v=d-h,m=-2*d+3*h,g=c.x,y=_.x;return Number.isFinite(g)&&Number.isFinite(y)?o.r=f*s.r+p*g*i+v*y*i+m*u.r:o.r=s.r,g=c.y,y=_.y,Number.isFinite(g)&&Number.isFinite(y)?o.g=f*s.g+p*g*i+v*y*i+m*u.g:o.g=s.g,g=c.z,y=_.z,Number.isFinite(g)&&Number.isFinite(y)?o.b=f*s.b+p*g*i+v*y*i+m*u.b:o.b=s.b,g=c.w,y=_.w,Number.isFinite(g)&&Number.isFinite(y)?o.a=f*s.a+p*g*i+v*y*i+m*u.a:o.a=s.a,o},l}(ar),si._isReferenceType=!0,si._isInterpolationType=!0,si))||vl),pl,gl,li,Pa=(pl=Yt(),pl(gl=(li=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}return l._initializeOwner=function(t){var e=t.referenceTargetValue.length;t.defaultValue=new Float32Array(e),t.fixedPoseValue=new Float32Array(e),t.baseTempValue=new Float32Array(e),t.crossTempValue=new Float32Array(e)},l._lerpValue=function(t,e,r,i){for(var o=0,s=i.length;o<s;++o){var c=t[o];i[o]=c+(e[o]-c)*r}return i},l._subtractValue=function(t,e,r){for(var i=0,o=t.length;i<o;i++)r[i]=t[i]-e[i];return r},l._getZeroValue=function(t){for(var e=0,r=t.length;e<r;e++)t[e]=0;return t},l._additiveValue=function(t,e,r){for(var i=0,o=r.length;i<o;++i)r[i]+=t[i]*e;return r},l._copyValue=function(t,e){for(var r=0,i=e.length;r<i;++r)e[r]=t[r];return e},l._hermiteInterpolationValue=function(t,e,r,i,o){for(var s=t.outTangent,c=e.inTangent,u=t.value,_=e.value,h=r*r,d=h*r,f=2*d-3*h+1,p=d-2*h+r,v=d-h,m=-2*d+3*h,g=0,y=u.length;g<y;++g)Number.isFinite(s[g])&&Number.isFinite(c[g])?o[g]=f*u[g]+p*s[g]*i+v*c[g]*i+m*_[g]:o[g]=t.value[g];return o},l}(ar),li._isReferenceType=!0,li._isInterpolationType=!0,li))||gl),ml,yl,ci,Mu=(ml=Yt(),ml(yl=(ci=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}return l._initializeOwner=function(t){t.defaultValue=0,t.fixedPoseValue=0,t.baseTempValue=0,t.crossTempValue=0},l._lerpValue=function(t,e,r){return t+(e-t)*r},l._additiveValue=function(t,e,r){return r+=t*e},l._subtractValue=function(t,e){return t-e},l._getZeroValue=function(){return 0},l._copyValue=function(t){return t},l._hermiteInterpolationValue=function(t,e,r,i){var o=t.outTangent,s=e.inTangent;if(Number.isFinite(o)&&Number.isFinite(s)){var c=r*r,u=c*r,_=2*u-3*c+1,h=u-2*c+r,d=u-c,f=-2*u+3*c;return _*t.value+h*o*i+d*s*i+f*e.value}else return t.value},l}(ar),ci._isReferenceType=!1,ci._isInterpolationType=!0,ci))||yl),xl,wl,Rn,Ma=(xl=Yt(),xl(wl=(Rn=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}return l._initializeOwner=function(t){t.defaultValue=new xe,t.fixedPoseValue=new xe,t.baseTempValue=new xe,t.crossTempValue=new xe},l._lerpValue=function(t,e,r,i){return xe.slerp(t,e,r,i),i},l._additiveValue=function(t,e,r){return t.x=t.x*e,t.y=t.y*e,t.z=t.z*e,t.normalize(),r.multiply(t),r},l._subtractValue=function(t,e,r){var i=l._tempConjugateQuat;return xe.conjugate(e,i),xe.multiply(i,t,r),r},l._getZeroValue=function(t){return t.set(0,0,0,1),t},l._copyValue=function(t,e){return e.copyFrom(t),e},l._hermiteInterpolationValue=function(t,e,r,i,o){var s=t.value,c=t.outTangent,u=e.value,_=e.inTangent,h=r*r,d=h*r,f=2*d-3*h+1,p=d-2*h+r,v=d-h,m=-2*d+3*h,g=c.x,y=_.x;return Number.isFinite(g)&&Number.isFinite(y)?o.x=f*s.x+p*g*i+v*y*i+m*u.x:o.x=s.x,g=c.y,y=_.y,Number.isFinite(g)&&Number.isFinite(y)?o.y=f*s.y+p*g*i+v*y*i+m*u.y:o.y=s.y,g=c.z,y=_.z,Number.isFinite(g)&&Number.isFinite(y)?o.z=f*s.z+p*g*i+v*y*i+m*u.z:o.z=s.z,g=c.w,y=_.w,Number.isFinite(g)&&Number.isFinite(y)?o.w=f*s.w+p*g*i+v*y*i+m*u.w:o.w=s.w,o},l}(ar),Rn._isInterpolationType=!0,Rn._isReferenceType=!0,Rn._tempConjugateQuat=new xe,Rn))||wl),bl,Cl,ui,Eu=(bl=Yt(),bl(Cl=(ui=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}return l._initializeOwner=function(t){t.defaultValue=new X,t.fixedPoseValue=new X,t.baseTempValue=new X,t.crossTempValue=new X},l._lerpValue=function(t,e,r,i){return X.lerp(t,e,r,i),i},l._additiveValue=function(t,e,r){return X.scale(t,e,t),X.add(r,t,r),r},l._subtractValue=function(t,e,r){return X.subtract(t,e,r),r},l._getZeroValue=function(t){return t.set(0,0),t},l._copyValue=function(t,e){return e.copyFrom(t),e},l._hermiteInterpolationValue=function(t,e,r,i,o){var s=t.value,c=t.outTangent,u=e.value,_=e.inTangent,h=r*r,d=h*r,f=2*d-3*h+1,p=d-2*h+r,v=d-h,m=-2*d+3*h,g=c.x,y=_.x;return Number.isFinite(g)&&Number.isFinite(y)?o.x=f*s.x+p*g*i+v*y*i+m*u.x:o.x=s.x,g=c.y,y=_.y,Number.isFinite(g)&&Number.isFinite(y)?o.y=f*s.y+p*g*i+v*y*i+m*u.y:o.y=s.y,o},l}(ar),ui._isReferenceType=!0,ui._isInterpolationType=!0,ui))||Cl),Sl,Tl,_i,Ea=(Sl=Yt(),Sl(Tl=(_i=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}return l._initializeOwner=function(t){t.defaultValue=new w,t.fixedPoseValue=new w,t.baseTempValue=new w,t.crossTempValue=new w},l._lerpValue=function(t,e,r,i){return w.lerp(t,e,r,i),i},l._relativeBaseValue=function(t,e){return w.subtract(e,t,e),e},l._additiveValue=function(t,e,r){return w.scale(t,e,t),w.add(r,t,r),r},l._subtractValue=function(t,e,r){return w.subtract(t,e,r),r},l._getZeroValue=function(t){return t.set(0,0,0),t},l._copyValue=function(t,e){return e.copyFrom(t),e},l._hermiteInterpolationValue=function(t,e,r,i,o){var s=t.value,c=t.outTangent,u=e.value,_=e.inTangent,h=r*r,d=h*r,f=2*d-3*h+1,p=d-2*h+r,v=d-h,m=-2*d+3*h,g=c.x,y=_.x;return Number.isFinite(g)&&Number.isFinite(y)?o.x=f*s.x+p*g*i+v*y*i+m*u.x:o.x=s.x,g=c.y,y=_.y,Number.isFinite(g)&&Number.isFinite(y)?o.y=f*s.y+p*g*i+v*y*i+m*u.y:o.y=s.y,g=c.z,y=_.z,Number.isFinite(g)&&Number.isFinite(y)?o.z=f*s.z+p*g*i+v*y*i+m*u.z:o.z=s.z,o},l}(ar),_i._isReferenceType=!0,_i._isInterpolationType=!0,_i))||Tl),Al,Pl,hi,Ru=(Al=Yt(),Al(Pl=(hi=function(n){$(l,n);function l(){return n.apply(this,arguments)||this}return l._initializeOwner=function(t){t.defaultValue=new ve,t.fixedPoseValue=new ve,t.baseTempValue=new ve,t.crossTempValue=new ve},l._lerpValue=function(t,e,r,i){return ve.lerp(t,e,r,i),i},l._additiveValue=function(t,e,r){return ve.scale(t,e,t),ve.add(r,t,r),r},l._subtractValue=function(t,e,r){return ve.subtract(t,e,r),r},l._getZeroValue=function(t){return t.set(0,0,0,0),t},l._copyValue=function(t,e){return e.copyFrom(t),e},l._hermiteInterpolationValue=function(t,e,r,i,o){var s=t.value,c=t.outTangent,u=e.value,_=e.inTangent,h=r*r,d=h*r,f=2*d-3*h+1,p=d-2*h+r,v=d-h,m=-2*d+3*h,g=c.x,y=_.x;return Number.isFinite(g)&&Number.isFinite(y)?o.x=f*s.x+p*g*i+v*y*i+m*u.x:o.x=s.x,g=c.y,y=_.y,Number.isFinite(g)&&Number.isFinite(y)?o.y=f*s.y+p*g*i+v*y*i+m*u.y:o.y=s.y,g=c.z,y=_.z,Number.isFinite(g)&&Number.isFinite(y)?o.z=f*s.z+p*g*i+v*y*i+m*u.z:o.z=s.z,g=c.w,y=_.w,Number.isFinite(g)&&Number.isFinite(y)?o.w=f*s.w+p*g*i+v*y*i+m*u.w:o.w=s.w,o},l}(ar),hi._isReferenceType=!0,hi._isInterpolationType=!0,hi))||Pl),Wn;(function(n){n[n.Override=0]="Override",n[n.Additive=1]="Additive"})(Wn||(Wn={}));var dt;(function(n){n[n.UnStarted=0]="UnStarted",n[n.Playing=1]="Playing",n[n.Finished=2]="Finished"})(dt||(dt={}));var Ge;(function(n){n[n.Standby=0]="Standby",n[n.Playing=1]="Playing",n[n.CrossFading=2]="CrossFading",n[n.FixedCrossFading=3]="FixedCrossFading"})(Ge||(Ge={}));var dd=function(){this.event=void 0,this.handlers=[]},Ra=function(){this.duration=0,this.offset=0,this.exitTime=1,this.destinationState=void 0},Xn;(function(n){n[n.Once=0]="Once",n[n.Loop=1]="Loop"})(Xn||(Xn={}));var Ml=function(){function n(){this.state=void 0,this.stateData=void 0,this.frameTime=void 0,this.playState=void 0,this.clipTime=void 0,this.currentEventIndex=void 0}var l=n.prototype;return l.reset=function(t,e,r){this.state=t,this.frameTime=r,this.stateData=e,this.playState=dt.UnStarted,this.clipTime=t.clipStartTime*t.clip.length,this.currentEventIndex=0},l.update=function(t){var e=this.state,r=this.frameTime,i=e._getDuration();this.playState=dt.Playing,e.wrapMode===Xn.Loop?r=i?r%i:0:Math.abs(r)>i&&(r=r<0?-i:i,this.playState=dt.Finished),t&&r===0?this.clipTime=e.clipEndTime*e.clip.length:(r<0&&(r+=i),this.clipTime=r+e.clipStartTime*e.clip.length)},n}(),fd=function(){function n(){this.animatorStateDataMap={},this.srcPlayData=new Ml,this.destPlayData=new Ml,this.layerState=Ge.Standby,this.crossCurveMark=0,this.manuallyTransition=new Ra,this.crossFadeTransition=void 0}var l=n.prototype;return l.switchPlayData=function(){var t=this.destPlayData,e=this.srcPlayData;this.srcPlayData=t,this.destPlayData=e},n}(),vd=function(){this.curveOwners=[],this.eventHandlers=[]},pd=function(){this.layerIndex=void 0,this.state=void 0},gd=function(){this.curveOwner=void 0,this.srcCurveIndex=void 0,this.destCurveIndex=void 0},lr,El,Rl,zl,Fl,Bl,Vl,Dl,Yi,za=(lr=(Yi=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,e._animatorController=void 0,U(e,"_speed",El,L(e)),U(e,"_controllerUpdateFlag",Rl,L(e)),U(e,"_animatorLayersData",zl,L(e)),U(e,"_crossCurveDataCollection",Fl,L(e)),U(e,"_animationCurveOwners",Bl,L(e)),U(e,"_crossCurveDataPool",Vl,L(e)),U(e,"_animationEventHandlerPool",Dl,L(e)),e}var a=l.prototype;return a.play=function(e,r,i){var o;r===void 0&&(r=-1),i===void 0&&(i=0),(o=this._controllerUpdateFlag)!==null&&o!==void 0&&o.flag&&this._clearPlayData();var s=this._getAnimatorStateInfo(e,r,l._tempAnimatorInfo),c=s.state;if(!!c){if(!c.clip){console.warn("The state named "+e+" has no AnimationClip data.");return}var u=this._getAnimatorLayerData(s.layerIndex),_=u.srcPlayData,h=_.state;h&&h!==c&&this._revertDefaultValue(_.state,_.stateData);var d=this._getAnimatorStateData(e,c,u);u.layerState=Ge.Playing,_.reset(c,d,c._getDuration()*i),this._saveDefaultValues(d)}},a.crossFade=function(e,r,i,o){var s;i===void 0&&(i=-1),o===void 0&&(o=0),(s=this._controllerUpdateFlag)!==null&&s!==void 0&&s.flag&&this._clearPlayData();var c=this._getAnimatorStateInfo(e,i,l._tempAnimatorInfo),u=c.state,_=this._getAnimatorLayerData(i),h=_.manuallyTransition;h.duration=r,h.offset=o,h.destinationState=u,this._crossFadeByTransition(h,i)},a.update=function(e){var r;if(this.speed!==0){var i=this._animatorController;if(!!i){if((r=this._controllerUpdateFlag)!==null&&r!==void 0&&r.flag){this._checkAutoPlay();return}e*=this.speed;for(var o=0,s=i.layers.length;o<s;o++){var c=this._getAnimatorLayerData(o);c.layerState!==Ge.Standby&&this._updateLayer(o,o===0,e/1e3)}}}},a.getCurrentAnimatorState=function(e){var r,i;return(r=this._animatorLayersData[e])===null||r===void 0||(i=r.srcPlayData)===null||i===void 0?void 0:i.state},a.findAnimatorState=function(e,r){return r===void 0&&(r=-1),this._getAnimatorStateInfo(e,r,l._tempAnimatorInfo).state},a._onEnable=function(){this.engine._componentsManager.addOnUpdateAnimations(this),this.animatorController&&this._checkAutoPlay()},a._onDisable=function(){this.engine._componentsManager.removeOnUpdateAnimations(this)},a._reset=function(){var e=this._animationCurveOwners;for(var r in e){var i=e[r];for(var o in i){var s=i[o];s.hasSavedDefaultValue&&s.revertDefaultValue()}}this._clearPlayData()},a._getAnimatorStateInfo=function(e,r,i){var o=this._animatorController,s=null;if(o){var c=o.layers;if(r===-1){for(var u=0,_=c.length;u<_;u++)if(s=c[u].stateMachine.findStateByName(e),s){r=u;break}}else s=c[r].stateMachine.findStateByName(e)}return i.layerIndex=r,i.state=s,i},a._saveDefaultValues=function(e){for(var r=e.curveOwners,i=r.length-1;i>=0;i--)r[i].saveDefaultValue()},a._getAnimatorStateData=function(e,r,i){var o=i.animatorStateDataMap,s=o[e];return s||(s=new vd,o[e]=s,this._saveAnimatorStateData(r,s),this._saveAnimatorEventHandlers(r,s)),s},a._saveAnimatorStateData=function(e,r){for(var i=this.entity,o=this._animationCurveOwners,s=r.curveOwners,c=e.clip._curveBindings,u=c.length-1;u>=0;u--){var _=c[u],h=_.relativePath===""?i:i.findByPath(_.relativePath),d=_.property,f=h,p=f.instanceId,v=o[p]||(o[p]={});s[u]=v[d]||(v[d]=_._createCurveOwner(h))}},a._saveAnimatorEventHandlers=function(e,r){var i=this._animationEventHandlerPool,o=this._entity._scripts,s=o.length,c=r.eventHandlers,u=e.clip.events;i.resetPool(),c.length=0;for(var _=0,h=u.length;_<h;_++){var d=u[_],f=i.getFromPool(),p=d.functionName,v=f.handlers;f.event=d,v.length=0;for(var m=s-1;m>=0;m--){var g=o.get(m)[p];g&&v.push(g)}c.push(f)}},a._clearCrossData=function(e){e.crossCurveMark++,this._crossCurveDataCollection.length=0,this._crossCurveDataPool.resetPool()},a._addCrossCurveData=function(e,r,i,o){var s=this._crossCurveDataPool.getFromPool();s.curveOwner=r,s.srcCurveIndex=i,s.destCurveIndex=o,e.push(s)},a._prepareCrossFading=function(e){var r=this._crossCurveDataCollection,i=e.crossCurveMark;this._prepareSrcCrossData(r,e.srcPlayData,i,!1),this._prepareDestCrossData(r,e.destPlayData,i,!1)},a._prepareStandbyCrossFading=function(e){var r=this._crossCurveDataCollection,i=e.srcPlayData,o=e.crossCurveMark;i.state&&this._prepareSrcCrossData(r,i,o,!0),this._prepareDestCrossData(r,e.destPlayData,o,!0)},a._prepareFixedPoseCrossFading=function(e){for(var r=this._crossCurveDataCollection,i=r.length-1;i>=0;i--){var o=r[i];o.curveOwner.saveFixedPoseValue(),o.destCurveIndex=-1}this._prepareDestCrossData(r,e.destPlayData,e.crossCurveMark,!0)},a._prepareSrcCrossData=function(e,r,i,o){for(var s=r.stateData.curveOwners,c=s.length-1;c>=0;c--){var u=s[c];u.crossCurveMark=i,u.crossCurveDataIndex=e.length,o&&u.saveFixedPoseValue(),this._addCrossCurveData(e,u,c,-1)}},a._prepareDestCrossData=function(e,r,i,o){for(var s=r.stateData.curveOwners,c=s.length-1;c>=0;c--){var u=s[c];u.crossCurveMark===i?e[u.crossCurveDataIndex].destCurveIndex=c:(u.saveDefaultValue(),o&&u.saveFixedPoseValue(),u.crossCurveMark=i,u.crossCurveDataIndex=e.length,this._addCrossCurveData(e,u,-1,c))}},a._getAnimatorLayerData=function(e){var r=this._animatorLayersData[e];return r||(this._animatorLayersData[e]=r=new fd),r},a._updateLayer=function(e,r,i){var o=this._animatorController.layers[e],s=o.blendingMode,c=o.weight,u=this._animatorLayersData[e],_=u.srcPlayData,h=u.destPlayData,d=u.crossFadeTransition,f=s===Wn.Additive,p=r?1:c;switch(u.layerState!==Ge.FixedCrossFading&&this._checkTransition(_,d,e),u.layerState){case Ge.Playing:this._updatePlayingState(_,u,e,p,i,f);break;case Ge.FixedCrossFading:this._updateCrossFadeFromPose(h,u,e,p,i,f);break;case Ge.CrossFading:this._updateCrossFade(_,h,u,e,p,i,f);break}},a._updatePlayingState=function(e,r,i,o,s,c){var u=e.stateData,_=u.curveOwners,h=u.eventHandlers,d=e.state,f=e.playState,p=e.clipTime,v=d.clip._curveBindings;e.update(this.speed<0);var m=e.clipTime,g=e.playState;h.length&&this._fireAnimationEvents(e,h,p,m);for(var y=v.length-1;y>=0;y--)_[y].evaluateAndApplyValue(v[y].curve,m,o,c);e.frameTime+=d.speed*s,g===dt.Finished&&(r.layerState=Ge.Standby),f===dt.UnStarted&&this._callAnimatorScriptOnEnter(d,i),g===dt.Finished?this._callAnimatorScriptOnExit(d,i):this._callAnimatorScriptOnUpdate(d,i)},a._updateCrossFade=function(e,r,i,o,s,c,u){var _=this._crossCurveDataCollection,h=e.state.clip._curveBindings,d=e.state,f=e.stateData,p=e.playState,v=f.eventHandlers,m=r.state,g=r.stateData,y=r.playState,x=g.eventHandlers,b=m.clip._curveBindings,S=e.clipTime,P=r.clipTime,T=Math.abs(r.frameTime)/(m._getDuration()*i.crossFadeTransition.duration);T>=1&&(T=1),e.update(this.speed<0),r.update(this.speed<0);var E=e.playState,M=r.playState;this._updateCrossFadeData(i,T,c,!1);var V=e.clipTime,A=r.clipTime;v.length&&this._fireAnimationEvents(e,v,S,V),x.length&&this._fireAnimationEvents(r,x,P,A),p===dt.UnStarted&&this._callAnimatorScriptOnEnter(d,o),T===1||E===dt.Finished?this._callAnimatorScriptOnExit(d,o):this._callAnimatorScriptOnUpdate(d,o),y===dt.UnStarted&&this._callAnimatorScriptOnEnter(m,o),M===dt.Finished?this._callAnimatorScriptOnExit(m,o):this._callAnimatorScriptOnUpdate(m,o);for(var C=_.length-1;C>=0;C--){var R=_[C],z=R.srcCurveIndex,F=R.destCurveIndex;R.curveOwner.crossFadeAndApplyValue(z>=0?h[z].curve:null,F>=0?b[F].curve:null,V,A,T,s,u)}},a._updateCrossFadeFromPose=function(e,r,i,o,s,c){var u=this._crossCurveDataCollection,_=e.state,h=e.stateData,d=e.playState,f=h.eventHandlers,p=_.clip._curveBindings,v=e.clipTime,m=Math.abs(e.frameTime)/(_._getDuration()*r.crossFadeTransition.duration);m>=1&&(m=1),e.update(this.speed<0);var g=e.playState;this._updateCrossFadeData(r,m,s,!0);var y=e.clipTime;f.length&&this._fireAnimationEvents(e,f,v,y),d===dt.UnStarted&&this._callAnimatorScriptOnEnter(_,i),g===dt.Finished?this._callAnimatorScriptOnExit(_,i):this._callAnimatorScriptOnUpdate(_,i);for(var x=u.length-1;x>=0;x--){var b=u[x],S=b.destCurveIndex;b.curveOwner.crossFadeFromPoseAndApplyValue(S>=0?p[S].curve:null,y,m,o,c)}},a._updateCrossFadeData=function(e,r,i,o){var s=e.destPlayData;s.frameTime+=s.state.speed*i,r===1?(s.playState===dt.Finished?e.layerState=Ge.Standby:e.layerState=Ge.Playing,e.switchPlayData()):o||(e.srcPlayData.frameTime+=e.srcPlayData.state.speed*i)},a._revertDefaultValue=function(e,r){var i=e.clip;if(i)for(var o=i._curveBindings,s=r.curveOwners,c=o.length-1;c>=0;c--){var u=s[c];u.hasSavedDefaultValue&&u.revertDefaultValue()}},a._checkTransition=function(e,r,i){for(var o=e.state,s=e.clipTime,c=o.transitions,u=o._getDuration(),_=0,h=c.length;_<h;++_){var d=c[_];u*d.exitTime<=s&&r!==d&&this._crossFadeByTransition(d,i)}},a._crossFadeByTransition=function(e,r){var i=e.destinationState.name,o=this._getAnimatorStateInfo(i,r,l._tempAnimatorInfo),s=o.state;if(!!s){if(!s.clip){console.warn("The state named "+i+" has no AnimationClip data.");return}var c=this._getAnimatorLayerData(o.layerIndex),u=c.layerState,_=c.destPlayData,h=this._getAnimatorStateData(i,s,c),d=s._getDuration(),f=d*e.offset;switch(_.reset(s,h,f),u){case Ge.Standby:c.layerState=Ge.FixedCrossFading,this._clearCrossData(c),this._prepareStandbyCrossFading(c);break;case Ge.Playing:c.layerState=Ge.CrossFading,this._clearCrossData(c),this._prepareCrossFading(c);break;case Ge.CrossFading:c.layerState=Ge.FixedCrossFading,this._prepareFixedPoseCrossFading(c);break;case Ge.FixedCrossFading:this._prepareFixedPoseCrossFading(c);break}c.crossFadeTransition=e}},a._fireAnimationEvents=function(e,r,i,o){var s=e.state,c=s.clip.length;this.speed>=0?o<i?(this._fireSubAnimationEvents(e,r,i,s.clipEndTime*c),e.currentEventIndex=0,this._fireSubAnimationEvents(e,r,s.clipStartTime*c,o)):this._fireSubAnimationEvents(e,r,i,o):o>i?(this._fireBackwardSubAnimationEvents(e,r,i,s.clipStartTime*c),e.currentEventIndex=r.length-1,this._fireBackwardSubAnimationEvents(e,r,s.clipEndTime*c,o)):this._fireBackwardSubAnimationEvents(e,r,i,o)},a._fireSubAnimationEvents=function(e,r,i,o){for(var s=e.currentEventIndex,c=r.length;s<c;s++){var u=r[s],_=u.event,h=_.time,d=_.parameter;if(h>o)break;var f=u,p=f.handlers;if(h>=i){for(var v=p.length-1;v>=0;v--)p[v](d);e.currentEventIndex=Math.min(s+1,c-1)}}},a._fireBackwardSubAnimationEvents=function(e,r,i,o){for(var s=e.currentEventIndex;s>=0;s--){var c=r[s],u=c.event,_=u.time,h=u.parameter;if(_<o)break;if(_<=i){for(var d=c,f=d.handlers,p=f.length-1;p>=0;p--)f[p](h);e.currentEventIndex=Math.max(s-1,0)}}},a._callAnimatorScriptOnEnter=function(e,r){for(var i=e._onStateEnterScripts,o=0,s=i.length;o<s;o++)i[o].onStateEnter(this,e,r)},a._callAnimatorScriptOnUpdate=function(e,r){for(var i=e._onStateUpdateScripts,o=0,s=i.length;o<s;o++)i[o].onStateUpdate(this,e,r)},a._callAnimatorScriptOnExit=function(e,r){for(var i=e._onStateExitScripts,o=0,s=i.length;o<s;o++)i[o].onStateExit(this,e,r)},a._checkAutoPlay=function(){for(var e=this._animatorController.layers,r=0,i=e.length;r<i;++r){var o=e[r].stateMachine;o!=null&&o.defaultState&&this.play(o.defaultState.name,r)}},a._clearPlayData=function(){this._animatorLayersData.length=0,this._crossCurveDataCollection.length=0,this._animationCurveOwners.length=0,this._controllerUpdateFlag&&(this._controllerUpdateFlag.flag=!1)},j(l,[{key:"speed",get:function(){return this._speed},set:function(e){this._speed=e}},{key:"animatorController",get:function(){return this._animatorController},set:function(e){e!==this._animatorController&&(this._reset(),this._controllerUpdateFlag&&this._controllerUpdateFlag.destroy(),this._controllerUpdateFlag=e&&e._registerChangeFlag(),this._animatorController=e)}}]),l}(ir),Yi._tempAnimatorInfo=new pd,Yi),El=N(lr.prototype,"_speed",[Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Rl=N(lr.prototype,"_controllerUpdateFlag",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),zl=N(lr.prototype,"_animatorLayersData",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Fl=N(lr.prototype,"_crossCurveDataCollection",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Bl=N(lr.prototype,"_animationCurveOwners",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vl=N(lr.prototype,"_crossCurveDataPool",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $r(gd)}}),Dl=N(lr.prototype,"_animationEventHandlerPool",[q],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $r(dd)}}),lr),Fa=function(){function n(){this._updateFlagManager=new mn,this._layers=[],this._layersMap={}}var l=n.prototype;return l.findLayerByName=function(t){return this._layersMap[t]},l.addLayer=function(t){this._layers.push(t),this._layersMap[t.name]=t,this._updateFlagManager.dispatch()},l.removeLayer=function(t){var e=this.layers[t];this._layers.splice(t,1),delete this._layersMap[e.name],this._updateFlagManager.dispatch()},l.clearLayers=function(){this._layers.length=0;for(var t in this._layersMap)delete this._layersMap[t];this._updateFlagManager.dispatch()},l._registerChangeFlag=function(){return this._updateFlagManager.createFlag(Ai)},j(n,[{key:"layers",get:function(){return this._layers}}]),n}(),Ba=function(l){this.name=l,this.weight=1,this.blendingMode=Wn.Override,this.stateMachine=void 0},oa=function(){function n(){this._destroyed=!1,this._state=void 0}var l=n.prototype;return l.onStateEnter=function(t,e,r){},l.onStateUpdate=function(t,e,r){},l.onStateExit=function(t,e,r){},l.destroy=function(){this._destroyed||(this._state._removeStateMachineScript(this),this._destroyed=!0)},n}(),zu=function(){function n(a){this.name=a,this.speed=1,this.wrapMode=Xn.Loop,this._onStateEnterScripts=[],this._onStateUpdateScripts=[],this._onStateExitScripts=[],this._clipStartTime=0,this._clipEndTime=1,this._clip=void 0,this._transitions=[]}var l=n.prototype;return l.addTransition=function(t){this._transitions.push(t)},l.removeTransition=function(t){var e=this._transitions.indexOf(t);e!==-1&&this._transitions.splice(e,1)},l.addStateMachineScript=function(t){var e=new t;e._state=this;var r=oa.prototype;return e.onStateEnter!==r.onStateEnter&&this._onStateEnterScripts.push(e),e.onStateUpdate!==r.onStateUpdate&&this._onStateUpdateScripts.push(e),e.onStateExit!==r.onStateExit&&this._onStateExitScripts.push(e),e},l.clearTransitions=function(){this._transitions.length=0},l._getDuration=function(){return this.clip?(this._clipEndTime-this._clipStartTime)*this.clip.length:null},l._removeStateMachineScript=function(t){var e=oa.prototype;if(t.onStateEnter!==e.onStateEnter){var r=this._onStateEnterScripts.indexOf(t);r!==-1&&this._onStateEnterScripts.splice(r,1)}if(t.onStateUpdate!==e.onStateUpdate){var i=this._onStateUpdateScripts.indexOf(t);i!==-1&&this._onStateUpdateScripts.splice(i,1)}if(t.onStateExit!==e.onStateExit){var o=this._onStateExitScripts.indexOf(t);o!==-1&&this._onStateExitScripts.splice(o,1)}},j(n,[{key:"transitions",get:function(){return this._transitions}},{key:"clip",get:function(){return this._clip},set:function(t){this._clip=t,this._clipEndTime=Math.min(this._clipEndTime,1)}},{key:"clipStartTime",get:function(){return this._clipStartTime},set:function(t){this._clipStartTime=Math.max(t,0)}},{key:"clipEndTime",get:function(){return this._clipEndTime},set:function(t){this._clipEndTime=Math.min(t,1)}}]),n}(),Va=function(){function n(){this.states=[],this.defaultState=void 0,this._statesMap={}}var l=n.prototype;return l.addState=function(t){var e=this.findStateByName(t);return e?console.warn("The state named "+t+" has existed."):(e=new zu(t),this.states.push(e),this._statesMap[t]=e),e},l.removeState=function(t){var e=t.name,r=this.states.indexOf(t);r>-1&&this.states.splice(r,1),delete this._statesMap[e]},l.findStateByName=function(t){return this._statesMap[t]},l.makeUniqueStateName=function(t){for(var e=this._statesMap,r=t,i=0;e[t];)t=r+" "+i,i++;return t},n}(),sa;(function(n){n[n.If=0]="If",n[n.IfNot=1]="IfNot",n[n.Greater=2]="Greater",n[n.Less=3]="Less",n[n.Equals=4]="Equals",n[n.NotEquals=5]="NotEquals"})(sa||(sa={}));var Lt=function(){this.time=void 0,this.value=void 0,this.inTangent=void 0,this.outTangent=void 0},Fu=function(n){$(l,n);function l(a){var t;return t=n.call(this,a,O.find("skybox"))||this,t._decodeParam=new ve(0,5,0,0),t.renderState.rasterState.cullMode=Pt.Off,t.renderState.depthState.compareFunction=be.LessEqual,t.shaderData.setVector4("u_cubeDecodeParam",t._decodeParam),t}return j(l,[{key:"textureDecodeRGBM",get:function(){return Boolean(this._decodeParam.x)},set:function(t){this._decodeParam.x=Number(t)}},{key:"RGBMDecodeFactor",get:function(){return this._decodeParam.y},set:function(t){this._decodeParam.y=t}},{key:"textureCubeMap",get:function(){return this.shaderData.getTexture("u_cube")},set:function(t){this.shaderData.setTexture("u_cube",t)}}]),l}(dr),zn,Qi,_e;(function(n){n[n.Position=1]="Position",n[n.Velocity=2]="Velocity",n[n.Acceleration=4]="Acceleration",n[n.Color=8]="Color",n[n.Alpha=16]="Alpha",n[n.Size=32]="Size",n[n.StartAngle=64]="StartAngle",n[n.StartTime=128]="StartTime",n[n.LifeTime=256]="LifeTime",n[n.RotateVelocity=512]="RotateVelocity",n[n.Scale=1024]="Scale",n[n.Everything=4294967295]="Everything"})(_e||(_e={}));var gn;(function(n){n[n.Transparent=0]="Transparent",n[n.Additive=1]="Additive"})(gn||(gn={}));var Bu=(zn=(Qi=function(n){$(l,n),l._getRandom=function(){return Math.random()-.5};function l(t){var e;return e=n.call(this,t)||this,e._vertexStride=void 0,e._vertices=void 0,e._vertexBuffer=void 0,e._maxCount=1e3,e._position=new w,e._positionRandomness=new w,e._positionArray=void 0,e._velocity=new w,e._velocityRandomness=new w,e._acceleration=new w,e._accelerationRandomness=new w,e._color=new re(1,1,1,1),e._colorRandomness=0,e._size=1,e._sizeRandomness=0,e._alpha=1,e._alphaRandomness=0,e._startAngle=0,e._startAngleRandomness=0,e._rotateVelocity=0,e._rotateVelocityRandomness=0,e._lifetime=5,e._startTimeRandomness=0,e._scale=1,e._isOnce=!1,e._onceTime=0,e._time=0,e._isInit=!1,e._isStart=!1,e._updateDirtyFlag=_e.Everything,e._isRotateToVelocity=!1,e._isUseOriginColor=!1,e._isScaleByLifetime=!1,e._is2d=!0,e._isFadeIn=!1,e._isFadeOut=!1,e._playOnEnable=!0,e._blendMode=gn.Transparent,e.spriteSheet=void 0,e._onColorChanged=e._onColorChanged.bind(L(e)),e._color._onValueChanged=e._onColorChanged,e.setMaterial(e._createMaterial()),e}var a=l.prototype;return a.update=function(e){if(!(!this._isInit||!this._isStart)){if(this._isOnce&&this._time>this._onceTime)return this.stop();this._updateDirtyFlag&&(this._updateBuffer(),this._updateDirtyFlag=0),this._time+=e/1e3,this.shaderData.setFloat("u_time",this._time)}},a._onEnable=function(){n.prototype._onEnable.call(this),this._playOnEnable&&this.start()},a.start=function(){this._isStart=!0,this._time=0},a.stop=function(){this._isStart=!1},a._createMaterial=function(){var e=new dr(this.engine,O.find("particle-shader")),r=e.renderState,i=r.blendState.targetBlendState;return i.enabled=!0,i.sourceColorBlendFactor=oe.SourceAlpha,i.destinationColorBlendFactor=oe.OneMinusSourceAlpha,i.sourceAlphaBlendFactor=oe.One,i.destinationAlphaBlendFactor=oe.OneMinusSourceAlpha,r.depthState.writeEnabled=!1,e.renderState.renderQueueType=rt.Transparent,this.isUseOriginColor=!0,this.is2d=!0,this.isFadeOut=!0,e},a._createMesh=function(){var e=new Fi(this._entity.engine,"particleMesh"),r=96,i=this._maxCount*4,o=i*r,s=new Float32Array(o),c=null,u=!1;if(i>l._uint16VertexLimit)if(this.engine._hardwareRenderer.canIUse(J.elementIndexUint))u=!0,c=new Uint32Array(6*this._maxCount);else throw Error("The vertex count is over limit.");else c=new Uint16Array(6*this._maxCount);for(var _=0,h=0;_<this._maxCount;++_){var d=_*4;c[h++]=d,c[h++]=d+1,c[h++]=d+2,c[h++]=d,c[h++]=d+2,c[h++]=d+3}var f=[new ge("a_position",0,Z.Vector3,0),new ge("a_velocity",12,Z.Vector3,0),new ge("a_acceleration",24,Z.Vector3,0),new ge("a_color",36,Z.Vector4,0),new ge("a_lifeAndSize",52,Z.Vector4,0),new ge("a_rotation",68,Z.Vector2,0),new ge("a_uv",76,Z.Vector3,0),new ge("a_normalizedUv",88,Z.Vector2,0)],p=new gr(this.engine,$t.VertexBuffer,o*4,at.Dynamic),v=new gr(this.engine,$t.IndexBuffer,c,at.Dynamic);return e.setVertexBufferBinding(p,r),e.setIndexBufferBinding(v,u?qe.UInt32:qe.UInt16),e.setVertexElements(f),e.addSubMesh(0,c.length),this._vertexBuffer=p,this._vertexStride=r/4,this._vertices=s,e},a._updateBuffer=function(){for(var e=0;e<this._maxCount;e++)this._updateSingleBuffer(e);this._vertexBuffer.setData(this._vertices)},a._updateSingleBuffer=function(e){var r=this._updateDirtyFlag,i=this._vertices,o=this._vertexStride,s=l._getRandom,c=e*4,u=c*o,_=(c+1)*o,h=(c+2)*o,d=(c+3)*o;if(r&_e.Position){var f=this._position,p=f.x,v=f.y,m=f.z,g=this._positionArray,y=this._positionRandomness;if(g){if(g.length!==this._maxCount)throw Error("The length of positionArray must be equal to maxCount.");var x=g[e];p+=x.x,v+=x.y,m+=x.z}else p+=s()*y.x,v+=s()*y.y,m+=s()*y.z;i[u]=i[_]=i[h]=i[d]=p,i[u+1]=i[_+1]=i[h+1]=i[d+1]=v,i[u+2]=i[_+2]=i[h+2]=i[d+2]=m}if(r&_e.Velocity){var b=this._velocity,S=this._velocityRandomness;i[u+3]=i[_+3]=i[h+3]=i[d+3]=b.x+s()*S.x,i[u+4]=i[_+4]=i[h+4]=i[d+4]=b.y+s()*S.y,i[u+5]=i[_+5]=i[h+5]=i[d+5]=b.z+s()*S.z}if(r&_e.Acceleration){var P=this._acceleration,T=this._accelerationRandomness;i[u+6]=i[_+6]=i[h+6]=i[d+6]=P.x+s()*T.x,i[u+7]=i[_+7]=i[h+7]=i[d+7]=P.y+s()*T.y,i[u+8]=i[_+8]=i[h+8]=i[d+8]=P.z+s()*T.z}if(r&_e.Color){var E=this._color,M=this._colorRandomness;i[u+9]=i[_+9]=i[h+9]=i[d+9]=G.clamp(E.r+s()*M,0,1),i[u+10]=i[_+10]=i[h+10]=i[d+10]=G.clamp(E.g+s()*M,0,1),i[u+11]=i[_+11]=i[h+11]=i[d+11]=G.clamp(E.b+s()*M,0,1)}if(r&_e.Alpha&&(i[u+12]=i[_+12]=i[h+12]=i[d+12]=G.clamp(this._alpha+s()*this._alphaRandomness,0,1)),r&_e.StartTime&&(i[u+13]=i[_+13]=i[h+13]=i[d+13]=Math.random()*this._startTimeRandomness),r&_e.LifeTime){var V=this._lifetime;i[u+14]=i[_+14]=i[h+14]=i[d+14]=V+s()*V}if((r&_e.StartTime||r&_e.LifeTime)&&(this._onceTime=Math.max(this._onceTime,i[u+13]+i[u+14])),r&_e.Size){var A=this._size;i[u+15]=i[_+15]=i[h+15]=i[d+15]=Math.max(A+s()*this._sizeRandomness*A*2,0)}r&_e.Scale&&(i[u+16]=i[_+16]=i[h+16]=i[d+16]=this._scale),r&_e.StartAngle&&(i[u+17]=i[_+17]=i[h+17]=i[d+17]=this._startAngle+s()*Math.PI*this._startAngleRandomness*2),r&_e.RotateVelocity&&(i[u+18]=i[_+18]=i[h+18]=i[d+18]=this._rotateVelocity+s()*this._rotateVelocityRandomness),this._updateSingleUv(e,u,_,h,d)},a._updateSingleUv=function(e,r,i,o,s){var c=this.spriteSheet,u=this.getMaterial().shaderData.getTexture("u_texture"),_=this._vertices;if(u){var h=u.width,d=u.height;if(c){var f=c[e%c.length],p=f.x,v=f.y,m=f.w,g=f.h,y=p/h,x=v/d,b=y+m/h,S=x+g/d,P=g/m;_[r+19]=y,_[r+20]=S,_[r+21]=P,_[i+19]=b,_[i+20]=S,_[i+21]=P,_[o+19]=b,_[o+20]=x,_[o+21]=P,_[s+19]=y,_[s+20]=x,_[s+21]=P}else{var T=d/h;_[r+19]=0,_[r+20]=1,_[r+21]=T,_[i+19]=1,_[i+20]=1,_[i+21]=T,_[o+19]=1,_[o+20]=0,_[o+21]=T,_[s+19]=0,_[s+20]=0,_[s+21]=T}}else _[r+19]=0,_[r+20]=0,_[r+21]=1,_[i+19]=1,_[i+20]=0,_[i+21]=1,_[o+19]=1,_[o+20]=1,_[o+21]=1,_[s+19]=0,_[s+20]=1,_[s+21]=1;_[r+22]=-.5,_[r+23]=-.5,_[i+22]=.5,_[i+23]=-.5,_[o+22]=.5,_[o+23]=.5,_[s+22]=-.5,_[s+23]=.5},a._onColorChanged=function(){this._updateDirtyFlag|=_e.Color},j(l,[{key:"texture",get:function(){return this.getMaterial().shaderData.getTexture("u_texture")},set:function(e){e?(this.shaderData.enableMacro("particleTexture"),this.getMaterial().shaderData.setTexture("u_texture",e)):this.shaderData.disableMacro("particleTexture")}},{key:"position",get:function(){return this._position},set:function(e){this._updateDirtyFlag|=_e.Position,this._position=e}},{key:"positionRandomness",get:function(){return this._positionRandomness},set:function(e){this._updateDirtyFlag|=_e.Position,this._positionRandomness=e}},{key:"positionArray",get:function(){return this._positionArray},set:function(e){this._updateDirtyFlag|=_e.Position,this._positionArray=e}},{key:"velocity",get:function(){return this._velocity},set:function(e){this._updateDirtyFlag|=_e.Velocity,this._velocity=e}},{key:"velocityRandomness",get:function(){return this._velocityRandomness},set:function(e){this._updateDirtyFlag|=_e.Velocity,this._velocityRandomness=e}},{key:"acceleration",get:function(){return this._acceleration},set:function(e){this._updateDirtyFlag|=_e.Acceleration,this._acceleration=e}},{key:"accelerationRandomness",get:function(){return this._accelerationRandomness},set:function(e){this._updateDirtyFlag|=_e.Acceleration,this._accelerationRandomness=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.copyFrom(e)}},{key:"colorRandomness",get:function(){return this._colorRandomness},set:function(e){this._updateDirtyFlag|=_e.Color,this._colorRandomness=e}},{key:"size",get:function(){return this._size},set:function(e){this._updateDirtyFlag|=_e.Size,this._size=e}},{key:"sizeRandomness",get:function(){return this._sizeRandomness},set:function(e){this._updateDirtyFlag|=_e.Size,this._sizeRandomness=e}},{key:"alpha",get:function(){return this._alpha},set:function(e){this._updateDirtyFlag|=_e.Alpha,this._alpha=e}},{key:"alphaRandomness",get:function(){return this._alphaRandomness},set:function(e){this._updateDirtyFlag|=_e.Alpha,this._alphaRandomness=e}},{key:"angle",get:function(){return this._startAngle},set:function(e){this._updateDirtyFlag|=_e.StartAngle,this._startAngle=e}},{key:"angleRandomness",get:function(){return this._startAngleRandomness},set:function(e){this._updateDirtyFlag|=_e.StartAngle,this._startAngleRandomness=e}},{key:"rotateVelocity",get:function(){return this._rotateVelocity},set:function(e){this._updateDirtyFlag|=_e.RotateVelocity,this._rotateVelocity=e}},{key:"rotateVelocityRandomness",get:function(){return this._rotateVelocityRandomness},set:function(e){this._updateDirtyFlag|=_e.RotateVelocity,this._rotateVelocityRandomness=e}},{key:"lifetime",get:function(){return this._lifetime},set:function(e){this._updateDirtyFlag|=_e.LifeTime,this._lifetime=e,this._onceTime=0}},{key:"startTimeRandomness",get:function(){return this._startTimeRandomness},set:function(e){this._updateDirtyFlag|=_e.StartTime,this._startTimeRandomness=e,this._onceTime=0}},{key:"scale",get:function(){return this._scale},set:function(e){this._updateDirtyFlag|=_e.Scale,this._scale=e}},{key:"maxCount",get:function(){return this._maxCount},set:function(e){this._isStart=!1,this._isInit=!1,this._maxCount=e,this._updateDirtyFlag=_e.Everything,this.mesh=this._createMesh(),this._updateBuffer(),this._isInit=!0,this.shaderData.setFloat("u_time",0)}},{key:"isOnce",get:function(){return this._isOnce},set:function(e){this._time=0,this.shaderData.setInt("u_once",e?1:0),this._isOnce=e}},{key:"isRotateToVelocity",get:function(){return this._isRotateToVelocity},set:function(e){e?this.shaderData.enableMacro("rotateToVelocity"):this.shaderData.disableMacro("rotateToVelocity"),this._isRotateToVelocity=e}},{key:"isUseOriginColor",get:function(){return this._isUseOriginColor},set:function(e){e?this.shaderData.enableMacro("useOriginColor"):this.shaderData.disableMacro("useOriginColor"),this._isUseOriginColor=e}},{key:"isScaleByLifetime",get:function(){return this._isScaleByLifetime},set:function(e){e?this.shaderData.enableMacro("isScaleByLifetime"):this.shaderData.disableMacro("isScaleByLifetime"),this._isScaleByLifetime=e}},{key:"is2d",get:function(){return this._is2d},set:function(e){e?this.shaderData.enableMacro("is2d"):(this.shaderData.disableMacro("is2d"),this.getMaterial().renderState.rasterState.cullMode=Pt.Off),this._is2d=e}},{key:"isFadeIn",get:function(){return this._isFadeIn},set:function(e){e?this.shaderData.enableMacro("fadeIn"):this.shaderData.disableMacro("fadeIn"),this._isFadeIn=e}},{key:"isFadeOut",get:function(){return this._isFadeOut},set:function(e){e?this.shaderData.enableMacro("fadeOut"):this.shaderData.disableMacro("fadeOut"),this._isFadeOut=e}},{key:"playOnEnable",get:function(){return this._playOnEnable},set:function(e){this._playOnEnable=e,e?this.start():this.stop()}},{key:"blendMode",get:function(){return this._blendMode},set:function(e){var r=this.getMaterial().renderState.blendState,i=r.targetBlendState;e===gn.Transparent?(i.enabled=!0,i.sourceColorBlendFactor=oe.SourceAlpha,i.destinationColorBlendFactor=oe.OneMinusSourceAlpha,i.sourceAlphaBlendFactor=oe.One,i.destinationAlphaBlendFactor=oe.OneMinusSourceAlpha):e===gn.Additive&&(i.enabled=!0,i.sourceColorBlendFactor=oe.SourceAlpha,i.destinationColorBlendFactor=oe.One,i.sourceAlphaBlendFactor=oe.One,i.destinationAlphaBlendFactor=oe.OneMinusSourceAlpha),this._blendMode=e}}]),l}(Tn),Qi._uint16VertexLimit=65535,Qi),N(zn.prototype,"_onColorChanged",[q],Object.getOwnPropertyDescriptor(zn.prototype,"_onColorChanged"),zn.prototype),zn),md=`#define GLSLIFY 1
varying vec2 v_uv;uniform sampler2D u_texture;void main(void){gl_FragColor=texture2D(u_texture,v_uv);}`,yd=`#define GLSLIFY 1
attribute vec3 POSITION;attribute vec2 TEXCOORD_0;varying vec2 v_uv;uniform mat4 u_projMat;uniform mat4 u_viewMat;void main(){gl_Position=u_projMat*u_viewMat*vec4(POSITION,1.0);v_uv=TEXCOORD_0;}`;O.create("trail",yd,md);var Vu=function(n){$(l,n);function l(a){var t;t=n.call(this,a,O.find("trail"))||this;var e=t.renderState.blendState.targetBlendState;return e.enabled=!0,e.sourceColorBlendFactor=e.sourceAlphaBlendFactor=oe.SourceAlpha,e.destinationColorBlendFactor=e.destinationAlphaBlendFactor=oe.One,t.renderState.depthState.writeEnabled=!1,t}return l}(dr),Ll=new w,xd=function(n){$(l,n);function l(t,e){var r;r=n.call(this,t)||this,r._vertexStride=void 0,r._vertices=void 0,r._vertexBuffer=void 0,r._stroke=void 0,r._minSeg=void 0,r._lifetime=void 0,r._maxPointNum=void 0,r._points=void 0,r._pointStates=void 0,r._strapPoints=void 0,r._curPointNum=void 0,r._prePointsNum=void 0,r._stroke=e.stroke||.2,r._minSeg=e.minSeg||.02,r._lifetime=e.lifetime||1e3,r._maxPointNum=r._lifetime/1e3*t.engine.targetFrameRate,r._points=[],r._pointStates=[],r._strapPoints=[];for(var i=0;i<r._maxPointNum;i++)r._points.push(new w),r._pointStates.push(r._lifetime),r._strapPoints.push(new w),r._strapPoints.push(new w);r._curPointNum=0;var o=e.material||new Vu(r.engine);return r.setMaterial(o),r.setTexture(e.texture),r._initGeometry(),r}var a=l.prototype;return a.update=function(e){for(var r=0,i=0,o=0;o<this._curPointNum;o++)this._pointStates[o]-=e,this._pointStates[o]<0?r++:r>0&&(i=o-r,this._pointStates[i]=this._pointStates[o],this._points[i].copyFrom(this._points[o]));this._curPointNum-=r;var s=!0;if(this._curPointNum===this._maxPointNum)s=!1;else if(this._curPointNum>0){var c=this._points[this._points.length-1];w.distance(this.entity.transform.worldPosition,c)<this._minSeg&&(s=!1)}s&&(this._pointStates[this._curPointNum]=this._lifetime,this._points[this._curPointNum].copyFrom(this.entity.transform.worldPosition),this._curPointNum++)},a._render=function(e){this._updateStrapVertices(e.camera,this._points),this._updateStrapCoords(),this._vertexBuffer.setData(this._vertices),n.prototype._render.call(this,e)},a.setTexture=function(e){e&&this.getMaterial().shaderData.setTexture("u_texture",e)},a._initGeometry=function(){var e=new Fi(this._entity.engine),r=20,i=this._maxPointNum*2,o=i*r,s=new Float32Array(o),c=[new ge("POSITION",0,Z.Vector3,0),new ge("TEXCOORD_0",12,Z.Vector2,0)],u=new gr(this.engine,o*4,at.Dynamic);e.setVertexBufferBinding(u,r),e.setVertexElements(c),e.addSubMesh(0,i,rn.TriangleStrip),this._vertexBuffer=u,this._vertexStride=r,this._vertices=s,this.mesh=e},a._updateStrapVertices=function(e,r){var i=e.viewMatrix,o=i.elements,s=new w(o[0],o[4],o[8]),c=new w(o[1],o[5],o[9]),u=new w(o[2],o[6],o[10]),_=this._stroke;c.scale(_);var h=new w,d=new w,f=new xe;w.transformByQuat(s,f,s),w.transformByQuat(c,f,c);var p=new w,v=new w,m=new w;s.normalize();for(var g=this._vertices,y=0;y<this._maxPointNum;y++){if(y<this._curPointNum){var x=r[y];y===this._curPointNum-1&&y!==0?w.subtract(x,r[y-1],m):w.subtract(r[y+1],x,m),this._projectOnPlane(m,u,m),m.normalize();var b=Math.acos(w.dot(s,m));w.cross(s,m,v),w.dot(v,u)<=0&&(b=Math.PI*2-b),xe.rotationAxisAngle(u,b,f),w.transformByQuat(c,f,p),w.add(x,p,h),w.subtract(x,p,d)}var S=y*2*this._vertexStride/4,P=(y*2+1)*this._vertexStride/4;g[S]=h.x,g[S+1]=h.y,g[S+2]=h.z,g[P]=d.x,g[P+1]=d.y,g[P+2]=d.z}},a._updateStrapCoords=function(){if(this._prePointsNum!==this._curPointNum){this._prePointsNum=this._curPointNum;for(var e=this._curPointNum,r=1/e,i=this._vertices,o=0;o<e;o++){var s=1-o*r,c=o*2*this._vertexStride/4,u=(o*2+1)*this._vertexStride/4;i[c]=0,i[c+1]=s,i[u]=1,i[u+1]=s}}},a._projectOnVector=function(e,r,i){var o=r.clone();w.normalize(o,o);var s=w.dot(e,o);i.x=o.x*s,i.y=o.y*s,i.z=o.z*s},a._projectOnPlane=function(e,r,i){this._projectOnVector(e,r,Ll),w.subtract(e,Ll,i)},l}(Tn),Di=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,e._color=new re(1,0,0,1),e.color=e._color,e}var a=l.prototype;return a._onEnable=function(){this.scene.shaderData.enableMacro("O3_HAS_FOG")},a._onDisable=function(){this.scene.shaderData.disableMacro("O3_HAS_FOG")},j(l,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this.scene.shaderData.setColor(l._colorProperty,e)}}]),l}(ir);Di._colorProperty=O.getPropertyByName("u_fogColor");var Du=function(n){$(l,n);function l(t){var e;return e=n.call(this,t)||this,e._density=.0025,e.density=e._density,e}var a=l.prototype;return a._onEnable=function(){this.scene.shaderData.enableMacro("O3_FOG_EXP2")},a._onDisable=function(){this.scene.shaderData.disableMacro("O3_FOG_EXP2")},j(l,[{key:"density",get:function(){return this._density},set:function(e){this._density=e,this.scene.shaderData.setFloat(l._densityProperty,e)}}]),l}(Di);Du._densityProperty=O.getPropertyByName("u_fogDensity");var Da=function(n){$(l,n);function l(a){var t;return t=n.call(this,a)||this,t._near=1,t._far=1e3,t.near=t._near,t.far=t._far,t}return j(l,[{key:"near",get:function(){return this._near},set:function(t){this._near=t,this.scene.shaderData.setFloat(l._nearProperty,t)}},{key:"far",get:function(){return this._far},set:function(t){this._far=t,this.scene.shaderData.setFloat(l._farProperty,t)}}]),l}(Di);Da._nearProperty=O.getPropertyByName("u_fogNear");Da._farProperty=O.getPropertyByName("u_fogFar");var Lu=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.probeLayer=nr.Everything,t.width=1024,t.height=1024,t.antiAliasing=1,t._isCube=!1,t._oriCameraRenderTarget=void 0,t._renderTarget=void 0,t._renderTargetSwap=void 0,t._activeRenderTarget=void 0,t._camera=void 0,t._oriCameraCullingMask=void 0,t}var a=l.prototype;return a.onTextureChange=function(e){},a.onBeginRender=function(e){!this.enabled||(this._camera=e,this._oriCameraCullingMask=e.cullingMask,e.cullingMask=this.probeLayer,(!this._activeRenderTarget||this._activeRenderTarget.width!==this.width||this._activeRenderTarget.height!==this.height||this._activeRenderTarget.antiAliasing!==this.antiAliasing)&&(this._renderTarget=new Nn(this.engine,this.width,this.height,this._isCube?new Ct(this.engine,this.width):new Mt(this.engine,this.width,this.height),$e.Depth,this.antiAliasing),this._renderTargetSwap=new Nn(this.engine,this.width,this.height,this._isCube?new Ct(this.engine,this.width):new Mt(this.engine,this.width,this.height),$e.Depth,this.antiAliasing),this._activeRenderTarget=this._renderTarget),this._oriCameraRenderTarget=e.renderTarget,e.renderTarget=this._activeRenderTarget)},a.onEndRender=function(e){!this.enabled||(this.onTextureChange&&this.onTextureChange(this._texture),this._activeRenderTarget=this._activeRenderTarget===this._renderTarget?this._renderTargetSwap:this._renderTarget)},a._reset=function(){!this.enabled||(this._camera.renderTarget=this._oriCameraRenderTarget,this._camera.cullingMask=this._oriCameraCullingMask)},j(l,[{key:"_texture",get:function(){var e;return(e=this._activeRenderTarget)===null||e===void 0?void 0:e.getColorTexture()}}]),l}(wa),Il=new w,Hr=new w,Wr=new w,wd=function(n){$(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t.position=new w(0,0,0),t._isCube=!0,t.oriViewMatrix=new te,t._oriFieldOfView=void 0,t}var a=l.prototype;return a.onBeginRender=function(e){if(!!this.enabled){n.prototype.onBeginRender.call(this,e),this._storeCamera(e);for(var r=0;r<6;r++)this._setCamera(r,e),e.render(wt.PositiveX+r);this._restoreCamera(e),n.prototype._reset.call(this)}},a._storeCamera=function(e){this.oriViewMatrix.copyFrom(e.viewMatrix),this._oriFieldOfView=e.fieldOfView},a._restoreCamera=function(e){e.viewMatrix.copyFrom(this.oriViewMatrix),e.fieldOfView=this._oriFieldOfView},a._setCamera=function(e,r){switch(e){case 0:Hr.set(0,-1,0),Wr.set(1,0,0);break;case 1:Hr.set(0,-1,0),Wr.set(-1,0,0);break;case 2:Hr.set(0,0,1),Wr.set(0,1,0);break;case 3:Hr.set(0,0,-1),Wr.set(0,-1,0);break;case 4:Hr.set(0,-1,0),Wr.set(0,0,1);break;case 5:Hr.set(0,-1,0),Wr.set(0,0,-1);break}w.add(this.position,Wr,Il),te.lookAt(this.position,Il,Hr,r.viewMatrix),r.fieldOfView=90},l}(Lu);const Ol=Object.freeze(Object.defineProperty({__proto__:null,AmbientLight:kt,AnimationArrayCurve:Au,AnimationBoolCurve:hd,AnimationClip:Aa,AnimationClipCurveBinding:Tu,AnimationColorCurve:Pu,AnimationCurve:ar,AnimationEvent:Ta,AnimationFloatArrayCurve:Pa,AnimationFloatCurve:Mu,AnimationQuaternionCurve:Ma,AnimationVector2Curve:Eu,AnimationVector3Curve:Ea,AnimationVector4Curve:Ru,Animator:za,get AnimatorConditionMode(){return sa},AnimatorController:Fa,AnimatorControllerLayer:Ba,get AnimatorLayerBlendingMode(){return Wn},AnimatorState:zu,AnimatorStateMachine:Va,AnimatorStateTransition:Ra,AssetPromise:Ee,get AssetType(){return Me},Background:mu,get BackgroundMode(){return pr},get BackgroundTextureFillMode(){return Er},BaseMaterial:ot,BasicRenderPipeline:Vi,get BlendFactor(){return oe},get BlendMode(){return Qr},get BlendOperation(){return St},BlendShape:ya,BlendShapeFrame:gu,BlinnPhongMaterial:An,BoolUpdateFlag:Ai,BoxColliderShape:a_,Buffer:gr,get BufferBindFlag(){return $t},BufferMesh:Fi,get BufferUsage(){return at},BufferUtil:Gn,Camera:ba,get CameraClearFlags(){return It},CapsuleColliderShape:l_,CharacterController:i_,CloneManager:Nt,Collider:Dr,ColliderShape:Sn,get ColliderShapeUpAxis(){return yi},get CollisionDetectionMode(){return xi},get ColorSpace(){return zr},get ColorWriteMask(){return Xt},get CompareFunction(){return be},Component:ir,get ControllerCollisionFlag(){return ia},get ControllerNonWalkableMode(){return mi},CubeProbe:wd,get CullMode(){return Pt},get DataType(){return Be},get DiffuseMode(){return bn},DirectLight:Vr,DynamicCollider:v_,get DynamicColliderConstraints(){return aa},EXP2Fog:Du,Engine:mr,EngineObject:xr,Entity:hr,Event:ra,EventDispatcher:ou,FixedJoint:c_,Fog:Di,Font:tn,get FontStyle(){return Rr},get GLCapabilityType(){return J},HingeJoint:u_,HitResult:cu,IndexBufferBinding:bi,get IndexFormat(){return qe},InputManager:_u,get InterpolationType(){return Ye},Joint:Pi,JointLimits:h_,JointMotor:d_,Keyframe:Lt,get Keys(){return gi},get Layer(){return nr},Light:vt,LinearFog:Da,Loader:Te,Logger:ce,Material:dr,Mesh:ga,MeshRenderElement:du,MeshRenderer:Tn,get MeshTopology(){return rn},ModelMesh:nt,ObjectValues:na,get OverflowMode(){return nn},PBRBaseMaterial:Qt,PBRMaterial:Pn,PBRSpecularMaterial:an,ParticleRenderer:Bu,get ParticleRendererBlendMode(){return gn},PhysicsManager:bt,PhysicsMaterial:uu,get PhysicsMaterialCombineMode(){return kn},PlaneColliderShape:s_,PointLight:Lr,Pointer:lu,get PointerButton(){return Xe},get PointerPhase(){return je},PrimitiveMesh:pu,Probe:Lu,RefObject:wr,get RenderBufferDepthFormat(){return $e},get RenderFace(){return fr},RenderPass:Vn,RenderQueue:_r,get RenderQueueType(){return rt},RenderTarget:Nn,Renderer:Jn,ResourceManager:$n,Scene:xa,SceneManager:yu,Script:wa,get SetDataOptions(){return Hn},Shader:O,ShaderData:Qn,ShaderFactory:Xr,ShaderPass:ha,ShaderProperty:da,get ShaderPropertyType(){return ht},get ShadowCascadesMode(){return Dt},get ShadowResolution(){return Mr},get ShadowType(){return Br},Skin:vu,SkinnedMeshRenderer:ma,Sky:wn,SkyBoxMaterial:Fu,SphereColliderShape:o_,SpotLight:Ut,SpringJoint:__,Sprite:Sa,SpriteAtlas:wu,get SpriteDrawMode(){return Pr},SpriteElement:fu,SpriteMask:wi,get SpriteMaskInteraction(){return Ot},get SpriteMaskLayer(){return yn},SpriteRenderer:bu,StateMachineScript:oa,StaticCollider:f_,get StencilOperation(){return He},SubMesh:pa,SystemInfo:$h,get TextHorizontalAlignment(){return Jr},TextRenderer:Su,get TextVerticalAlignment(){return Zr},Texture:rr,Texture2D:Mt,Texture2DArray:_a,get TextureCoordinate(){return Fr},TextureCube:Ct,get TextureCubeFace(){return wt},get TextureDepthCompareFunction(){return Vt},get TextureFilterMode(){return gt},get TextureFormat(){return H},get TextureWrapMode(){return pt},Time:su,TrailMaterial:Vu,TrailRenderer:xd,Transform:At,UnlitMaterial:Ca,Util:fi,VertexBufferBinding:zi,VertexElement:ge,get VertexElementFormat(){return Z},get WrapMode(){return Xn},assignmentClone:Ce,deepClone:ze,dependentComponents:Yn,ignoreClone:q,request:Dn,resourceLoader:Ue,shallowClone:au},Symbol.toStringTag,{value:"Module"}));function Nl(n,l){for(var a=0;a<l.length;a++){var t=l[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function bd(n,l,a){return l&&Nl(n.prototype,l),a&&Nl(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n}var Cd=function(){function n(a,t){var e=this;this._worker=void 0,this._costs={},this._currentLoad=0,this._callbacks={},this._worker=new Worker(a),this._worker.onmessage=function(r){var i=r.data;switch(i.type){case"decode":e._callbacks[i.id].resolve(i.geometry);break;case"error":e._callbacks[i.id].reject(i);break;default:ce.error('DRACOWorker: Unexpected message, "'+i.type+'"')}},t?this._worker.postMessage({type:"init",decoderConfig:{wasmBinary:t}}):this._worker.postMessage({type:"init",decoderConfig:{}})}var l=n.prototype;return l.setCosts=function(t,e){this._costs[t]=e},l.addCurrentLoad=function(t){this._currentLoad+=t},l.setCallback=function(t,e,r){this._callbacks[t]={resolve:e,reject:r}},l.decode=function(t,e,r){this._worker.postMessage({type:"decode",id:t,taskConfig:e,buffer:r},[r])},l.releaseTask=function(t){this._currentLoad-=this._costs[t],delete this._callbacks[t],delete this._costs[t]},bd(n,[{key:"currentLoad",get:function(){return this._currentLoad}}]),n}(),Ul=`let decoderPending;
let decoderConfig;

onmessage = function(e) {
  const message = e.data;

  switch (message.type) {
    case "init":
      decoderConfig = message.decoderConfig;
      decoderPending = new Promise(function(resolve /*, reject*/) {
        decoderConfig.onModuleLoaded = function(draco) {
          // Module is Promise-like. Wrap before resolving to avoid loop.
          resolve({ draco: draco });
        };
        DracoDecoderModule(decoderConfig);
      });
      break;

    case "decode":
      const buffer = message.buffer;
      const taskConfig = message.taskConfig;
      decoderPending.then(module => {
        const draco = module.draco;
        const decoder = new draco.Decoder();
        const decoderBuffer = new draco.DecoderBuffer();
        decoderBuffer.Init(new Int8Array(buffer), buffer.byteLength);
        try {
          const geometry = decodeGeometry(draco, decoder, decoderBuffer, taskConfig);
          const buffers = geometry.attributes.map(attr => attr.array.buffer);
          if (geometry.index) buffers.push(geometry.index.array.buffer);
          self.postMessage({ type: "decode", id: message.id, geometry }, buffers);
        } catch (error) {
          console.error(error);
          self.postMessage({ type: "error", id: message.id, error: error.message });
        } finally {
          draco.destroy(decoderBuffer);
          draco.destroy(decoder);
        }
      });
      break;
  }
};

function decodeGeometry(draco, decoder, decoderBuffer, taskConfig) {
  const attributeIDs = taskConfig.attributeIDs;
  const attributeTypes = taskConfig.attributeTypes;

  let dracoGeometry;
  let decodingStatus;

  const geometryType = decoder.GetEncodedGeometryType(decoderBuffer);
  if (geometryType === draco.TRIANGULAR_MESH) {
    dracoGeometry = new draco.Mesh();
    decodingStatus = decoder.DecodeBufferToMesh(decoderBuffer, dracoGeometry);
  } else {
    throw new Error("DRACODecoder worker: Unexpected geometry type.");
  }

  if (!decodingStatus.ok() || dracoGeometry.ptr === 0) {
    throw new Error("DRACODecoder worker: Decoding failed: " + decodingStatus.error_msg());
  }

  const geometry = { index: null, attributes: [] };

  // Gather all vertex attributes.
  for (let attributeName in attributeIDs) {
    const attributeType = self[attributeTypes[attributeName]];

    let attribute;
    let attributeID;

    // A Draco file may be created with default vertex attributes, whose attribute IDs
    // are mapped 1:1 from their semantic name (POSITION, NORMAL, ...). Alternatively,
    // a Draco file may contain a custom set of attributes, identified by known unique
    // IDs. glTF files always do the latter, and .drc files typically do the former.
    if (taskConfig.useUniqueIDs) {
      attributeID = attributeIDs[attributeName];
      attribute = decoder.GetAttributeByUniqueId(dracoGeometry, attributeID);
    } else {
      attributeID = decoder.GetAttributeId(dracoGeometry, draco[attributeIDs[attributeName]]);
      if (attributeID === -1) continue;
      attribute = decoder.GetAttribute(dracoGeometry, attributeID);
    }
    geometry.attributes.push(decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute));
  }
  // Add index.
  if (geometryType === draco.TRIANGULAR_MESH) {
    // Generate mesh faces.
    const numFaces = dracoGeometry.num_faces();
    const numIndices = numFaces * 3;
    let dataSize;
    let ptr;
    let index;
    const indexType = self[taskConfig.indexType];

    switch (indexType) {
      case Uint16Array:
        dataSize = numIndices * 2;
        ptr = draco._malloc(dataSize);
        decoder.GetTrianglesUInt16Array(dracoGeometry, dataSize, ptr);
        index = new Uint16Array(draco.HEAPU16.buffer, ptr, numIndices).slice();
        draco._free(ptr);
        break;
      case Uint32Array:
        dataSize = numIndices * 4;
        ptr = draco._malloc(dataSize);
        decoder.GetTrianglesUInt32Array(dracoGeometry, dataSize, ptr);
        index = new Uint32Array(draco.HEAPU32.buffer, ptr, numIndices).slice();
        draco._free(ptr);
        break;
      default:
        throw new Error("DRACODecoder: Unexpected index type.");
    }
    geometry.index = { array: index, itemSize: 1 };
  }
  draco.destroy(dracoGeometry);
  return geometry;
}

function decodeAttribute(draco, decoder, dracoGeometry, attributeName, attributeType, attribute) {
  const numComponents = attribute.num_components();
  const numPoints = dracoGeometry.num_points();
  const numValues = numPoints * numComponents;
  let ptr;
  let array;
  let dataSize;
  switch (attributeType) {
    case Float32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_FLOAT32, dataSize, ptr);
      array = new Float32Array(draco.HEAPF32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int8Array:
      ptr = draco._malloc(numValues);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT8, numValues, ptr);
      array = new Int8Array(draco.HEAP8.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int16Array:
      dataSize = numValues * 2;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT16, dataSize, ptr);
      array = new Int16Array(draco.HEAP16.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Int32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_INT32, dataSize, ptr);
      array = new Int32Array(draco.HEAP32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint8Array:
      ptr = draco._malloc(numValues);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT8, numValues, ptr);
      array = new Uint8Array(draco.HEAPU8.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint16Array:
      dataSize = numValues * 2;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT16, dataSize, ptr);
      array = new Uint16Array(draco.HEAPU16.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    case Uint32Array:
      dataSize = numValues * 4;
      ptr = draco._malloc(dataSize);
      decoder.GetAttributeDataArrayForAllPoints(dracoGeometry, attribute, draco.DT_UINT32, dataSize, ptr);
      array = new Uint32Array(draco.HEAPU32.buffer, ptr, numValues).slice();
      draco._free(ptr);
      break;

    default:
      throw new Error("DRACODecoder: Unexpected attribute type.");
  }

  return {
    name: attributeName,
    array: array,
    itemSize: numComponents
  };
}
`,Ji="https://gw.alipayobjects.com/os/lib/alipay/draco-javascript/1.3.6/lib/",Sd="draco_decoder_gltf.js",Td="draco_decoder_gltf.r3bin",Ad="draco_wasm_wrapper_gltf.js",Pd=function(){function n(a){if(a===void 0&&(a={type:"wasm",workerLimit:4}),this.pool=[],this.workerLimit=Math.min(navigator.hardwareConcurrency||4,4),this.useJS=void 0,this.currentTaskId=1,this.taskCache=new WeakMap,this.loadLibPromise=void 0,a.workerLimit>this.workerLimit)ce.warn("DRACOWorkerPool: Can not initialize worker pool with limit:"+a.workerLimit);else{var t;this.workerLimit=(t=a.workerLimit)!=null?t:4}this.useJS=typeof WebAssembly!="object"||a.type==="js",this.loadLibPromise=this.preloadLib()}var l=n.prototype;return l.preloadLib=function(){var t=this;return this.loadLibPromise?this.loadLibPromise:new Promise(function(e,r){t.useJS?Dn(""+Ji+Sd,{type:"text"}).then(function(i){var o=[i,Ul].join(`
`),s=URL.createObjectURL(new Blob([o]));e({workerSourceURL:s,decoderWASMBinary:null})}).catch(function(i){r(i)}):Promise.all([Dn(""+Ji+Ad,{type:"text"}),Dn(""+Ji+Td,{type:"arraybuffer"})]).then(function(i){var o=i[0],s=i[1],c=[o,Ul].join(`
`),u=URL.createObjectURL(new Blob([c]));e({workerSourceURL:u,decoderWASMBinary:s})}).catch(function(i){r(i)})})},l.getWorker=function(){var t=this;return this.preloadLib().then(function(e){if(t.pool.length<t.workerLimit){var r=new Cd(e.workerSourceURL,e.decoderWASMBinary);t.pool.push(r)}else t.pool.sort(function(i,o){return i.currentLoad>o.currentLoad?-1:1});return t.pool[t.pool.length-1]})},l.decode=function(t,e){var r=this,i=JSON.stringify(e);if(this.taskCache.has(t)){var o=this.taskCache.get(t);if(o.key===i)return o.promise;if(t.byteLength===0)throw new Error("DRACODecoder: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}var s=this.currentTaskId++,c=t.byteLength,u,_=new Promise(function(h,d){r.getWorker().then(function(f){u=f,f.setCosts(s,c),f.addCurrentLoad(c),f.setCallback(s,h,d),f.decode(s,e,t)}).catch(function(f){d(f)})});return _.finally(function(){u&&s&&u.releaseTask(s)}),this.taskCache.set(t,{key:i,promise:_}),_},n}(),ae;(function(n){n[n.RGBA_ASTC_4X4_KHR=37808]="RGBA_ASTC_4X4_KHR",n[n.RGBA_ASTC_5X4_KHR=37809]="RGBA_ASTC_5X4_KHR",n[n.RGBA_ASTC_5X5_KHR=37810]="RGBA_ASTC_5X5_KHR",n[n.RGBA_ASTC_6X5_KHR=37811]="RGBA_ASTC_6X5_KHR",n[n.RGBA_ASTC_6X6_KHR=37812]="RGBA_ASTC_6X6_KHR",n[n.RGBA_ASTC_8X5_KHR=37813]="RGBA_ASTC_8X5_KHR",n[n.RGBA_ASTC_8X6_KHR=37814]="RGBA_ASTC_8X6_KHR",n[n.RGBA_ASTC_8X8_KHR=37815]="RGBA_ASTC_8X8_KHR",n[n.RGBA_ASTC_10X5_KHR=37816]="RGBA_ASTC_10X5_KHR",n[n.RGBA_ASTC_10X6_KHR=37817]="RGBA_ASTC_10X6_KHR",n[n.RGBA_ASTC_10X8_KHR=37818]="RGBA_ASTC_10X8_KHR",n[n.RGBA_ASTC_10X10_KHR=37819]="RGBA_ASTC_10X10_KHR",n[n.RGBA_ASTC_12X10_KHR=37820]="RGBA_ASTC_12X10_KHR",n[n.RGBA_ASTC_12X12_KHR=37821]="RGBA_ASTC_12X12_KHR",n[n.SRGB8_ALPHA8_ASTC_4X4_KHR=37840]="SRGB8_ALPHA8_ASTC_4X4_KHR",n[n.SRGB8_ALPHA8_ASTC_5X4_KHR=37841]="SRGB8_ALPHA8_ASTC_5X4_KHR",n[n.SRGB8_ALPHA8_ASTC_5X5_KHR=37842]="SRGB8_ALPHA8_ASTC_5X5_KHR",n[n.SRGB8_ALPHA8_ASTC_6X5_KHR=37843]="SRGB8_ALPHA8_ASTC_6X5_KHR",n[n.SRGB8_ALPHA8_ASTC_6X6_KHR=37844]="SRGB8_ALPHA8_ASTC_6X6_KHR",n[n.SRGB8_ALPHA8_ASTC_8X5_KHR=37845]="SRGB8_ALPHA8_ASTC_8X5_KHR",n[n.SRGB8_ALPHA8_ASTC_8X6_KHR=37846]="SRGB8_ALPHA8_ASTC_8X6_KHR",n[n.SRGB8_ALPHA8_ASTC_8X8_KHR=37847]="SRGB8_ALPHA8_ASTC_8X8_KHR",n[n.SRGB8_ALPHA8_ASTC_10X5_KHR=37848]="SRGB8_ALPHA8_ASTC_10X5_KHR",n[n.SRGB8_ALPHA8_ASTC_10X6_KHR=37849]="SRGB8_ALPHA8_ASTC_10X6_KHR",n[n.SRGB8_ALPHA8_ASTC_10X8_KHR=37850]="SRGB8_ALPHA8_ASTC_10X8_KHR",n[n.SRGB8_ALPHA8_ASTC_10X10_KHR=37851]="SRGB8_ALPHA8_ASTC_10X10_KHR",n[n.SRGB8_ALPHA8_ASTC_12X10_KHR=37852]="SRGB8_ALPHA8_ASTC_12X10_KHR",n[n.SRGB8_ALPHA8_ASTC_12X12_KHR=37853]="SRGB8_ALPHA8_ASTC_12X12_KHR",n[n.RGB_ETC1_WEBGL=36196]="RGB_ETC1_WEBGL",n[n.R11_EAC=37488]="R11_EAC",n[n.SIGNED_R11_EAC=37489]="SIGNED_R11_EAC",n[n.RG11_EAC=37490]="RG11_EAC",n[n.SIGNED_RG11_EAC=37491]="SIGNED_RG11_EAC",n[n.RGB8_ETC2=37492]="RGB8_ETC2",n[n.SRGB8_ETC2=37493]="SRGB8_ETC2",n[n.RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="RGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",n[n.RGBA8_ETC2_EAC=37496]="RGBA8_ETC2_EAC",n[n.SRGB8_ALPHA8_ETC2_EAC=37497]="SRGB8_ALPHA8_ETC2_EAC",n[n.RGB_PVRTC_4BPPV1_IMG=35840]="RGB_PVRTC_4BPPV1_IMG",n[n.RGB_PVRTC_2BPPV1_IMG=35841]="RGB_PVRTC_2BPPV1_IMG",n[n.RGBA_PVRTC_4BPPV1_IMG=35842]="RGBA_PVRTC_4BPPV1_IMG",n[n.RGBA_PVRTC_2BPPV1_IMG=35843]="RGBA_PVRTC_2BPPV1_IMG",n[n.RGB_S3TC_DXT1_EXT=33776]="RGB_S3TC_DXT1_EXT",n[n.RGBA_S3TC_DXT1_EXT=33777]="RGBA_S3TC_DXT1_EXT",n[n.RGBA_S3TC_DXT3_EXT=33778]="RGBA_S3TC_DXT3_EXT",n[n.RGBA_S3TC_DXT5_EXT=33779]="RGBA_S3TC_DXT5_EXT"})(ae||(ae={}));function kl(n,l){var a=Object.keys(n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(n);l&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),a.push.apply(a,t)}return a}function Md(n){for(var l=1;l<arguments.length;l++){var a=arguments[l]!=null?arguments[l]:{};l%2?kl(Object(a),!0).forEach(function(t){Ed(n,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):kl(Object(a)).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(a,t))})}return n}function Gl(n,l){for(var a=0;a<l.length;a++){var t=l[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function Kn(n,l,a){return l&&Gl(n.prototype,l),a&&Gl(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n}function Ed(n,l,a){return l in n?Object.defineProperty(n,l,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[l]=a,n}function Li(n,l){n.prototype=Object.create(l.prototype),n.prototype.constructor=n,la(n,l)}function la(n,l){return la=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},la(n,l)}var Rd=function(){var n=l.prototype;n.resizeByClientSize=function(t){t===void 0&&(t=window.devicePixelRatio);var e=this._webCanvas;(typeof OffscreenCanvas>"u"||!(e instanceof OffscreenCanvas))&&(this.width=e.clientWidth*t,this.height=e.clientHeight*t)};function l(a){this._webCanvas=void 0,this._width=void 0,this._height=void 0,this._scale=new X;var t=a.width,e=a.height;this._webCanvas=a,this._width=t,this._height=e}return n.setScale=function(t,e){this._scale.set(t,e),this.scale=this._scale},Kn(l,[{key:"width",get:function(){return this._width},set:function(t){this._width!==t&&(this._webCanvas.width=t,this._width=t)}},{key:"height",get:function(){return this._height},set:function(t){this._height!==t&&(this._webCanvas.height=t,this._height=t)}},{key:"scale",get:function(){var t=this._webCanvas;return(typeof OffscreenCanvas>"u"||!(t instanceof OffscreenCanvas))&&this._scale.set(t.clientWidth*devicePixelRatio/t.width,t.clientHeight*devicePixelRatio/t.height),this._scale},set:function(t){var e=this._webCanvas;(typeof OffscreenCanvas>"u"||!(e instanceof OffscreenCanvas))&&(e.style.transformOrigin="left top",e.style.transform="scale("+t.x+", "+t.y+")")}}]),l}(),zd=function(){function n(a){this._maxDrawBuffers=void 0,this._maxAnisoLevel=void 0,this._maxAntiAliasing=void 0,this._rhi=void 0,this.capabilityList=void 0,this._rhi=a,this.capabilityList=new Map,this._init(),this._compatibleAllInterface()}var l=n.prototype;return l.canIUse=function(t){return this.capabilityList.get(t)},l.canIUseCompressedTextureInternalFormat=function(t){var e=ae.RGBA_ASTC_4X4_KHR,r=ae.RGBA_ASTC_12X12_KHR,i=ae.SRGB8_ALPHA8_ASTC_4X4_KHR,o=ae.SRGB8_ALPHA8_ASTC_12X12_KHR,s=ae.RGB_ETC1_WEBGL,c=ae.R11_EAC,u=ae.SRGB8_ALPHA8_ETC2_EAC,_=ae.RGB_PVRTC_4BPPV1_IMG,h=ae.RGBA_PVRTC_2BPPV1_IMG,d=ae.RGB_S3TC_DXT1_EXT,f=ae.RGBA_S3TC_DXT5_EXT;return t>=e&&r<=r||t>=i&&t<=o?this.canIUse(J.astc):t===s?this.canIUse(J.etc1):t>=c&&t<=u?this.canIUse(J.etc):t>=_&&t<=h?this.canIUse(J.pvrtc):t>=d&&t<=f?this.canIUse(J.s3tc):!1},l._init=function(){var t=this.capabilityList,e=this.rhi.isWebGL2,r=this.rhi.requireExtension.bind(this.rhi),i=J.shaderVertexID,o=J.standardDerivatives,s=J.shaderTextureLod,c=J.elementIndexUint,u=J.depthTexture,_=J.vertexArrayObject,h=J.instancedArrays,d=J.multipleSample,f=J.drawBuffers,p=J.astc,v=J.astc_webkit,m=J.etc,g=J.etc_webkit,y=J.etc1,x=J.etc1_webkit,b=J.pvrtc,S=J.pvrtc_webkit,P=J.s3tc,T=J.s3tc_webkit,E=J.textureFloat,M=J.textureHalfFloat,V=J.textureFloatLinear,A=J.textureHalfFloatLinear,C=J.WEBGL_colorBufferFloat,R=J.colorBufferFloat,z=J.colorBufferHalfFloat,F=J.textureFilterAnisotropic;t.set(i,e),t.set(o,e||!!r(o)),t.set(s,e||!!r(s)),t.set(c,e||!!r(c)),t.set(u,e||!!r(u)),t.set(_,e||!!r(_)),t.set(h,e||!!r(h)),t.set(d,e),t.set(f,e||!!r(f)),t.set(E,e||!!r(E)),t.set(M,e||!!r(M)),t.set(V,!!r(V)),t.set(A,e||!!r(A)),t.set(R,e&&!!r(R)||!!r(C)),t.set(z,e&&!!r(R)||!!r(z)),t.set(F,!!r(F)),t.set(p,!!(r(p)||r(v))),t.set(m,!!(r(m)||r(g))),t.set(y,!!(r(y)||r(x))),t.set(b,!!(r(b)||r(S))),t.set(P,!!(r(P)||r(T)))},l._compatibleInterface=function(t,e){var r=this.rhi,i=r.gl,o=null;if(o=r.requireExtension(t))for(var s in e){var c=e[s],u=o[c];u!=null&&u.bind?i[s]=u.bind(o):i[s]=u}},l._compatibleAllInterface=function(){var t=J.depthTexture,e=J.vertexArrayObject,r=J.instancedArrays,i=J.drawBuffers,o=J.textureFilterAnisotropic,s=J.textureHalfFloat,c=J.colorBufferHalfFloat,u=J.WEBGL_colorBufferFloat,_=this.rhi.isWebGL2;if(!_){this._compatibleInterface(t,{UNSIGNED_INT_24_8:"UNSIGNED_INT_24_8_WEBGL"}),this._compatibleInterface(e,{createVertexArray:"createVertexArrayOES",deleteVertexArray:"deleteVertexArrayOES",isVertexArray:"isVertexArrayOES",bindVertexArray:"bindVertexArrayOES"}),this._compatibleInterface(r,{drawArraysInstanced:"drawArraysInstancedANGLE",drawElementsInstanced:"drawElementsInstancedANGLE",vertexAttribDivisor:"vertexAttribDivisorANGLE"}),this._compatibleInterface(i,{MAX_DRAW_BUFFERS:"MAX_DRAW_BUFFERS_WEBGL"});var h={};if(this.canIUse(J.drawBuffers)){for(var d=this.maxDrawBuffers,f=0;f<d;f++)f!=0&&(h["COLOR_ATTACHMENT"+f]="COLOR_ATTACHMENT"+f+"_WEBGL"),h["DRAW_BUFFER"+f]="DRAW_BUFFER"+f+"_WEBGL";this._compatibleInterface(i,Md({drawBuffers:"drawBuffersWEBGL"},h))}this._compatibleInterface(s,{HALF_FLOAT:"HALF_FLOAT_OES"}),this._compatibleInterface(c,{RGBA16F:"RBGA16F_EXT"}),this._compatibleInterface(u,{RGBA32F:"RBGA32F_EXT"})}this._compatibleInterface(o,{TEXTURE_MAX_ANISOTROPY_EXT:"TEXTURE_MAX_ANISOTROPY_EXT"})},Kn(n,[{key:"maxTextureSize",get:function(){return this.rhi.renderStates.getParameter(this.rhi.gl.MAX_TEXTURE_SIZE)}},{key:"canUseFloatTextureBlendShape",get:function(){return this.canIUse(J.shaderVertexID)&&this.canIUse(J.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"canIUseMoreJoints",get:function(){return this.canIUse(J.textureFloat)&&this.rhi.renderStates.getParameter(this.rhi.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0}},{key:"maxDrawBuffers",get:function(){return this._maxDrawBuffers||(this.canIUse(J.drawBuffers)?this._maxDrawBuffers=this._rhi.gl.getParameter(this._rhi.gl.MAX_DRAW_BUFFERS):this._maxDrawBuffers=1),this._maxDrawBuffers}},{key:"maxAnisoLevel",get:function(){if(!this._maxAnisoLevel){var t=this._rhi.requireExtension(J.textureFilterAnisotropic);this._maxAnisoLevel=t?this._rhi.gl.getParameter(t.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1}return this._maxAnisoLevel}},{key:"maxAntiAliasing",get:function(){if(!this._maxAntiAliasing){var t=this._rhi.gl,e=this.canIUse(J.multipleSample);this._maxAntiAliasing=e?t.getParameter(t.MAX_SAMPLES):1}return this._maxAntiAliasing}},{key:"rhi",get:function(){return this._rhi}}]),n}(),Fd=function(){function n(a){this.rhi=void 0,this._requireResult=void 0,this.rhi=a,this._requireResult={}}var l=n.prototype;return l.requireExtension=function(t){return this._requireResult[t]!==void 0?this._requireResult[t]:(this._requireResult[t]=this.rhi.gl.getExtension(t),this._requireResult[t])},n}(),Bd=function(){function n(a,t){this.attribLocArray=[],this._primitive=void 0,this.canUseInstancedArrays=void 0,this.gl=void 0,this.vao=new Map,this._useVao=void 0,this._primitive=t,this.canUseInstancedArrays=a.canIUse(J.instancedArrays),this._useVao=a.canIUse(J.vertexArrayObject),this.gl=a.gl}var l=n.prototype;return l.draw=function(t,e){var r=this.gl,i=this._primitive,o=this._useVao&&i._enableVAO;if(o){this.vao.has(t.id)||this.registerVAO(t);var s=this.vao.get(t.id);r.bindVertexArray(s)}else this.bindBufferAndAttrib(t);var c=i._indexBufferBinding,u=i._instanceCount,_=i._glIndexType,h=i._glIndexByteCount,d=e.topology,f=e.start,p=e.count;if(u)if(this.canUseInstancedArrays)if(c)if(this._useVao)r.drawElementsInstanced(d,p,_,f*h,u);else{var m=c.buffer._nativeBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,m),r.drawElementsInstanced(d,p,_,f*h,u),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArraysInstanced(d,f,p,u);else ce.error("ANGLE_instanced_arrays extension is not supported");else if(c)if(o)r.drawElements(d,p,_,f*h);else{var v=c.buffer._nativeBuffer;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,v),r.drawElements(d,p,_,f*h),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,null)}else r.drawArrays(d,f,p);this._useVao?r.bindVertexArray(null):this.disableAttrib()},l.destroy=function(){if(this._useVao){var t=this.gl;this.vao.forEach(function(e){t.deleteVertexArray(e)}),this.vao.clear()}},l.bindBufferAndAttrib=function(t){var e=this.gl,r=this._primitive,i=r._vertexBufferBindings;this.attribLocArray.length=0;var o=t.attributeLocation,s=r._vertexElementMap,c,u;for(var _ in o){var h=o[_];if(h!==-1){var d=s[_];if(d){var f=i[d.bindingIndex],p=f.buffer,v=f.stride;c=p._nativeBuffer,u!==c&&(u=c,e.bindBuffer(e.ARRAY_BUFFER,c)),e.enableVertexAttribArray(h);var m=d._glElementInfo;e.vertexAttribPointer(h,m.size,m.type,m.normalized,v,d.offset),this.canUseInstancedArrays&&e.vertexAttribDivisor(h,d.instanceStepRate),this.attribLocArray.push(h)}else ce.warn("vertex attribute not found: "+_)}}e.bindBuffer(e.ARRAY_BUFFER,null)},l.disableAttrib=function(){for(var t=this.gl,e=0,r=this.attribLocArray.length;e<r;e++)t.disableVertexAttribArray(this.attribLocArray[e])},l.registerVAO=function(t){var e=this.gl,r=e.createVertexArray();e.bindVertexArray(r);var i=this._primitive._indexBufferBinding;i&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,i.buffer._nativeBuffer),this.bindBufferAndAttrib(t),e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),this.disableAttrib(),this.vao.set(t.id,r)},n}(),Vd=function(){function n(a){this._gl=void 0,this._parameters={},this._gl=a,this._parameters={},this._parameters[a.MAX_COMBINED_TEXTURE_IMAGE_UNITS]=a.getParameter(a.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this._parameters[a.MAX_VERTEX_UNIFORM_VECTORS]=a.getParameter(a.MAX_VERTEX_UNIFORM_VECTORS),this._parameters[a.MAX_VERTEX_ATTRIBS]=a.getParameter(a.MAX_VERTEX_ATTRIBS),this._parameters[a.MAX_VERTEX_TEXTURE_IMAGE_UNITS]=a.getParameter(a.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._parameters[a.MAX_TEXTURE_SIZE]=a.getParameter(a.MAX_TEXTURE_SIZE),a.blendFuncSeparate(a.ONE,a.ZERO,a.ONE,a.ZERO),a.blendEquationSeparate(a.FUNC_ADD,a.FUNC_ADD),a.colorMask(!0,!0,!0,!0),a.blendColor(0,0,0,0),a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),a.enable(a.DEPTH_TEST),a.depthFunc(a.LESS),a.depthMask(!0),a.disable(a.STENCIL_TEST),a.stencilFuncSeparate(a.FRONT,a.ALWAYS,0,255),a.stencilFuncSeparate(a.BACK,a.ALWAYS,0,255),a.stencilOpSeparate(a.FRONT,a.KEEP,a.KEEP,a.KEEP),a.stencilOpSeparate(a.BACK,a.KEEP,a.KEEP,a.KEEP),a.stencilMask(255),a.enable(a.CULL_FACE),a.cullFace(a.BACK),a.disable(a.POLYGON_OFFSET_FILL),a.polygonOffset(0,0)}var l=n.prototype;return l.getParameter=function(t){return this._parameters[t]},n}(),Qe=function(){n._isPowerOf2=function(t){return(t&t-1)===0},n._getFormatDetail=function(t,e,r){switch(t){case H.R8G8B8:return{internalFormat:r?e.RGB8:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case H.R8G8B8A8:return{internalFormat:r?e.RGBA8:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case H.R4G4B4A4:return{internalFormat:r?e.RGBA4:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_4_4_4_4,isCompressed:!1};case H.R5G5B5A1:return{internalFormat:r?e.RGB5_A1:e.RGBA,baseFormat:e.RGBA,dataType:e.UNSIGNED_SHORT_5_5_5_1,isCompressed:!1};case H.R5G6B5:return{internalFormat:r?e.RGB565:e.RGB,baseFormat:e.RGB,dataType:e.UNSIGNED_SHORT_5_6_5,isCompressed:!1};case H.Alpha8:return{internalFormat:e.ALPHA,baseFormat:e.ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case H.LuminanceAlpha:return{internalFormat:e.LUMINANCE_ALPHA,baseFormat:e.LUMINANCE_ALPHA,dataType:e.UNSIGNED_BYTE,isCompressed:!1};case H.R16G16B16A16:return{internalFormat:r?e.RGBA16F:e.RGBA,baseFormat:e.RGBA,dataType:e.HALF_FLOAT,isCompressed:!1};case H.R32G32B32A32:return{internalFormat:r?e.RGBA32F:e.RGBA,baseFormat:e.RGBA,dataType:e.FLOAT,isCompressed:!1};case H.DXT1:return{internalFormat:ae.RGB_S3TC_DXT1_EXT,isCompressed:!0};case H.DXT5:return{internalFormat:ae.RGBA_S3TC_DXT5_EXT,isCompressed:!0};case H.ETC1_RGB:return{internalFormat:ae.RGB_ETC1_WEBGL,isCompressed:!0};case H.ETC2_RGB:return{internalFormat:ae.RGB8_ETC2,isCompressed:!0};case H.ETC2_RGBA5:return{internalFormat:ae.RGB8_PUNCHTHROUGH_ALPHA1_ETC2,isCompressed:!0};case H.ETC2_RGBA8:return{internalFormat:ae.RGBA8_ETC2_EAC,isCompressed:!0};case H.PVRTC_RGB2:return{internalFormat:ae.RGB_PVRTC_2BPPV1_IMG,isCompressed:!0};case H.PVRTC_RGBA2:return{internalFormat:ae.RGBA_PVRTC_2BPPV1_IMG,isCompressed:!0};case H.PVRTC_RGB4:return{internalFormat:ae.RGB_PVRTC_4BPPV1_IMG,isCompressed:!0};case H.PVRTC_RGBA4:return{internalFormat:ae.RGBA_PVRTC_4BPPV1_IMG,isCompressed:!0};case H.ASTC_4x4:return{internalFormat:ae.RGBA_ASTC_4X4_KHR,isCompressed:!0};case H.ASTC_5x5:return{internalFormat:ae.RGBA_ASTC_5X5_KHR,isCompressed:!0};case H.ASTC_6x6:return{internalFormat:ae.RGBA_ASTC_6X6_KHR,isCompressed:!0};case H.ASTC_8x8:return{internalFormat:ae.RGBA_ASTC_8X8_KHR,isCompressed:!0};case H.ASTC_10x10:return{internalFormat:ae.RGBA_ASTC_10X10_KHR,isCompressed:!0};case H.ASTC_12x12:return{internalFormat:ae.RGBA_ASTC_12X12_KHR,isCompressed:!0};case H.Depth:return{internalFormat:r?e.DEPTH_COMPONENT32F:e.DEPTH_COMPONENT,baseFormat:e.DEPTH_COMPONENT,dataType:r?e.FLOAT:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case H.DepthStencil:return{internalFormat:r?e.DEPTH32F_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:r?e.FLOAT_32_UNSIGNED_INT_24_8_REV:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case H.Depth16:return{internalFormat:r?e.DEPTH_COMPONENT16:e.DEPTH_COMPONENT,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case H.Depth24Stencil8:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case H.Depth24:return{internalFormat:e.DEPTH_COMPONENT24,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case H.Depth32:return{internalFormat:e.DEPTH_COMPONENT32F,baseFormat:e.DEPTH_COMPONENT,dataType:e.FLOAT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case H.Depth32Stencil8:return{internalFormat:e.DEPTH32F_STENCIL8,baseFormat:e.DEPTH_STENCIL,dataType:e.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+t)}},n._getRenderBufferDepthFormatDetail=function(t,e,r){switch(t){case $e.Depth:return{internalFormat:r?e.DEPTH_COMPONENT32F:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:r?e.FLOAT:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case $e.DepthStencil:return{internalFormat:r?e.DEPTH32F_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:r?e.FLOAT_32_UNSIGNED_INT_24_8_REV:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case $e.Stencil:return{internalFormat:e.STENCIL_INDEX8,baseFormat:e.STENCIL_ATTACHMENT,dataType:e.UNSIGNED_BYTE,isCompressed:!1,attachment:e.STENCIL_ATTACHMENT};case $e.Depth16:return{internalFormat:e.DEPTH_COMPONENT16,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_SHORT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case $e.Depth24Stencil8:return{internalFormat:r?e.DEPTH24_STENCIL8:e.DEPTH_STENCIL,baseFormat:e.DEPTH_STENCIL,dataType:e.UNSIGNED_INT_24_8,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};case $e.Depth24:return{internalFormat:e.DEPTH_COMPONENT24,baseFormat:e.DEPTH_COMPONENT,dataType:e.UNSIGNED_INT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case $e.Depth32:return{internalFormat:e.DEPTH_COMPONENT32F,baseFormat:e.DEPTH_COMPONENT,dataType:e.FLOAT,isCompressed:!1,attachment:e.DEPTH_ATTACHMENT};case $e.Depth32Stencil8:return{internalFormat:e.DEPTH32F_STENCIL8,baseFormat:e.DEPTH_STENCIL,dataType:e.FLOAT_32_UNSIGNED_INT_24_8_REV,isCompressed:!1,attachment:e.DEPTH_STENCIL_ATTACHMENT};default:throw new Error("this TextureFormat is not supported in Oasis Engine: "+t)}},n._supportTextureFormat=function(t,e){switch(t){case H.R16G16B16A16:if(!e.canIUse(J.textureHalfFloat))return!1;break;case H.R32G32B32A32:if(!e.canIUse(J.textureFloat))return!1;break;case H.Depth16:case H.Depth24Stencil8:case H.Depth:case H.DepthStencil:if(!e.canIUse(J.depthTexture))return!1;break;case H.Depth24:case H.Depth32:case H.Depth32Stencil8:return e.isWebGL2}return!0},n._supportRenderBufferColorFormat=function(t,e){var r=!0;switch(t){case H.R16G16B16A16:(!e.canIUse(J.colorBufferHalfFloat)||!e.canIUse(J.textureHalfFloat))&&(r=!1);break;case H.R32G32B32A32:(!e.canIUse(J.colorBufferFloat)||!e.canIUse(J.textureFloat))&&(r=!1);break}return r},n._supportRenderBufferDepthFormat=function(t,e){if(!e.isWebGL2)switch(t){case $e.Depth24:case $e.Depth32:case $e.Depth32Stencil8:return!1}return!0};function n(a,t,e){this._texture=void 0,this._glTexture=void 0,this._rhi=void 0,this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._formatDetail=void 0,this._texture=t,this._rhi=a,this._gl=a.gl,this._isWebGL2=a.isWebGL2,this._target=e,this._glTexture=this._gl.createTexture()}var l=n.prototype;return l.destroy=function(){this._gl.deleteTexture(this._glTexture),this._texture=null,this._glTexture=null,this._formatDetail=null},l.setUseDepthCompareMode=function(t){var e=this._gl;e.texParameteri(this._target,e.TEXTURE_COMPARE_MODE,t?e.COMPARE_REF_TO_TEXTURE:e.NONE)},l.generateMipmaps=function(){this._bind(),this._gl.generateMipmap(this._target)},l._bind=function(){this._rhi.bindTexture(this)},l._init=function(t){var e=this._gl,r=this._isWebGL2,i=this._formatDetail,o=i.internalFormat,s=i.baseFormat,c=i.dataType,u=this._texture,_=u.mipmapCount,h=u.width,d=u.height,f=u._isDepthTexture;if(this._bind(),r&&!(s===e.LUMINANCE_ALPHA||s===e.ALPHA))e.texStorage2D(this._target,_,o,h,d);else if(t)for(var g=0;g<_;g++)for(var y=Math.max(1,h>>g),x=0;x<6;x++)e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+x,g,o,y,y,0,s,c,null);else if(f)e.texImage2D(this._target,0,o,h,d,0,s,c,null);else for(var p=0;p<_;p++){var v=Math.max(1,h>>p),m=Math.max(1,d>>p);e.texImage2D(this._target,p,o,v,m,0,s,c,null)}},l._getPixelBuffer=function(t,e,r,i,o,s,c){var u=this._gl,_=this._formatDetail,h=_.baseFormat,d=_.dataType;u.bindFramebuffer(u.FRAMEBUFFER,this._getReadFrameBuffer()),s>0&&!this._isWebGL2&&(s=0,ce.error("mipLevel only take effect in WebGL2.0")),t!=null?u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_CUBE_MAP_POSITIVE_X+t,this._glTexture,s):u.framebufferTexture2D(u.FRAMEBUFFER,u.COLOR_ATTACHMENT0,u.TEXTURE_2D,this._glTexture,s),u.readPixels(e,r,i,o,h,d,c),u.bindFramebuffer(u.FRAMEBUFFER,null)},l._setWrapMode=function(t,e){var r=this._gl,i=this._isWebGL2,o=this._target,s=this._texture,c=s.width,u=s.height;switch(!i&&t!==pt.Clamp&&(!n._isPowerOf2(c)||!n._isPowerOf2(u))&&(ce.warn("non-power-2 texture is not supported for REPEAT or MIRRORED_REPEAT in WebGL1,and has automatically downgraded to CLAMP_TO_EDGE"),t=pt.Clamp),t){case pt.Clamp:r.texParameteri(o,e,r.CLAMP_TO_EDGE);break;case pt.Repeat:r.texParameteri(o,e,r.REPEAT);break;case pt.Mirror:r.texParameteri(o,e,r.MIRRORED_REPEAT);break}},l._getReadFrameBuffer=function(){var t=this._rhi._readFrameBuffer;return t||(this._rhi._readFrameBuffer=t=this._gl.createFramebuffer()),t},Kn(n,[{key:"wrapModeU",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_S)}},{key:"wrapModeV",set:function(t){this._bind(),this._setWrapMode(t,this._gl.TEXTURE_WRAP_T)}},{key:"filterMode",set:function(t){var e=this._gl,r=this._target,i=this._texture._mipmap;switch(this._bind(),t){case gt.Point:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(r,e.TEXTURE_MIN_FILTER,i?e.NEAREST_MIPMAP_NEAREST:e.NEAREST);break;case gt.Bilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,i?e.LINEAR_MIPMAP_NEAREST:e.LINEAR);break;case gt.Trilinear:e.texParameteri(r,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(r,e.TEXTURE_MIN_FILTER,i?e.LINEAR_MIPMAP_LINEAR:e.LINEAR);break}}},{key:"anisoLevel",set:function(t){var e=this._gl;this._bind(),e.texParameterf(this._target,e.TEXTURE_MAX_ANISOTROPY_EXT,t)}},{key:"depthCompareFunction",set:function(t){this._bind();var e=this._gl;switch(t){case Vt.Never:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.NEVER);break;case Vt.Less:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.LESS);break;case Vt.Equal:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.EQUAL);break;case Vt.LessEqual:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.LEQUAL);break;case Vt.Greater:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.GREATER);break;case Vt.NotEqual:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.NOTEQUAL);break;case Vt.GreaterEqual:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.GEQUAL);break;case Vt.Always:e.texParameteri(this._target,e.TEXTURE_COMPARE_FUNC,e.ALWAYS);break}}}]),n}(),Dd=function(){function n(a,t){this._gl=void 0,this._isWebGL2=void 0,this._target=void 0,this._frameBuffer=void 0,this._MSAAFrameBuffer=void 0,this._depthRenderBuffer=void 0,this._MSAAColorRenderBuffers=[],this._MSAADepthRenderBuffer=void 0,this._oriDrawBuffers=void 0,this._blitDrawBuffers=void 0,this._curMipLevel=0,this._gl=a.gl,this._isWebGL2=a.isWebGL2,this._target=t;for(var e=t._colorTextures,r=t._depth,i=t.width,o=t.height,s=r instanceof rr,c=0,u=e.length;c<u;c++){var _=e[c]._format;if(!Qe._supportRenderBufferColorFormat(_,a))throw new Error("TextureFormat is not supported:"+H[_]+" in RenderTarget")}if(!s&&!Qe._supportRenderBufferDepthFormat(r,a))throw new Error("TextureFormat is not supported:"+H[r]+" in RenderTarget");if(e.length>1&&!a.canIUse(J.drawBuffers))throw new Error("MRT is not supported");if(e.some(function(d){return d.width!==i||d.height!==o}))throw new Error("ColorTexture's size must as same as RenderTarget");if(s&&(r.width!==i||r.height!==o))throw new Error("DepthTexture's size must as same as RenderTarget");if(e.length>1&&e.some(function(d){return d instanceof Ct}))throw new Error("MRT+Cube+[,MSAA] is not supported");var h=a.capability.maxAntiAliasing;t.antiAliasing>h&&(ce.warn("MSAA antiAliasing exceeds the limit and is automatically downgraded to:"+h),t._antiAliasing=h),this._frameBuffer=this._gl.createFramebuffer(),this._bindMainFBO(),t.antiAliasing>1&&(this._MSAAFrameBuffer=this._gl.createFramebuffer(),this._bindMSAAFBO())}var l=n.prototype;return l.setRenderTargetInfo=function(t,e){var r=this._gl,i=this._target,o=i.depthTexture,s=i.getColorTexture(0),c=e!==this._curMipLevel;if(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),s){var u=s instanceof Ct;(c||u)&&r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,u?r.TEXTURE_CUBE_MAP_POSITIVE_X+t:r.TEXTURE_2D,s._platformTexture._glTexture,e)}if(o){var _=o instanceof Ct;if(c||_){var h=o._platformTexture;r.framebufferTexture2D(r.FRAMEBUFFER,h._formatDetail.attachment,_?r.TEXTURE_CUBE_MAP_POSITIVE_X+t:r.TEXTURE_2D,h._glTexture,e)}}else if(c){var d=Qe._getRenderBufferDepthFormatDetail(i._depth,r,this._isWebGL2),f=d.internalFormat;r.bindRenderbuffer(r.RENDERBUFFER,this._depthRenderBuffer),r.renderbufferStorage(r.RENDERBUFFER,f,i.width>>e,i.height>>e)}this._curMipLevel=e,this._activeRenderTarget()},l.blitRenderTarget=function(){if(!!this._MSAAFrameBuffer){var t=this._gl,e=t.COLOR_BUFFER_BIT|(this._target.depthTexture?t.DEPTH_BUFFER_BIT:0),r=this._target,i=r.colorTextureCount,o=r.width,s=r.height;t.bindFramebuffer(t.READ_FRAMEBUFFER,this._MSAAFrameBuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this._frameBuffer);for(var c=0;c<i;c++){var u=t.COLOR_ATTACHMENT0+c;this._blitDrawBuffers[c]=u,t.readBuffer(u),t.drawBuffers(this._blitDrawBuffers),t.blitFramebuffer(0,0,o,s,0,0,o,s,e,t.NEAREST),this._blitDrawBuffers[c]=t.NONE}t.bindFramebuffer(t.FRAMEBUFFER,null)}},l.destroy=function(){var t=this._gl;this._frameBuffer&&t.deleteFramebuffer(this._frameBuffer),this._depthRenderBuffer&&t.deleteRenderbuffer(this._depthRenderBuffer),this._MSAAFrameBuffer&&t.deleteFramebuffer(this._MSAAFrameBuffer),this._MSAADepthRenderBuffer&&t.deleteRenderbuffer(this._MSAADepthRenderBuffer);for(var e=0;e<this._MSAAColorRenderBuffers.length;e++)t.deleteRenderbuffer(this._MSAAColorRenderBuffers[e]);this._frameBuffer=null,this._depthRenderBuffer=null,this._MSAAFrameBuffer=null,this._MSAAColorRenderBuffers.length=0,this._MSAADepthRenderBuffer=null},l._activeRenderTarget=function(){var t=this._gl;this._MSAAFrameBuffer?t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer):t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer)},l._bindMainFBO=function(){var t=this._gl,e=this._isWebGL2,r=this._target,i=r._depth,o=r.colorTextureCount,s=r.width,c=r.height,u=new Array(o);t.bindFramebuffer(t.FRAMEBUFFER,this._frameBuffer);for(var _=0;_<o;_++){var h=this._target.getColorTexture(_),d=t.COLOR_ATTACHMENT0+_;u[_]=d,h instanceof Ct||t.framebufferTexture2D(t.FRAMEBUFFER,d,t.TEXTURE_2D,h._platformTexture._glTexture,0)}if(o>1&&t.drawBuffers(u),this._oriDrawBuffers=u,i!==null){if(i instanceof rr&&!(i instanceof Ct)){var f=i._platformTexture;t.framebufferTexture2D(t.FRAMEBUFFER,f._formatDetail.attachment,t.TEXTURE_2D,f._glTexture,0)}else if(this._target.antiAliasing<=1){var p=Qe._getRenderBufferDepthFormatDetail(i,t,e),v=p.internalFormat,m=p.attachment,g=t.createRenderbuffer();this._depthRenderBuffer=g,t.bindRenderbuffer(t.RENDERBUFFER,g),t.renderbufferStorage(t.RENDERBUFFER,v,s,c),t.framebufferRenderbuffer(t.FRAMEBUFFER,m,t.RENDERBUFFER,g)}}t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},l._bindMSAAFBO=function(){var t=this._gl,e=this._isWebGL2,r=t.createRenderbuffer(),i=this._target,o=i._depth,s=i.colorTextureCount,c=i.antiAliasing,u=i.width,_=i.height;this._blitDrawBuffers=new Array(s),this._MSAADepthRenderBuffer=r,t.bindFramebuffer(t.FRAMEBUFFER,this._MSAAFrameBuffer);for(var h=0;h<s;h++){var d=t.createRenderbuffer();this._MSAAColorRenderBuffers[h]=d,this._blitDrawBuffers[h]=t.NONE,t.bindRenderbuffer(t.RENDERBUFFER,d),t.renderbufferStorageMultisample(t.RENDERBUFFER,c,this._target.getColorTexture(h)._platformTexture._formatDetail.internalFormat,u,_),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0+h,t.RENDERBUFFER,d)}if(t.drawBuffers(this._oriDrawBuffers),o!==null){var f=o instanceof rr?o._platformTexture._formatDetail:Qe._getRenderBufferDepthFormatDetail(o,t,e),p=f.internalFormat,v=f.attachment;t.bindRenderbuffer(t.RENDERBUFFER,r),t.renderbufferStorageMultisample(t.RENDERBUFFER,c,p,u,_),t.framebufferRenderbuffer(t.FRAMEBUFFER,v,t.RENDERBUFFER,r)}this._checkFrameBuffer(),t.bindFramebuffer(t.FRAMEBUFFER,null),t.bindRenderbuffer(t.RENDERBUFFER,null)},l._checkFrameBuffer=function(){var t=this._gl,e=this._isWebGL2,r=t.checkFramebufferStatus(t.FRAMEBUFFER);switch(r){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw new Error("The attachment types are mismatched or not all framebuffer attachment points are framebuffer attachment complete");case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw new Error("There is no attachment");case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw new Error(" Height and width of the attachment are not the same.");case t.FRAMEBUFFER_UNSUPPORTED:throw new Error("The format of the attachment is not supported or if depth and stencil attachments are not the same renderbuffer")}if(e&&r===t.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE)throw new Error("The values of gl.RENDERBUFFER_SAMPLES are different among attached renderbuffers, or are non-zero if the attached images are a mix of renderbuffers and textures.")},n}(),Ld=function(n){Li(l,n);function l(t,e){var r;r=n.call(this,t,e,t.gl.TEXTURE_2D)||this,r._compressedMipFilled=0;var i=e.format,o=e._mipmap,s=e.width,c=e.height,u=r._isWebGL2;if(!Qe._supportTextureFormat(i,t))throw new Error("Texture format is not supported:"+H[i]);return o&&!u&&(!Qe._isPowerOf2(s)||!Qe._isPowerOf2(c))&&(ce.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=Qe._getFormatDetail(i,r._gl,u),r._formatDetail.isCompressed&&!u||r._init(!1),r}var a=l.prototype;return a.setPixelBuffer=function(e,r,i,o,s,c){r===void 0&&(r=0);var u=this._gl,_=this._isWebGL2,h=this._formatDetail,d=h.internalFormat,f=h.baseFormat,p=h.dataType,v=h.isCompressed,m=Math.max(1,this._texture.width>>r),g=Math.max(1,this._texture.height>>r);if(s=s||m-i,c=c||g-o,this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,0),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),v){var y=1<<r;_||this._compressedMipFilled&y?u.compressedTexSubImage2D(this._target,r,i,o,s,c,d,e):(u.compressedTexImage2D(this._target,r,d,s,c,0,e),this._compressedMipFilled|=y)}else u.texSubImage2D(this._target,r,i,o,s,c,f,p,e)},a.setImageSource=function(e,r,i,o,s,c){var u=this._gl,_=this._formatDetail,h=_.baseFormat,d=_.dataType;this._bind(),u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,+i),u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+o),u.texSubImage2D(this._target,r,s||0,c||0,h,d,e)},a.getPixelBuffer=function(e,r,i,o,s,c){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");n.prototype._getPixelBuffer.call(this,null,e,r,i,o,s,c)},l}(Qe),Id=function(n){Li(l,n);function l(t,e){var r;r=n.call(this,t,e,t.gl.TEXTURE_2D_ARRAY)||this;var i=e.format,o=e.width,s=e.height,c=e.length,u=e.mipmapCount;if(!r._isWebGL2)throw new Error("Texture2D Array is not supported in WebGL1.0");if(!Qe._supportTextureFormat(i,t))throw new Error("Texture format is not supported:"+H[i]);return r._bind(),r._formatDetail=Qe._getFormatDetail(i,r._gl,!0),r._gl.texStorage3D(r._target,u,r._formatDetail.internalFormat,o,s,c),r}var a=l.prototype;return a.setPixelBuffer=function(e,r,i,o,s,c,u,_){var h=this._target,d=this._gl,f=this._formatDetail,p=f.internalFormat,v=f.baseFormat,m=f.dataType,g=f.isCompressed;c=c||Math.max(1,this._texture.width>>i)-o,u=u||Math.max(1,this._texture.height>>i)-s,_=_||this._texture.length,this._bind(),d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,0),d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),g?d.compressedTexSubImage3D(h,i,o,s,e,c,u,_,p,r):d.texSubImage3D(h,i,o,s,e,c,u,_,v,m,r)},a.setImageSource=function(e,r,i,o,s,c,u){var _=this._gl,h=this._formatDetail,d=h.baseFormat,f=h.dataType;this._bind(),_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,+o),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+s),_.texSubImage3D(this._target,i,c,u,e,r.width,r.height,1,d,f,r)},a.getPixelBuffer=function(e,r,i,o,s,c,u){var _=this._gl,h=this._formatDetail;if(h.isCompressed)throw new Error("Unable to read compressed texture");_.bindFramebuffer(_.FRAMEBUFFER,this._getReadFrameBuffer()),_.framebufferTextureLayer(_.FRAMEBUFFER,_.COLOR_ATTACHMENT0,this._glTexture,c,e),_.readPixels(r,i,o,s,h.baseFormat,h.dataType,u),_.bindFramebuffer(_.FRAMEBUFFER,null)},l}(Qe),Od=function(n){Li(l,n);function l(t,e){var r;r=n.call(this,t,e,t.gl.TEXTURE_CUBE_MAP)||this,r._compressedFaceFilled=[0,0,0,0,0,0];var i=e.format,o=e._mipmap,s=e.width,c=r._isWebGL2;if(!Qe._supportTextureFormat(i,t))throw new Error("Texture format is not supported:"+H[i]);return o&&!c&&!Qe._isPowerOf2(s)&&(ce.warn("non-power-2 texture is not supported for mipmap in WebGL1,and has automatically downgraded to non-mipmap"),e._mipmap=!1,e._mipmapCount=e._getMipmapCount()),r._formatDetail=Qe._getFormatDetail(i,r._gl,c),r._formatDetail.isCompressed&&!c||r._init(!0),r}var a=l.prototype;return a.setPixelBuffer=function(e,r,i,o,s,c,u){var _=this._gl,h=this._isWebGL2,d=this._formatDetail,f=d.internalFormat,p=d.baseFormat,v=d.dataType,m=d.isCompressed,g=Math.max(1,this._texture.width>>i);if(c=c||g-o,u=u||g-s,this._bind(),_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,0),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,0),m){var y=1<<i;h||this._compressedFaceFilled[e]&y?_.compressedTexSubImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X+e,i,o,s,c,u,f,r):(_.compressedTexImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X+e,i,f,c,u,0,r),this._compressedFaceFilled[e]|=y)}else _.texSubImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X+e,i,o,s,c,u,p,v,r)},a.setImageSource=function(e,r,i,o,s,c,u){var _=this._gl,h=this._formatDetail,d=h.baseFormat,f=h.dataType;this._bind(),_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,+o),_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,+s),_.texSubImage2D(_.TEXTURE_CUBE_MAP_POSITIVE_X+e,i,c||0,u||0,d,f,r)},a.getPixelBuffer=function(e,r,i,o,s,c,u){if(this._formatDetail.isCompressed)throw new Error("Unable to read compressed texture");n.prototype._getPixelBuffer.call(this,e,r,i,o,s,c,u)},l}(Qe),jr;(function(n){n[n.Auto=0]="Auto",n[n.WebGL2=1]="WebGL2",n[n.WebGL1=2]="WebGL1"})(jr||(jr={}));var Nd=function(){function n(a){a===void 0&&(a={}),this._readFrameBuffer=void 0,this._currentBind=void 0,this._options=void 0,this._gl=void 0,this._renderStates=void 0,this._extensions=void 0,this._capability=void 0,this._isWebGL2=void 0,this._renderer=void 0,this._webCanvas=void 0,this._activeTextureID=void 0,this._activeTextures=new Array(32),this._lastViewport=new ve(null,null,null,null),this._lastClearColor=new re(null,null,null,null),this._scissorEnable=!1,this._options=a}var l=n.prototype;return l.init=function(t){var e=this._options;e.alpha===void 0&&(e.alpha=!1),e.stencil===void 0&&(e.stencil=!0);var r=this._webCanvas=t._webCanvas,i=e.webGLMode||jr.Auto,o;if((i==jr.Auto||i==jr.WebGL2)&&(o=r.getContext("webgl2",e),!o&&(typeof OffscreenCanvas>"u"||!(r instanceof OffscreenCanvas))&&(o=r.getContext("experimental-webgl2",e)),this._isWebGL2=!0,o&&!o.deleteQuery&&(this._isWebGL2=!1)),o||(i==jr.Auto||i==jr.WebGL1)&&(o=r.getContext("webgl",e),!o&&(typeof OffscreenCanvas>"u"||!(r instanceof OffscreenCanvas))&&(o=r.getContext("experimental-webgl",e)),this._isWebGL2=!1),!o)throw new Error("Get GL Context FAILED.");this._gl=o,this._activeTextureID=o.TEXTURE0,this._renderStates=new Vd(o),this._extensions=new Fd(this),this._capability=new zd(this),o.activeTexture(o.TEXTURE0);var s=o.getExtension("WEBGL_debug_renderer_info");s!=null&&(this._renderer=o.getParameter(s.UNMASKED_RENDERER_WEBGL)),this._options=null},l.createPlatformPrimitive=function(t){return new Bd(this,t)},l.createPlatformTexture2D=function(t){return new Ld(this,t)},l.createPlatformTexture2DArray=function(t){return new Id(this,t)},l.createPlatformTextureCube=function(t){return new Od(this,t)},l.createPlatformRenderTarget=function(t){return new Dd(this,t)},l.requireExtension=function(t){return this._extensions.requireExtension(t)},l.canIUse=function(t){return this.capability.canIUse(t)},l.canIUseCompressedTextureInternalFormat=function(t){return this.capability.canIUseCompressedTextureInternalFormat(t)},l.viewport=function(t,e,r,i){var o=this._gl,s=this._lastViewport;if(t!==s.x||e!==s.y||r!==s.z||i!==s.w){var c=this._webCanvas;t===0&&e===0&&r===c.width&&i===c.height?this._scissorEnable&&(o.disable(o.SCISSOR_TEST),this._scissorEnable=!1):(this._scissorEnable||(o.enable(o.SCISSOR_TEST),this._scissorEnable=!0),o.scissor(t,e,r,i)),o.viewport(t,e,r,i),s.set(t,e,r,i)}},l.colorMask=function(t,e,r,i){this._gl.colorMask(t,e,r,i)},l.clearRenderTarget=function(t,e,r){var i=this._gl,o=t._lastRenderState,s=o.blendState.targetBlendState,c=o.depthState,u=o.stencilState,_=0;if(e&It.Color){_|=i.COLOR_BUFFER_BIT;var h=this._lastClearColor,d=r.r,f=r.g,p=r.b,v=r.a;r&&(d!==h.r||f!==h.g||p!==h.b||v!==h.a)&&(i.clearColor(d,f,p,v),h.set(d,f,p,v)),s.colorWriteMask!==Xt.All&&(i.colorMask(!0,!0,!0,!0),s.colorWriteMask=Xt.All)}e&It.Depth&&(_|=i.DEPTH_BUFFER_BIT,c.writeEnabled!==!0&&(i.depthMask(!0),c.writeEnabled=!0)),e&It.Stencil&&(_|=i.STENCIL_BUFFER_BIT,u.writeMask!==255&&(i.stencilMask(255),u.writeMask=255)),i.clear(_)},l.drawPrimitive=function(t,e,r){t?t._draw(r,e):ce.error("draw primitive failed.")},l.activeRenderTarget=function(t,e,r){var i=this._gl;if(t){var o;(o=t._platformRenderTarget)===null||o===void 0||o._activeRenderTarget();var s=t.width,c=t.height;this.viewport(0,0,s>>r,c>>r)}else{i.bindFramebuffer(i.FRAMEBUFFER,null);var u=i.drawingBufferWidth,_=i.drawingBufferHeight,h=u*e.z,d=_*e.w,f=e.x*u,p=_-e.y*_-d;this.viewport(f,p,h,d)}},l.destroy=function(){},l.activeTexture=function(t){this._activeTextureID!==t&&(this._gl.activeTexture(t),this._activeTextureID=t)},l.bindTexture=function(t){var e=this._activeTextureID-this._gl.TEXTURE0;this._activeTextures[e]!==t&&(this._gl.bindTexture(t._target,t._glTexture),this._activeTextures[e]=t)},Kn(n,[{key:"isWebGL2",get:function(){return this._isWebGL2}},{key:"renderer",get:function(){return this._renderer}},{key:"gl",get:function(){return this._gl}},{key:"renderStates",get:function(){return this._renderStates}},{key:"capability",get:function(){return this._capability}},{key:"canIUseMoreJoints",get:function(){return this.capability.canIUseMoreJoints}}]),n}(),_f=function(n){Li(l,n);function l(a,t){var e=new Rd(typeof a=="string"?document.getElementById(a):a),r=new Nd(t);return n.call(this,e,r)||this}return Kn(l,[{key:"canvas",get:function(){return this._canvas}}]),l}(mr);function Hl(n,l){var a=Object.keys(n);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(n);l&&(t=t.filter(function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})),a.push.apply(a,t)}return a}function Pe(n){for(var l=1;l<arguments.length;l++){var a=arguments[l]!=null?arguments[l]:{};l%2?Hl(Object(a),!0).forEach(function(t){Ud(n,t,a[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(a)):Hl(Object(a)).forEach(function(t){Object.defineProperty(n,t,Object.getOwnPropertyDescriptor(a,t))})}return n}function jt(){jt=function(){return n};var n={},l=Object.prototype,a=l.hasOwnProperty,t=Object.defineProperty||function(A,C,R){A[C]=R.value},e=typeof Symbol=="function"?Symbol:{},r=e.iterator||"@@iterator",i=e.asyncIterator||"@@asyncIterator",o=e.toStringTag||"@@toStringTag";function s(A,C,R){return Object.defineProperty(A,C,{value:R,enumerable:!0,configurable:!0,writable:!0}),A[C]}try{s({},"")}catch{s=function(C,R,z){return C[R]=z}}function c(A,C,R,z){var F=C&&C.prototype instanceof h?C:h,D=Object.create(F.prototype),I=new E(z||[]);return t(D,"_invoke",{value:b(A,R,I)}),D}function u(A,C,R){try{return{type:"normal",arg:A.call(C,R)}}catch(z){return{type:"throw",arg:z}}}n.wrap=c;var _={};function h(){}function d(){}function f(){}var p={};s(p,r,function(){return this});var v=Object.getPrototypeOf,m=v&&v(v(M([])));m&&m!==l&&a.call(m,r)&&(p=m);var g=f.prototype=h.prototype=Object.create(p);function y(A){["next","throw","return"].forEach(function(C){s(A,C,function(R){return this._invoke(C,R)})})}function x(A,C){function R(F,D,I,B){var k=u(A[F],A,D);if(k.type!=="throw"){var Y=k.arg,K=Y.value;return K&&typeof K=="object"&&a.call(K,"__await")?C.resolve(K.__await).then(function(Q){R("next",Q,I,B)},function(Q){R("throw",Q,I,B)}):C.resolve(K).then(function(Q){Y.value=Q,I(Y)},function(Q){return R("throw",Q,I,B)})}B(k.arg)}var z;t(this,"_invoke",{value:function(F,D){function I(){return new C(function(B,k){R(F,D,B,k)})}return z=z?z.then(I,I):I()}})}function b(A,C,R){var z="suspendedStart";return function(F,D){if(z==="executing")throw new Error("Generator is already running");if(z==="completed"){if(F==="throw")throw D;return V()}for(R.method=F,R.arg=D;;){var I=R.delegate;if(I){var B=S(I,R);if(B){if(B===_)continue;return B}}if(R.method==="next")R.sent=R._sent=R.arg;else if(R.method==="throw"){if(z==="suspendedStart")throw z="completed",R.arg;R.dispatchException(R.arg)}else R.method==="return"&&R.abrupt("return",R.arg);z="executing";var k=u(A,C,R);if(k.type==="normal"){if(z=R.done?"completed":"suspendedYield",k.arg===_)continue;return{value:k.arg,done:R.done}}k.type==="throw"&&(z="completed",R.method="throw",R.arg=k.arg)}}}function S(A,C){var R=A.iterator[C.method];if(R===void 0){if(C.delegate=null,C.method==="throw"){if(A.iterator.return&&(C.method="return",C.arg=void 0,S(A,C),C.method==="throw"))return _;C.method="throw",C.arg=new TypeError("The iterator does not provide a 'throw' method")}return _}var z=u(R,A.iterator,C.arg);if(z.type==="throw")return C.method="throw",C.arg=z.arg,C.delegate=null,_;var F=z.arg;return F?F.done?(C[A.resultName]=F.value,C.next=A.nextLoc,C.method!=="return"&&(C.method="next",C.arg=void 0),C.delegate=null,_):F:(C.method="throw",C.arg=new TypeError("iterator result is not an object"),C.delegate=null,_)}function P(A){var C={tryLoc:A[0]};1 in A&&(C.catchLoc=A[1]),2 in A&&(C.finallyLoc=A[2],C.afterLoc=A[3]),this.tryEntries.push(C)}function T(A){var C=A.completion||{};C.type="normal",delete C.arg,A.completion=C}function E(A){this.tryEntries=[{tryLoc:"root"}],A.forEach(P,this),this.reset(!0)}function M(A){if(A){var C=A[r];if(C)return C.call(A);if(typeof A.next=="function")return A;if(!isNaN(A.length)){var R=-1,z=function F(){for(;++R<A.length;)if(a.call(A,R))return F.value=A[R],F.done=!1,F;return F.value=void 0,F.done=!0,F};return z.next=z}}return{next:V}}function V(){return{value:void 0,done:!0}}return d.prototype=f,t(g,"constructor",{value:f,configurable:!0}),t(f,"constructor",{value:d,configurable:!0}),d.displayName=s(f,o,"GeneratorFunction"),n.isGeneratorFunction=function(A){var C=typeof A=="function"&&A.constructor;return!!C&&(C===d||(C.displayName||C.name)==="GeneratorFunction")},n.mark=function(A){return Object.setPrototypeOf?Object.setPrototypeOf(A,f):(A.__proto__=f,s(A,o,"GeneratorFunction")),A.prototype=Object.create(g),A},n.awrap=function(A){return{__await:A}},y(x.prototype),s(x.prototype,i,function(){return this}),n.AsyncIterator=x,n.async=function(A,C,R,z,F){F===void 0&&(F=Promise);var D=new x(c(A,C,R,z),F);return n.isGeneratorFunction(C)?D:D.next().then(function(I){return I.done?I.value:D.next()})},y(g),s(g,o,"Generator"),s(g,r,function(){return this}),s(g,"toString",function(){return"[object Generator]"}),n.keys=function(A){var C=Object(A),R=[];for(var z in C)R.push(z);return R.reverse(),function F(){for(;R.length;){var D=R.pop();if(D in C)return F.value=D,F.done=!1,F}return F.done=!0,F}},n.values=M,E.prototype={constructor:E,reset:function(A){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(T),!A)for(var C in this)C.charAt(0)==="t"&&a.call(this,C)&&!isNaN(+C.slice(1))&&(this[C]=void 0)},stop:function(){this.done=!0;var A=this.tryEntries[0].completion;if(A.type==="throw")throw A.arg;return this.rval},dispatchException:function(A){if(this.done)throw A;var C=this;function R(k,Y){return D.type="throw",D.arg=A,C.next=k,Y&&(C.method="next",C.arg=void 0),!!Y}for(var z=this.tryEntries.length-1;z>=0;--z){var F=this.tryEntries[z],D=F.completion;if(F.tryLoc==="root")return R("end");if(F.tryLoc<=this.prev){var I=a.call(F,"catchLoc"),B=a.call(F,"finallyLoc");if(I&&B){if(this.prev<F.catchLoc)return R(F.catchLoc,!0);if(this.prev<F.finallyLoc)return R(F.finallyLoc)}else if(I){if(this.prev<F.catchLoc)return R(F.catchLoc,!0)}else{if(!B)throw new Error("try statement without catch or finally");if(this.prev<F.finallyLoc)return R(F.finallyLoc)}}}},abrupt:function(A,C){for(var R=this.tryEntries.length-1;R>=0;--R){var z=this.tryEntries[R];if(z.tryLoc<=this.prev&&a.call(z,"finallyLoc")&&this.prev<z.finallyLoc){var F=z;break}}F&&(A==="break"||A==="continue")&&F.tryLoc<=C&&C<=F.finallyLoc&&(F=null);var D=F?F.completion:{};return D.type=A,D.arg=C,F?(this.method="next",this.next=F.finallyLoc,_):this.complete(D)},complete:function(A,C){if(A.type==="throw")throw A.arg;return A.type==="break"||A.type==="continue"?this.next=A.arg:A.type==="return"?(this.rval=this.arg=A.arg,this.method="return",this.next="end"):A.type==="normal"&&C&&(this.next=C),_},finish:function(A){for(var C=this.tryEntries.length-1;C>=0;--C){var R=this.tryEntries[C];if(R.finallyLoc===A)return this.complete(R.completion,R.afterLoc),T(R),_}},catch:function(A){for(var C=this.tryEntries.length-1;C>=0;--C){var R=this.tryEntries[C];if(R.tryLoc===A){var z=R.completion;if(z.type==="throw"){var F=z.arg;T(R)}return F}}throw new Error("illegal catch attempt")},delegateYield:function(A,C,R){return this.delegate={iterator:M(A),resultName:C,nextLoc:R},this.method==="next"&&(this.arg=void 0),_}},n}function Wl(n,l,a,t,e,r,i){try{var o=n[r](i),s=o.value}catch(c){a(c);return}o.done?l(s):Promise.resolve(s).then(t,e)}function qn(n){return function(){var l=this,a=arguments;return new Promise(function(t,e){var r=n.apply(l,a);function i(s){Wl(r,t,e,i,o,"next",s)}function o(s){Wl(r,t,e,i,o,"throw",s)}i(void 0)})}}function Xl(n,l){for(var a=0;a<l.length;a++){var t=l[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(n,t.key,t)}}function Iu(n,l,a){return l&&Xl(n.prototype,l),a&&Xl(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n}function Ud(n,l,a){return l in n?Object.defineProperty(n,l,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[l]=a,n}function ue(n,l){n.prototype=Object.create(l.prototype),n.prototype.constructor=n,Si(n,l)}function Si(n,l){return Si=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Si(n,l)}function kd(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function pi(n,l,a){return kd()?pi=Reflect.construct.bind():pi=function(e,r,i){var o=[null];o.push.apply(o,r);var s=Function.bind.apply(e,o),c=new s;return i&&Si(c,i.prototype),c},pi.apply(null,arguments)}function Gd(n,l){if(!!n){if(typeof n=="string")return ql(n,l);var a=Object.prototype.toString.call(n).slice(8,-1);if(a==="Object"&&n.constructor&&(a=n.constructor.name),a==="Map"||a==="Set")return Array.from(n);if(a==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return ql(n,l)}}function ql(n,l){(l==null||l>n.length)&&(l=n.length);for(var a=0,t=new Array(l);a<l;a++)t[a]=n[a];return t}function Ii(n,l){var a=typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(a)return(a=a.call(n)).next.bind(a);if(Array.isArray(n)||(a=Gd(n))||l&&n&&typeof n.length=="number"){a&&(n=a);var t=0;return function(){return t>=n.length?{done:!0}:{done:!1,value:n[t++]}}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var jl,$l;jl=Ue(Me.AnimatorController,["json"],!1),jl($l=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){i.request(e.url,Pe(Pe({},e),{},{type:"json"})).then(function(){var c=qn(jt().mark(function u(_){var h,d,f;return jt().wrap(function(v){for(;;)switch(v.prev=v.next){case 0:h=new Fa,d=_.layers,f=[],d.forEach(function(m,g){var y=m.name,x=m.blendingMode,b=m.weight,S=m.stateMachine,P=new Ba(y);if(P.blendingMode=x,P.weight=b,S){var T=S.states,E=P.stateMachine=new Va;T.forEach(function(M,V){var A=M.name,C=M.speed,R=M.wrapMode,z=M.clipStartNormalizedTime,F=M.clipEndNormalizedTime,D=M.isDefaultState,I=M.clip,B=E.addState(A);D&&(E.defaultState=B),B.speed=C,B.wrapMode=R,B.clipStartTime=z,B.clipEndTime=F,I&&f.push(new Promise(function(){var k=qn(jt().mark(function Y(K){return jt().wrap(function(ee){for(;;)switch(ee.prev=ee.next){case 0:return ee.t0=K,ee.t1=g,ee.t2=V,ee.next=5,r.getResourceByRef(I);case 5:ee.t3=ee.sent,ee.t4={layerIndex:ee.t1,stateIndex:ee.t2,clip:ee.t3},(0,ee.t0)(ee.t4);case 8:case"end":return ee.stop()}},Y)}));return function(Y){return k.apply(this,arguments)}}()))}),T.forEach(function(M){var V=M.name,A=M.transitions;A.forEach(function(C){var R=C.targetStateName,z=C.duration,F=C.offset,D=C.exitTime,I=E.findStateByName(V),B=E.findStateByName(R),k=new Ra;k.destinationState=B,k.duration=z,k.exitTime=D,k.offset=F,I.addTransition(k)})})}h.addLayer(P)}),Promise.all(f).then(function(m){m.forEach(function(g){var y=g.layerIndex,x=g.stateIndex,b=g.clip;h.layers[y].stateMachine.states[x].clip=b}),o(h)});case 5:case"end":return v.stop()}},u)}));return function(u){return c.apply(this,arguments)}}())})},l}(Te));var Yl,Ql;function Hd(n){return/^data:(.+?);base64,/.test(n)}Yl=Ue(Me.Buffer,["bin","r3bin"],!1),Yl(Ql=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e){var r=e.url;return Hd(r)?new Ee(function(i){var o=r.slice(13+RegExp.$1.length),s=Uint8Array.from(atob(o),function(c){return c.charCodeAt(0)});i(s.buffer)}):this.request(r,Pe(Pe({},e),{},{type:"arraybuffer"}))},l}(Te));var Jl,Zl;Jl=Ue(Me.Env,["env"]),Jl(Zl=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){i.request(e.url,{type:"arraybuffer"}).then(function(c){var u,_=new Float32Array(c,0,27),h=27*4,d=(u=new Uint16Array(c,h,1))===null||u===void 0?void 0:u[0],f=new Ct(r.engine,d);f.filterMode=gt.Trilinear;for(var p=f.mipmapCount,v=h+2,m=0;m<p;m++)for(var g=d>>m,y=0;y<6;y++){var x=g*g*4,b=new Uint8Array(c,v,x);v+=x,f.setPixelBuffer(wt.PositiveX+y,b,m)}var S=new kt,P=new Xu;S.diffuseMode=bn.SphericalHarmonics,P.copyFromArray(_),S.diffuseSphericalHarmonics=P,S.specularTexture=f,S.specularTextureDecodeRGBM=!0,o(S)}).catch(function(c){s(c)})})},l}(Te));var et;(function(n){n[n.BYTE=5120]="BYTE",n[n.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",n[n.SHORT=5122]="SHORT",n[n.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",n[n.UNSIGNED_INT=5125]="UNSIGNED_INT",n[n.FLOAT=5126]="FLOAT"})(et||(et={}));var er;(function(n){n.SCALAR="SCALAR",n.VEC2="VEC2",n.VEC3="VEC3",n.VEC4="VEC4",n.MAT2="MAT2",n.MAT3="MAT3",n.MAT4="MAT4"})(er||(er={}));var Kt;(function(n){n.TRANSLATION="translation",n.ROTATION="rotation",n.SCALE="scale",n.WEIGHTS="weights"})(Kt||(Kt={}));var pn;(function(n){n.Linear="LINEAR",n.Step="STEP",n.CubicSpine="CUBICSPLINE"})(pn||(pn={}));var Ti;(function(n){n.PERSPECTIVE="perspective",n.ORTHOGRAPHIC="orthographic"})(Ti||(Ti={}));var Kl;(function(n){n.JPEG="image/jpeg",n.PNG="image/png"})(Kl||(Kl={}));var Ln;(function(n){n.OPAQUE="OPAQUE",n.MASK="MASK",n.BLEND="BLEND"})(Ln||(Ln={}));var ca;(function(n){n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9729]="LINEAR"})(ca||(ca={}));var ua;(function(n){n[n.NEAREST=9728]="NEAREST",n[n.LINEAR=9729]="LINEAR",n[n.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",n[n.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",n[n.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",n[n.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(ua||(ua={}));var In;(function(n){n[n.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",n[n.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",n[n.REPEAT=10497]="REPEAT"})(In||(In={}));var Wd=".".charCodeAt(0),Xd=/\\(\\)?/g,qd=RegExp(`[^.[\\]]+|\\[(?:([^"'][^[]*)|(["'])((?:(?!\\2)[^\\\\]|\\\\.)*?)\\2)\\]|(?=(?:\\.|\\[\\])(?:\\.|\\[\\]|$))`,"g"),he=function(){function n(){}return n.floatBufferToVector2Array=function(a){for(var t=a.length,e=new Array(t/2),r=0;r<t;r+=2)e[r/2]=new X(a[r],a[r+1]);return e},n.floatBufferToVector3Array=function(a){for(var t=a.length,e=new Array(t/3),r=0;r<t;r+=3)e[r/3]=new w(a[r],a[r+1],a[r+2]);return e},n.floatBufferToVector4Array=function(a){for(var t=a.length,e=new Array(t/4),r=0;r<t;r+=4)e[r/4]=new ve(a[r],a[r+1],a[r+2],a[r+3]);return e},n.floatBufferToColorArray=function(a,t){var e=a.length,r=new Array(e/(t?3:4));if(t)for(var i=0;i<e;i+=3)r[i/3]=new re(a[i],a[i+1],a[i+2],1);else for(var o=0;o<e;o+=4)r[o/4]=new re(a[o],a[o+1],a[o+2],a[o+3]);return r},n.decodeText=function(a){if(typeof TextDecoder<"u")return new TextDecoder().decode(a);for(var t="",e=0,r=a.length;e<r;e++)t+=String.fromCharCode(a[e]);return decodeURIComponent(encodeURIComponent(t))},n.getAccessorTypeSize=function(a){switch(a){case er.SCALAR:return 1;case er.VEC2:return 2;case er.VEC3:return 3;case er.VEC4:return 4;case er.MAT2:return 4;case er.MAT3:return 9;case er.MAT4:return 16}},n.getComponentType=function(a){switch(a){case et.BYTE:return Int8Array;case et.UNSIGNED_BYTE:return Uint8Array;case et.SHORT:return Int16Array;case et.UNSIGNED_SHORT:return Uint16Array;case et.UNSIGNED_INT:return Uint32Array;case et.FLOAT:return Float32Array}},n.getAccessorData=function(a,t,e){var r,i=a.bufferViews,o=i[t.bufferView],s=e[o.buffer],c=t.hasOwnProperty("byteOffset")?t.byteOffset:0,u=o.hasOwnProperty("byteOffset")?o.byteOffset:0,_=c+u,h=n.getAccessorTypeSize(t.type),d=h*t.count,f=(r=o.byteStride)!=null?r:0,p=n.getComponentType(t.componentType),v;if(f){var m=h*p.BYTES_PER_ELEMENT;v=new Uint8Array(t.count*m);for(var g=new Uint8Array(s,u,o.byteLength),y=0;y<t.count;y++)for(var x=0;x<m;x++)v[y*m+x]=g[y*f+c+x]}else v=new Uint8Array(s.slice(_,_+d*p.BYTES_PER_ELEMENT));var b=new p(v.buffer);if(t.sparse)for(var S,P,T,E,M=t.sparse,V=M.count,A=M.indices,C=M.values,R=i[A.bufferView],z=i[C.bufferView],F=e[R.buffer],D=e[z.buffer],I=((S=A.byteOffset)!=null?S:0)+((P=R.byteOffset)!=null?P:0),B=R.byteLength,k=((T=C.byteOffset)!=null?T:0)+((E=z.byteOffset)!=null?E:0),Y=z.byteLength,K=n.getComponentType(A.componentType),Q=new K(F,I,B/K.BYTES_PER_ELEMENT),ee=new p(D,k,Y/p.BYTES_PER_ELEMENT),de=0;de<V;de++)for(var pe=Q[de],me=0;me<h;me++)b[pe*h+me]=ee[de*h+me];return b},n.getBufferViewData=function(a,t){var e=a.buffer,r=a.byteOffset,i=r===void 0?0:r,o=a.byteLength,s=t[e];return s.slice(i,i+o)},n.getVertexStride=function(a,t){var e,r=a.bufferViews[(e=t.bufferView)!=null?e:0].byteStride;if(r)return r;var i=n.getAccessorTypeSize(t.type),o=n.getComponentType(t.componentType);return i*o.BYTES_PER_ELEMENT},n.createVertexElement=function(a,t,e){var r=n.getAccessorTypeSize(t.type);return new ge(a,0,n.getElementFormat(t.componentType,r,t.normalized),e)},n.getIndexFormat=function(a){switch(a){case et.UNSIGNED_BYTE:return qe.UInt8;case et.UNSIGNED_SHORT:return qe.UInt16;case et.UNSIGNED_INT:return qe.UInt32}},n.getElementFormat=function(a,t,e){if(e===void 0&&(e=!1),a==et.FLOAT)switch(t){case 1:return Z.Float;case 2:return Z.Vector2;case 3:return Z.Vector3;case 4:return Z.Vector4}if(a==et.SHORT)switch(t){case 2:return e?Z.NormalizedShort2:Z.Short2;case 3:case 4:return e?Z.NormalizedShort4:Z.Short4}if(a==et.UNSIGNED_SHORT)switch(t){case 2:return e?Z.NormalizedUShort2:Z.UShort2;case 3:case 4:return e?Z.NormalizedUShort4:Z.UShort4}if(a==et.BYTE)switch(t){case 2:case 3:case 4:return e?Z.NormalizedByte4:Z.Byte4}if(a==et.UNSIGNED_BYTE)switch(t){case 2:case 3:case 4:return e?Z.NormalizedUByte4:Z.UByte4}},n.loadImageBuffer=function(a,t){return new Promise(function(e,r){var i=new window.Blob([a],{type:t}),o=new Image;o.onerror=function(){r(new Error("Failed to load image buffer"))},o.onload=function(){requestAnimationFrame(function(){e(o),o.onload=null,o.onerror=null,o.onabort=null})},o.crossOrigin="anonymous",o.src=URL.createObjectURL(i)})},n.isAbsoluteUrl=function(a){return/^(?:http|blob|data:|\/)/.test(a)},n.parseRelativeUrl=function(a,t){if(n.isAbsoluteUrl(t))return t;var e=t.charAt(0);return e==="."?n._formatRelativePath(t+t):a.substring(0,a.lastIndexOf("/")+1)+t},n.getQuery=function(a){for(var t=new URL(a),e=t.searchParams.entries(),r={},i=Ii(e),o;!(o=i()).done;){var s=o.value;r[s[0]]=s[1]}return r},n.stringToPath=function(a){var t=[];return a.charCodeAt(0)===Wd&&t.push(""),a.replace(qd,function(e,r,i,o){var s=e;i?s=o.replace(Xd,"$1"):r&&(s=r.trim()),t.push(s)}),t},n.parseGLB=function(a){var t=4,e=1179937895,r=12,i={JSON:1313821514,BIN:5130562},o=new DataView(a),s={magic:o.getUint32(0,!0),version:o.getUint32(t,!0),length:o.getUint32(2*t,!0)};if(s.magic!==e)return console.error("Invalid glb magic number. Expected 0x46546C67, found 0x"+s.magic.toString(16)),null;var c=o.getUint32(r,!0),u=o.getUint32(r+t,!0);if(u!==i.JSON)return console.error("Invalid glb chunk type. Expected 0x4E4F534A, found 0x"+u.toString(16)),null;for(var _=new Uint8Array(a,r+2*t,c),h=JSON.parse(n.decodeText(_)),d=[],f=r+2*t+c;f<s.length;){if(c=o.getUint32(f,!0),u=o.getUint32(f+t,!0),u!==i.BIN)return console.error("Invalid glb chunk type. Expected 0x004E4942, found 0x"+u.toString(16)),null;var p=f+2*t,v=a.slice(p,p+c);d.push(v),f+=c+2*t}return{gltf:h,buffers:d}},n._formatRelativePath=function(a){for(var t=a.split("/"),e=0,r=t.length;e<r;e++)t[e]==".."&&(t.splice(e-1,2),e-=2);return t.join("/")},n}(),De=function(){function n(){}return n.parseEngineResource=function(a,t,e,r){var i=n._extensionParsers[a];if(i!=null&&i.length){for(var o=arguments.length,s=new Array(o>4?o-4:0),c=4;c<o;c++)s[c-4]=arguments[c];for(var u=0;u<i.length;u++){var _;(_=i[u]).parseEngineResource.apply(_,[t,e,r].concat(s))}}},n.createEngineResource=function(a,t,e){var r=n._extensionParsers[a];if(r!=null&&r.length){for(var i,o=arguments.length,s=new Array(o>3?o-3:0),c=3;c<o;c++)s[c-3]=arguments[c];return(i=r[0]).createEngineResource.apply(i,[t,e].concat(s))}},n.hasExtensionParser=function(a){var t=n._extensionParsers[a];return!!(t!=null&&t.length)},n.initialize=function(a){var t=n._extensionParsers[a];if(t!=null&&t.length)for(var e=0;e<t.length;e++)t[e].initialize()},n._addExtensionParser=function(a,t){n._extensionParsers[a]||(n._extensionParsers[a]=[]),n._extensionParsers[a].push(t)},n}();De._extensionParsers={};function br(n){return function(l){var a=new l;De._addExtensionParser(n,a)}}var Cr=function(){function n(){}var l=n.prototype;return l.initialize=function(){},l.parseEngineResource=function(t,e,r){},l.createEngineResource=function(t,e){return null},n}(),ec,tc,Zi;ec=br("KHR_draco_mesh_compression"),ec(tc=(Zi=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.initialize=function(){l._decoder||(l._decoder=new Pd)},a.createEngineResource=function(e,r,i){var o=r.gltf,s=r.buffers,c=o.bufferViews,u=o.accessors,_=e.bufferView,h=e.attributes,d={},f={};for(var p in h)d[p]=h[p];for(var v in i.attributes)if(h[v]!==void 0){var m=u[i.attributes[v]];f[v]=he.getComponentType(m.componentType).name}var g=u[i.indices],y=he.getComponentType(g.componentType).name,x={attributeIDs:d,attributeTypes:f,useUniqueIDs:!0,indexType:y},b=he.getBufferViewData(c[_],s);return l._decoder.decode(b,x).then(function(S){return S})},l}(Cr),Zi._decoder=void 0,Zi));var rc,nc;rc=br("KHR_lights_punctual"),rc(nc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parseEngineResource=function(e,r,i){var o=e.color,s=e.intensity,c=s===void 0?1:s,u=e.type,_=e.range,h=e.spot,d;if(u==="directional"?d=r.addComponent(Vr):u==="point"?d=r.addComponent(Lr):u==="spot"&&(d=r.addComponent(Ut)),o&&d.color.set(o[0],o[1],o[2],1),d.intensity=c,_&&!(d instanceof Vr)&&(d.distance=_),h&&d instanceof Ut){var f=h.innerConeAngle,p=f===void 0?0:f,v=h.outerConeAngle,m=v===void 0?Math.PI/4:v;d.angle=p,d.penumbra=m-p}i.lights||(i.lights=[]),i.lights.push(d)},l}(Cr));var en=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}l._parseTextureTransform=function(e,r,i){r===void 0&&(r={});var o=r.KHR_texture_transform;o&&De.parseEngineResource("KHR_texture_transform",o,e,i)};var a=l.prototype;return a.parse=function(e){var r=e.glTFResource,i=e.materialIndex,o=r.gltf,s=r.engine,c=r.textures;if(!!o.materials){for(var u=[],_=0;_<o.materials.length;_++)if(!(i>=0&&i!==_)){var h=o.materials[_],d=h.extensions,f=d===void 0?{}:d,p=h.pbrMetallicRoughness,v=h.normalTexture,m=h.occlusionTexture,g=h.emissiveTexture,y=h.emissiveFactor,x=h.alphaMode,b=h.alphaCutoff,S=h.doubleSided,P=h.name,T=P===void 0?"":P,E=f.KHR_materials_unlit,M=f.KHR_materials_pbrSpecularGlossiness,V=f.KHR_materials_clearcoat,A=f.OASIS_materials_remap,C=null;if(E?C=De.createEngineResource("KHR_materials_unlit",E,r):M?C=De.createEngineResource("KHR_materials_pbrSpecularGlossiness",M,r):C=new Pn(s),C.name=T,V&&De.parseEngineResource("KHR_materials_clearcoat",V,C,r),p){var R=p.baseColorFactor,z=p.baseColorTexture,F=p.metallicFactor,D=p.roughnessFactor,I=p.metallicRoughnessTexture;if(R&&(C.baseColor=new re(re.linearToGammaSpace(R[0]),re.linearToGammaSpace(R[1]),re.linearToGammaSpace(R[2]),R[3])),z&&(C.baseTexture=c[z.index],l._parseTextureTransform(C,z.extensions,r)),!E&&!M){var B=C;B.metallic=F!=null?F:1,B.roughness=D!=null?D:1,I&&(B.roughnessMetallicTexture=c[I.index],l._parseTextureTransform(C,I.extensions,r))}}if(!E){var k=C;if(g&&(k.emissiveTexture=c[g.index],l._parseTextureTransform(C,g.extensions,r)),y&&(k.emissiveColor=new re(re.linearToGammaSpace(y[0]),re.linearToGammaSpace(y[1]),re.linearToGammaSpace(y[2]))),v){var Y=v.index,K=v.scale;k.normalTexture=c[Y],l._parseTextureTransform(C,v.extensions,r),K!==void 0&&(k.normalTextureIntensity=K)}if(m){var Q=m.index,ee=m.strength,de=m.texCoord;k.occlusionTexture=c[Q],l._parseTextureTransform(C,m.extensions,r),ee!==void 0&&(k.occlusionTextureIntensity=ee),de===Fr.UV1?k.occlusionTextureCoord=Fr.UV1:de>Fr.UV1&&ce.warn("Occlusion texture uv coordinate must be UV0 or UV1.")}}if(A){var pe,me;r.gltf.extensions=(pe=r.gltf.extensions)!=null?pe:{},r.gltf.extensions.OASIS_materials_remap=(me=r.gltf.extensions.OASIS_materials_remap)!=null?me:{},r.gltf.extensions.OASIS_materials_remap[_]=De.createEngineResource("OASIS_materials_remap",A,r)}switch(S?C.renderFace=fr.Double:C.renderFace=fr.Front,x){case Ln.OPAQUE:C.isTransparent=!1;break;case Ln.BLEND:C.isTransparent=!0;break;case Ln.MASK:C.alphaCutoff=b!=null?b:.5;break}u[_]=C}if(i>=0){var Re=u[i];if(Re)return Re;throw"material index not find in: "+i}r.materials=u}},l}(De),ic,ac;ic=br("KHR_materials_clearcoat"),ic(ac=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parseEngineResource=function(e,r,i){var o=i.textures,s=e.clearcoatFactor,c=s===void 0?0:s,u=e.clearcoatTexture,_=e.clearcoatRoughnessFactor,h=_===void 0?0:_,d=e.clearcoatRoughnessTexture,f=e.clearcoatNormalTexture;r.clearCoat=c,r.clearCoatRoughness=h,u&&(r.clearCoatTexture=o[u.index],en._parseTextureTransform(r,u.extensions,i)),d&&(r.clearCoatRoughnessTexture=o[d.index],en._parseTextureTransform(r,d.extensions,i)),f&&(r.clearCoatNormalTexture=o[f.index],en._parseTextureTransform(r,f.extensions,i))},l}(Cr));var oc,sc;oc=br("KHR_materials_pbrSpecularGlossiness"),oc(sc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.createEngineResource=function(e,r){var i=r.engine,o=r.textures,s=new an(i),c=e.diffuseFactor,u=e.diffuseTexture,_=e.specularFactor,h=e.glossinessFactor,d=e.specularGlossinessTexture;return c&&(s.baseColor=new re(re.linearToGammaSpace(c[0]),re.linearToGammaSpace(c[1]),re.linearToGammaSpace(c[2]),c[3])),u&&(s.baseTexture=o[u.index],en._parseTextureTransform(s,u.extensions,r)),_&&(s.specularColor=new re(re.linearToGammaSpace(_[0]),re.linearToGammaSpace(_[1]),re.linearToGammaSpace(_[2]))),h!==void 0&&(s.glossiness=h),d&&(s.specularGlossinessTexture=o[d.index],en._parseTextureTransform(s,d.extensions,r)),s},l}(Cr));var lc,cc;lc=br("KHR_materials_unlit"),lc(cc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.createEngineResource=function(e,r){var i=r.engine,o=new Ca(i);return o},l}(Cr));var uc,_c;uc=br("KHR_materials_variants"),uc(_c=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parseEngineResource=function(e,r,i){for(var o=i.gltf.extensions.KHR_materials_variants.variants,s=i.materials,c=e.mappings,u=0;u<c.length;u++){var _=c[u],h=_.material,d=_.variants;i.variants||(i.variants=[]),i.variants.push({renderer:r,material:s[h],variants:d.map(function(f){return o[f].name})})}},l}(Cr));var hc,dc;hc=br("KHR_mesh_quantization"),hc(dc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}return l}(Cr));var fc,vc;fc=br("KHR_texture_transform"),fc(vc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parseEngineResource=function(e,r,i){var o=e.offset,s=e.rotation,c=e.scale,u=e.texCoord;o&&(r.tilingOffset.z=o[0],r.tilingOffset.w=o[1]),c&&(r.tilingOffset.x=c[0],r.tilingOffset.y=c[1]),s&&ce.warn("rotation in KHR_texture_transform is not supported now"),u&&ce.warn("texCoord in KHR_texture_transform is not supported now")},l}(Cr));var pc,gc;pc=br("OASIS_materials_remap"),pc(gc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.createEngineResource=function(e,r){var i=r.engine;return i.resourceManager.getResourceByRef(e)},l}(Cr));var Ou=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parse=function(e){var r=e.animationIndex,i=e.glTFResource,o=i.gltf,s=i.buffers,c=i.entities,u=o.animations,_=o.accessors;if(!!u){for(var h=u.length,d=new Array(h),f=new Array(h),p=0;p<h;p++)if(!(r>=0&&r!==p)){for(var v=u[p],m=v.channels,g=v.samplers,y=v.name,x=y===void 0?"AnimationClip"+p:y,b=new Aa(x),S=new Array,P=0;P<g.length;P++){var T,E=g[P],M=_[E.input],V=_[E.output],A=he.getAccessorData(o,M,s),C=he.getAccessorData(o,V,s),R=C.length/A.length,z=(T=E.interpolation)!=null?T:pn.Linear,F=void 0;switch(z){case pn.CubicSpine:F=Ye.CubicSpine;break;case pn.Step:F=Ye.Step;break;case pn.Linear:F=Ye.Linear;break}A[A.length-1],S.push({type:V.type,interpolation:F,input:A,output:C,outputSize:R})}for(var D=0;D<m.length;D++){for(var I=m[D],B=I.target,k=c[B.node],Y="",K=k;K.parent;)Y=Y===""?""+K.name:K.name+"/"+Y,K=K.parent;var Q=void 0,ee=void 0;switch(B.path){case Kt.TRANSLATION:Q=At,ee="position";break;case Kt.ROTATION:Q=At,ee="rotationQuaternion";break;case Kt.SCALE:Q=At,ee="scale";break;case Kt.WEIGHTS:Q=ma,ee="blendShapeWeights";break}var de=this._addCurve(B.path,I,S);b.addCurveBinding(Y,Q,ee,de)}d[p]=b,f[p]={name:x,index:p}}if(r>=0){var pe=d[r];if(pe)return pe;throw"animation index not find in: "+r}i.animations=d,i._animationsIndices=f}},a._addCurve=function(e,r,i){var o=i[r.sampler],s=o.input,c=o.output,u=o.outputSize;switch(e){case Kt.TRANSLATION:case Kt.SCALE:{for(var _=new Ea,h=_.interpolation=o.interpolation,d=0,f=function(){var F=new w(c[d],c[d+1],c[d+2]);return d+=3,F},p=0,v=s.length;p<v;p++){var m=new Lt;m.time=s[p],h===Ye.CubicSpine?(m.inTangent=f(),m.value=f(),m.outTangent=f()):m.value=f(),_.addKey(m)}return _}case Kt.ROTATION:{for(var g=new Ma,y=g.interpolation=o.interpolation,x=0,b=function(F){var D=F?new xe(c[x],c[x+1],c[x+2],c[x+3]):new ve(c[x],c[x+1],c[x+2],c[x+3]);return x+=4,D},S=0,P=s.length;S<P;S++){var T=new Lt;T.time=s[S],y===Ye.CubicSpine?(T.inTangent=b(!1),T.value=b(!0),T.outTangent=b(!1)):T.value=b(!0),g.addKey(T)}return g}case Kt.WEIGHTS:{var E=new Pa;E.interpolation=o.interpolation;for(var M=0,V=function(){var F=c.subarray(M,M+u);return M+=u,F},A=0,C=s.length;A<C;A++){var R=new Lt;R.time=s[A],E.interpolation===Ye.CubicSpine?(R.inTangent=Array.from(V()),R.value=V(),R.outTangent=Array.from(V())):R.value=V(),E.addKey(R)}return E}}},l}(De),ei=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parse=function(e){var r=e.glTFResource,i=r.url,o=r.engine;return this._isGLB(i)?o.resourceManager.load({url:i,type:Me.Buffer}).then(he.parseGLB).then(function(s){var c=s.gltf,u=s.buffers;r.gltf=c,r.buffers=u}):o.resourceManager.load({url:i,type:Me.JSON}).then(function(s){return r.gltf=s,Promise.all(s.buffers.map(function(c){return o.resourceManager.load({type:Me.Buffer,url:he.parseRelativeUrl(i,c.uri)})})).then(function(c){r.buffers=c})})},a._isGLB=function(e){var r=e.lastIndexOf(".");return e.substring(r+1,r+4)==="glb"},l}(De),La=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parse=function(e){var r=e.glTFResource,i=r.engine,o=r.gltf.nodes;if(!!o){for(var s=[],c=0;c<o.length;c++){var u=o[c],_=u.matrix,h=u.translation,d=u.rotation,f=u.scale,p=new hr(i,u.name||""+l._defaultName+c),v=p,m=v.transform;if(_){var g=m.localMatrix;g.copyFromArray(_),m.localMatrix=g}else h&&m.setPosition(h[0],h[1],h[2]),d&&m.setRotationQuaternion(d[0],d[1],d[2],d[3]),f&&m.setScale(f[0],f[1],f[2]);s[c]=p}r.entities=s,this._buildEntityTree(r),this._createSceneRoots(r)}},a._buildEntityTree=function(e){for(var r=e.gltf.nodes,i=e.entities,o=0;o<r.length;o++){var s=r[o].children,c=i[o];if(s)for(var u=0;u<s.length;u++){var _=i[s[u]];c.addChild(_)}}},a._createSceneRoots=function(e){var r=e.engine,i=e.gltf,o=i.scene,s=o===void 0?0:o,c=i.scenes,u=e.entities;if(!!c){for(var _=[],h=0;h<c.length;h++){var d=c[h].nodes;if(!!d)if(d.length===1)_[h]=u[d[0]];else{for(var f=new hr(r,"GLTF_ROOT"),p=0;p<d.length;p++)f.addChild(u[d[p]]);_[h]=f}}e.sceneRoots=_,e.defaultSceneRoot=_[s]}},l}(De);La._defaultName="_GLTF_ENTITY_";var Ia=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parse=function(e){var r=this,i=e.meshIndex,o=e.subMeshIndex,s=e.glTFResource,c=s.engine,u=s.gltf,_=s.buffers;if(!!u.meshes){for(var h=[],d=function(m){if(i>=0&&i!==m)return"continue";for(var g=u.meshes[m],y=[],x=function(T){if(o>=0&&o!==T)return"continue";var E=g.primitives[T],M=E.extensions,V=M===void 0?{}:M,A=V.KHR_draco_mesh_compression;y[T]=new Promise(function(C){var R=new nt(c,g.name||T+"");A?De.createEngineResource("KHR_draco_mesh_compression",A,s,E).then(function(z){return r._parseMeshFromGLTFPrimitive(R,g,E,u,function(F){for(var D=0;D<z.attributes.length;D++)if(z.attributes[D].name===F)return z.attributes[D].array;return null},function(F,D){throw"BlendShape animation is not supported when using draco."},function(){return z.index.array},e.keepMeshData)}).then(C):r._parseMeshFromGLTFPrimitive(R,g,E,u,function(z){var F=E.attributes[z],D=u.accessors[F];return he.getAccessorData(u,D,_)},function(z,F){var D=E.targets[F],I=D[z];if(I){var B=u.accessors[I];return he.getAccessorData(u,B,_)}else return null},function(){var z=u.accessors[E.indices];return he.getAccessorData(u,z,_)},e.keepMeshData).then(C)})},b=0;b<g.primitives.length;b++)var S=x(b);h[m]=Promise.all(y)},f=0;f<u.meshes.length;f++)var p=d(f);return Promise.all(h).then(function(v){if(i>=0){var m,g=(m=v[i])===null||m===void 0?void 0:m[o];if(g)return g;throw"meshIndex-subMeshIndex index not find in: "+i+"-"+o}s.meshes=v})}},a._parseMeshFromGLTFPrimitive=function(e,r,i,o,s,c,u,_){var h=i.attributes,d=i.targets,f=i.indices,p=i.mode,v,m=o.accessors,g=m[h.POSITION],y=s("POSITION"),x=he.floatBufferToVector3Array(y);e.setPositions(x);var b=e.bounds;if(v=g.count,g.min&&g.max)b.min.copyFromArray(g.min),b.max.copyFromArray(g.max);else{var S=l._tempVector3,P=b.min,T=b.max;P.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),T.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var E=y.length/v,M=0;M<v;M++){var V=M*E;S.copyFromArray(y,V),w.min(P,S,P),w.max(T,S,T)}}for(var A in h)if(A!=="POSITION"){var C=s(A);switch(A){case"NORMAL":var R=he.floatBufferToVector3Array(C);e.setNormals(R);break;case"TEXCOORD_0":var z=he.floatBufferToVector2Array(C);e.setUVs(z,0);break;case"TEXCOORD_1":var F=he.floatBufferToVector2Array(C);e.setUVs(F,1);break;case"TEXCOORD_2":var D=he.floatBufferToVector2Array(C);e.setUVs(D,2);break;case"TEXCOORD_3":var I=he.floatBufferToVector2Array(C);e.setUVs(I,3);break;case"TEXCOORD_4":var B=he.floatBufferToVector2Array(C);e.setUVs(B,4);break;case"TEXCOORD_5":var k=he.floatBufferToVector2Array(C);e.setUVs(k,5);break;case"TEXCOORD_6":var Y=he.floatBufferToVector2Array(C);e.setUVs(Y,6);break;case"TEXCOORD_7":var K=he.floatBufferToVector2Array(C);e.setUVs(K,7);break;case"COLOR_0":var Q=he.floatBufferToColorArray(C,m[h.COLOR_0].type===er.VEC3);e.setColors(Q);break;case"TANGENT":var ee=he.floatBufferToVector4Array(C);e.setTangents(ee);break;case"JOINTS_0":var de=he.floatBufferToVector4Array(C);e.setBoneIndices(de);break;case"WEIGHTS_0":var pe=he.floatBufferToVector4Array(C);e.setBoneWeights(pe);break}}if(f!==void 0){var me=o.accessors[f],Re=u();e.setIndices(Re),e.addSubMesh(0,me.count,p)}else e.addSubMesh(0,v,p);return d&&this._createBlendShape(e,r,d,c),e.uploadData(!_),Promise.resolve(e)},a._createBlendShape=function(e,r,i,o){for(var s=r.extras?r.extras.targetNames:null,c=0,u=i.length;c<u;c++){var _=s?s[c]:"blendShape"+c,h=o("POSITION",c),d=o("NORMAL",c),f=o("TANGENT",c),p=h?he.floatBufferToVector3Array(h):null,v=d?he.floatBufferToVector3Array(d):null,m=f?he.floatBufferToVector3Array(f):null,g=new ya(_);g.addFrame(1,p,v,m),e.addBlendShape(g)}},l}(De);Ia._tempVector3=new w;var Nu=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}l._getDefaultMaterial=function(e){return l._defaultMaterial||(l._defaultMaterial=new An(e)),l._defaultMaterial};var a=l.prototype;return a.parse=function(e){var r=e.defaultSceneRootOnly,i=e.glTFResource,o=i.gltf,s=o.nodes,c=o.cameras,u=i.entities;if(!!s){for(var _=[],h=0;h<s.length;h++){var d=s[h],f=d.camera,p=d.mesh,v=d.extensions,m=v===void 0?{}:v,g=m.KHR_lights_punctual,y=u[h];if(f!==void 0&&this._createCamera(i,c[f],y),p!==void 0&&_.push(this._createRenderer(e,d,y)),g){var x=g.light,b=i.gltf.extensions.KHR_lights_punctual.lights;De.parseEngineResource("KHR_lights_punctual",b[x],y,i)}}return i.defaultSceneRoot&&this._createAnimator(e),i.gltf.extensions&&delete i.gltf.extensions.OASIS_materials_remap,Promise.all(_).then(function(){if(r){if(i.defaultSceneRoot)return i.defaultSceneRoot;throw"defaultSceneRoot is not find in this gltf"}})}},a._createCamera=function(e,r,i){var o=r.orthographic,s=r.perspective,c=r.type,u=i.addComponent(ba);if(c===Ti.ORTHOGRAPHIC){var _=o.xmag,h=o.ymag,d=o.zfar,f=o.znear;u.isOrthographic=!0,f!==void 0&&(u.nearClipPlane=f),d!==void 0&&(u.farClipPlane=d),u.orthographicSize=Math.max(h!=null?h:0,_!=null?_:0)/2}else if(c===Ti.PERSPECTIVE){var p=s.aspectRatio,v=s.yfov,m=s.zfar,g=s.znear;p!==void 0&&(u.aspectRatio=p),v!==void 0&&(u.fieldOfView=v*180/Math.PI),m!==void 0&&(u.farClipPlane=m),g!==void 0&&(u.nearClipPlane=g)}e.cameras||(e.cameras=[]),e.cameras.push(u),u.enabled=!1},a._createRenderer=function(e,r,i){for(var o=e.glTFResource,s=o.engine,c=o.gltf.meshes,u=o.meshes,_=o.materials,h=o.skins,d=r.mesh,f=r.skin,p=c[d],v=p.primitives,m=r.weights||p.weights,g=[],y=function(S){var P=u[d][S],T=void 0;if(f!==void 0||m){e.hasSkinned=!0;var E=i.addComponent(ma);E.mesh=P,f!==void 0&&(E.skin=h[f]),m&&(E.blendShapeWeights=new Float32Array(m)),T=E}else T=i.addComponent(Tn),T.mesh=P;var M=v[S].material,V=o.gltf.extensions&&o.gltf.extensions.OASIS_materials_remap;if(V&&V[M])g.push(V[M].then(function(F){T.setMaterial(F)}));else{var A=(_==null?void 0:_[M])||l._getDefaultMaterial(s);T.setMaterial(A)}var C=v[S].extensions,R=C===void 0?{}:C,z=R.KHR_materials_variants;z&&De.parseEngineResource("KHR_materials_variants",z,T,o)},x=0;x<v.length;x++)y(x);return Promise.all(g)},a._createAnimator=function(e){if(!(!e.hasSkinned&&!e.glTFResource.animations)){var r=e.glTFResource,i=r.defaultSceneRoot,o=r.animations,s=i.addComponent(za),c=new Fa,u=new Ba("layer"),_=new Va;if(c.addLayer(u),s.animatorController=c,u.stateMachine=_,o)for(var h=0;h<o.length;h++){var d=o[h],f=d.name,p=_.makeUniqueStateName(f);p!==f&&console.warn("AnimatorState name is existed, name: "+f+" reset to "+p);var v=_.addState(p);v.clip=d}}},l}(De);Nu._defaultMaterial=void 0;var jd=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parse=function(e){var r=e.glTFResource,i=r.gltf,o=r.buffers,s=r.entities,c=i.skins;if(!!c){for(var u=c.length,_=new Array(u),h=0;h<u;h++){var d=c[h],f=d.inverseBindMatrices,p=d.skeleton,v=d.joints,m=d.name,g=m===void 0?"SKIN_"+h:m,y=v.length,x=new vu(g);x.inverseBindMatrices.length=y;for(var b=i.accessors[f],S=he.getAccessorData(i,b,o),P=0;P<y;P++){var T=new te;T.copyFromArray(S,P*16),x.inverseBindMatrices[P]=T}for(var E=0;E<y;E++)x.joints[E]=s[v[E]].name;if(p!==void 0)x.skeleton=s[p].name;else{var M=this._findSkeletonRootBone(v,s);if(M)x.skeleton=M.name;else throw"Failed to find skeleton root bone."}_[h]=x}r.skins=_}},a._findSkeletonRootBone=function(e,r){for(var i={},o=Ii(e),s;!(s=o()).done;){for(var c=s.value,u=new Array,_=r[c];_.parent!==null;)u.unshift(_),_=_.parent;i[c]=u}for(var h=null,d=0;;d++){var f=i[e[0]];if(d>=f.length)return h;for(var p=f[d],v=1,m=e.length;v<m;v++)if(f=i[e[v]],d>=f.length||p!==f[d])return h;h=p}},l}(De),Fn,Oi=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parse=function(e){var r=this,i=e.textureIndex,o=e.glTFResource,s=o.gltf,c=o.buffers,u=o.engine,_=o.url;if(s.textures)return Promise.all(s.textures.map(function(h,d){var f=h.sampler,p=h.source,v=p===void 0?0:p,m=h.name;if(!(i>=0&&i!==d)){var g=s.images[v],y=g.uri,x=g.bufferView,b=g.mimeType,S=g.name;if(y)return u.resourceManager.load({url:he.parseRelativeUrl(_,y),type:Me.Texture2D}).then(function(E){return E.name||(E.name=m||S||"texture_"+d),f!==void 0&&r._parseSampler(E,s.samplers[f]),E});var P=s.bufferViews[x],T=he.getBufferViewData(P,c);return he.loadImageBuffer(T,b).then(function(E){var M=new Mt(u,E.width,E.height);return M.setImageSource(E),M.generateMipmaps(),M.name=m||S||"texture_"+d,f!==void 0&&r._parseSampler(M,s.samplers[f]),M})}})).then(function(h){if(i>=0){var d=h[i];if(d)return d;throw"texture index not find in: "+i}o.textures=h})},a._parseSampler=function(e,r){var i=r.magFilter,o=r.minFilter,s=r.wrapS,c=r.wrapT;(i||o)&&(i===ca.NEAREST?e.filterMode=gt.Point:o<=ua.LINEAR_MIPMAP_NEAREST?e.filterMode=gt.Bilinear:e.filterMode=gt.Trilinear),s&&(e.wrapModeU=l._wrapMap[s]),c&&(e.wrapModeV=l._wrapMap[c])},l}(De);Oi._wrapMap=(Fn={},Fn[In.CLAMP_TO_EDGE]=pt.Clamp,Fn[In.MIRRORED_REPEAT]=pt.Mirror,Fn[In.REPEAT]=pt.Repeat,Fn);var $d=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.parse=function(e){var r=e.glTFResource.gltf,i=r.asset.version,o=r.extensionsUsed,s=r.extensionsRequired,c=Number(i);if(!(c>=2&&c<3))throw"Only support gltf 2.x.";if(o){ce.info("extensionsUsed: ",o);for(var u=0;u<o.length;u++)De.hasExtensionParser(o[u])||ce.warn("Extension "+o[u]+" is not implemented, you can customize this extension in gltf.")}if(s){ce.info("extensionsRequired: "+s);for(var _=0;_<s.length;_++){var h=s[_];De.hasExtensionParser(h)?De.initialize(h):ce.error("GLTF parser has not supported required extension "+h+".")}}},l}(De),it=function(){function n(a){var t=this;this._pipes=[],a.forEach(function(e,r){t._pipes[r]=new e})}var l=n.prototype;return l.parse=function(t){var e=this,r=t.glTFResource,i;return new Promise(function(o,s){e._pipes.forEach(function(c){i?i=i.then(function(){return c.parse(t)}):i=c.parse(t)}),i?i.then(function(c){o(c||r)}).catch(s):o(r)})},n}();it.defaultPipeline=new it([ei,$d,Oi,en,Ia,La,jd,Ou,Nu]);it.texturePipeline=new it([ei,Oi]);it.materialPipeline=new it([ei,Oi,en]);it.animationPipeline=new it([ei,La,Ou]);it.meshPipeline=new it([ei,Ia]);var Yd=function(n){ue(l,n);function l(){for(var a,t=arguments.length,e=new Array(t),r=0;r<t;r++)e[r]=arguments[r];return a=n.call.apply(n,[this].concat(e))||this,a.url=void 0,a.gltf=void 0,a.buffers=void 0,a.textures=void 0,a.materials=void 0,a.meshes=void 0,a.skins=void 0,a.animations=void 0,a.entities=void 0,a.cameras=void 0,a.lights=void 0,a.sceneRoots=void 0,a.defaultSceneRoot=void 0,a.variants=void 0,a}return l}(xr),Qd=function(){this.glTFResource=void 0,this.keepMeshData=void 0,this.hasSkinned=!1,this.textureIndex=void 0,this.materialIndex=void 0,this.animationIndex=void 0,this.meshIndex=void 0,this.subMeshIndex=void 0,this.defaultSceneRootOnly=void 0},mc,yc;mc=Ue(Me.Prefab,["gltf","glb"]),mc(yc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=e.url;return new Ee(function(o,s){var c,u,_=new Qd,h=new Yd(r.engine);_.glTFResource=h,h.url=i,_.keepMeshData=(c=(u=e.params)===null||u===void 0?void 0:u.keepMeshData)!=null?c:!1;var d=it.defaultPipeline,f=he.getQuery(i);if(f.q){var p=he.stringToPath(f.q),v=p[0],m=Number(p[1])||0,g=Number(p[2])||0;switch(v){case"textures":d=it.texturePipeline,_.textureIndex=m;break;case"materials":d=it.materialPipeline,_.materialIndex=m;break;case"animations":d=it.animationPipeline,_.animationIndex=m;break;case"meshes":d=it.meshPipeline,_.meshIndex=m,_.subMeshIndex=g;break;case"defaultSceneRoot":d=it.defaultPipeline,_.defaultSceneRootOnly=!0;break}}d.parse(_).then(o).catch(function(y){console.error(y),s("Error loading glTF model from "+i+" .")})})},l}(Te));var xc,wc,se,dn=Math.PI;xc=Ue(Me.HDR,["hdr"]),xc(wc=(se=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}l._convertToCubemap=function(e,r,i,o){if(!e)throw"ConvertPanoramaToCubemap: input cannot be null";if(e.length!=r*i*4)throw"ConvertPanoramaToCubemap: input size is wrong";var s=this._createCubemapData(o,this._faceRight,e,r,i),c=this._createCubemapData(o,this._faceLeft,e,r,i),u=this._createCubemapData(o,this._faceUp,e,r,i),_=this._createCubemapData(o,this._faceBottom,e,r,i),h=this._createCubemapData(o,this._faceFront,e,r,i),d=this._createCubemapData(o,this._faceBack,e,r,i);return[s,c,u,_,h,d]},l._createCubemapData=function(e,r,i,o,s){for(var c=new Uint8ClampedArray(e*e*4),u=this._tempVector3.set(0,0,0).add(r[1]).subtract(r[0]).scale(1/e),_=this._temp2Vector3.set(0,0,0).add(r[3]).subtract(r[2]).scale(1/e),h=1/e,d=0,f=0;f<e;f++){for(var p=this._temp3Vector3.set(0,0,0).add(r[0]),v=this._temp4Vector3.set(0,0,0).add(r[2]),m=0;m<e;m++){var g=this._temp5Vector3.set(0,0,0).add(v).subtract(p).scale(d).add(p);g.normalize();var y=this._calcProjectionSpherical(g,i,o,s);this._RGBEToLinear(y),this._linearToRGBM(y,5);var x=f*e*4+m*4;c[x]=y.r,c[x+1]=y.g,c[x+2]=y.b,c[x+3]=y.a,p.add(u),v.add(_)}d+=h}return c},l._calcProjectionSpherical=function(e,r,i,o){for(var s=Math.atan2(e.z,-e.x),c=Math.acos(e.y);s<-dn;)s+=2*dn;for(;s>dn;)s-=2*dn;var u=s/dn,_=c/dn;u=u*.5+.5;var h=Math.round(u*i);h<0?h=0:h>=i&&(h=i-1);var d=Math.round(_*o);d<0?d=0:d>=o&&(d=o-1);var f=o-d-1,p=f*i*4+h*4,v=r[p],m=r[p+1],g=r[p+2],y=r[p+3];return new re(v,m,g,y)},l._readStringLine=function(e,r){for(var i="",o="",s=r;s<e.length-r&&(o=String.fromCharCode(e[s]),o!=`
`);s++)i+=o;return i},l._parseHeader=function(e){var r=0,i=0,o=this._readStringLine(e,0);if(o[0]!="#"||o[1]!="?")throw"Bad HDR Format.";var s=!1,c=!1,u=0;do u+=o.length+1,o=this._readStringLine(e,u),o=="FORMAT=32-bit_rle_rgbe"?c=!0:o.length==0&&(s=!0);while(!s);if(!c)throw"HDR Bad header format, unsupported FORMAT";u+=o.length+1,o=this._readStringLine(e,u);var _=/^\-Y (.*) \+X (.*)$/g,h=_.exec(o);if(!h||h.length<3)throw"HDR Bad header format, no size";if(i=parseInt(h[2]),r=parseInt(h[1]),i<8||i>32767)throw"HDR Bad header format, unsupported size";return u+=o.length+1,{height:r,width:i,dataPosition:u}},l._readPixels=function(e,r,i){for(var o=r,s=e.byteLength,c=new Uint8Array(4*r*i),u=0,_=0,h=4*o,d=new Uint8Array(4),f=new Uint8Array(h),p=i;p>0&&_<s;){if(d[0]=e[_++],d[1]=e[_++],d[2]=e[_++],d[3]=e[_++],d[0]!=2||d[1]!=2||(d[2]<<8|d[3])!=o)throw"HDR Bad header format, wrong scan line width";for(var v=0,m=void 0;v<h&&_<s;){m=e[_++];var g=m>128;if(g&&(m-=128),m===0||v+m>h)throw"HDR Bad Format, bad scanline data (run)";if(g)for(var y=e[_++],x=0;x<m;x++)f[v++]=y;else f.set(e.subarray(_,_+m),v),v+=m,_+=m}for(var b=o,S=0;S<b;S++){var P=0;c[u]=f[S+P],P+=o,c[u+1]=f[S+P],P+=o,c[u+2]=f[S+P],P+=o,c[u+3]=f[S+P],u+=4}p--}return c},l._RGBEToLinear=function(e){var r=Math.pow(2,e.a-128)/255;e.r*=r,e.g*=r,e.b*=r,e.a=1},l._linearToRGBM=function(e,r){var i=Math.max(e.r,Math.max(e.g,e.b)),o=Math.min(i/r,1);o=Math.ceil(o*255);var s=65025/(o*r);e.r*=s,e.g*=s,e.b*=s,e.a*=o};var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){var c=r.engine;i.request(e.url,{type:"arraybuffer"}).then(function(u){for(var _=new Uint8Array(u),h=l._parseHeader(_),d=h.width,f=h.height,p=h.dataPosition,v=l._readPixels(_.subarray(p),d,f),m=f>>1,g=l._convertToCubemap(v,d,f,m),y=new Ct(c,m),x=0;x<6;x++)y.setPixelBuffer(wt.PositiveX+x,g[x],0);y.generateMipmaps(),o(y)}).catch(s)})},l}(Te),se._rightBottomBack=new w(1,-1,-1),se._rightBottomFront=new w(1,-1,1),se._rightUpBack=new w(1,1,-1),se._rightUpFront=new w(1,1,1),se._leftBottomBack=new w(-1,-1,-1),se._leftBottomFront=new w(-1,-1,1),se._leftUpBack=new w(-1,1,-1),se._leftUpFront=new w(-1,1,1),se._faceRight=[se._rightBottomBack,se._rightBottomFront,se._rightUpBack,se._rightUpFront],se._faceLeft=[se._leftBottomFront,se._leftBottomBack,se._leftUpFront,se._leftUpBack],se._faceUp=[se._leftBottomFront,se._rightBottomFront,se._leftBottomBack,se._rightBottomBack],se._faceBottom=[se._leftUpBack,se._rightUpBack,se._leftUpFront,se._rightUpFront],se._faceFront=[se._leftBottomBack,se._rightBottomBack,se._leftUpBack,se._rightUpBack],se._faceBack=[se._rightBottomFront,se._leftBottomFront,se._rightUpFront,se._leftUpFront],se._tempVector3=new w,se._temp2Vector3=new w,se._temp3Vector3=new w,se._temp4Vector3=new w,se._temp5Vector3=new w,se));var bc,Cc;bc=Ue(Me.JSON,["json"],!1),bc(Cc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e){return this.request(e.url,Pe(Pe({},e),{},{type:"json"}))},l}(Te));var Jd=12+13*4,Zd=0;function Kd(n,l){for(var a=[],t=Jd+n.bytesOfKeyValueData,e=n.pixelWidth,r=n.pixelHeight,i=l?n.numberOfMipmapLevels:1,o=0;o<i;o++){var s=new Int32Array(n.buffer,t,1)[0];t+=4;for(var c=0;c<n.numberOfFaces;c++){var u=new Uint8Array(n.buffer,t,s);a.push({data:u,width:e,height:r}),t+=s,t+=3-(s+3)%4}e=Math.max(1,e*.5),r=Math.max(1,r*.5)}return a}function ef(n){if(n.byteLength>=12){var l=new Uint8Array(n,0,12);if(l[0]===171&&l[1]===75&&l[2]===84&&l[3]===88&&l[4]===32&&l[5]===49&&l[6]===49&&l[7]===187&&l[8]===13&&l[9]===10&&l[10]===26&&l[11]===10)return!0}return!1}function tf(n){switch(n){case ae.RGB_S3TC_DXT1_EXT:return H.DXT1;case ae.RGBA_S3TC_DXT5_EXT:return H.DXT5;case ae.RGB_ETC1_WEBGL:return H.ETC1_RGB;case ae.RGB8_ETC2:return H.ETC2_RGB;case ae.RGB8_PUNCHTHROUGH_ALPHA1_ETC2:return H.ETC2_RGBA5;case ae.RGBA8_ETC2_EAC:return H.ETC2_RGBA8;case ae.RGB_PVRTC_2BPPV1_IMG:return H.PVRTC_RGB2;case ae.RGBA_PVRTC_2BPPV1_IMG:return H.PVRTC_RGBA2;case ae.RGB_PVRTC_4BPPV1_IMG:return H.PVRTC_RGB4;case ae.RGBA_PVRTC_4BPPV1_IMG:return H.PVRTC_RGBA4;case ae.RGBA_ASTC_4X4_KHR:return H.ASTC_4x4;case ae.RGBA_ASTC_5X5_KHR:return H.ASTC_5x5;case ae.RGBA_ASTC_6X6_KHR:return H.ASTC_6x6;case ae.RGBA_ASTC_8X8_KHR:return H.ASTC_8x8;case ae.RGBA_ASTC_10X10_KHR:return H.ASTC_10x10;case ae.RGBA_ASTC_12X12_KHR:return H.ASTC_12x12;default:var l=ae[n];throw new Error("this format is not supported in Oasis Engine: "+l)}}var Uu={parse:function(l,a,t,e){if(e===void 0&&(e=!1),!ef(l))throw new Error("khronosTextureContainerParser: invalid KTX file, texture missing KTX identifier");var r=Uint32Array.BYTES_PER_ELEMENT,i=new DataView(l,12,13*r),o=i.getUint32(0,!0),s=o===67305985,c={buffer:l,glType:i.getUint32(1*r,s),glTypeSize:i.getUint32(2*r,s),glFormat:i.getUint32(3*r,s),glInternalFormat:i.getUint32(4*r,s),glBaseInternalFormat:i.getUint32(5*r,s),pixelWidth:i.getUint32(6*r,s),pixelHeight:i.getUint32(7*r,s),pixelDepth:i.getUint32(8*r,s),numberOfArrayElements:i.getUint32(9*r,s),numberOfFaces:i.getUint32(10*r,s),numberOfMipmapLevels:i.getUint32(11*r,s),bytesOfKeyValueData:i.getUint32(12*r,s),loadType:Zd};if(c.glType!==0)throw new Error("only compressed formats currently supported");if(c.numberOfMipmapLevels=Math.max(1,c.numberOfMipmapLevels),c.pixelHeight===0||c.pixelDepth!==0)throw new Error("only 2D textures currently supported");if(c.numberOfArrayElements!==0)throw new Error("texture arrays not currently supported");if(c.numberOfFaces!==a)throw new Error("number of faces expected"+a+", but found "+c.numberOfFaces);return t&&(c.mipmaps=Kd(c,!0)),e&&(c.engineFormat=tf(c.glInternalFormat)),c}};function rf(n){var l=Uu.parse(n,1,!0,!0);return{mipmaps:l.mipmaps,engineFormat:l.engineFormat,internalFormat:l.glInternalFormat,width:l.pixelWidth,height:l.pixelHeight}}function nf(n){for(var l=[],a,t,e,r,i=0;i<n.length;i++){var o=Uu.parse(n[i],1,!0,!0);l.push(o.mipmaps),i===0&&(e=o.pixelWidth,r=o.pixelHeight,a=o.glInternalFormat,t=o.engineFormat)}return{mipmapsFaces:l,engineFormat:t,internalFormat:a,width:e,height:r}}var Sc,Tc;Sc=Ue(Me.KTXCube,[]),Sc(Tc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){Promise.all(e.urls.map(function(c){return i.request(c,Pe(Pe({},e),{},{type:"arraybuffer"}))})).then(function(c){for(var u=nf(c),_=u.width,h=u.mipmapsFaces,d=u.engineFormat,f=h[0].length>1,p=new Ct(r.engine,_,d,f),v=0;v<6;v++)for(var m=h[v].length,g=0;g<m;g++){var y=h[v][g],x=y.data,b=y.width,S=y.height;p.setPixelBuffer(wt.PositiveX+v,x,g,0,0,b,S)}o(p)}).catch(function(c){s(c)})})},l}(Te));var Ac,Pc;Ac=Ue(Me.KTX,["ktx"]),Ac(Pc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){i.request(e.url,Pe(Pe({},e),{},{type:"arraybuffer"})).then(function(c){for(var u=rf(c),_=u.width,h=u.height,d=u.mipmaps,f=u.engineFormat,p=d.length>1,v=new Mt(r.engine,_,h,f,p),m=0;m<d.length;m++){var g=d[m],y=g.width,x=g.height,b=g.data;v.setPixelBuffer(b,m,0,0,y,x)}o(v)}).catch(function(c){s(c)})})},l}(Te));var Mc,Ec;Mc=Ue(Me.Material,["json"]),Mc(Ec=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){i.request(e.url,Pe(Pe({},e),{},{type:"json"})).then(function(c){var u=r.engine,_=c.shader,h=c.shaderData,d=c.macros,f=c.renderState,p;switch(_){case"pbr":p=new Pn(u);break;case"pbr-specular":p=new an(u);break;case"unlit":p=new Ca(u);break;case"blinn-phong":p=new An(u);break}var v=new Array,m=p.shaderData,g=function(V){var A=h[V],C=A.type,R=A.value;switch(C){case"Vector2":m.setVector2(V,new X(R.x,R.y));break;case"Vector3":m.setVector3(V,new w(R.x,R.y,R.z));break;case"Vector4":m.setVector4(V,new ve(R.x,R.y,R.z,R.w));break;case"Color":m.setColor(V,new re(R.r,R.g,R.b,R.a));break;case"Float":m.setFloat(V,R);break;case"Texture":v.push(r.getResourceByRef(R).then(function(z){m.setTexture(V,z)}));break}};for(var y in h)g(y);for(var x=0,b=d.length;x<b;x++){var S=d[x],P=S.name,T=S.value;T==null?m.enableMacro(P):m.enableMacro(P,T)}for(var E in f)m[E]=f[E];Promise.all(v).then(function(){o(p)})})})},l}(Te));var ku=function(){function n(a,t,e,r){t===void 0&&(t=0),r===void 0&&(r=!0),this.buffer=a,this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(a),this._littleEndian=r,this._offset=t}var l=n.prototype;return l.nextUint8=function(){var t=this._dataView.getUint8(this._offset);return this._offset+=1,t},l.nextUint16=function(){var t=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,t},l.nextUint32=function(){var t=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,t},l.nextInt32=function(){var t=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,t},l.nextInt32Array=function(t){var e=new Int32Array(this.buffer,this._offset,t);return this._offset+=4*t,e},l.nextFloat32=function(){var t=this._dataView.getFloat32(this._offset,this._littleEndian);return this._offset+=4,t},l.nextFloat32Array=function(t){var e=new Float32Array(this.buffer,this._offset,t);return this._offset+=4*t,e},l.nextUint32Array=function(t){var e=new Uint32Array(this.buffer,this._offset,t);return this._offset+=4*t,e},l.nextUint8Array=function(t){var e=new Uint8Array(this.buffer,this._offset,t);return this._offset+=t,e},l.nextUint64=function(){var t=this._dataView.getUint32(this._offset,this._littleEndian),e=this._dataView.getUint32(this._offset+4,this._littleEndian),r=t+Math.pow(2,32)*e;return this._offset+=8,r},l.nextStr=function(){var t=this.nextUint16(),e=new Uint8Array(this.buffer,this._offset,t);return this._offset+=t,he.decodeText(e)},l.nextImageData=function(t){return this.buffer.slice(this._offset)},l.nextImagesData=function(t){for(var e=new Array(t),r=0;r<t;r++){var i=this._dataView.getUint32(this._offset,this._littleEndian);e[r]=i,this._offset+=4}for(var o=[],s=0;s<t;s++){var c=e[s],u=this.buffer.slice(this._offset,this._offset+c);this._offset+=c,o.push(u)}return o},l.skip=function(t){return this._offset+=t,this},l.scan=function(t,e){e===void 0&&(e=0);for(var r=this._offset,i=0;this._dataView.getUint8(this._offset)!==e&&i<t;)i++,this._offset++;return i<t&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+r,i)},Iu(n,[{key:"offset",get:function(){return this._offset}}]),n}();ku.imageMapping={0:"image/png",1:"image/jpg",2:"image/webp",3:"ktx"};var Gu={};function Oa(n){return function(l){Gu[n]=l}}var af=function(){function n(){this.totalLength=0,this.version=0,this.type="",this.name="",this.headerLength=0}return n.decode=function(a){var t=new DataView(a),e=t.getUint32(0,!0),r=t.getUint8(4),i=t.getUint16(5,!0),o=new Uint8Array(a,7,i),s=t.getUint16(7+i,!0),c=new Uint8Array(a,9+i,s),u=he.decodeText(c),_=he.decodeText(o),h=new n;return h.totalLength=e,h.name=u,h.type=_,h.version=r,h.headerLength=c.byteLength+o.byteLength+9,h},Iu(n,[{key:"dataLength",get:function(){return this.totalLength-this.headerLength}}]),n}(),Rc,zc;Rc=Oa("Mesh"),Rc(zc=function(){function n(){}return n.decode=function(a,t){return new Promise(function(e){var r=new nt(a),i=t.nextStr(),o=JSON.parse(i),s=Math.ceil(t.offset/4)*4,c=new Float32Array(t.buffer,o.positions.start+s,(o.positions.end-o.positions.start)/4),u=c.length/3,_=di(c,u);if(r.setPositions(_),o.normals){var h=new Float32Array(t.buffer,o.normals.start+s,(o.normals.end-o.normals.start)/4),d=di(h,u);r.setNormals(d)}if(o.uvs){var f=new Float32Array(t.buffer,o.uvs.start+s,(o.uvs.end-o.uvs.start)/4);r.setUVs(Ar(f,u))}if(o.uv1){var p=new Float32Array(t.buffer,o.uv1.start+s,(o.uv1.end-o.uv1.start)/4);r.setUVs(Ar(p,u),1)}if(o.uv2){var v=new Float32Array(t.buffer,o.uv2.start+s,(o.uv2.end-o.uv2.start)/4);r.setUVs(Ar(v,u),2)}if(o.uv3){var m=new Float32Array(t.buffer,o.uv3.start+s,(o.uv3.end-o.uv3.start)/4);r.setUVs(Ar(m,u),3)}if(o.uv4){var g=new Float32Array(t.buffer,o.uv4.start+s,(o.uv4.end-o.uv4.start)/4);r.setUVs(Ar(g,u),4)}if(o.uv5){var y=new Float32Array(t.buffer,o.uv5.start+s,(o.uv5.end-o.uv5.start)/4);r.setUVs(Ar(y,u),5)}if(o.uv6){var x=new Float32Array(t.buffer,o.uv6.start+s,(o.uv6.end-o.uv6.start)/4);r.setUVs(Ar(x,u),6)}if(o.uv7){var b=new Float32Array(t.buffer,o.uv7.start+s,(o.uv7.end-o.uv7.start)/4);r.setUVs(Ar(b,u),7)}if(o.colors){var S=new Float32Array(t.buffer,o.colors.start+s,(o.colors.end-o.colors.start)/4);r.setColors(of(S,u))}if(o.boneWeights){var P=new Float32Array(t.buffer,o.boneWeights.start+s,(o.boneWeights.end-o.boneWeights.start)/4);r.setBoneWeights(Ki(P,u))}if(o.boneIndices){var T=new Float32Array(t.buffer,o.boneIndices.start+s,(o.boneIndices.end-o.boneIndices.start)/4);r.setBoneIndices(Ki(T,u))}if(o.blendShapes&&o.blendShapes.forEach(function(M){var V=new ya(M.name);M.frames.forEach(function(A){var C=new Float32Array(t.buffer,A.deltaPosition.start+s,(A.deltaPosition.end-A.deltaPosition.start)/4),R=C.length/3,z=di(C,R);if(A.deltaNormals){var F=new Float32Array(t.buffer,A.deltaNormals.start+s,(A.deltaNormals.end-A.deltaNormals.start)/4);di(F,R)}if(A.deltaTangents){var D=new Float32Array(t.buffer,A.deltaTangents.start+s,(A.deltaTangents.end-A.deltaTangents.start)/4);Ki(D,R)}V.addFrame(A.weight,z)}),r.addBlendShape(V)}),o.indices){var E=null;o.indices.type===0?E=new Uint16Array(t.buffer,o.indices.start+s,(o.indices.end-o.indices.start)/2):E=new Uint32Array(t.buffer,o.indices.start+s,(o.indices.end-o.indices.start)/4),r.setIndices(E)}o.subMeshes.forEach(function(M){r.addSubMesh(M)}),r.uploadData(!1),e(r)})},n}());function of(n,l){for(var a=new Array(l),t=0;t<l;t++)a[t]=new re(n[t*4],n[t*4+1],n[t*4+2],n[t*4+3]);return a}function Ki(n,l){for(var a=new Array(l),t=0;t<l;t++)a[t]=new ve(n[t*4],n[t*4+1],n[t*4+2],n[t*4+3]);return a}function di(n,l){for(var a=new Array(l),t=0;t<l;t++)a[t]=new w(n[t*3],n[t*3+1],n[t*3+2]);return a}function Ar(n,l){for(var a=new Array(l),t=0;t<l;t++)a[t]=new X(n[t*2],n[t*2+1]);return a}var Fc,Bc;Fc=Oa("Texture2D"),Fc(Bc=function(){function n(){}return n.decode=function(a,t){return new Promise(function(e,r){var i=t.nextStr(),o=!!t.nextUint8(),s=t.nextUint8(),c=t.nextUint8(),u=t.nextUint8(),_=t.nextUint8(),h=t.nextUint8(),d=t.nextUint16(),f=t.nextUint16(),p=t.nextUint8(),v=t.nextUint8(),m=t.nextImagesData(v),g=new Mt(a,d,f,h,o);if(g.filterMode=s,g.anisoLevel=c,g.wrapModeU=u,g.wrapModeV=_,p){var y=new Uint8Array(m[0]);if(g.setPixelBuffer(y),o){g.generateMipmaps();for(var x=1;x<v;x++){var b=new Uint8Array(m[x]);g.setPixelBuffer(b,x)}}a.resourceManager._objectPool[i]=g,e(g)}else{var S=new window.Blob([m[0]]),P=new Image;P.onload=function(){g.setImageSource(P);var T=0,E=function(){T++,T>=v&&e(g)};if(E(),o){g.generateMipmaps();for(var M=function(C){var R=new window.Blob([m[C]]),z=new Image;z.onload=function(){g.setImageSource(z,C),E()},z.src=URL.createObjectURL(R)},V=1;V<v;V++)M(V)}},P.src=URL.createObjectURL(S)}})},n}());var Ni=function(){function n(){}return n.registerCustomParseComponent=function(a,t){this.customParseComponentHandles[a]=t},n.parseEntity=function(a,t){var e=this;return n.getEntityByConfig(a,t).then(function(r){var i;r.isActive=(i=a.isActive)!=null?i:!0;var o=a.position,s=a.rotation,c=a.scale;o&&r.transform.setPosition(o.x,o.y,o.z),s&&r.transform.setRotation(s.x,s.y,s.z),c&&r.transform.setScale(c.x,c.y,c.z);for(var u=[],_=0;_<a.components.length;_++){var h=a.components[_],d=h.refId?h.refId:h.class,f=void 0;d==="Animator"&&(f=r.getComponent(Te.getClass(d))),f=f||r.addComponent(Te.getClass(d));var p=e.parsePropsAndMethods(f,h,t);u.push(p)}return Promise.all(u).then(function(){return r})})},n.getEntityByConfig=function(a,t){var e=a.assetRefId;if(e)return t.resourceManager.getResourceByRef({refId:e,key:a.key,isClone:a.isClone}).then(function(i){return i.name=a.name,i});var r=new hr(t,a.name);return Promise.resolve(r)},n.parseClassObject=function(a,t,e){var r;e===void 0&&(e=t.resourceManager);var i=Te.getClass(a.class),o=(r=a.constructParams)!=null?r:[],s=pi(i,o);return this.parsePropsAndMethods(s,a,t,e)},n.parseBasicType=function(a,t,e){var r=this;return e===void 0&&(e=t.resourceManager),Array.isArray(a)?Promise.all(a.map(function(i){return r.parseBasicType(i,t,e)})):typeof a=="object"&&a!=null?this._isClass(a)?this.parseClassObject(a,t,e):this._isRef(a)?e.getResourceByRef(a):Promise.resolve(a):Promise.resolve(a)},n.parsePropsAndMethods=function(a,t,e,r){var i=this;r===void 0&&(r=e.resourceManager);var o=[];if(t.methods)for(var s in t.methods)for(var c=t.methods[s],u=0,_=c.length;u<_;u++){var h=c[u],d=this.parseMethod(a,s,h,e,r);o.push(d)}if(t.props){var f=function(m){var g=t.props[m],y=i.parseBasicType(g,e).then(function(x){return a[m]=x});o.push(y)};for(var p in t.props)f(p)}return new Promise(function(v){Promise.all(o).then(function(){var m=i.customParseComponentHandles[a.constructor.name];m?m(a,t,e).then(function(){v(a)}):v(a)})})},n.parseMethod=function(a,t,e,r,i){var o=this;return i===void 0&&(i=r.resourceManager),Promise.all(e.map(function(s){return o.parseBasicType(s,r,i)})).then(function(s){return a[t].apply(a,s)})},n._isClass=function(a){return a.class!=null},n._isRef=function(a){return a.refId!=null},n}();Ni.customParseComponentHandles=new Map;var sf=function(){function n(a){this._engine=a}var l=n.prototype;return l.parse=function(t){for(var e={},r={},i=[],o=t.entities,s=Ii(o),c;!(c=s()).done;){var u=c.value;r[u.id]=u,i.push(Ni.parseEntity(u,this._engine))}return Promise.all(i).then(function(_){var h=o[0].id;return _.forEach(function(d,f){e[o[f].id]=d}),n.parseChildren(r,e,h),e[h]})},n.parseChildren=function(t,e,r){var i=t[r].children;if(i&&i.length>0)for(var o=e[r],s=0;s<i.length;s++){var c=i[s],u=e[c];o.addChild(u),this.parseChildren(t,e,c)}},n}(),lf={Transform:At,Animator:za,DirectLight:Vr,Camera:ba,MeshRenderer:Tn,ParticleRenderer:Bu,PointLight:Lr,SpotLight:Ut,Script:wa,SpriteMask:wi,SpriteRenderer:bu,TextRenderer:Su},Vc,Dc,Lc;(function(n){n[n.Float=0]="Float",n[n.FloatArray=1]="FloatArray",n[n.Vector2=2]="Vector2",n[n.Vector3=3]="Vector3",n[n.Vector4=4]="Vector4",n[n.Quaternion=5]="Quaternion",n[n.Color=6]="Color",n[n.Array=7]="Array",n[n.Boolean=8]="Boolean"})(Lc||(Lc={}));Vc=Oa("AnimationClip"),Vc(Dc=function(){function n(){}return n.decode=function(a,t){return new Promise(function(e){for(var r=t.nextStr(),i=new Aa(r),o=t.nextUint16(),s=0;s<o;++s){var c=new Ta;c.time=t.nextFloat32(),c.functionName=t.nextStr(),c.parameter=JSON.parse(t.nextStr()).val,i.addEvent(c)}for(var u=t.nextUint16(),_=0;_<u;++_){var h=t.nextStr(),d=t.nextStr(),f=lf[d],p=t.nextStr(),v=void 0,m=t.nextUint8(),g=t.nextUint16(),y=t.nextStr();switch(y){case"AnimationFloatCurve":{v=v||new Mu,v.interpolation=m;for(var x=0;x<g;++x){var b=new Lt;b.time=t.nextFloat32(),b.value=t.nextFloat32(),b.inTangent=t.nextFloat32(),b.outTangent=t.nextFloat32(),v.addKey(b)}break}case"AnimationArrayCurve":{v=v||new Au,v.interpolation=m;for(var S=0;S<g;++S){var P=new Lt;P.time=t.nextFloat32();var T=t.nextUint16();P.value=Array.from(t.nextFloat32Array(T)),P.inTangent=Array.from(t.nextFloat32Array(T)),P.outTangent=Array.from(t.nextFloat32Array(T)),v.addKey(P)}break}case"AnimationFloatArrayCurve":{v=v||new Pa,v.interpolation=m;for(var E=0;E<g;++E){var M=new Lt;M.time=t.nextFloat32();var V=t.nextUint16();M.value=t.nextFloat32Array(V),M.inTangent=Array.from(t.nextFloat32Array(V)),M.outTangent=Array.from(t.nextFloat32Array(V)),v.addKey(M)}break}case"AnimationVector2Curve":{v=v||new Eu,v.interpolation=m;for(var A=0;A<g;++A){var C=new Lt;C.time=t.nextFloat32(),C.value=new X(t.nextFloat32(),t.nextFloat32()),C.inTangent=new X(t.nextFloat32(),t.nextFloat32()),C.outTangent=new X(t.nextFloat32(),t.nextFloat32()),v.addKey(C)}break}case"AnimationVector3Curve":{v=v||new Ea,v.interpolation=m;for(var R=0;R<g;++R){var z=new Lt;z.time=t.nextFloat32(),z.value=new w(t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),z.inTangent=new w(t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),z.outTangent=new w(t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),v.addKey(z)}break}case"AnimationVector4Curve":{v=v||new Ru,v.interpolation=m;var F=new Lt;F.time=t.nextFloat32(),F.value=new ve(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),F.inTangent=new ve(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),F.outTangent=new ve(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),v.addKey(F);break}case"AnimationColorCurve":{v=v||new Pu,v.interpolation=m;for(var D=0;D<g;++D){var I=new Lt;I.time=t.nextFloat32(),I.value=new re(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),I.inTangent=new ve(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),I.outTangent=new ve(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),v.addKey(I)}break}case"AnimationQuaternionCurve":{v=v||new Ma,v.interpolation=m;for(var B=0;B<g;++B){var k=new Lt;k.time=t.nextFloat32(),k.value=new xe(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),k.inTangent=new ve(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),k.outTangent=new ve(t.nextFloat32(),t.nextFloat32(),t.nextFloat32(),t.nextFloat32()),v.addKey(k)}break}}i.addCurveBinding(h,f,p,v)}e(i)})},n}());var cf=function(){function n(){}return n.parse=function(a,t){for(var e=new xa(a),r={},i={},o=[],s=t.entities,c=Ii(s),u;!(u=c()).done;){var _=u.value;i[_.id]=_,o.push(Ni.parseEntity(_,a))}return Promise.all(o).then(function(h){var d=[];h.forEach(function(y,x){r[s[x].id]=y,s[x].parent||d.push(s[x].id)});for(var f=0,p=d;f<p.length;f++){var v=p[f];sf.parseChildren(i,r,v)}for(var m=d.map(function(y){return r[y]}),g=0;g<m.length;g++)e.addRootEntity(m[g]);return e})},n}(),Ic,Oc;Ic=Ue("Mesh",["prefab"],!0),Ic(Oc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){i.request(e.url,{type:"arraybuffer"}).then(function(c){Na(c,r.engine).then(function(u){o(u)})})})},l}(Te));var Nc,Uc;Nc=Ue("EditorTexture2D",["prefab"],!0),Nc(Uc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o){i.request(e.url,{type:"arraybuffer"}).then(function(s){Na(s,r.engine).then(function(c){o(c)})})})},l}(Te));function Na(n,l){var a=af.decode(n),t=new ku(n,a.headerLength,a.dataLength);return Gu[a.type].decode(l,t).then(function(e){return e.name=a.name,e})}var kc,Gc;kc=Ue(Me.Mesh,["mesh"]),kc(Gc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o){i.request(e.url,Pe(Pe({},e),{},{type:"arraybuffer"})).then(function(s){return Na(s,r.engine)}).then(function(s){o(s)})})},l}(Te));var Hc,Wc;Hc=Ue(Me.SpriteAtlas,["atlas"],!1),Hc(Wc=function(n){ue(l,n);function l(){for(var t,e=arguments.length,r=new Array(e),i=0;i<e;i++)r[i]=arguments[i];return t=n.call.apply(n,[this].concat(r))||this,t._tempRect=new ea,t._tempVec2=new X,t}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){i.request(e.url,Pe(Pe({},e),{},{type:"json"})).then(function(c){var u=c.atlasItems,_=c.format,h=u.length;Promise.all(u.map(function(d){var f=d.img;return i.request(he.parseRelativeUrl(e.url,f),Pe(Pe({},e),{},{type:"image"}))})).then(function(d){for(var f=r.engine,p=i._tempRect,v=i._tempVec2,m=new wu(f),g=0;g<h;g++){var y=d[g],x=y.width,b=y.height,S=new Mt(f,x,b,_);S.setImageSource(y),S.generateMipmaps();for(var P=u[g],T=P.sprites,E=1/x,M=1/b,V=T.length-1;V>=0;V--){var A=T[V],C=A.region,R=A.atlasRegionOffset,z=A.atlasRegion,F=A.id,D=A.pivot,I=new Sa(f,S,C?p.set(C.x,C.y,C.w,C.h):void 0,D?v.set(D.x,D.y):void 0,void 0,A.name);if(I.atlasRegion.set(z.x*E,z.y*M,z.w*E,z.h*M),A.atlasRotated&&(I.atlasRotated=!0),R){var B=R.x,k=R.y,Y=R.z,K=R.w;I.atlasRegionOffset.set(B*E,k*M,Y*E,K*M)}F!==void 0&&(I._assetID=F),m._addSprite(I)}}o(m)})}).catch(function(c){s(c)})})},l}(Te));var Xc,qc;Xc=Ue(Me.Sprite,["sprite"],!1),Xc(qc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){i.request(e.url,Pe(Pe({},e),{},{type:"json"})).then(function(c){r.getResourceByRef(c.texture).then(function(u){var _=new Sa(r.engine,u);_.region=c.region,_.pivot=c.pivot,o(_)})})})},l}(Te));var jc,$c;jc=Ue(Me.Texture2D,["png","jpg","webp","jpeg"]),jc($c=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){i.request(e.url,Pe(Pe({},e),{},{type:"image"})).then(function(c){var u,_=(u=e.params)!=null?u:{},h=new Mt(r.engine,c.width,c.height,_.format,_.mipmap);if(!!h._platformTexture){if(h.setImageSource(c),h.generateMipmaps(),e.url.indexOf("data:")!==0){var d=e.url.split("/");h.name=d[d.length-1]}o(h)}}).catch(function(c){s(c)})})},l}(Te));var Yc,Qc;Yc=Ue(Me.TextureCube,[""]),Yc(Qc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){Promise.all(e.urls.map(function(c){return i.request(c,Pe(Pe({},e),{},{type:"image"}))})).then(function(c){var u=c[0],_=u.width,h=u.height;if(_!==h){console.error("The cube texture must have the same width and height");return}var d=new Ct(r.engine,_);if(!!d._platformTexture){for(var f=0;f<6;f++)d.setImageSource(wt.PositiveX+f,c[f],0);d.generateMipmaps(),o(d)}}).catch(function(c){s(c)})})},l}(Te));var Jc,Zc;Jc=Ue(Me.Font,["font"],!1),Jc(Zc=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){i.request(e.url,{type:"json"}).then(function(c){var u=c.fontName,_=c.fontUrl;if(_)i._registerFont(u,_).then(function(){var d=new tn(r.engine,u);o(d)}).catch(function(d){s("load font "+_+" fail")});else{var h=new tn(r.engine,u);o(h)}}).catch(function(c){s(c)})})},a._registerFont=function(){var t=qn(jt().mark(function r(i,o){var s;return jt().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return s=new FontFace(i,"url("+o+")"),u.next=3,s.load();case 3:document.fonts.add(s);case 4:case"end":return u.stop()}},r)}));function e(r,i){return t.apply(this,arguments)}return e}(),l}(Te));var Kc,eu;Kc=Ue(Me.SourceFont,["ttf","otf","woff"],!1),Kc(eu=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this;return new Ee(function(o,s){var c=e.url;i._registerFont(c,c).then(function(){var u=new tn(r.engine,c);o(u)}).catch(function(u){s("load font "+c+" fail")})})},a._registerFont=function(){var t=qn(jt().mark(function r(i,o){var s;return jt().wrap(function(u){for(;;)switch(u.prev=u.next){case 0:return s=new FontFace(i,"url("+o+")"),u.next=3,s.load();case 3:document.fonts.add(s);case 4:case"end":return u.stop()}},r)}));function e(r,i){return t.apply(this,arguments)}return e}(),l}(Te));var tu,ru;tu=Ue(Me.Scene,["prefab"],!0),tu(ru=function(n){ue(l,n);function l(){return n.apply(this,arguments)||this}var a=l.prototype;return a.load=function(e,r){var i=this,o=r.engine;return new Ee(function(s,c){return i.request(e.url,{type:"json"}).then(function(u){return o.resourceManager.initVirtualResources(u.files),cf.parse(o,u).then(function(_){var h=u.scene.ambient,d=Promise.resolve();h.ambientLight?d=r.getResourceByRef(u.scene.ambient.ambientLight).then(function(v){_.ambientLight=v,_.ambientLight.diffuseIntensity=h.diffuseIntensity,_.ambientLight.specularIntensity=h.specularIntensity}):(_.ambientLight.diffuseIntensity=h.diffuseIntensity,_.ambientLight.specularIntensity=h.specularIntensity,_.ambientLight.diffuseSolidColor.copyFrom(h.diffuseSolidColor));var f=u.scene.background;_.background.mode=f.mode;var p=Promise.resolve();switch(_.background.mode){case pr.SolidColor:_.background.solidColor.copyFrom(f.color);break;case pr.Sky:f.sky&&(p=r.getResourceByRef(f.sky).then(function(v){var m=_.background.sky,g=new Fu(o);g.textureCubeMap=v.specularTexture,g.textureDecodeRGBM=!0,m.material=g,m.mesh=pu.createCuboid(o,1,1,1)}));break;case pr.Texture:f.texture&&(p=r.getResourceByRef(f.texture).then(function(v){_.background.texture=v}));break}Promise.all([d,p]).then(function(){s(_)})})})})},l}(Te));Ni.registerCustomParseComponent("TextRenderer",function(){var n=qn(jt().mark(function l(a,t,e){var r;return jt().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return r=t.props,r.font||(a.font=tn.createFromOS(e,r.fontFamily||"Arial")),o.abrupt("return",a);case 3:case"end":return o.stop()}},l)}));return function(l,a,t){return n.apply(this,arguments)}}());var uf="0.9.0-beta.8";console.log("oasis engine version: "+uf);for(var nu in Ol)Te.registerClass(nu,Ol[nu]);export{Ee as A,Fi as B,re as C,Vr as D,hr as E,an as F,za as G,qe as I,gi as K,Te as L,Tn as M,pu as P,Nn as R,pa as S,Mt as T,Ca as U,ge as V,_f as W,Z as a,gr as b,$t as c,at as d,wa as e,gt as f,w as g,O as h,q as i,Me as j,Ct as k,wt as l,xa as m,ba as n,dr as o,Xe as p,G as q,Ue as r,X as s,te as t,Fu as u,Tt as v,pr as w,Pn as x,Xu as y,Qt as z};
